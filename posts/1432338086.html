<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>IAP+YMODEM+CRC16+AES256+PC端软件+hex合并 | 赵逸尘个人博客</title><meta name="keywords" content="C,STM32,嵌入式,IAP,YMODEM,hex,bin,BootLoader,CRC16,AES256"><meta name="author" content="ZhaoYichen"><meta name="copyright" content="ZhaoYichen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="IAP+YMODEM+CRC16+AES256+PC端软件+hex合并升级">
<meta property="og:type" content="article">
<meta property="og:title" content="IAP+YMODEM+CRC16+AES256+PC端软件+hex合并">
<meta property="og:url" content="https://zml3589110.github.io/posts/1432338086.html">
<meta property="og:site_name" content="赵逸尘个人博客">
<meta property="og:description" content="IAP+YMODEM+CRC16+AES256+PC端软件+hex合并升级">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg">
<meta property="article:published_time" content="2024-11-02T08:14:20.000Z">
<meta property="article:modified_time" content="2024-11-02T09:10:07.261Z">
<meta property="article:author" content="ZhaoYichen">
<meta property="article:tag" content="C">
<meta property="article:tag" content="STM32">
<meta property="article:tag" content="嵌入式">
<meta property="article:tag" content="IAP">
<meta property="article:tag" content="YMODEM">
<meta property="article:tag" content="hex">
<meta property="article:tag" content="bin">
<meta property="article:tag" content="BootLoader">
<meta property="article:tag" content="CRC16">
<meta property="article:tag" content="AES256">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" href="/img/favicon_1.png"><link rel="canonical" href="https://zml3589110.github.io/posts/1432338086"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: ZhaoYichen","link":"链接: ","source":"来源: 赵逸尘个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'IAP+YMODEM+CRC16+AES256+PC端软件+hex合并',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-02 17:10:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="赵逸尘个人博客" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">337</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">459</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">178</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><i class="fa-fw fas fa-random"></i><span> Random | 随机文章</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">赵逸尘个人博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><i class="fa-fw fas fa-random"></i><span> Random | 随机文章</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">IAP+YMODEM+CRC16+AES256+PC端软件+hex合并</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-11-02T08:14:20.000Z" title="发表于 2024-11-02 16:14:20">2024-11-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-02T09:10:07.261Z" title="更新于 2024-11-02 17:10:07">2024-11-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E7%B1%BB/">编程类</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E7%B1%BB/C/">C</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/IAP/">IAP</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/YMODEM/">YMODEM</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AES256/">AES256</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>13分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="IAP+YMODEM+CRC16+AES256+PC端软件+hex合并"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h1><p>最近研究 STM32 芯片的 IAP 升级，找到这文章，</p>
<p>后边 PC端软件设置的时候根据自己文章 <strong>“1. Csharp算法之AES实现”</strong> 补充即可得到 bin<br>其他IAP还没测验–20241102</p>
<h1 id="需求及基础"><a href="#需求及基础" class="headerlink" title="需求及基础"></a>需求及基础</h1><p>由于项目需要，花时间研究了一下有关IAP的知识，虽然在原子哥的教程中有讲到关于IAP，但是实际项目中并不会那样使用，也不会使用串口直接不通过协议传输文件，但是原子哥的教程很好的讲明白了IAP的思路以及实现的方法，至于细节部分就是我开贴的原因，希望能多把这种实际项目一定会用到的知识为大家所知，一下代码使用的平台是STM32F0，改成F1&#x2F;F4也很简单，可根据自己情况修改</p>
<h2 id="IAP："><a href="#IAP：" class="headerlink" title="IAP："></a>IAP：</h2><p>学习IAP之前建议大家先看看原子哥的教程了解一下大概，知道IAP的作用以及实现，下面提供一个网址( <a target="_blank" rel="noopener" href="http://www.openedv.com/posts/list/11494.htm">http://www.openedv.com/posts/list/11494.htm</a>) ，是原子哥的IAP文字教程，看完后起码按照教程顺序下来实现串口升级代码了，但是教程中有个跳转至中断向量表的知识点我觉得可能存在问题，我也发帖询问过，但是没有得到解答，以下是我的提问帖，希望能得到答复<br>( <a target="_blank" rel="noopener" href="http://www.openedv.com/forum.php?mod=viewthread&amp;tid=75843">http://www.openedv.com/forum.php?mod=viewthread&amp;tid=75843</a>)</p>
<h2 id="YMODEM："><a href="#YMODEM：" class="headerlink" title="YMODEM："></a>YMODEM：</h2><p>Ymodem的知识简介自己百度一下吧，<br><a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=Z7sLoTcGJjKH580EUmlnqTFIZnPYUM4IH-Tj-TMYVOy7vOmp7L_J5E5ADX8O97rHLvjX-AVM6LAPkslPUvV6qK">传送门</a></p>
<p>原子哥采用的是串口直传升级文件，显然在实际项目我们一般不会那么做，因为可能传输出现错误，需要采取些容错、重发和校验等一些措施来避免传输错误，原本有考虑自己写这个协议来实现文件传输，但是上ST官网一查，已经有了现成的YMODEM+CRC16的代码，所以没多想，直接移植过来好了，也许就是所谓的傻瓜式编程了。但是我觉得去了解YMODEM协议是如何实现的对自己技术水平的提高有很大的帮助，在遇到移植出错时起码知道从哪里下手修改代码，官方找来的IAP+Ymodem的代码在附件中，需要的可以自行下载查看。</p>
<p>这里主要讲解一下几个重要的函数，其中主要有menu.c &#x2F;ymodem.c &#x2F; flash_if.c &#x2F; common.c 这几个头文件，<br>menu.c主要实现的是调用ymodem协议的接口然后对传输是否成功以及传输文件的大小名字做一些显示，<br>最关键还是ymodem.c，实现通过ymodem协议发送和接收文件，<br>其中作为接收一方，我们只用到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ymodem_Receive(<span class="keyword">uint8_t</span> *buf)</span><br></pre></td></tr></table></figure>

<p>这个函数，其中buf是将接收到的1024字节通过ymodem协议接收下来存到缓存buf里面，每传送完成1024字节就写入一次FLASH，这样只需要开辟一个1024字节的缓存就可以实现升级了，而不需要开辟一个很大的数组存储所有代码，没必要浪费那么大一片存储空间，这就是边写边存的好处，</p>
<p>在源码中flash_if.c主要就是对flash的操作了，里面有个FLASH_If_Write函数很好的实现了这个功能，<br>而common.c里面就是现实些整数和字符串的转换和串口发送。把这个协议移植到自己代码中的时候还是跳了不少坑的，官方的东西有时候也不一定靠谱，</p>
<p>我发现我ymodem接收数据后写入flash的时候总是写入错误，写入flash指定地址后从同个地址读出那个值做二次判断的时候居然不同，我使用的是电脑的超级终端，win7网上可以随便下载得到，XP有自带。</p>
<p>这个软件我也会添加到下面的附件当中，里面集成了各种文件传输协议，其中就有ymodem，只要将代码生成bin文件后直接通过ymodem发送出去，然后串口收到的数据通过官方的这段代码就直接能用了。回到话题，写入flash总是出错，后面经过debug发现官方在写flash之前居然不解锁和上锁！不解锁和上锁！！！后面我在写入前加了解锁，写入后上锁，写入错误这个bug就没了，但是还有个问题官方处理的不太严谨，<br>就是代码文件是否写入完成不是按照文件的大小来判断的，而是通过设定的代码区flash大小来决定的，所以我修改了一些代码，在往flash写入数据的时候判断是否已经把整个文件写完了，</p>
<p>由于ymodem协议传输文件时首先会传递文件的大小的一些信息，所以这个文件的大小通过第一个包就可以获取到了，<br>修改的是“FLASH_If_Write”这个函数，可以对比查看，另外官方在写入前会将要写入的那个flash地址先擦除一遍，但是也没有先解锁再上锁的操作，这个地方我也加上了，我会将我修改后ymodem协议添加到附件中，官方的我也会给在附件中，需要的可以自己查看这个函数的区别。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ymodem_Receive (<span class="keyword">uint8_t</span> *buf)</span><br></pre></td></tr></table></figure>

<p>在官方例程中还需要修改一个串口发送和接收函数(在commo.h中)，官方的代码的串口发送这样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SerialPutChar</span><span class="params">(<span class="keyword">uint8_t</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  USART_SendData(EVAL_COM1, c);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (USART_GetFlagStatus(EVAL_COM1, USART_FLAG_TXE) == RESET)</span><br><span class="line">  &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//改成如下：串口几可以根据自己的情况修改</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SerialPutChar</span><span class="params">(<span class="keyword">uint8_t</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  USART_SendData(USART1, c);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (USART_GetFlagStatus(USART1, USART_FLAG_TXE) == RESET)</span><br><span class="line">  &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//官方的串口接收如下：</span></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">SerialKeyPressed</span><span class="params">(<span class="keyword">uint8_t</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( USART_GetFlagStatus(EVAL_COM1, USART_FLAG_RXNE) != RESET)</span><br><span class="line">  &#123;</span><br><span class="line">    *key = USART_ReceiveData(EVAL_COM1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//改成：</span></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">SerialKeyPressed</span><span class="params">(<span class="keyword">uint8_t</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( USART_GetFlagStatus(USART1, USART_FLAG_RXNE) != RESET)</span><br><span class="line">  &#123;</span><br><span class="line">    *key = USART_ReceiveData(USART1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在程序中我使用的升级方式是通过串口发送字符‘1’(可自行修改)，<br>串口收到字符‘1’后，向指定的地址写入0xAAAA，然后使用软复位回到bootloader，bootloader中判断那个地址是不是0xAAAA，<br>如果是则升级，升级完成后擦除这个地址的flash内容跳到APP，<br>如果不是则跳直接回到APP执行，由于升级不可能频繁升，所以这里不用担心把falsh擦写坏。</p>
<h2 id="AES256-PC软件："><a href="#AES256-PC软件：" class="headerlink" title="AES256+PC软件："></a>AES256+PC软件：</h2><p>完成ymodem协议传输代码后紧接着又有一个问题了，以往的代码中如果不需要用到升级功能我们会加上读保护，保证有一层明锁，不至于能直接读出代码，但是一旦有了APP和bootloader，虽然你代码还是能加上读保护，但是当APP变成一个bin文件给到客户升级的时候如果你不进行加密，很容易就给别人读出来，所以APP就要想办法再给到客户的时候又不至于那么容易让他破解，因此需要采用代码加密，AES是目前最流行的加密算法之一，破解也有一定的难度，<br>关于AES的介绍看<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44565944/article/details/108679381">传送门</a></p>
<p>对代码加密有更加严格需求，想加暗锁的可以看下坛友写的一些方法<br>传送门-》<a target="_blank" rel="noopener" href="http://www.openedv.com/thread-64685-1-1.html">关于暗锁</a></p>
<p>一开始也是想自己写AES来着，研究了网上的很多资料，偏理论性的东西实在太多了，后面找到了一个动图，可以很清晰的了解每个加密过程，看了后感觉茅塞顿开，动图贴附件中，需要自己写AES的可以根据这个动图来写。AES分加密和解密两个步奏，了解了原理以后偷懒上网查了一下有没现成的可以用，几次查找后发现了个好东西，如果自己写的话首先需要写解密到MCU上，然后PC需要自己写个软件来对bin进行加密，这份资料已经做完了这些，我只需要直接拿来用就好了，使用的是AES256，</p>
<p>想想也没那么简单，拿来就能直接用？作者提供MCU端AES算法倒是没问题，问题在PC端软件根本用不了，下载了他的软件后用VS编译器调试了下，发现作者不是纯用C#，界面用C#写的，AES的实现用C写的，用C代码生成dll给C#调用，问题就出现这个dll，不知道什么原因总之调用这个dll就报错，后面我重新将这部分C代码重新生成一个dll软件把平台改成X86后就可以正常使用了，接着只要将生成的hex文件导入这个软件，写入AES密匙后会自动生成一个加密后的代码，接着通过Ymodem传输给MCU，MCU边接收别解密，解密后写入flash，<br>这个作者的<a href="(http://www.amobbs.com/thread-5069186-1-1.html)">原网址</a></p>
<p><strong>注意：这个问题自己解决了（放在文章 “Csharp算法之AES实现” 里）</strong></p>
<p>他给的文件包无法直接用，我给的文件包估计也没法在你们的电脑上上直接用，所以只能用你们自己用电脑将C代码生成dll才能正常用了，怎么把C代码生成dll给C#调用，这个百度一大把，很容易(底下有教程，需要VS环境)。</p>
<p>下面是我加了AES的yemodem接收代码，由于是之前写的，现在只加了一些关键备注，附件中的源代码都有注释，这里截取关键的发出来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">Ymodem_Receive</span> <span class="params">(<span class="keyword">uint8_t</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;                    <span class="comment">//1024 + 5</span></span><br><span class="line">        <span class="keyword">uint8_t</span> bufferOut[<span class="number">16</span>]=&#123;<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>&#125;;</span><br><span class="line">  <span class="keyword">uint8_t</span> packet_data[PACKET_1K_SIZE + PACKET_OVERHEAD], file_size[FILE_SIZE_LENGTH], *file_ptr, *buf_ptr;</span><br><span class="line">  <span class="keyword">uint8_t</span> *BufferIn;</span><br><span class="line">        <span class="keyword">int32_t</span> i, j, packet_length, session_done, file_done, packets_received, errors, session_begin, size = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">uint32_t</span> flashdestination, ramsource;</span><br><span class="line"> </span><br><span class="line">        aesDecInit();<span class="comment">//AES解密初始化</span></span><br><span class="line">        </span><br><span class="line">  <span class="comment">/* Initialize flashdestination variable */</span></span><br><span class="line">  flashdestination = APPLICATION_ADDRESS; <span class="comment">//APP代码的起始地址,APPLICATION_ADDRESS = 0x8005000,可在target界面根据情况设置</span></span><br><span class="line">                                           <span class="comment">//这些都在ymodem.h里面的宏进行设置</span></span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (session_done = <span class="number">0</span>, errors = <span class="number">0</span>, session_begin = <span class="number">0</span>; ;)<span class="comment">//死循环直至文件数据包全部发送完成</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (packets_received = <span class="number">0</span>, file_done = <span class="number">0</span>, buf_ptr = buf; ;)</span><br><span class="line">    &#123;</span><br><span class="line">                        </span><br><span class="line">      <span class="keyword">switch</span> (Receive_Packet(packet_data, &amp;packet_length, NAK_TIMEOUT))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:<span class="comment">//成功接收到1K</span></span><br><span class="line">          errors = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">switch</span> (packet_length)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">/* Abort by sender */</span></span><br><span class="line">            <span class="keyword">case</span> - <span class="number">1</span>:  <span class="comment">//接收失败</span></span><br><span class="line">              Send_Byte(ACK);  <span class="comment">//回复</span></span><br><span class="line">              <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="comment">/* End of transmission */</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">              Send_Byte(ACK);<span class="comment">//回复</span></span><br><span class="line">              file_done = <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">/* Normal packet */</span></span><br><span class="line">            <span class="keyword">default</span>:   <span class="comment">//接收成功</span></span><br><span class="line">              <span class="keyword">if</span> ((packet_data[PACKET_SEQNO_INDEX] &amp; <span class="number">0xff</span>) != (packets_received &amp; <span class="number">0xff</span>))</span><br><span class="line">              &#123;<span class="comment">//序号00(文件名)</span></span><br><span class="line">                Send_Byte(NAK);</span><br><span class="line">                                                                </span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> (packets_received == <span class="number">0</span>)<span class="comment">//文件名(首包)</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="comment">/* Filename packet */</span></span><br><span class="line">                  <span class="keyword">if</span> (packet_data[PACKET_HEADER] != <span class="number">0</span>)<span class="comment">//文件名字</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="comment">/* Filename packet has valid data */</span></span><br><span class="line">                    <span class="keyword">for</span> (i = <span class="number">0</span>, file_ptr = packet_data + PACKET_HEADER; (*file_ptr != <span class="number">0</span>) &amp;&amp; (i &lt; FILE_NAME_LENGTH);)</span><br><span class="line">                    &#123;</span><br><span class="line">                      FileName[i++] = *file_ptr++;<span class="comment">//保存文件名</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    FileName[i++] = <span class="string">&#x27;\0&#x27;</span>;<span class="comment">//字符串形式</span></span><br><span class="line">                    <span class="keyword">for</span> (i = <span class="number">0</span>, file_ptr ++; (*file_ptr != <span class="string">&#x27; &#x27;</span>) &amp;&amp; (i &lt; (FILE_SIZE_LENGTH - <span class="number">1</span>));)</span><br><span class="line">                    &#123;</span><br><span class="line">                      file_size[i++] = *file_ptr++;<span class="comment">//文件大小</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    file_size[i++] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                    Str2Int(file_size, &amp;size);<span class="comment">//Convert a string to an integer</span></span><br><span class="line"> </span><br><span class="line">                    <span class="comment">/* Test the size of the image to be sent */</span></span><br><span class="line">                    <span class="comment">/* Image size is greater than Flash size */</span></span><br><span class="line">                    <span class="keyword">if</span> (size &gt; (USER_FLASH_SIZE + <span class="number">1</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="comment">/* End session */</span></span><br><span class="line">                      Send_Byte(CA);</span><br><span class="line">                      Send_Byte(CA);</span><br><span class="line">                      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">/* erase user application area */</span></span><br><span class="line">                                                                                FLASH_Unlock();                                                <span class="comment">//解锁</span></span><br><span class="line">                    FLASH_If_Erase(APPLICATION_ADDRESS);<span class="comment">//This function does an erase of all user flash area</span></span><br><span class="line">                                                                                FLASH_Lock();             <span class="comment">//上锁</span></span><br><span class="line">                                                                                </span><br><span class="line">                                                                                Send_Byte(ACK);</span><br><span class="line">                                                                                Send_Byte(CRC16);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="comment">/* Filename packet is empty, end session */</span></span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    Send_Byte(ACK);</span><br><span class="line">                    file_done = <span class="number">1</span>;</span><br><span class="line">                    session_done = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* Data packet */</span></span><br><span class="line">                <span class="keyword">else</span>  <span class="comment">//文件信息保存完后开始接收数据</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">memcpy</span>(buf_ptr, packet_data + PACKET_HEADER, packet_length);</span><br><span class="line">                                                                        </span><br><span class="line">                                                                        <span class="comment">/*----------------------------------------------------------------------------------------------*/</span></span><br><span class="line">                                                                        BufferIn=buf;</span><br><span class="line">                                                                        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; packet_length; j += <span class="number">16</span>) <span class="comment">//每次解密16字节</span></span><br><span class="line">                                                                        &#123;</span><br><span class="line">                                                                                <span class="comment">//解密数据包</span></span><br><span class="line">                                                                                aesDecrypt(BufferIn,bufferOut); <span class="comment">//由于参数使用的是指针,所以解密后依旧存在buf里面</span></span><br><span class="line">                                                                                BufferIn+=<span class="number">16</span>;</span><br><span class="line">                                                                        &#125;</span><br><span class="line">                                                                        <span class="comment">/*----------------------------------------------------------------------------------------------*/</span></span><br><span class="line">                                                                </span><br><span class="line">                  ramsource = (<span class="keyword">uint32_t</span>)buf;</span><br><span class="line">                  </span><br><span class="line">                  <span class="comment">/* Write received data in Flash */</span>                                   <span class="comment">//这个size参数是自己加进入的,便于判断文件传输完成 </span></span><br><span class="line">                  <span class="keyword">if</span> (FLASH_If_Write(&amp;flashdestination, (<span class="keyword">uint32_t</span>*) ramsource, (<span class="keyword">uint16_t</span>) packet_length/<span class="number">4</span>, size)  == <span class="number">0</span>)</span><br><span class="line">                  &#123;<span class="comment">//写入FLASH  </span></span><br><span class="line">                    Send_Byte(ACK);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span> <span class="comment">/* An error occurred while writing to Flash memory */</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="comment">/* End session */</span></span><br><span class="line">                    Send_Byte(CA);</span><br><span class="line">                    Send_Byte(CA);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                packets_received ++;</span><br><span class="line">                session_begin = <span class="number">1</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">          Send_Byte(CA);</span><br><span class="line">          Send_Byte(CA);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">        <span class="keyword">default</span>:<span class="comment">//检验错误</span></span><br><span class="line">          <span class="keyword">if</span> (session_begin &gt; <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            errors ++;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (errors &gt; MAX_ERRORS)</span><br><span class="line">          &#123;</span><br><span class="line">            Send_Byte(CA);</span><br><span class="line">            Send_Byte(CA);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          Send_Byte(CRC16); <span class="comment">//发送校验值</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">                        </span><br><span class="line">      <span class="keyword">if</span> (file_done != <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (session_done != <span class="number">0</span>) <span class="comment">//文件发送完成</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int32_t</span>)size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Hex合并以及Hex转bin（文件在附件）"><a href="#Hex合并以及Hex转bin（文件在附件）" class="headerlink" title="Hex合并以及Hex转bin（文件在附件）"></a>Hex合并以及Hex转bin（文件在附件）</h2><p>首次下载代码时为了方便需要合并bootloader和APP的hex文件，Hex合并本论坛有人已经提供了一个很好的方法 (<a target="_blank" rel="noopener" href="http://www.openedv.com/thread-70162-1-1.html">http://www.openedv.com/thread-70162-1-1.html</a>) 转成一个hex文件后通过上面那个PC软件，可以直接生成bin文件，之后通过超级终端接通串口传输过去就行了。</p>
<h2 id="无线方式传输"><a href="#无线方式传输" class="headerlink" title="无线方式传输"></a>无线方式传输</h2><p>我试过用电脑蓝牙传输(使用超级终端发送)，接收方也用蓝牙，可以实现升级文件的传输，<br>但是一般客户不会使用电脑蓝牙来发送，只有笔记本有，台式需要蓝牙适配器，当然使用USB转串口来实现升级也是不错的选择，但是需要个USB转串口芯片，也可以直接改修串口发送函数改成USB发送，加上USB驱动就行了。<br>综合考虑还是在产品的APP通过ymodem协议发送会比较符合现在客户的主流需求，安卓系统的我在网上有找到java现成的ymodem发送代码，但是苹果系统如果使用OC进行开发，我目前还没有找到，希望有资源的坛友能提供，下面需要java代码的ymodem协议的可以在这个网址搜  </p>
<p>(<a target="_blank" rel="noopener" href="https://github.com/search?utf8=%E2%9C%93&q=ymodem">https://github.com/search?utf8=%E2%9C%93&q=ymodem</a>)</p>
<p>安卓手机也可以下载有些通用的串口助手，有些也有带ymodem协议。至于其他的无线方式也是一样的。</p>
<h2 id="整个升级过程分为以下步奏："><a href="#整个升级过程分为以下步奏：" class="headerlink" title="整个升级过程分为以下步奏："></a>整个升级过程分为以下步奏：</h2><ol>
<li><p>完成ymodem移植，修改官方ymodem串口发送以及修改flash的一些操作(操作前解锁，操作完上锁)，修改ymodem.h的宏配置，对应编译器的bootloader区和APP代码区的地址</p>
</li>
<li><p>移植aes.c的代码，添加到ymodem接收函数中</p>
</li>
<li><p>在target界面修改APP的代码区地址，写入跳回Bootloader的条件，接收到串口字符’1’后往指定地址写入0xAAAA，软复位在bootloader判断这个地址是否是0xAAAA(这个写入我是另外开辟了1Kflash专门用于存储掉电不丢失数据区，比如0xAAAA就是)，是则升级后跳回APP</p>
</li>
<li><p>修改附件提供的PC端AES256加密软件，用VS编译器重新将环境改为X86，C代码(.c文件)生成DLL供C#调用，C#代码中替换下关键字即可，如果我附件中的软件能直接用则不需要做任何修改(直接能用的概率不高)</p>
</li>
<li><p>合并两个hex文件后，通过PC软件加上16字节的密匙后自动生成bin</p>
</li>
<li><p>下载超级终端，设置为ymodem发送文件，首先发送两个字符‘1’，进入bootloader后发送文件完成升级</p>
</li>
</ol>
<h2 id="PC软件（参考-“Csharp算法之AES实现”-来修改）"><a href="#PC软件（参考-“Csharp算法之AES实现”-来修改）" class="headerlink" title="PC软件（参考 “Csharp算法之AES实现” 来修改）"></a>PC软件（参考 “Csharp算法之AES实现” 来修改）</h2><p><strong>刚拿到这个软件的作者(网址在上面有提到)时会出现如下报警，经修改后可以正常使用。</strong></p>
<img src="/posts/1432338086/eb841fbe9b67da47be5281f356d9f6bf.png" class="" title="img">

<p>VS如何生成DLL文件让PC端软件能够正常使用，先根据下面这个网址操作一遍生成dll工程</p>
<p><a target="_blank" rel="noopener" href="http://jingyan.baidu.com/article/ff411625ad116612e48237a4.html">http://jingyan.baidu.com/article/ff411625ad116612e48237a4.html</a></p>
<img src="/posts/1432338086/4c1081f01d790a8f006bd703c95b619b.png" class="" title="img">

<img src="/posts/1432338086/e4ab66cccdafa4ffa40b43d32cf5f6d2.png" class="" title="img">



<img src="/posts/1432338086/111e412fa6a540e17399dad7722d45d5.png" class="" title="img">

<p><strong>注意：其实这里不用复制那么多，主要只是用到了 DLL 动态库而已</strong></p>
<p>接着先打开项目工程</p>
<img src="/posts/1432338086/2894121745846d98cff956c90ba81412.png" class="" title="img">

<p>先将平台修改为X86</p>
<img src="/posts/1432338086/a6d957b7f9df9d12f960b7ec84dbe083.png" class="" title="img">

<img src="/posts/1432338086/86979ecc3a1888a5c8d9b437dac1eb5e.png" class="" title="img">

<img src="/posts/1432338086/65df58091ff285f21deae8b44b7487c3.png" class="" title="img">

<p>修改完后编译一遍，可以看到多了一个x86的文件夹</p>
<img src="/posts/1432338086/e1e82f029bdaa77a44d2dc53ffc1c0e0.png" class="" title="img">


<p>之后将Debug里面有关MYAES256的5个文件都copy到x86-&gt;debug里面，如下</p>
<img src="/posts/1432338086/226f687c80d7817af2c01d30e433146a.png" class="" title="img">


<p>接下来要做的就是用这个“MYAES256.dl”替代作者的那个“AES256.dll”了，替换关键字</p>
<img src="/posts/1432338086/342644b5768bbb307c5282af87341067.png" class="" title="img">

<p>修改完后编译程序，PC软件就可以正常运行了，密匙根据自己的MCU解密匙来写，如下</p>
<img src="/posts/1432338086/b0b13acaa8c6dd58d5b141825b915665.png" class="" title="img">


<p>生成一个bin在桌面，之后用“超级终端”发送这个bin文件就可以了</p>
<img src="/posts/1432338086/358ad8be482e0f3d00a19afede447347.png" class="" title="img">




<hr>
<h1 id="相关链接-侵删"><a href="#相关链接-侵删" class="headerlink" title="相关链接(侵删)"></a>相关链接(侵删)</h1><ol>
<li><a target="_blank" rel="noopener" href="https://javonpeng.blog.csdn.net/article/details/102680510">IAP+YMODEM+CRC16+AES256+PC端软件+hex合并</a></li>
</ol>
<hr>
<center><font color=red>=================我是分割线=================</font></center>


<p><strong>欢迎到公众号来唠嗑:</strong></p>
<img src="https://pic4.zhimg.com/80/v2-eedc5dc7d30beedf4c2f1812df8e61a7_720w.jpg">

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://zml3589110.github.io">ZhaoYichen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zml3589110.github.io/posts/1432338086.html">https://zml3589110.github.io/posts/1432338086.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zml3589110.github.io" target="_blank">赵逸尘个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C</a><a class="post-meta__tags" href="/tags/STM32/">STM32</a><a class="post-meta__tags" href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a><a class="post-meta__tags" href="/tags/IAP/">IAP</a><a class="post-meta__tags" href="/tags/YMODEM/">YMODEM</a><a class="post-meta__tags" href="/tags/hex/">hex</a><a class="post-meta__tags" href="/tags/bin/">bin</a><a class="post-meta__tags" href="/tags/BootLoader/">BootLoader</a><a class="post-meta__tags" href="/tags/CRC16/">CRC16</a><a class="post-meta__tags" href="/tags/AES256/">AES256</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/1863846554.html"><img class="prev-cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">暗锁程序加密思路</div></div></a></div><div class="next-post pull-right"><a href="/posts/1164397684.html"><img class="next-cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">合并hex文件</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/1164397684.html" title="合并hex文件"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-02</div><div class="title">合并hex文件</div></div></a></div><div><a href="/posts/1135562047.html" title="Csharp算法之AES实现"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-02</div><div class="title">Csharp算法之AES实现</div></div></a></div><div><a href="/posts/1863846554.html" title="暗锁程序加密思路"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-02</div><div class="title">暗锁程序加密思路</div></div></a></div><div><a href="/posts/944314574.html" title="STM32通过SPI驱动ST7789(使用DMA)"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-30</div><div class="title">STM32通过SPI驱动ST7789(使用DMA)</div></div></a></div><div><a href="/posts/423287766.html" title="STM32实现SPI跟DMA功能"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-30</div><div class="title">STM32实现SPI跟DMA功能</div></div></a></div><div><a href="/posts/2741096271.html" title="STM32F错误收集"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-22</div><div class="title">STM32F错误收集</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ZhaoYichen</div><div class="author-info__description">直到这一刻微笑着说话为止，我至少留下了一公升眼泪</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">337</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">459</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">178</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zml3589110"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zml3589110" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:zhaominglong_life@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%95%E5%AD%90"><span class="toc-number">1.</span> <span class="toc-text">引子</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%8F%8A%E5%9F%BA%E7%A1%80"><span class="toc-number">2.</span> <span class="toc-text">需求及基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IAP%EF%BC%9A"><span class="toc-number">2.1.</span> <span class="toc-text">IAP：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#YMODEM%EF%BC%9A"><span class="toc-number">2.2.</span> <span class="toc-text">YMODEM：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AES256-PC%E8%BD%AF%E4%BB%B6%EF%BC%9A"><span class="toc-number">2.3.</span> <span class="toc-text">AES256+PC软件：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hex%E5%90%88%E5%B9%B6%E4%BB%A5%E5%8F%8AHex%E8%BD%ACbin%EF%BC%88%E6%96%87%E4%BB%B6%E5%9C%A8%E9%99%84%E4%BB%B6%EF%BC%89"><span class="toc-number">2.4.</span> <span class="toc-text">Hex合并以及Hex转bin（文件在附件）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E7%BA%BF%E6%96%B9%E5%BC%8F%E4%BC%A0%E8%BE%93"><span class="toc-number">2.5.</span> <span class="toc-text">无线方式传输</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%B8%AA%E5%8D%87%E7%BA%A7%E8%BF%87%E7%A8%8B%E5%88%86%E4%B8%BA%E4%BB%A5%E4%B8%8B%E6%AD%A5%E5%A5%8F%EF%BC%9A"><span class="toc-number">2.6.</span> <span class="toc-text">整个升级过程分为以下步奏：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PC%E8%BD%AF%E4%BB%B6%EF%BC%88%E5%8F%82%E8%80%83-%E2%80%9CCsharp%E7%AE%97%E6%B3%95%E4%B9%8BAES%E5%AE%9E%E7%8E%B0%E2%80%9D-%E6%9D%A5%E4%BF%AE%E6%94%B9%EF%BC%89"><span class="toc-number">2.7.</span> <span class="toc-text">PC软件（参考 “Csharp算法之AES实现” 来修改）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5-%E4%BE%B5%E5%88%A0"><span class="toc-number">3.</span> <span class="toc-text">相关链接(侵删)</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/56459246.html" title="我想做一个与380V半桥8KW电磁板配套的平板线圈盘,电感200,直径600MM,有人做吗"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="我想做一个与380V半桥8KW电磁板配套的平板线圈盘,电感200,直径600MM,有人做吗"/></a><div class="content"><a class="title" href="/posts/56459246.html" title="我想做一个与380V半桥8KW电磁板配套的平板线圈盘,电感200,直径600MM,有人做吗">我想做一个与380V半桥8KW电磁板配套的平板线圈盘,电感200,直径600MM,有人做吗</a><time datetime="2025-01-21T06:06:20.000Z" title="发表于 2025-01-21 14:06:20">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1392348728.html" title="ESP-IDF使用example_disconnect报错"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ESP-IDF使用example_disconnect报错"/></a><div class="content"><a class="title" href="/posts/1392348728.html" title="ESP-IDF使用example_disconnect报错">ESP-IDF使用example_disconnect报错</a><time datetime="2025-01-16T00:35:20.000Z" title="发表于 2025-01-16 08:35:20">2025-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2222175314.html" title="ESP一键配网实现"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ESP一键配网实现"/></a><div class="content"><a class="title" href="/posts/2222175314.html" title="ESP一键配网实现">ESP一键配网实现</a><time datetime="2025-01-15T02:14:20.000Z" title="发表于 2025-01-15 10:14:20">2025-01-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2903904808.html" title="ESP8266如何使用UART串口通讯"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ESP8266如何使用UART串口通讯"/></a><div class="content"><a class="title" href="/posts/2903904808.html" title="ESP8266如何使用UART串口通讯">ESP8266如何使用UART串口通讯</a><time datetime="2024-11-27T12:56:20.000Z" title="发表于 2024-11-27 20:56:20">2024-11-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1164397684.html" title="合并hex文件"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="合并hex文件"/></a><div class="content"><a class="title" href="/posts/1164397684.html" title="合并hex文件">合并hex文件</a><time datetime="2024-11-02T08:49:20.000Z" title="发表于 2024-11-02 16:49:20">2024-11-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By ZhaoYichen</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="icp连接"><img class="icp-icon" src="icp图片"><span>备案号：xxxxxx</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>