<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ESP一键配网实现 | 赵逸尘个人博客</title><meta name="keywords" content="Ubuntu,ESP8266,物联网,UDP,乐鑫,一键配网,广播,组播多播,Wireshark网络抓包,smartconfig"><meta name="author" content="ZhaoYichen"><meta name="copyright" content="ZhaoYichen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="如何通过路由器UDP组播多播方式在 ESP8266 上实现一键配网">
<meta property="og:type" content="article">
<meta property="og:title" content="ESP一键配网实现">
<meta property="og:url" content="https://zml3589110.github.io/posts/2222175314.html">
<meta property="og:site_name" content="赵逸尘个人博客">
<meta property="og:description" content="如何通过路由器UDP组播多播方式在 ESP8266 上实现一键配网">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg">
<meta property="article:published_time" content="2025-01-15T02:14:20.000Z">
<meta property="article:modified_time" content="2025-01-21T06:21:31.986Z">
<meta property="article:author" content="ZhaoYichen">
<meta property="article:tag" content="Ubuntu">
<meta property="article:tag" content="ESP8266">
<meta property="article:tag" content="物联网">
<meta property="article:tag" content="UDP">
<meta property="article:tag" content="乐鑫">
<meta property="article:tag" content="一键配网">
<meta property="article:tag" content="广播">
<meta property="article:tag" content="组播多播">
<meta property="article:tag" content="Wireshark网络抓包">
<meta property="article:tag" content="smartconfig">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" href="/img/favicon_1.png"><link rel="canonical" href="https://zml3589110.github.io/posts/2222175314"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: ZhaoYichen","link":"链接: ","source":"来源: 赵逸尘个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ESP一键配网实现',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-21 14:21:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="赵逸尘个人博客" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">376</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">539</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">219</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><i class="fa-fw fas fa-random"></i><span> Random | 随机文章</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">赵逸尘个人博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><i class="fa-fw fas fa-random"></i><span> Random | 随机文章</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ESP一键配网实现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-01-15T02:14:20.000Z" title="发表于 2025-01-15 10:14:20">2025-01-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-21T06:21:31.986Z" title="更新于 2025-01-21 14:21:31">2025-01-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ESP8266/">ESP8266</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B9%90%E9%91%AB/">乐鑫</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%93%E5%8C%85/">抓包</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/UDP/">UDP</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/smartconfig/">smartconfig</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ESP一键配网实现"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="手动实现-WIFI-SmartConfig-一键配网功能"><a href="#手动实现-WIFI-SmartConfig-一键配网功能" class="headerlink" title="手动实现 WIFI SmartConfig 一键配网功能"></a>手动实现 WIFI SmartConfig 一键配网功能</h1><h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>之前有尝试过乐鑫官方提供的smartconfig，效果并不是很理想，后来也使用巴法云的一键配网功能，想重新学习原理并实现这个功能，但发现网上关于UDP组播的方式文章很好，很多都是使用广播方式发送WIFI信息，因此就重新自己做了程序并记录一下。<br>目前实现的效果为:使ESP8266进入混杂模式，然后使用UDP程序发送组播信息，得到并解析出路由器的SSID和PWD信息！后续就能使用这个账号密码来连接WIFI了</p>
<p>最后实现的是组播方式发送信息，且每一个数据包带上校验和。第一个数据包为数据总长度，第二个为SSID长度，后边为SSID和PWD数据。</p>
<blockquote>
<p><strong>网上有很多文章已经很完整解释了一键配网的基本原理，这里就简单记录用到的内容。</strong></p>
</blockquote>
<h2 id="常用的配网方式"><a href="#常用的配网方式" class="headerlink" title="常用的配网方式"></a>常用的配网方式</h2><p>常用的配网方式：<br>1、AP配网：ESP等WIFI芯片开启AP模式，然后手机连接上这个AP并通过TCP等发送路由器SSID和PWD信息到芯片，WIFI芯片接收到后切换到STA模式并连接到对应WIFI，这个方式的缺点是步骤麻烦，不过也相对稳定！可以通过强制门户功能使手机在连接上AP之后直接打开配网网页！</p>
<p>2、一键配网：用户直接通过已经连接路由器的手机或者其他工具发送UDP广播或多播信息，处于混杂模式(WiFi Promiscuous)的WIFI芯片会接收并解析相应信息后得到了联网SSID和PWD信息，然后进行联网操作。</p>
<p>3、蓝牙配网等：通过蓝牙或者其他方式将配网信息发送到WIFI芯片并进行联网。</p>
<h2 id="流程实现"><a href="#流程实现" class="headerlink" title="流程实现"></a>流程实现</h2><p>1、 先复制乐鑫SDK下的 examples&#x2F;wifi&#x2F;sniffer 混杂实验到测试目录，并编译。<br>2、 通过网络工具的UDP功能向 239.0.0.1:18226 发送任意数据，这里就发送一个字符，此时路由器会发送组播信息。<br>3、 使用Wireshark等工具查看当前IP所发送的UDP数据包，发现有个 0x01 0x00 0x05 … 的数据包，这就是组播数据包。<br>4、 对ESP接收到的数据进行解析，截取 0x01 0x00 0x05 … 开头的6组数据，这个其实是 这个 239.0.0.1 对应的MAC地址。<br>5、 后续只要对 UDP地址进行调整即可得到相应的信息。</p>
<h2 id="编译修改ESP的sniffer工程"><a href="#编译修改ESP的sniffer工程" class="headerlink" title="编译修改ESP的sniffer工程"></a>编译修改ESP的sniffer工程</h2><p>正常ESP环境搭建好的话编译是没有问题的。<br>需要修改的是实现方式。</p>
<p><strong>注意：开始使用了默认方式老是接收不到有效UDP信息，后来先尝试全开然后发现 CONFIG_FILTER_MASK_DATA 这个模式下才能接收到。</strong></p>
<blockquote>
<p>数据格式为：0x01-0x00-0x5e-index-char-checksum</p>
</blockquote>
<p>其中： 0x01-0x00-0x5e：组播固定MAC；index：数据编号；char：有效字符；checksum：校验和</p>
<h2 id="SSID和PWD字符串转换工具"><a href="#SSID和PWD字符串转换工具" class="headerlink" title="SSID和PWD字符串转换工具"></a>SSID和PWD字符串转换工具</h2><p>写了个程序将SSID和PWD转换成IP并通过UDP组播发送出去。</p>
<p>即只需要根据SSID和PWD字符串中的每个字符来更改IP地址的后3位就能得到不一样的MAC后三位数据，也就是最终对应的char。</p>
<h2 id="ESP接收解析"><a href="#ESP接收解析" class="headerlink" title="ESP接收解析"></a>ESP接收解析</h2><p>ESP在没接收到一组信息时会一直变换信道，分别从1-12不断变化，直到有一组数据正确后就会停留在当前信道20秒，若20秒内一直没有等到数据则需要重新调整信道来接收数据。</p>
<p>根据相应信息编码就可得到联网所需的SSID和PWD信息，进一步设置STA即可完成联网！</p>
<h2 id="效果实现"><a href="#效果实现" class="headerlink" title="效果实现"></a>效果实现</h2><p><strong>下图为信道刷新</strong><br>当一直接收不到信息时，将会每秒调整信道，用以查到信道位置。</p>
<img src="/posts/2222175314/%E4%BF%A1%E9%81%93%E5%88%B7%E6%96%B0.png" class="" title="信道刷新">



<p><strong>下图是ESP打印出接收到的有效SSID和PWD信息</strong><br>发送的信息为 MySSID 和 My877 ,ESP所接收到的也是一样，同时打印出当前为12信道。</p>
<img src="/posts/2222175314/ESP-UDP%E7%BB%84%E6%92%AD.png" class="" title="ESP-UDP组播">


<h1 id="WiFi一键配网（smartconfig）原理介绍"><a href="#WiFi一键配网（smartconfig）原理介绍" class="headerlink" title="WiFi一键配网（smartconfig）原理介绍"></a>WiFi一键配网（smartconfig）原理介绍</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>随着越来越多智能家居设备进入家庭，这些产品大部分都是要连接家庭的WiFi网络的，但WiFi网络的接入需要知道无线路由器的名字（SSID）和密码，绝大多数的智能家居不会设置键盘和屏幕，这样对于智能家居要连接的无线路由器输入无线路由器的名字和密码就成了一个困难。为了克服这个问题，人们使用了多种配网方法，比如智能家居热点配网，手机热点配网，蓝牙辅助配网等等，这些配网方式都存在一定的不方便之处，而smartConfig配网方式是无线配网方式里面比较方便和快捷的配网方式。</p>
<h2 id="常用的配网方式-1"><a href="#常用的配网方式-1" class="headerlink" title="常用的配网方式"></a>常用的配网方式</h2><p>智能家居设备热点配网：</p>
<img src="/posts/2222175314/5366d0160924ab18401616d31a11f1ca79890bc0.jpeg@f_auto" class="" title="img">

<p>如上图所示，待配网设备首先启动热点功能，手机连接后把待连接的无线路由器SSID和密码告诉设备，然后，设备去连接无线路由器<br><strong>手机热点配网方式：</strong><br>手机热点配网方式和设备配网差不多，仅仅是手机做为热点，流程和上图类似。<br><strong>蓝牙配网方式：</strong><br>蓝牙配网是需要设备同时具有蓝牙功能，先使用蓝牙进行连接，把无线路由器的SSID和密码通过蓝牙发送给待配网设备。这种配网方式要求待配网设备具有蓝牙功能，成本较高，结构复杂，使用较少。<br>这些配网方式都需要实现设置一个网络来辅助配网，配网时间比较长，也比较繁琐，使用上并不便利。</p>
<h2 id="SmartConfig配网基本原理"><a href="#SmartConfig配网基本原理" class="headerlink" title="SmartConfig配网基本原理"></a>SmartConfig配网基本原理</h2><p>smartconfig的配网基本原理是通过手机直接发送报文到待配网设备。</p>
<img src="/posts/2222175314/8718367adab44aedcf3962c29df79006a08bfb90.jpeg@f_auto" class="" title="img">

<p>手机发送UDP广播报文，待配网设备扫描所有的可用无线信道，找到发送smartConfig的报文，并锁定在这一信道上开始接受数据。</p>
<h2 id="需要克服的问题"><a href="#需要克服的问题" class="headerlink" title="需要克服的问题"></a>需要克服的问题</h2><p>我们配置的无线路由器绝大多数都是带密码的，我们知道，WiFi设置了密码则数据就是加密的，这时候待配网的设备是不能解密出数据的内容的，那怎么把无线路由器的密码和SSID送给待配网设备呢？</p>
<img src="/posts/2222175314/962bd40735fae6cd1e4da9f13f58182340a70f92.jpeg@f_auto" class="" title="img">


<p>上图就是用抓包软件抓取的数据报文内容，大家可以看到，除了802.11 MAC Header 能看到外，其他都是加密字段，我们能了解到的只有源MAC地址和目的MAC地址和BSSID信息其他有限几个字段，如何把信息告诉待配网设备呢？</p>
<ol>
<li>由于配网设备未连接无线路由器，手机无法知道待配网设备的的MAC地址，如何才能让待配网设备接收到信息呢？<br>解决方法：<ol>
<li>虽然报文的整个数据部分都是加密的，但我们能知道报文的长度和发送MAC和目的MAC，我们要传输信息可以从这几个地方着手。我们可以使用报文长度这个特征来传递数据。</li>
<li>由于设备没有连接到无线路由器，这时候手机要发送配网信息是不知道设备的地址的，所以使用的地址是广播地址，这样只要在附近的无线WiFi设备处于监听模式都可以接收到这个报文。</li>
</ol>
</li>
</ol>
<h2 id="报文长度传递信息"><a href="#报文长度传递信息" class="headerlink" title="报文长度传递信息"></a>报文长度传递信息</h2><p>如何使用报文长度传递信息呢？smartconfig使用UDP报文传递信息，UDP的特点是可以发送广播数据，长度从0到最大的MAC报文长度减去前面的报文首部。这个长度可以传递我们需要的信息。SmartConfig有多种实现，我们举一个例子来说明。</p>
<img src="/posts/2222175314/279759ee3d6d55fb65b259ac40c9584d21a4dd32.jpeg@f_auto" class="" title="img">

<p>上图显示的是连续发送三个长度为1248长度的数据报文表示smartconfig的开始，后面接数据帧。数据帧里面可以传递无线路由器的SSID和密码。由于smartconfig使用的是UDP报文传递，在发送的时候是没有顺序的，这时候就需要对发送的数据有索引字段。</p>
<img src="/posts/2222175314/96dda144ad345982256741b9231f26aacaef841a.jpeg@f_auto" class="" title="img">

<p>这样报文的长度等于 packet len &#x3D; 索引 | 数据 ，索引和数据的位数可以自己来设计。</p>
<h2 id="传递的效率"><a href="#传递的效率" class="headerlink" title="传递的效率"></a>传递的效率</h2><p>由于信息仅能靠长度来传递，而且报文的长度是受限的，则每个报文的信息量是很有限的，传递一个长度是1248长度的数据帧，传递的信息也仅仅是两个字节的数据0X04E0 (0x04e0 &#x3D; 1248), 传递信息的效率是相当低的，1248是UDP报文的长度，加上前面的UDP包头IP包头，MAC包头等可能要超过1300个字节，那传输的效率就是2&#x2F;1300&#x3D;0.0015，情况更糟的是，2个字节传递的信息是0- 0xFFFF，就是0-65535，MAC层的报文长度最大是1500个字节，也就是说即便使用最大的报文长度传递信息连两个字节也传递不了，再去掉索引数据，一般一个报文只能传递一个字节数据。这样传递的效率就更低了。所以smartconfig广播UDP配网的效率普遍较慢，在密码和SSID比较长的情况下，还有配网失败的情况发生。</p>
<h2 id="多播配网"><a href="#多播配网" class="headerlink" title="多播配网"></a>多播配网</h2><p>为了克服广播配网的缺陷，出现了多播配网的应用。多播和广播一样，都是一种可以被附近配网设备接收到的报文，但由于多播地址有多个，可以使用多播的地址来传递信息。<br>IP多播地址<br>范围从 224.0.0.0 到 239.255.255.255<br>MAC多播地址<br>01-00-5E-00-00-00 到 01-00-5E-7F-FF-FF<br>对于smartconfig配网而言，一般情况下IP地址是加密的字段，我们无法看到，所以只能使用多播MAC地址来传递信息。<br>从上面的地址我们可以看出多播地址有个较大的范围，地址有三个字节是变化的，我们可以使用这三个变化的地址空间来传递信息。同样由于每次只能传递三个字节，我们需要一个顺序字段，一般会占用一个字节，这样还有两个字节来传递信息，如下图是使用多播MAC地址的示意图。</p>
<img src="/posts/2222175314/b2de9c82d158ccbf9632ea603733ab39b33541d4.jpeg@f_auto" class="" title="img">

<p>多播配网的数据部分不需要传递信息，所以传递的数据长度大大降低，传递效率很高，多播配网的效率和速度都远远高于广播长度字段配网效率。</p>
<h1 id="smartConfig-浅析"><a href="#smartConfig-浅析" class="headerlink" title="smartConfig 浅析"></a>smartConfig 浅析</h1><p>一、背景</p>
<p>物联网时代技术开始规模化服务于民众，方便快捷显得尤为重要，WIFI 直连便是一个典型案例。</p>
<p>目前主流的 WIFI 配置模式有以下 2 种:</p>
<ol>
<li>智能硬件处于 AP 模式（类似路由器，组成局域网），手机用于 STA 模式<br> 手机连接到处于 AP 模式的智能硬件后组成局域网,手机发送需要连接路由的 SSID 及密码至智能硬件，智能硬件主动去连接指定路由后,完成配网</li>
<li>一键配网(smartConfig)模式<br> 智能硬件处于混杂模式下,监听网络中的所有报文;手机 APP 将 SSID 和密码编码到 UDP 报文中,通过广播包或组播报发送,智能硬件接收到 UDP 报文后解码,得到正确的 SSID 和密码,然后主动连接指定 SSID 的路由完成连接。</li>
</ol>
<p><strong>AP 模式：</strong></p>
<p>AP 是 (Wireless) Access Point 的缩写，即 (无线) 访问接入点。简单来讲就像是无线路由器一样，设备打开后进入 AP 模式，在手机的网络列表里面，可以搜索到类似 TPLINK_XXX 的名字（SSID）。</p>
<p>连接步骤：</p>
<p>1、智能硬件设备初始化并进入 AP 模式<br>2、手机扫描 WIFI 列表：扫描到智能硬件设备后（SSID）连接该智能硬件设备，通过 UDP 发送 经过 AES 加密过的 ssid&#x2F;password&#x2F;token</p>
<img src="/posts/2222175314/917705-20200109180746048-626612788.png" class="" title="img">

<p>** smartConfig 模式：**<br>这种快速连接方式，相对于 AP 模式连接简化操作，更加贴近于市场</p>
<p>1、手机连上 WiFi，打开智能硬件指定 APP 软件，进入配置界面，输入手机所在 WiFi 密码，请求配网 TOKEN<br>2、智能硬件开启混杂模式监听所有网络数据包<br>3、手机通过广播、组播循环发送 ssid&#x2F;password&#x2F;token<br>4、硬件设备通过 UDP 包（长度）获取配置信息捕捉到 ssid&#x2F;password&#x2F;token，连接路由器（广播根据 UDP 包长度，组播根据 IP 地址信息）</p>
<img src="/posts/2222175314/917705-20200109180812392-845370729.png" class="" title="img">

<p>从原理上讲只要芯片驱动支持开启混杂模式(WiFi Promiscuous),就可以支持一键配网功能</p>
<p>手机编码发送采用有 UDP 组播或广播，不同的发送方式和编码，对应的解码过程也不一样</p>
<p>1、广播：</p>
<p>发送方可通过改变其所需要发送数据包的长度进行控制，因此只要指定出一套利用长度编码的通讯协议，就可利用数据包的 Length 字段进行数据传递</p>
<p>2、 组播：</p>
<p>组播地址是保留的 D 类地址从224.0.0.0-239.255.255.255</p>
<p>IP 地址与 MAC 地址映射关系为：将 MAC 地址的前 25 位设定为 01.00.5e，而 MAC 地址的后 23 位对应 IP 地址位</p>
<p>故发送端可以将数据编码在组播 IP 的后 23bit 中，通过组播包发送接收端进行解码即可</p>
<img src="/posts/2222175314/917705-20200109180835935-2003338703.png" class="" title="img">

<p>二、smartConfig 原理浅析</p>
<p>在没有和其他设备(支持 smartConfig 技术)建立任何性质的通讯链路的情况下, 配置该设备接入 WIFI 网络</p>
<p>普通权限的应用程序是没有能力完全控制和定义传输层及下层所有协议数据的, 唯一可以完全控制的就是应用层数据</p>
<p>本质上就是将 UDP 包头的数据长度作为 smartConfig 的数据，APP 端和设备端共用一套编码表即可解析数据</p>
<p>TCP&#x2F;IP 协议栈中的网络层和传输层的数据结构</p>
<p>常用的网络层协议是 IPv4, IPv4 的头部绝大多数情况下都是定长的20字节</p>
<p>传输层协议是 UDP, 因为 UDP 协议头部为定长的 8 字节</p>
<p>明文长度 &#x3D; 20 + 8 + dataLen</p>
<p>密文长度 &#x3D; 20 + 8 + dataLen + 算法常量</p>
<p>例子：</p>
<p>如果需要发出一个密文长度为 500 字节的 802.11 帧,只需要在 UDP 中填充任意(500 – 20 – 8 – 算法常亮)个字节数据即可</p>
<p>因此，只需要利用可控的密文长度（dataLen）定义一张编码表即可将数据告诉任何知道这张编码表的设备（IoT硬件设备）</p>
<p>自定义一张编码表，流程如下:</p>
<p>dataLen –&gt; 映射<br>1234    –&gt; 起始符; 连续的3个起始符, 用于表示数据传输开始<br>1324    –&gt; 结束符; 连续的3个结束符, 用于表示数据传输结束<br>110     –&gt; 间隔符; 连续的2个间隔符, 用于表示数据符之间的间隔<br>1000    –&gt; 数据符; 表示 ASCII 0x00<br>1001    –&gt; 数据符; 表示 ASCII 0x01<br>…<br>1127    –&gt; 数据符; 表示 ASCII 0x7F</p>
<img src="/posts/2222175314/917705-20200109180859712-1075065612.png" class="" title="img">

<p> 假设我们要把字符串”Jay”告诉摄像头, 整个流程大致如下: (假设算法常亮为 16)</p>
<p>APP 端:</p>
<p>打开手机 APP, 在输入框中填入要发送的字符串”Jay”, 点击发送：</p>
<p>1.1、APP 连续发送 3 个 UDP 广播包, 填充数据为 1190 个字节 0x00 数据 ( 1234 – 16 – 20 – 8 &#x3D; 1190 ), 表示传输开始<br>1.2、APP 发送     1 个 UDP 广播包, 填充数据为 1030 个字节 0x00 数据 ( 1074 – 16 -20 – 8 &#x3D; 1030  ), 传输字符 J<br>1.3、APP 连续发送 2 个 UDP 广播包, 填充数据为 66   个字节 0x00 数据 ( 110 – 16 – 20 – 8 &#x3D; 66    ), 表示数据间隔<br>1.4、APP 发送     1 个 UDP 广播包, 填充数据为 1053 个字节 0x00 数据 ( 1097 – 16 -20 – 8 &#x3D; 1053  ), 传输字符 1097 对应 a<br>1.5、APP 连续发送 2 个 UDP 广播包, 填充数据为 66   个字节 0x00 数据 ( 110 – 16 – 20 – 8 &#x3D; 66    ), 表示数据间隔<br>1.6、APP 发送     1 个 UDP 广播包, 填充数据为 1077 个字节 0x00 数据 ( 1121 – 16 -20 – 8 &#x3D; 1077  ), 传输字符 1121 对应 y<br>1.7、APP 连续发送 3 个 UDP 广播包, 填充数据为 1280 个字节 0x00 数据 ( 1324- 16 – 20 – 8 &#x3D; 1280  ), 表示传输结束</p>
<p>从步骤 1.1 开始循环多次, 直到超时或 IoT 设备成功接入 WIFI</p>
<p>IoT 设备端:</p>
<p>设备上电进入混杂模式，开始监听信号覆盖范围内的所有 WIFI 数据帧</p>
<p>捕获数据帧, 如果连续收到 3 个密文，其数据长度 dataLen 为 1234 字节, 且来自于同一个发射源 channel-A 的数据帧, 则进入下一步, 否则该步骤</p>
<p>捕获发射源 channel-A 的数据帧, 持续捕获密文数据长度为 110 或 1000-1127 之间的数据帧, 直到捕获到连续 3 个密文数据长度为 1324 的数据帧</p>
<p>将上述数据帧按照编码表进行映射, 由于手机 APP 并非是独占网络, 所以捕获到的数据可能有噪音, 比如解码出来的结果可能是(&#x2F;表示分隔符): mnJ&#x2F;o@a&#x2F;ymmm</p>
<p>如果没有噪音, 记为候选数据RC, 重复捕获X, 进行二次验证, 通过则表示接收完成, 没通过也重复捕获 channel-A,</p>
<p>将这次所得结果同上一次做交集, 循环如此直到得出唯一结果, 即 RC, 之后再重复 5</p>
<p>由于捕获的数据帧头部信息中已经包含了 WIFI 的 BSSID 信息, 使用 “Jay” 作为密码去尝试连接相应的 WIFI</p>
<h2 id="四、知识扩展"><a href="#四、知识扩展" class="headerlink" title="四、知识扩展"></a>四、知识扩展</h2><p>在当前网络通信中有三种通信模式：</p>
<p>单播、广播、组播(又叫多播)，其中多播出现的时间最晚，但同时具备单播和广播的优点，最具有发展前景.</p>
<p>通信方式分类：</p>
<pre><code>1.单播：单台主机与单台主机之间的通信；

2.广播：单台主机与网络中所有主机的通信；

3.组播：单台主机与选定的一组主机的通信；
</code></pre>
<p>单播：</p>
<pre><code> 单播是网络通信中最常见的，网络节点之间的通信 就好像是人们之间的对话一样，如果一个人对另外一个人说话,那么用网络技术的术语来描述就是“单播”，此时信息的接收和传递只在两个节点之间进行。

 1. 单播的优点：

     (1)服务器以及响应客户端的请求；

     (2)服务器能针对每个客户端的不同请求发送不同的响应，容易显示个性化服务；

 2. 单播的缺点：

     服务器针对每个客户机发送数据流，服务器流量＝客户机数量×客户机流量；在客户数量大、每个客户机流量大的流媒体应用中服务器不堪重负；

 3. 应用场景：

    单播在网络中得到了广泛的应用，网络上绝大部分的数据都是以单播的形式传输的，例如：收发电子邮件、游览网页时，必须与邮件服务器、服务器建立连接，此时使用的就是单播通信方式；
</code></pre>
<p>广播：</p>
<pre><code>广播可以比作为一个人通过广播喇叭对在场的全体说话，换句话说: 广播是一台主机对某一个网络上的所有主机发送数据报包。

这个网络可能是网络，也可能时子网，还有可能是所有子网。

广播有两类：本地广播和定向广播：

        定向广播：将数据报包发送到本网络之外的特定网络的所有主机，互联网上的大部分路由器都不转发定向广播消息；

        本地广播：将数据报包发送到本地网络的所有主机，IPv4的本地广播地址为“255.255.255.255”，路由器不会转发此广播；

1.广播的优点：

   (1)通信的效率高，信息一下子就可以传递到某一个网络上的所有主机。

   (2)由于服务器不用向每个客户端单独发送数据，所以服务器流量比较负载低；

2.广播的缺点：

   (1)非常占用网络的带宽；

   (2)缺乏针对性,也不管主机是否真的需要接收该数据, 就强制的接收数据；

3.应用场景：

   有线电视就是典型的广播型网络
</code></pre>
<p>组播：</p>
<pre><code> 组播可以比作为你对着大街喊：女士免费领优惠券，那么女士就会过来，男士就不会过来(组播：其中所有的女士就是一个组)

 换句话说:
 
 组播是一台主机向指定的一组主机发送数据报包，因为如果采用单播方式，逐个节点传输，有多少个目标节点就会有多少次传送过程，这种方式显然效率极低，是不可取的；
 
 如果采用不区分目标、全部发送的广播方式，虽然一次可以传送完数据，但是显然达不到区分特定数据接收对象的目的，又会占用网络带宽。
 
 采用组播方式，既可以实现一次传送所有目标节点的数据，也可以达到只对特定对象传送数据的目的；

 IP 网络的组播一般通过组播 IP 地址来实现，组播 IP 地址就是 D 类 IP 地址，即 224.0.0.0 至 239.255.255.255 之间的IP地址。

 1.组播的优点：

    (1)具备广播所具备的所有优点；

    (2)与单播相比，提供了发送数据报包的效率，与广播相比，减少了网络流量；

 2.组播的缺点：

    与单播协议相比没有纠错机制，发生丢包错包后难以弥补，但可以通过一定的容错机制和QOS加以弥补；
</code></pre>
<p>refer:</p>
<p><a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/ab6bc08a9b6648d7c0c746ac.html">https://wenku.baidu.com/view/ab6bc08a9b6648d7c0c746ac.html</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/sadshen/article/details/47049129">https://blog.csdn.net/sadshen/article/details/47049129</a></p>
<p><a target="_blank" rel="noopener" href="https://my.oschina.net/u/2396236/blog/1788674">https://my.oschina.net/u/2396236/blog/1788674</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/li_yangyang_li/article/details/50989220">https://blog.csdn.net/li_yangyang_li/article/details/50989220</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/flyingcys/article/details/49283273">https://blog.csdn.net/flyingcys/article/details/49283273</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/dabing69221/article/details/17286441#t1">https://blog.csdn.net/dabing69221/article/details/17286441#t1</a></p>
<h1 id="UDP-单播、广播、多播"><a href="#UDP-单播、广播、多播" class="headerlink" title="UDP 单播、广播、多播"></a>UDP 单播、广播、多播</h1><img src="/posts/2222175314/1603710-20190222112509243-1228048082.png" class="" title="img">

<h2 id="一、UDP广播"><a href="#一、UDP广播" class="headerlink" title="一、UDP广播"></a>一、UDP广播</h2><p>广播UDP与单播UDP的区别就是IP地址不同，广播使用广播地址255.255.255.255，将消息发送到在同一广播网络上的每个主机。值得强调的是：本地广播信息是不会被路由器转发。当然这是十分容易理解的，因为如果路由器转发了广播信息，那么势必会引起网络瘫痪。这也是为什么IP协议的设计者故意没有定义互联网范围的广播机制。</p>
<p>广播地址通常用于在网络游戏中处于同一本地网络的玩家之间交流状态信息等。</p>
<p>其实广播顾名思义，就是想局域网内所有的人说话，但是广播还是要指明接收者的端口号的，因为不可能接受者的所有端口都来收听广播。</p>
<h2 id="二、UDP多播"><a href="#二、UDP多播" class="headerlink" title="二、UDP多播"></a>二、UDP多播</h2><h3 id="1、多播（组播）的概念"><a href="#1、多播（组播）的概念" class="headerlink" title="1、多播（组播）的概念"></a>1、多播（组播）的概念</h3><p>多播，也称为“组播”，将网络中同一业务类型主机进行了逻辑上的分组，进行数据收发的时候其数据仅仅在同一分组中进行，其他的主机没有加入此分组不能收发对应的数据。</p>
<p>　　在广域网上广播的时候，其中的交换机和路由器只向需要获取数据的主机复制并转发数据。主机可以向路由器请求加入或退出某个组，网络中的路由器和交换机有选择地复制并传输数据，将数据仅仅传输给组内的主机。多播的这种功能，可以一次将数据发送到多个主机，又能保证不影响其他不需要（未加入组）的主机的其他通 信。</p>
<p>相对于传统的一对一的单播，多播具有如下的优点：</p>
<p>　　1、具有同种业务的主机加入同一数据流，共享同一通道，节省了带宽和服务器的优点，具有广播的优点而又没有广播所需要的带宽。</p>
<p>　　2、服务器的总带宽不受客户端带宽的限制。由于组播协议由接收者的需求来确定是否进行数据流的转发，所以服务器端的带宽是常量，与客户端的数量无关。</p>
<p>　　3、与单播一样，多播是允许在广域网即Internet上进行传输的，而广播仅仅在同一局域网上才能进行。</p>
<p>组播的缺点：</p>
<p>　　1、多播与单播相比没有纠错机制，当发生错误的时候难以弥补，但是可以在应用层来实现此种功能。</p>
<p>　　2、多播的网络支持存在缺陷，需要路由器及网络协议栈的支持。</p>
<p>　　3、多播的应用主要有网上视频、网上会议等。</p>
<h3 id="2、广域网的多播"><a href="#2、广域网的多播" class="headerlink" title="2、广域网的多播"></a>2、广域网的多播</h3><p>多播的地址是特定的，D类地址用于多播。D类IP地址就是多播IP地址，即224.0.0.0至239.255.255.255之间的IP地址，并被划分为局部连接多播地址、预留多播地址和管理权限多播地址3类：</p>
<p>　　1、局部多播地址：在224.0.0.0～224.0.0.255之间，这是为路由协议和其他用途保留的地址，路由器并不转发属于此范围的IP包。</p>
<p>　　2、预留多播地址：在224.0.1.0～238.255.255.255之间，可用于全球范围（如Internet）或网络协议。</p>
<p>　　3、管理权限多播地址：在239.0.0.0～239.255.255.255之间，可供组织内部使用，类似于私有IP地址，不能用于Internet，可限制多播范围。</p>
<p>多播的程序设计使用setsockopt()函数和getsockopt()函数来实现，组播的选项是IP层的，其选项值和含义参见11.5所示。</p>
<p>　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　表11.5 多播相关的选项</p>
<table>
<thead>
<tr>
<th>**getsockopt()&#x2F;setsockopt()**的选项</th>
<th>含 义</th>
</tr>
</thead>
<tbody><tr>
<td>IP_MULTICAST_TTL</td>
<td>设置多播组数据的TTL值</td>
</tr>
<tr>
<td>IP_ADD_MEMBERSHIP</td>
<td>在指定接口上加入组播组</td>
</tr>
<tr>
<td>IP_DROP_MEMBERSHIP</td>
<td>退出组播组</td>
</tr>
<tr>
<td>IP_MULTICAST_IF</td>
<td>获取默认接口或设置接口</td>
</tr>
<tr>
<td>IP_MULTICAST_LOOP</td>
<td>禁止组播数据回送</td>
</tr>
</tbody></table>
<h3 id="3、多播程序设计的框架"><a href="#3、多播程序设计的框架" class="headerlink" title="3、多播程序设计的框架"></a>3、多播程序设计的框架</h3><p>要进行多播的编程，需要遵从一定的编程框架。多播程序框架主要包含套接字初始化、设置多播超时时间、加入多播组、发送数据、接收数据以及从多播组中离开几个方面。其步骤如下：</p>
<p>（1）建立一个socket。</p>
<p>（2）然后设置多播的参数，例如超时时间TTL、本地回环许可LOOP等。</p>
<p>（3）加入多播组。</p>
<p>（4）发送和接收数据。</p>
<p>（5）从多播组离开</p>
<h2 id="UDP广播与单播"><a href="#UDP广播与单播" class="headerlink" title="UDP广播与单播"></a>UDP广播与单播</h2><p>广播与单播的比较</p>
<p>广播和单播的处理过程是不同的，单播的数据只是收发数据的特定主机进行处理，而广播的数据整个局域网都进行处理。</p>
<p>　　例如在一个以太网上有3个主机，主机的配置如表11.4所示。</p>
<p>　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　表11.4 某局域网中主机的配置情况</p>
<table>
<thead>
<tr>
<th>主 机</th>
<th><strong>A</strong></th>
<th><strong>B</strong></th>
<th><strong>C</strong></th>
</tr>
</thead>
<tbody><tr>
<td>IP地址</td>
<td>192.168.1.150</td>
<td>192.168.1.151</td>
<td>192.168.1.158</td>
</tr>
<tr>
<td>MAC地址</td>
<td>00:00:00:00:00:01</td>
<td>00:00:00:00:00:02</td>
<td>00:00:00:00:00:03</td>
</tr>
</tbody></table>
<p>　　单播流程：主机A向主机B发送UDP数据报，发送的目的IP为192.168.1.151，端口为 80，目的MAC地址为00:00:00:00:00:02。此数据经过UDP层、IP层，到达数据链路层，数据在整个以太网上传播，在此层中其他主机会 判断目的MAC地址。主机C的MAC地址为00:00:00:00:00:03，与目的MAC地址00:00:00:00:00:02不匹配，数据链路层 不会进行处理，直接丢弃此数据。</p>
<p>　　主机B的MAC地址为00:00:00:00:00:02，与目的MAC地址00:00:00:00:00:02一致，此数据会经过IP层、UDP层，到达接收数据的应用程序。</p>
<p>　　广播的流程：主机A向整个网络发送广播数据，发送的目的IP为192.168.1.255，端口为 80，目的MAC地址为FF:FF:FF:FF:FF:FF。此数据经过UDP层、IP层，到达数据链路层，数据在整个以太网上传播，在此层中其他主机会 判断目的MAC地址。由于目的MAC地址为FF:FF:FF:FF:FF:FF，主机C和主机B会忽略MAC地址的比较（当然，如果协议栈不支持广播，则 仍然比较MAC地址），处理接收到的数据。</p>
<p>　　主机B和主机C的处理过程一致，此数据会经过IP层、UDP层，到达接收数据的应用程序。</p>
<hr>
<h1 id="相关链接（侵删）"><a href="#相关链接（侵删）" class="headerlink" title="相关链接（侵删）"></a>相关链接（侵删）</h1><ol>
<li><a target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1674425022615796809&wfr=spider&for=pc">WiFi一键配网（smartconfig）原理介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangshenghui/p/12172893.html">物联网之 WIFI 一键配网 smartConfig 浅析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yyy1234/p/10417383.html">UDP 单播、广播、多播</a></li>
</ol>
<hr>
<center><font color=red>=================我是分割线=================</font></center>


<p><strong>欢迎到公众号来唠嗑:</strong></p>
<img src="https://pic4.zhimg.com/80/v2-eedc5dc7d30beedf4c2f1812df8e61a7_720w.jpg">

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://zml3589110.github.io">ZhaoYichen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zml3589110.github.io/posts/2222175314.html">https://zml3589110.github.io/posts/2222175314.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zml3589110.github.io" target="_blank">赵逸尘个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Ubuntu/">Ubuntu</a><a class="post-meta__tags" href="/tags/ESP8266/">ESP8266</a><a class="post-meta__tags" href="/tags/%E7%89%A9%E8%81%94%E7%BD%91/">物联网</a><a class="post-meta__tags" href="/tags/UDP/">UDP</a><a class="post-meta__tags" href="/tags/%E4%B9%90%E9%91%AB/">乐鑫</a><a class="post-meta__tags" href="/tags/%E4%B8%80%E9%94%AE%E9%85%8D%E7%BD%91/">一键配网</a><a class="post-meta__tags" href="/tags/%E5%B9%BF%E6%92%AD/">广播</a><a class="post-meta__tags" href="/tags/%E7%BB%84%E6%92%AD%E5%A4%9A%E6%92%AD/">组播多播</a><a class="post-meta__tags" href="/tags/Wireshark%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85/">Wireshark网络抓包</a><a class="post-meta__tags" href="/tags/smartconfig/">smartconfig</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2903904808.html"><img class="prev-cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ESP8266如何使用UART串口通讯</div></div></a></div><div class="next-post pull-right"><a href="/posts/1392348728.html"><img class="next-cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ESP-IDF使用example_disconnect报错</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/442091668.html" title="通过HOMEKIT让ESP8266控制继电器"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-25</div><div class="title">通过HOMEKIT让ESP8266控制继电器</div></div></a></div><div><a href="/posts/3713584928.html" title="Ubuntu烧录下载时找不到USB0报错"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-28</div><div class="title">Ubuntu烧录下载时找不到USB0报错</div></div></a></div><div><a href="/posts/2449930636.html" title="ESP8266及ESP32固件生成及烧录方法"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-23</div><div class="title">ESP8266及ESP32固件生成及烧录方法</div></div></a></div><div><a href="/posts/3689554134.html" title="如何在 ESP8266 上选用合适的引脚"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-15</div><div class="title">如何在 ESP8266 上选用合适的引脚</div></div></a></div><div><a href="/posts/2171885577.html" title="乐鑫Esp8266_RTOS_SDK最新SDK_IDF编译环境搭建"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-27</div><div class="title">乐鑫Esp8266_RTOS_SDK最新SDK_IDF编译环境搭建</div></div></a></div><div><a href="/posts/1724428249.html" title="Homeassistant环境Docker配置"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-30</div><div class="title">Homeassistant环境Docker配置</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ZhaoYichen</div><div class="author-info__description">直到这一刻微笑着说话为止，我至少留下了一公升眼泪</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">376</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">539</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">219</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zml3589110"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zml3589110" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:zhaominglong_life@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%AE%9E%E7%8E%B0-WIFI-SmartConfig-%E4%B8%80%E9%94%AE%E9%85%8D%E7%BD%91%E5%8A%9F%E8%83%BD"><span class="toc-number">1.</span> <span class="toc-text">手动实现 WIFI SmartConfig 一键配网功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%B7%E5%9B%A0"><span class="toc-number">1.1.</span> <span class="toc-text">起因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E9%85%8D%E7%BD%91%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">常用的配网方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">流程实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E4%BF%AE%E6%94%B9ESP%E7%9A%84sniffer%E5%B7%A5%E7%A8%8B"><span class="toc-number">1.4.</span> <span class="toc-text">编译修改ESP的sniffer工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSID%E5%92%8CPWD%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%8D%A2%E5%B7%A5%E5%85%B7"><span class="toc-number">1.5.</span> <span class="toc-text">SSID和PWD字符串转换工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ESP%E6%8E%A5%E6%94%B6%E8%A7%A3%E6%9E%90"><span class="toc-number">1.6.</span> <span class="toc-text">ESP接收解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.7.</span> <span class="toc-text">效果实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WiFi%E4%B8%80%E9%94%AE%E9%85%8D%E7%BD%91%EF%BC%88smartconfig%EF%BC%89%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">WiFi一键配网（smartconfig）原理介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E9%85%8D%E7%BD%91%E6%96%B9%E5%BC%8F-1"><span class="toc-number">2.2.</span> <span class="toc-text">常用的配网方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SmartConfig%E9%85%8D%E7%BD%91%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">SmartConfig配网基本原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E5%85%8B%E6%9C%8D%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.4.</span> <span class="toc-text">需要克服的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A5%E6%96%87%E9%95%BF%E5%BA%A6%E4%BC%A0%E9%80%92%E4%BF%A1%E6%81%AF"><span class="toc-number">2.5.</span> <span class="toc-text">报文长度传递信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E9%80%92%E7%9A%84%E6%95%88%E7%8E%87"><span class="toc-number">2.6.</span> <span class="toc-text">传递的效率</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E6%92%AD%E9%85%8D%E7%BD%91"><span class="toc-number">2.7.</span> <span class="toc-text">多播配网</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#smartConfig-%E6%B5%85%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">smartConfig 浅析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%9F%A5%E8%AF%86%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.</span> <span class="toc-text">四、知识扩展</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#UDP-%E5%8D%95%E6%92%AD%E3%80%81%E5%B9%BF%E6%92%AD%E3%80%81%E5%A4%9A%E6%92%AD"><span class="toc-number">4.</span> <span class="toc-text">UDP 单播、广播、多播</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81UDP%E5%B9%BF%E6%92%AD"><span class="toc-number">4.1.</span> <span class="toc-text">一、UDP广播</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81UDP%E5%A4%9A%E6%92%AD"><span class="toc-number">4.2.</span> <span class="toc-text">二、UDP多播</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%A4%9A%E6%92%AD%EF%BC%88%E7%BB%84%E6%92%AD%EF%BC%89%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">4.2.1.</span> <span class="toc-text">1、多播（组播）的概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%B9%BF%E5%9F%9F%E7%BD%91%E7%9A%84%E5%A4%9A%E6%92%AD"><span class="toc-number">4.2.2.</span> <span class="toc-text">2、广域网的多播</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%A4%9A%E6%92%AD%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E7%9A%84%E6%A1%86%E6%9E%B6"><span class="toc-number">4.2.3.</span> <span class="toc-text">3、多播程序设计的框架</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UDP%E5%B9%BF%E6%92%AD%E4%B8%8E%E5%8D%95%E6%92%AD"><span class="toc-number">4.3.</span> <span class="toc-text">UDP广播与单播</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5%EF%BC%88%E4%BE%B5%E5%88%A0%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">相关链接（侵删）</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/3907184433.html" title="裸机开发环境搭建"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="裸机开发环境搭建"/></a><div class="content"><a class="title" href="/posts/3907184433.html" title="裸机开发环境搭建">裸机开发环境搭建</a><time datetime="2025-09-15T13:18:20.000Z" title="发表于 2025-09-15 21:18:20">2025-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3480903282.html" title="ESP8266无线下载器"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ESP8266无线下载器"/></a><div class="content"><a class="title" href="/posts/3480903282.html" title="ESP8266无线下载器">ESP8266无线下载器</a><time datetime="2025-09-15T13:10:20.000Z" title="发表于 2025-09-15 21:10:20">2025-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2510049814.html" title="读写SD卡"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="读写SD卡"/></a><div class="content"><a class="title" href="/posts/2510049814.html" title="读写SD卡">读写SD卡</a><time datetime="2025-09-15T13:08:20.000Z" title="发表于 2025-09-15 21:08:20">2025-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1214364109.html" title="SWD接口和通信实现"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SWD接口和通信实现"/></a><div class="content"><a class="title" href="/posts/1214364109.html" title="SWD接口和通信实现">SWD接口和通信实现</a><time datetime="2025-09-15T13:08:20.000Z" title="发表于 2025-09-15 21:08:20">2025-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1056682153.html" title="F1C100S-BOOTROM与SPL阶段"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="F1C100S-BOOTROM与SPL阶段"/></a><div class="content"><a class="title" href="/posts/1056682153.html" title="F1C100S-BOOTROM与SPL阶段">F1C100S-BOOTROM与SPL阶段</a><time datetime="2025-09-15T13:02:20.000Z" title="发表于 2025-09-15 21:02:20">2025-09-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By ZhaoYichen</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="icp连接"><img class="icp-icon" src="icp图片"><span>备案号：xxxxxx</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>