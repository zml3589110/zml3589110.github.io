<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>从零开始自制linux掌上电脑（F1C200S) | 赵逸尘个人博客</title><meta name="keywords" content="全志,F1C200S,开发板,Linux,BOOTROM,SPL,启动流程"><meta name="author" content="ZhaoYichen"><meta name="copyright" content="ZhaoYichen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="从零开始自制linux掌上电脑（F1C200S)详细教程-这个特别详细">
<meta property="og:type" content="article">
<meta property="og:title" content="从零开始自制linux掌上电脑（F1C200S)">
<meta property="og:url" content="https://zml3589110.github.io/posts/2887556754.html">
<meta property="og:site_name" content="赵逸尘个人博客">
<meta property="og:description" content="从零开始自制linux掌上电脑（F1C200S)详细教程-这个特别详细">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg">
<meta property="article:published_time" content="2025-09-18T03:49:20.000Z">
<meta property="article:modified_time" content="2025-09-19T08:24:03.338Z">
<meta property="article:author" content="ZhaoYichen">
<meta property="article:tag" content="全志">
<meta property="article:tag" content="F1C200S">
<meta property="article:tag" content="开发板">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="BOOTROM">
<meta property="article:tag" content="SPL">
<meta property="article:tag" content="启动流程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" href="/img/favicon_1.png"><link rel="canonical" href="https://zml3589110.github.io/posts/2887556754"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: ZhaoYichen","link":"链接: ","source":"来源: 赵逸尘个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '从零开始自制linux掌上电脑（F1C200S)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-19 16:24:03'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="赵逸尘个人博客" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">378</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">540</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">219</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><i class="fa-fw fas fa-random"></i><span> Random | 随机文章</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">赵逸尘个人博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><i class="fa-fw fas fa-random"></i><span> Random | 随机文章</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">从零开始自制linux掌上电脑（F1C200S)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-18T03:49:20.000Z" title="发表于 2025-09-18 11:49:20">2025-09-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-19T08:24:03.338Z" title="更新于 2025-09-19 16:24:03">2025-09-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/F1C200S/">F1C200S</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">49.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>200分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="从零开始自制linux掌上电脑（F1C200S)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="GPIO-编号规则"><a href="#GPIO-编号规则" class="headerlink" title="GPIO 编号规则"></a>GPIO 编号规则</h1><p>F1C200s 有 5 个 PIO（平台 I&#x2F;O）端口组，分别标记为 PIO0、PIO1、PIO2、PIO3 和 PIO4。<br>每个 PIO 端口组包含了 16 个 GPIO 管脚，分别标记为 PIOx.0 到 PIOx.15，其中 x 为 PIO 端口组的编号，从 0 到 4。</p>
<h1 id="硬件制作"><a href="#硬件制作" class="headerlink" title="硬件制作"></a>硬件制作</h1><h2 id="一、工作环境及项目简介"><a href="#一、工作环境及项目简介" class="headerlink" title="一、工作环境及项目简介"></a>一、工作环境及项目简介</h2><p><strong>立创EDA：</strong>硬件原理图及PCB绘制。</p>
<p><strong>全志F1C200S：</strong>F1C100S内置32MB DDR1内存，F1C200S内置64MB DDR1内存。</p>
<p><strong>原理图：</strong>参考开源项目，详见<a target="_blank" rel="noopener" href="https://whycan.com/t_75.html">墨云</a>， 详见<a target="_blank" rel="noopener" href="https://github.com/peng-zhihui/Planck-Pi">peng-zhihui</a>。</p>
<p><strong>核心板：</strong>四层。</p>
<p><strong>底板：</strong>两层。</p>
<p><strong>工具：</strong>烙铁、热风枪、焊锡膏、洗板水、各种电子元器件。</p>
<h2 id="二、原理图设计"><a href="#二、原理图设计" class="headerlink" title="二、原理图设计"></a>二、原理图设计</h2><h3 id="1、核心板"><a href="#1、核心板" class="headerlink" title="1、核心板"></a>1、核心板</h3><h4 id="🍎-电源电路"><a href="#🍎-电源电路" class="headerlink" title="🍎 电源电路"></a>🍎 电源电路</h4><p>在F1C200s的<strong>datasheet Allwinner_F1C200s_Datasheet_V1_1</strong>中可以得到推荐的运行环境，主要参考Typ，也就是典型值：</p>
<img src="/posts/undefined/2d9430c5289eeee40ca4d356efe50d7c.png" class="" title="img">

<p>因此我们需要实现的电压有四个：<strong>1.1V、2.5V、3.0V、3.3V。</strong></p>
<p>使用<strong>SY8088AAC SOT-23-5</strong>同步降压DC-DC稳压器，设置其外围的电阻搭配调整其输出电压（<strong>Vout &#x3D; 0.6 * (1+Ra&#x2F;Rb)</strong> ），使用其实现1.1V、2.5V、3.3V三个电压需求：</p>
<img src="/posts/undefined/1b86745c004bfba59c4f01309b4f7349.png" class="" title="img">

<p>使用<strong>XC6206P302MR-SOT23</strong>的封装方式，输入电压5V ，输出需求电压3.0V：</p>
<img src="/posts/undefined/70782d5c0cd4d7cf50adeda7b911fe83.png" class="" title="img">

<p>电路设计如下图所示，根据墨云所说电感选用<strong>2.2uH功率电感，电感额定电流为2A。</strong>此处的5V电源来自底板的USB供电。下面电阻的搭配方式可以进行调节，只要满足输出的电压为需求电压即可</p>
<img src="/posts/undefined/827611cbbd62a080c721ab825f318b39.png" class="" title="img">

<img src="/posts/undefined/0f7b68ed8dcc4d86d72cefdf14503879.png" class="" title="img">

<h4 id="🍎-板对板连接器"><a href="#🍎-板对板连接器" class="headerlink" title="🍎 板对板连接器"></a>🍎 板对板连接器</h4><p>板对板连接器选用可靠性较高的排针排母对。</p>
<img src="/posts/undefined/5e63267b6b7b27651de3092a5e1f9a28.png" class="" title="img">

<h4 id="🍎-复位电路"><a href="#🍎-复位电路" class="headerlink" title="🍎 复位电路"></a>🍎 复位电路</h4><p>复位电路比较简单，不再赘述。</p>
<img src="/posts/undefined/0d0b698979c70fa4661a3cb6d39202a6.png" class="" title="img">

<h4 id="🍎-晶振电路"><a href="#🍎-晶振电路" class="headerlink" title="🍎 晶振电路"></a>🍎 晶振电路</h4><p>晶振采用24MHz无源晶振，两个15pF电容滤波。</p>
<img src="/posts/undefined/ad8dc4a3fd879786a00bef677ff945d4.png" class="" title="img">



<h4 id="🍎-主控电路"><a href="#🍎-主控电路" class="headerlink" title="🍎 主控电路"></a>🍎 主控电路</h4><p>主控电路主要参考墨云和稚辉君，相关链接见上方。主要从主控F1C200s中引出TF卡引脚（本文选用的系统加载电路）、音频、晶振、串口、复位、SPI、OTG、图像、一些GPIO等等。</p>
<img src="/posts/undefined/799a4d55fb7441679ea0fa068b094d5c.png" class="" title="img">

<h3 id="2、底板"><a href="#2、底板" class="headerlink" title="2、底板"></a>2、底板</h3><h4 id="🍍-串口转USB电路"><a href="#🍍-串口转USB电路" class="headerlink" title="🍍 串口转USB电路"></a>🍍 串口转USB电路</h4><p>选用CH340E芯片，注意某宝的芯片<strong>可能是拆机、复新芯片，</strong>如果串口通信失败，考虑芯片问题。至于下面的接线，墨云提到：<strong>“根据CH340E官方的原理图，当VCC接入5V的时候，V3 需要接一个100nf的电容，但是此处在V3直接接入5V，也可以工作。”</strong>，因此本文选择将VCC接入5V，将V3接入3.3V。</p>
<img src="/posts/undefined/28e07909febda8f33861f0f65a3021c1.png" class="" title="img">

<h4 id="🍍-TF卡电路"><a href="#🍍-TF卡电路" class="headerlink" title="🍍 TF卡电路"></a>🍍 TF卡电路</h4><p>TF卡作为本系统唯一的系统加载方式，具体接线方式如下所示，TF卡为自弹minTF卡，只要PCB和你的硬件匹配，其他全部相同。</p>
<img src="/posts/undefined/92c57b2923b250a9507fa07a958906dd.png" class="" title="img">

<p>🍍 <strong>USB扩展电路</strong></p>
<p>FE8.1（1扩4）是一个非常紧凑的高速4端口USB集线器控制器。此处我们仅使用其中两个，也就是将一个USB扩展为两个。</p>
<img src="/posts/undefined/c6edd905cd4bb890de290ef4288ca35c.png" class="" title="img">

<h4 id="🍍-WIFI电路"><a href="#🍍-WIFI电路" class="headerlink" title="🍍 WIFI电路"></a>🍍 WIFI电路</h4><p>主要参考墨云的接线方式，暂未进行验证。</p>
<img src="/posts/undefined/d39a092e5c8b936de5671ed271595b7e.png" class="" title="img">

<h4 id="🍍-TFT屏幕"><a href="#🍍-TFT屏幕" class="headerlink" title="🍍 TFT屏幕"></a>🍍 TFT屏幕</h4><p>1.14英寸的IPS屏幕，某宝十几块钱，我这里加了一个接线端子，因为我留出了4.3寸屏幕（正点原子）的接口，防止干扰，我加了接线端子进行选择。</p>
<img src="/posts/undefined/f68a36b58f4f313d8e6c0fc8633a92ed.png" class="" title="img">

<h4 id="🍍-音频"><a href="#🍍-音频" class="headerlink" title="🍍 音频"></a>🍍 音频</h4><p>在墨云的基础上，结合稚辉君，我添加了咪头和3.5mm耳机接口。</p>
<img src="/posts/undefined/6234497a6864f15eefbbc9114858c6e4.png" class="" title="img">

<h4 id="🍍-板对板连接器"><a href="#🍍-板对板连接器" class="headerlink" title="🍍 板对板连接器"></a>🍍 板对板连接器</h4><p>和核心版的板对板连接器相对应，注意不要搞反了，否则可能导致短路，板对板连接器管脚分布和PCB布局有关，因为我未考虑到PCB布局，导致后面的布局较为困难，虽然核心板采用四层板，底板采用两层板，但布线还是花了很大功夫。</p>
<img src="/posts/undefined/d71bd954a76da65a43c1aa710018bd1b.png" class="" title="img">

<h4 id="🍍-40Pin4-3寸屏幕"><a href="#🍍-40Pin4-3寸屏幕" class="headerlink" title="🍍 40Pin4.3寸屏幕"></a>🍍 40Pin4.3寸屏幕</h4><p>屏幕为4.3寸正点原子屏幕，采用FPC连接，接线端子管脚间距为0.5mm，由于我的焊接设备原因，焊接较为麻烦。</p>
<img src="/posts/undefined/775906117b7296dcfb39c7aa0fc623d6.png" class="" title="img">

<h2 id="三、PCB展示"><a href="#三、PCB展示" class="headerlink" title="三、PCB展示"></a>三、PCB展示</h2><p>Wood是我做的标志，之所以选用排针连接底板和核心板，是因为排针相较于金手指和BTB来说，可以重复拔插，更便于将一个核心板应用到其他底板上。</p>
<img src="/posts/undefined/42d2a04b4746c7c9e37e1a70f7d8d4b4.png" class="" title="img">**核心板（四层，挺漂亮哈）**

<img src="/posts/undefined/acddb7024a7548b4413b8a39437aa308.png" class="" title="img">**底板**

<h2 id="四、实物展示"><a href="#四、实物展示" class="headerlink" title="四、实物展示"></a>四、实物展示</h2><img src="/posts/undefined/fa7f9a6ab4afe90e944ef6b3aa852e2c.png" class="" title="img">**核心板**

<img src="/posts/undefined/3f103fc619624827174a8cc0cd1ceeb3.png" class="" title="img">**底板**

<img src="/posts/undefined/b0b9fbcdbc90441cd4c8401120a75269.png" class="" title="img">**焊接完成组装实物**


<h1 id="uboot移植"><a href="#uboot移植" class="headerlink" title="uboot移植"></a>uboot移植</h1><h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><blockquote>
<p>在移植Linux之前我们需要先移植一个bootloader代码，这个bootloader代码用于启动Linux内核，<strong>bootloader有很多，常用的就是 uboot。</strong>移植好uboot以后再移植Linux内核，移植完Linux内核以后Linux还不能正常启动，还需要再移植一个根文件系统(rootfs)，根文件系统里面包含了一些最常用的命令和文件。所以<strong><em>*uboot、Linux kernel 和 rootfs*</em> 这三者一起构成了一个完整的Linux系统</strong>，一个可以正常使用、功能完善的 Linux 系统。</p>
<p><strong>– 来自正点原子嵌入式Linux驱动开发指南。</strong></p>
</blockquote>
<p>Linux系统要启动就必须需要一个bootloader程序，<strong>也就说芯片上电以后先运行一段bootloader程序。这段 bootloader 程序会先初始化DDR等外设，然后将 Linux 内核从 flash(NAND，NOR FLASH，SD，MMC等)拷贝到DDR中，最后启动Linux内核。</strong>下面我们首先进行uboot的移植，或者说适配。</p>
<hr>
<h2 id="二、F1C200s上电启动顺序"><a href="#二、F1C200s上电启动顺序" class="headerlink" title="二、F1C200s上电启动顺序"></a>二、F1C200s上电启动顺序</h2><p>在进行uboot移植之前，需要了解<strong>F1C200s芯片上电后启动的顺序，</strong>避免重复造轮子，我们直接根据<a target="_blank" rel="noopener" href="https://whycan.com/t_1746.html">F1C100s启动时搜索SPI Flash的顺序？</a>了解到启动顺序如下，F1C200s同F1C100s。</p>
<blockquote>
<p>\1. 上电后, f1c100s内部 BROM (芯片内置，无法擦除) 启动,<br>\2. 首先检查 SD0 有没有插卡, 如果有插卡就读卡 8k偏移数据，是否是合法的启动数据, 如果是BROM 引导结束, 否则进入下一步<br>\3. 检测SPI0 NOR FLASH(W25QXXX, MX25LXXX) 是否存在, 是否有合法的启动数据, 如果是BROM 引导结束, 否则进入下一步<br>\4. 检测SPI0 NAND FLASH 是否存在, 是否有合法的启动数据, 如果是BROM 引导结束, 否则进入下一步<br>\5. 因为找不到任何可以引导的介质， 系统进入usb fel 模式， 可以用USB烧录了。</p>
</blockquote>
<p><strong>上电之后，F1C200s芯片内部的BROM启动检查到SD卡，读取8k偏移数据。</strong></p>
<blockquote>
<p>注意：这里的<code>bs=1024 seek=8</code>是添加了8192字节的偏移，之所以要加8K偏移是因为FSBL也就是bootROM里面硬写死了会从设备的8K地址处加载SPL，然后进入uboot。因此上面烧写的时候，指定的偏移地址一定是相对于储存设备硬件的偏移，而不是相对于分区的偏移！</p>
<p>来自：<a target="_blank" rel="noopener" href="https://github.com/peng-zhihui/Planck-Pi">peng-zhihui&#x2F;Planck-Pi: Super TINY &amp; Low-cost Linux Develop-Kit Based On F1C200s.</a></p>
</blockquote>
<hr>
<h2 id="三、前期准备"><a href="#三、前期准备" class="headerlink" title="三、前期准备"></a>三、前期准备</h2><p><strong>虚拟机VmwareWorkstation安装；</strong></p>
<p><strong>ubuntu16.04系统安装。</strong></p>
<hr>
<h2 id="四、新建用户"><a href="#四、新建用户" class="headerlink" title="四、新建用户"></a>四、新建用户</h2><p>如果你已经再当前用户安装了一些其他的编译器，那么最好创建一个<strong>新的账户</strong>，避免一些命令可能出现干扰，或者说与其他项目隔离开，具体操作如下，比较简单，看图操作即可。</p>
<img src="/posts/undefined/c70236345acc7b5dec031062c915dcdc.png" class="" title="img">

<img src="/posts/undefined/ab18a8cba47d153dba64c7efae2edf0c.png" class="" title="img">

<img src="/posts/undefined/81aa4470e3a91dfd81c1910cf8109302.png" class="" title="img">

<img src="/posts/undefined/158f58337ef05c4add45859e667916c7.png" class="" title="img">

<hr>
<h2 id="五、交叉编译环境配置"><a href="#五、交叉编译环境配置" class="headerlink" title="五、交叉编译环境配置"></a>五、交叉编译环境配置</h2><p>在路径 <em><strong>*“ linaro release*</strong></em><em><strong>*-&gt;compoments-&gt;toolchain-&gt;binaries-&gt;7.2-2017.11-&gt;arm-linux-gnueabi-&gt;gcc-linaro-7.2.1-2017.11-x86_64_arm-linux-gnueabi.tar.xz ”*</strong></em> 中下载对应的交叉编译器，记住是release版本，不是snapshots版本。<strong>（Snapshot版本代表不稳定、尚处于开发中的版本，快照版本。Release版本则代表稳定的版本，发行版本。）</strong>具体链接如下：</p>
<p><a target="_blank" rel="noopener" href="https://releases.linaro.org/components/toolchain/binaries/7.2-2017.11/arm-linux-gnueabi/">Linaro Releases<img src="/posts/undefined/039a84e0f347bb45be0e5dcf71ea800a.png" class="" title="img">https://releases.linaro.org/components/toolchain/binaries/7.2-2017.11/arm-linux-gnueabi/</a><strong>下载完成，使用如下面命令解压缩：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -vxf gcc-linaro-7.2.1-2017.11-x86_64_arm-linux-gnueabi.tar.xz </span><br></pre></td></tr></table></figure>

<p><strong>将解压的文件复制到&#x2F;usr&#x2F;local&#x2F;arm&#x2F;中，操作命令如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -rf &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;gcc-linaro-7.2.1-2017.11-x86_64_arm-linux-gnueabi .&#x2F;</span><br></pre></td></tr></table></figure>

<p>**然后添加该*<em>交叉编译器的环境变量，*<em>只有这样编译器才能在任何目录或者任何位置打开的终端中执行，打开~&#x2F;.bashrc文件 *</em>(修改<code>.bashrc文件</code>，只是针对某一个特定的用户；修改<code>/etc/profile文件</code>，它是针对于所有的用户)*<em>，写入以下内容：</em></em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;arm&#x2F;gcc-linaro-7.2.1-2017.11-x86_64_arm-linux-gnueabi&#x2F;bin</span><br></pre></td></tr></table></figure>

<p><strong>使环境变量生效：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~&#x2F;.bashrc </span><br></pre></td></tr></table></figure>

<p><strong>验证是否成功：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabi-gcc -v</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/5a0b5ac09e8bb21ede25a4d3785c6744.png" class="" title="img">

<hr>
<h2 id="六、uboot简介"><a href="#六、uboot简介" class="headerlink" title="六、uboot简介"></a>六、uboot简介</h2><p>bootloader主要的工作就是启动 Linux 内核，<strong>bootloader和 Linux内核的关系就跟PC上的BIOS和 Windows的关系一样</strong>****，**bootloader就相当于BIOS。**常见的bootloader有 U-Boot、vivi、RedBoot 等等。</p>
<p>本文使用<strong>uboot</strong>作为系统的bootloader，它的全称是**”Universal Boot Loader”<strong>，意为</strong>“通用引导加载程序”。<strong>uboot是一种裸机程序，可以视为是一个</strong>汇集了多种裸机功能的综合示例。**目前的uboot已经支持液晶显示屏、网络连接、USB等高级功能。</p>
<p><strong>uboot官方</strong>会维护uboot源码，也是最原汁原味的源码，但是官方提供的代码是供<strong>半导体厂商</strong>，也就是生产F1C200s的厂商使用的，他们会维护一个<strong>定制版本的uboot，</strong>但是，很遗憾，全志并没有将资料公开。<strong>**（注：后来发现，<a target="_blank" rel="noopener" href="https://github.com/allwinner-zh/bootloader">这里</a>有全志的uboot，不知道这个是否是官方的网站，但已经好久没有更新）*<em><strong>由于网上关于F1C200s的uboot从零开始的开发资料几乎没有，此处我们使用</strong>荔枝派</em>*的uboot启动Linux。</strong>（后面有时间再完善，欢迎大佬加群或评论区指导）**</p>
<hr>
<h2 id="七、uboot移植"><a href="#七、uboot移植" class="headerlink" title="七、uboot移植"></a><strong>七、uboot移植</strong></h2><h4 id="🍏-uboot下载"><a href="#🍏-uboot下载" class="headerlink" title="🍏 uboot下载"></a><strong>🍏 uboot下载</strong></h4><p>**首先在github上*<em>下载Lichee-Pi提供的uboot，*<em>当然，前提是你的虚拟机能访问网络，如果不会配置，参看我左侧专栏虚拟机中的文章即可。或者直接在Windows中<a target="_blank" rel="noopener" href="https://github.com/Lichee-Pi/u-boot">github</a>上下载，然后传到ubuntu中解压。</em></em> </p>
<img src="/posts/undefined/ba3d3c29db1402f9d167aa44056565eb.png" class="" title="img">

<p>uboot下载完成后，打开文件夹，<strong>uboot文件内容</strong>如下图所示：</p>
<img src="/posts/undefined/5decc9a2b753263ee8f79eb86e916490.png" class="" title="img">

<h4 id="🍏-uboot默认配置"><a href="#🍏-uboot默认配置" class="headerlink" title="🍏 uboot默认配置"></a><strong>🍏</strong> uboot默认配置</h4><p>对于同一款芯片，比如F1C200s，可能有<strong>不同的外设</strong>，uboot需要<strong>初始化的内容也不相同</strong>，因此需要选用uboot中的某些配置，去初始化各个外设，在uboot中的configs文件夹中存储着一些配置“套餐”，就是已经固定配置某些外设的<strong>**默认配置文件**，**一旦进行编译，uboot会</strong>根据这个配置文件进行配置。**</p>
<img src="/posts/undefined/d4d61856f45cecf40476ac0d04cec742.png" class="" title="img">

<p>如上图所示，为uboot的<strong>configs目录</strong>下的两个荔枝派的配置文件，第一个<strong>licheepi_nono_defconfig</strong>   是针对<strong>**TF卡*<em><strong>的配置文件，第二个</strong>licheepi_nano_spiflash_defconfig</em>*是针对</strong>flash<strong>的启动文件，显然我们需要</strong>选择第一个配置文件**编译uboot，因为我们只有TF卡一种存储介质，没有flash。下面是编译指令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make ARCH&#x3D;arm CROSS_COMPILE&#x3D;arm-linux-gnueabi- licheepi_nano_defconfig</span><br></pre></td></tr></table></figure>

<p>为了避免使用类似于上方的<strong>繁琐编译指令，</strong>在uboot根目录Makfile中加入如下内容：</p>
<img src="/posts/undefined/dca8b0ceb6b83a231f786574a63afadb.png" class="" title="img">

<p>这样我们可以通过以下简洁的代码进行uboot配置： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 进入u-boot目录</span><br><span class="line">cd u-boot&#x2F;</span><br><span class="line"></span><br><span class="line"># 加载配置文件</span><br><span class="line">make licheepi_nano_defconfig</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/9c9ae54d1123928cd1f4bbbe61c6b6df.png" class="" title="img">

<p> 经过以上操作，默认配置文件<strong>licheepi_nano_deconfig</strong>已经写入到，**&#x2F;uboot&#x2F;.config文件<strong>中，这是根据默认配置文件，生成的uboot的</strong>最终配置文件**，这个配置文件记录了所有配置选项的宏开关，我们可以通过宏开关对其进行修改。</p>
<p><strong>注意：硬件中USB T口连接uart0，而荔枝派默认初始化uart0，因此无需修改。</strong></p>
<h4 id="🍏-uboot图形界面配置"><a href="#🍏-uboot图形界面配置" class="headerlink" title="🍏 uboot图形界面配置"></a><strong>🍏 uboot图形界面配置</strong></h4><p>使用<strong>make menuconfig</strong>命令进行图形界面配置uboot。</p>
<ol>
<li>bootcmd，主要用于描述控制Linux内核文件以及其他描述文件加载到内存中位置以及启动Linux内核系统等</li>
<li>bootargs，用于配制文件系统、串口信息等。</li>
</ol>
<p><strong>Enable boot arguments</strong> 选项上点击空格，弹出<strong>Boot arguments</strong>选项，选中回车输入以下内容后回车保存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console&#x3D;ttyS0,115200 panic&#x3D;5 rootwait root&#x3D;&#x2F;dev&#x2F;mmcblk0p2 earlyprintk rw</span><br></pre></td></tr></table></figure>

<p>同样的操作输入<strong>bootcmd</strong>的值，输入完成后如下图所示，有关<strong>bootargs和bootcmd</strong>值的含义，后序文章进行分析，这里不做解释。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load mmc 0:1 0x80008000 zImage;load mmc 0:1 0x80c08000 suniv-f1c100s-licheepi-nano.dtb;bootz 0x80008000 - 0x80c08000;</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/17b3b46aaae4fefaf43d314c6c1580e5.png" class="" title="img">

<h4 id="🍏-uboot编译"><a href="#🍏-uboot编译" class="headerlink" title="🍏 uboot编译"></a><strong>🍏</strong> uboot编译</h4><p>在进行编译之前需要在Ubuntu 中安装 <strong>ncurses 库</strong>，否则可能编译会报错，安装命令如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libncurses5-dev</span><br></pre></td></tr></table></figure>

<p>使用<strong>make -j2</strong>进行编译，其中-j2代表处理器核心数。编译完成，在根目录下找到<strong>u-boot-sunxi-with-spl.bin文件，</strong>该文件为最终烧录文件。</p>
<h4 id="🍏-烧录bin文件"><a href="#🍏-烧录bin文件" class="headerlink" title="🍏 烧录bin文件"></a><strong>🍏</strong> 烧录bin文件</h4><p>只要将<strong>u-boot-sunxi-with-spl.bin</strong>烧录到tf卡的<strong>8k偏移地址处</strong>就可以了，至于为什么，上面的引用已经解释清楚了。将准备号的TF卡插入读卡器，使用如下<strong>块搬移命令</strong>进行烧写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dd if&#x3D;u-boot-sunxi-with-spl.bin of&#x3D;&#x2F;dev&#x2F;sdb bs&#x3D;1024 seek&#x3D;8</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>if</strong>  文件名：输入文件名，缺省为标准输入。即指定源文件。&lt; if&#x3D;input file &gt;</p>
<p><strong>of</strong>  文件名：输出文件名，缺省为标准输出。即指定目的文件。&lt; of&#x3D;output file &gt;</p>
<p><strong>bs</strong> bytes：同时设置读入&#x2F;输出的块大小为bytes个字节。</p>
<p><strong>seek</strong> blocks：从输出文件开头跳过blocks个块后再开始复制。</p>
<p>这里的输出文件(of)为主机电脑的&#x2F;dev&#x2F;sdb文件，也就是插入的读卡器代表的TF卡。</p>
</blockquote>
<p> 烧录完成，如下图所示，然后弹出读卡器之后再拔出，否则可能损坏读卡器。<img src="/posts/undefined/65702ac2a6ae73522cd590802f6d7164.png" class="" title="img"></p>
<hr>
<h2 id="八、uboot启动测试"><a href="#八、uboot启动测试" class="headerlink" title="八、uboot启动测试"></a>八、uboot启动测试</h2><p>将开发板使用<strong>数据线</strong>与电脑相连，打开<strong>串口调试</strong>工具，根据<strong>bootargs参数</strong>设置串口通信参数：</p>
<img src="/posts/undefined/af0b325e42802fc3d6755ec8888726ab.png" class="" title="img">

<p> 正常启动，窗串口调试工具为<strong>SecureCRT，</strong>选中端口后，波特率设置为<strong>115200：</strong></p>
<img src="/posts/undefined/0569a1909e121f7e1e9b29cd9b24ae88.png" class="" title="img">

<blockquote>
<p>墨云：</p>
<p>因为在你插入USB通电的时候开发板就已经启动了，所以当你打开串口连接的时候可能<strong>未必会看到信息，</strong>所以按一下<strong>重启键</strong>，就可以看到如下的输出信息了，这就是我们的u-boot，执行到u-boot计数完成后会产生错误，那是因为我们还没有进行系统内核的移植，所以默认就会进入u-boot命令模式。</p>
</blockquote>
<p>点击复位按钮之后，在3秒之内（我设置的5秒）<strong>点击回车</strong>即可进入<strong>uboot命令模式</strong>，在 <strong>uboot命令模式</strong>输入<strong>“print”</strong>来查看环境变量 <strong>bootargs和bootcmd的值</strong>如下，和我们设置的相同，表示uboot启动成功！</p>
<img src="/posts/undefined/05fa8bba2156590e7ec8adbcff93148a.png" class="" title="img">

<p> 至此，完成uboot移植全部内容，然而并没有像我想的那样，从零开始，按照官方的uboot一步一步自己移植，谁让我是个小白呢。</p>
<hr>
<h1 id="内核移植"><a href="#内核移植" class="headerlink" title="内核移植"></a>内核移植</h1><h2 id="一、bootloader、kernel、rootfs联系"><a href="#一、bootloader、kernel、rootfs联系" class="headerlink" title="一、bootloader、kernel、rootfs联系"></a>一、bootloader、kernel、rootfs联系</h2><p>kernel可以理解为一个<strong>庞大的裸机程序</strong>，和uboot以及其他比如点灯类似的裸机程序没有本质区别，只是kernel分为<strong>用户态和内核态</strong>，内存和设备操作与裸机程序不同。kernel是<strong>最底层</strong>，负责各种外设硬件的驱动，kernel类似于<strong>黑盒子</strong>，从外面只能看到接口，无法看到具体功能是如何实现的，内核初始化提供的接口后，将<strong>控制权</strong>通过<strong>init程序</strong>交给根文件系统。</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/489819324#:~:text=%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%98%AF%E6%8E%A7%E5%88%B6,%E7%A9%BA%E9%97%B4%E7%9A%84%E4%B8%80%E4%B8%AA%E6%A1%A5%E6%A2%81%E3%80%82">详见：一文讲解Linux内核中根文件系统挂载流程 - 知乎</a></p>
<hr>
<h2 id="二、内核移植"><a href="#二、内核移植" class="headerlink" title="二、内核移植"></a>二、内核移植</h2><h3 id="1-内核源码获取"><a href="#1-内核源码获取" class="headerlink" title="1. 内核源码获取"></a>1. 内核源码获取</h3><p>下载<a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/refs/tags?h=v5.10.161">Linux5.7.1源码</a> ，下载后完成后，将代码复制到Ubuntu新建的用户中并解压。</p>
<p>或者在<a target="_blank" rel="noopener" href="https://mirror.bjtu.edu.cn/kernel/linux/kernel/v5.x/">国内镜像网站</a> 下载，速度相比于官网快很多很多。</p>
<h3 id="2-内核配置与编译"><a href="#2-内核配置与编译" class="headerlink" title="2. 内核配置与编译"></a>2. 内核配置与编译</h3><h4 id="🍍-基础配置与编译"><a href="#🍍-基础配置与编译" class="headerlink" title="🍍 基础配置与编译"></a>🍍 基础配置与编译</h4><p>解压完成后，使用<strong>VScode</strong>打开linux源码，同uboot编译前一样进行配置，首先在<strong>顶层Makfile</strong>中指定<strong>架构和交叉编译工具。*<em>注意：arm必须是小写，必须！*</em></strong></p>
<img src="/posts/undefined/1ce48567fc7491d4ad1f80f6cfd23257.png" class="" title="img">

<p>在uboot移植中，我们使用<strong>licheepi_nano_defconfig配置uboot，</strong>以识别开发板（不同开发板拥有不同的外设），同样，Linux内核也需要进行配置，在墨云对Linux内核进行移植时，提到：</p>
<blockquote>
<p>进入内核源码中的<strong>arch&#x2F;arm&#x2F;configs</strong>目录中，可以看到有很多开发板的配置文件，其中<strong>sunxi_defconfig</strong>是全志的配置文件，但是该配置文件<strong>非常不全</strong>，需要额外配置大量的选项，一般选项多大上千个，这里先使用**<a target="_blank" rel="noopener" href="https://files.cnblogs.com/files/twzy/linux-licheepi_nano_defconfig.zip">licheepi_nano的配置文件。</a>**</p>
</blockquote>
<p>因此，同样，作为新手来讲，只能使用<strong>荔枝派的配置文件，</strong>下载文件后放到<strong>arch&#x2F;arm&#x2F;configs</strong>文件夹中，在根目录使用以下命令配置Linux内核：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make linux-licheepi_nano_defconfig</span><br></pre></td></tr></table></figure>

<p>可能会报错：</p>
<img src="/posts/undefined/0334512651d95c7d3c0eaab704a89509.png" class="" title="img">

<img src="/posts/undefined/9e599b56ec9c8c2633f1a165e05bd1e0.png" class="" title="img">

<p> 使用如下命令安装组件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install flex</span><br><span class="line">sudo apt-get install bison -y</span><br></pre></td></tr></table></figure>

<p>如果出现以下错误，考虑更换<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27979907/article/details/107974738">镜像源，</a>注意一定要<strong>按照自己的Ubuntu版本</strong>选择对应的源，最好更新为<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/">最新的清华源：</a></p>
<img src="/posts/undefined/6fb7fae25e1841d6ee20d7ea70054910.png" class="" title="img">

<p>使用<strong>make</strong>命令编译，经过漫长的等待后，在 <strong>arch&#x2F;arm&#x2F;boot</strong>目录下生成内核文件：<strong>zImage，</strong>在<strong>arch&#x2F;arm&#x2F;boot&#x2F;dts</strong>目录下设备树文件：<strong>suniv-f1c100s-licheepi-nano.dtb。</strong></p>
<p>如果出现以下错误，使用<strong>sudo apt install libssl-dev</strong>命令安装对应缺失库文件即可。</p>
<img src="/posts/undefined/6c7731469a92e90d14dc91683b32c79c.png" class="" title="img">

<h4 id="🍍-TF卡分区"><a href="#🍍-TF卡分区" class="headerlink" title="🍍 TF卡分区"></a>🍍 TF卡分区</h4><p>uboot移植的时候<strong>**bootcmd*<em><strong>变量记录了</strong>内核文件（zImage）</em>*和</strong>**设备树（.dtb文件）*<em><strong>的存放位置，那么现在我们就要准备好TF卡的分区，一旦编译出内核文件和设备树文件，就可以放到TF卡的</strong>指定位置</em>*，启动Linux内核。</p>
<img src="/posts/undefined/c62958a8be622b4a937e3e253d5278c7.png" class="" title="img">

<p>我们需要将TF卡分区如下，其中uboot只能识别FAT16格式，EXT4格式为Linux内核识别格式。<strong>注意：一定要把上面图片中的分区删除，否则无法识别到启动文件（zImage、.dtb）。</strong></p>
<table>
<thead>
<tr>
<th><strong>分区</strong></th>
<th><strong>分区一</strong></th>
<th><strong>分区二</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>名称</strong></td>
<td><strong>kernel</strong></td>
<td><strong>rootfs</strong></td>
</tr>
<tr>
<td><strong>分区格式</strong></td>
<td><strong>FAT16</strong></td>
<td><strong>EXT4</strong></td>
</tr>
<tr>
<td><strong>大小</strong></td>
<td><strong>32M（可以随意填写)</strong></td>
<td><strong>剩余空间</strong></td>
</tr>
</tbody></table>
<p>TF卡配置完成如下图所示，注意我的TF卡是8G容量。</p>
<img src="/posts/undefined/71debed3f21e7eaabe0a8cc53fd97620.png" class="" title="img">

<p>注意需要给uboot<strong>预留1M</strong>的空间，在【之前的空余空间】选择1M即可，在上面的可视化分区中无法看到这个预留空间。</p>
<h4 id="🍍-内核烧录"><a href="#🍍-内核烧录" class="headerlink" title="🍍 内核烧录"></a>🍍 内核烧录</h4><p>将上面编译产生的<strong>zImage、suniv-f1c100s-licheepi-nano.dtb</strong>两个文件拷贝到<strong>KERNEL分区。</strong>将TF卡插好之后上电，打开<strong>串口调试，</strong>按下复位按键，等待uboot启动，5秒倒计时结束，读取两个文件，启动Linux内核。至此，Linux内核移植完成，下一步是Linux根文件系统（rootfs）。</p>
<img src="/posts/undefined/39d8a10735492e012f0f5ca0e8985ee5.png" class="" title="img">

<hr>
<h1 id="根文件系统"><a href="#根文件系统" class="headerlink" title="根文件系统"></a>根文件系统</h1><h2 id="一、根文件系统介绍"><a href="#一、根文件系统介绍" class="headerlink" title="一、根文件系统介绍"></a>一、根文件系统介绍</h2><blockquote>
<p>文件系统是对一个<strong>存储设备</strong>上的数据和元数据进行<strong>组织的机制</strong>，这种机制有利于<strong>用户和操作系统的交互。</strong>在Linux没有文件系统的话，用户和操作系统的交互也就断开了。</p>
</blockquote>
<blockquote>
<p>Unix<strong>没有盘符</strong>的概念，要求自己的文件系统是<strong>单一的一棵树</strong>。直接挂载在整棵树根上的那个盘里面的文件系统，就是<strong>根文件系统。</strong></p>
</blockquote>
<blockquote>
<p>文件系统不是指某一个<strong>文件系统类型，</strong>而是指任何可以将文件目录组织成<strong>特定系统所需结构</strong>的文件系统，然后把它挂载在系统的<strong>根</strong>上。</p>
</blockquote>
<p>Linux中的根文件系统像是一个<strong>文件夹管理系统，</strong>或者说像是一本书的<strong>目录，</strong>在某种意义上讲，根文件系统就是一个文件夹，只不过是这是一个特殊的文件夹，在这个目录里面会有很多的子目录，如下图所示。</p>
<img src="/posts/undefined/38bf130a320c2fede1942831de9cfdc1.png" class="" title="img">

<img src="/posts/undefined/bf9d263d7c59f3b1d9d8925b7394db8f.png" class="" title="img">

<p>下面是虚拟机中<strong>Ubuntu系统</strong>的根文件系统，根文件系统的目录名字为 <strong>‘&#x2F;’</strong> ，也就是一个<strong>斜杠，</strong>各个目录的功能在下面的表格中做了详细介绍。</p>
<img src="/posts/undefined/63ec775ad71f6331f5f2b305fa5528b5.png" class="" title="img">

<table>
<thead>
<tr>
<th align="left">Item</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>&#x2F; (root filesystem)</strong></td>
<td align="left">根文件系统是文件系统的最高级别目录。在其他文件系统被挂载之前，它必须包含启动Linux系统所需的所有文件。它必须包括启动其余文件系统所需的所有可执行文件和库。在系统启动后，所有其他文件系统都被挂载在标准的、定义明确的挂载点上，作为根文件系统的子目录。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;bin</strong></td>
<td align="left">&#x2F;bin目录包含用户可执行文件。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;boot</strong></td>
<td align="left">包含启动Linux计算机所需的静态引导程序和内核可执行文件以及配置文件。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;dev</strong></td>
<td align="left">这个目录包含了连接到系统的每个硬件设备的设备文件。这些不是设备驱动程序，而是代表计算机上每个设备的文件，并为访问这些设备提供便利。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;etc</strong></td>
<td align="left">包含主机的本地系统配置文件。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;home</strong></td>
<td align="left">用户文件的主目录存储。每个用户都有一个&#x2F;home的子目录。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;lib</strong></td>
<td align="left">包含启动系统所需的共享库文件。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;media</strong></td>
<td align="left">一个安装外部可移动媒体设备的地方，如可能连接到主机的USB拇指驱动器。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;mnt</strong></td>
<td align="left">普通文件系统（如不是可移动媒体）的临时挂载点，可以在管理员修复或处理文件系统的时候使用。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;opt</strong></td>
<td align="left">可选的文件，如供应商提供的应用程序应位于这里。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;root</strong></td>
<td align="left">这不是根（&#x2F;）文件系统。它是根用户的主目录。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;sbin</strong></td>
<td align="left">系统二进制文件。这些是用于系统管理的可执行文件。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;tmp</strong></td>
<td align="left">临时目录。由操作系统和许多程序用来存储临时文件。用户也可以在这里临时存储文件。请注意，存储在这里的文件可能在任何时候被删除，而无需事先通知。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;usr</strong></td>
<td align="left">这些是可共享的、只读的文件，包括可执行的二进制文件和库、人文件和其他类型的文件。</td>
</tr>
<tr>
<td align="left"><strong>&#x2F;var</strong></td>
<td align="left">可变的数据文件被存储在这里。这可以包括像日志文件、MySQL和其他数据库文件、网络服务器数据文件、电子邮件收件箱，以及更多的东西。</td>
</tr>
</tbody></table>
<hr>
<h2 id="二、根文件系统移植"><a href="#二、根文件系统移植" class="headerlink" title="二、根文件系统移植"></a>二、根文件系统移植</h2><h3 id="1、buildroot下载"><a href="#1、buildroot下载" class="headerlink" title="1、buildroot下载"></a>1、buildroot下载</h3><p>我们使用<strong>buildroot</strong>制作根文件系统，之前imx6ull使用的<strong>busybox，</strong>这里换一下，哈哈，首先进入官网，下载根文件系统<strong>buildroot2018.2.11版本，</strong>与墨云保持一致，下载后放到Ubuntu中解压。<a target="_blank" rel="noopener" href="https://buildroot.org/download.html">https://buildroot.org/download.html<img src="https://i-blog.csdnimg.cn/blog_migrate/039a84e0f347bb45be0e5dcf71ea800a.png" alt="img">https://buildroot.org/download.html</a></p>
<img src="/posts/undefined/16bf53f255e1014e4e752296ceb6f0b2.png" class="" title="img">

<p>这个网站比较友好，不需要魔法，buildroot体积较小，直接下载即可，下面是几个不同后缀的文件。</p>
<img src="/posts/undefined/e4373534d5b7ae809f099e92c13867b7.png" class="" title="img">

<p> 上面的四个选项，下载后是下面的文件，sign是什么文件我不清楚，嘿嘿，欢迎评论区指出，选择一个压缩包，到Ubuntu中解压</p>
<img src="/posts/undefined/3856ef4f5b04ad470b82f0c43b224cd1.png" class="" title="img">

<h3 id="2、根文件系统制作"><a href="#2、根文件系统制作" class="headerlink" title="2、根文件系统制作"></a>2、根文件系统制作</h3><p> 解压完成后进入根目录，<strong>清理工程</strong>后，进入<strong>图形界面配置：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>

<p><strong>图形配置界面</strong>如下图所示，使用<strong>方向键</strong>选择不同选项，<strong>空格</strong>进行选中，<strong>回车</strong>进行确认。</p>
<img src="/posts/undefined/3a02d588de0c22fb0d46063ed18e678a.png" class="" title="img">

<p>Target options选项的配置如下图所示，每个选项的含义墨云解释过了，我就不造轮子了。 </p>
<img src="/posts/undefined/455724818a74976030400f831f5e5140.png" class="" title="img">

<blockquote>
<ul>
<li>第一个选项为架构选择，这里选择ARM架构小端模式，</li>
<li>第二个为输出的二进制文件格式，这里选择EFL格式，</li>
<li>第三个为架构体系，这里选择arm926t，因为F1C200S&#x2F;F1C100S的架构就是这个架构，</li>
<li>第四个为矢量浮点处理器，这里不勾选，因为对于F1C200S&#x2F;F1C100S而言，其内部没有浮点运算单元，只能进行软浮点运算，也就是模拟浮点预运算。</li>
<li>第五个为应用程序二进制接口，这里选择EABI，原因是该格式支持软件浮点和硬件实现浮点功能混用。</li>
<li>第六个为浮点运算规则，这里使用软件浮点</li>
<li>第七个选择指令集，这里选择ARM指令集，因为thumb主要针对Cortex M系列而言的，对于运行操作系统的A系列以及ARM9和ARM11而言，使用的都是32位的ARM指令集。</li>
</ul>
<p>来自：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/twzy/p/15355842.html">小白自制Linux开发板 三. Linux内核与文件系统移植 - 淡墨青云 - 博客园</a></p>
</blockquote>
<p>据说Toolchain按照下方配置（打开了一些功能）可以在开发板上直接编译程序。 </p>
<img src="/posts/undefined/9e713011b73ff3129131295e7da48c4c.png" class="" title="img">

<p>登录的时候会显示 <strong>“Wecome to kashine linux system.”</strong> ，并且我们设置了<strong>root用户密码为“good luck!”。</strong></p>
<img src="/posts/undefined/68122ef42f9ee4586e28bfa96df5bd6d.png" class="" title="img">

<p>配置完成后，使用<strong>make命令</strong>进行编译，从下面可以看出，buildroot的编译需要<strong>网络支持，</strong>以通过网络配置我们选择的内容。 当然如果你的虚拟机无法连接网络，请看<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41709234/article/details/123145449">虚拟机ubuntu桥接怎么联网</a>，或者是<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41709234/article/details/124901317">虚拟机net模式访问互联网</a>。</p>
<img src="/posts/undefined/97c047f3075ca262d6381b9b5ff906fe.png" class="" title="img">

<p>此处是<strong>漫长的等待……….，</strong>建议来一道力扣中等！复杂链表的复制！<a target="_blank" rel="noopener" href="https://leetcode.cn/problems/fu-za-lian-biao-de-fu-zhi-lcof/?envType=study-plan&id=lcof&plan=lcof&plan_progress=y16046r">力扣<img src="/posts/undefined/039a84e0f347bb45be0e5dcf71ea800a.png" class="" title="img">https://leetcode.cn/problems/fu-za-lian-biao-de-fu-zhi-lcof/?envType=study-plan&id=lcof&plan=lcof&plan_progress&#x3D;y16046r</a></p>
<p>这个下载速度真的是<strong>奇慢无比！</strong>如果下载依赖包或者软件速度非常慢，可以尝试（不要试了，我试过不管用，哈哈）<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_15175006/2720995">Ubuntu20.04换源之后依旧慢？</a><a target="_blank" rel="noopener" href="https://blog.csdn.net/LukeZhaZha/article/details/104070045">Ubuntu16.04找不到Software&amp;Updates（软件更新）</a>，但我试了一下仍然很慢，这不科学呀！魔法也不管用。</p>
<img src="/posts/undefined/9d637b3f3f4c7a7526b01aa749780086.png" class="" title="img">

<p>终于编译完成了！已经是第二天了，昨天搞到1：00还没有编译完，我就直接挂起虚拟机，今天早晨打开Ubuntu没大会，就已经编译完成了，大概两个多小时。编译完成后，在buildroot根目录的****output&#x2F;images目录*<em><strong>下生成一个</strong>rootfs.rar文件</em>*，这个就是我们心心念念的根文件系统。</p>
<img src="/posts/undefined/a97b6c2f1c95c40b78f572acfe223960.png" class="" title="img">

<p>注意：第二次编译就会快很多，比如误删，别问我怎么知道的，唔哈哈哈。 </p>
<h3 id="3、根文件系统移植"><a href="#3、根文件系统移植" class="headerlink" title="3、根文件系统移植"></a>3、根文件系统移植</h3><p>将上面得到的<strong>rootfs.rar</strong>解压到TF卡的<strong>第二个分区</strong>，也就是<strong>rootfs分区</strong>，不要解压完成在复制过去，因为解压出来好多文件夹。两种选择，要么把压缩包复制到rootfs分区，解压后删除压缩包，要么直接解压到第二分区。使用如下命令将压缩包<strong>解压到rootfs分区后</strong>如下图所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -vxf rootfs.tar -C &#x2F;media&#x2F;project01&#x2F;rootfs&#x2F;</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/f41f2b0688c2bc690b8ebf14a886a9aa.png" class="" title="img">

<p>其中tar解压缩命令格式如下：</p>
<table>
<thead>
<tr>
<th><strong>选项</strong></th>
<th><strong>含义</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>-x</strong></td>
<td><strong>对 tar 包做解打包操作。</strong></td>
</tr>
<tr>
<td><strong>-f</strong></td>
<td><strong>指定要解压的 tar 包的包名。</strong></td>
</tr>
<tr>
<td><strong>-t</strong></td>
<td><strong>只查看 tar 包中有哪些文件或目录，不对 tar 包做解打包操作。</strong></td>
</tr>
<tr>
<td><strong>-C 目录</strong></td>
<td><strong>指定解打包位置。</strong></td>
</tr>
<tr>
<td><strong>-v</strong></td>
<td><strong>显示解打包的具体过程。</strong></td>
</tr>
</tbody></table>
<h3 id="4、根文件系统加载"><a href="#4、根文件系统加载" class="headerlink" title="4、根文件系统加载"></a>4、根文件系统加载</h3><p>TF卡第二个分区内已经放置了我们制作好的根文件系统，将TF卡插到开发板上并<strong>上电启动，</strong>打开<strong>串口调试</strong>助手，设置<strong>波特率115200，</strong>可以看到下面的内容，<strong>uboot和内核启动成功。</strong></p>
<img src="/posts/undefined/c5af8acc93d90bc7be2efe5f252f2a25.png" class="" title="img">

<p>但是并没有启动Linux的根文件系统，我们看最后打印出的提示代码为： <strong>Waiting for root device &#x2F;dev&#x2F;mmcblk0p2…，</strong>看来是<strong>mmcblk0p2表示mmc设备（MultiMedia Card，多媒体存储卡）没有被内核启动成功</strong>，mmcblk0是我们的TF卡，p2代表第二个分区，我们最终确定是<strong>mmc设备</strong>出了问题。</p>
<img src="/posts/undefined/87902481b25d7c127344c9821270fdbf.png" class="" title="img">

<h3 id="5、mmc设备问题分析"><a href="#5、mmc设备问题分析" class="headerlink" title="5、mmc设备问题分析"></a>5、mmc设备问题分析</h3><p>我们先来分析一下出现这个问题的原因，如果说<strong>mmcblk0p2</strong>设备出现问题，那么为什么在启动Linux内核的时候没有出错的，内核文件和设备树文件存放在<strong>mmcblk0p1</strong>中，如果是<strong>mmcblk0p2</strong>加载出错，也就表示TF卡的设备树或者是驱动出了问题，那么<strong>mmcblk0p1</strong>不应该也是错的吗？<strong>那Linux内核不应该能够启动才对的？</strong></p>
<p>小朋友，你是否有很多问号？好的，现在来说一下我对上面问题的理解。其实上面的<strong>问题有点不太对，</strong>不知道大家是否有相同的疑问，所以我对上面也进行了保留。<strong>下面分析：</strong>首先是<strong>uboot的启动，</strong>在TF卡的8k处，我们硬件没有问题，也就是说TF卡接在F1C200s的指定引脚，bootROM启动的时候一定会读取TF卡的8k位置，成功启动uboot，而在uboot启动后，进入倒计时，<strong>倒计时结束后，****执行bootcmd命令，</strong>bootcmd命令如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load mmc 0:1 0x80008000 zImage;load mmc 0:1 0x80c08000 suniv-f1c100s-licheepi-nano.dtb;bootz 0x80008000 - 0x80c08000;</span><br></pre></td></tr></table></figure>

<p>该命令的主要作用是将<strong>zImage和设备树从mmc的第一个分区拷贝到内存中执行，</strong>这个应该好理解哈，Linux内核启动成功了，说明uboot能够将两个文件拷贝到内存中执行，进一步说明<strong>**uboot的TF卡驱动**是没有问题的，**拷贝结束后，</strong>uboot生命周期结束，Linux内核启动，<strong>但是</strong>Linux内核TF卡启动出错**，导致无法加载TF卡第二分区中的根文件系统。</p>
<p>至此，我们大致分析出<strong>导致无法启动Linux根文件系统的原因是：TF卡设备树或者驱动出错。</strong>对于设备树来讲，我们只需要提供对应的硬件信息，即可在不同的开发板可以使用相同的驱动。形象一点讲就是：对某个LED点灯程序<strong>（驱动），</strong>我宏定义了一个LED管脚<strong>（设备树），</strong>程序是官方给的，也就是说确定这个程序可以点灯，现在我们将这套程序放到另一个相同主控的开发板上运行，出问题的话就很可能是我们的<strong>宏定义出错了</strong>，也就是说，<strong>很可能是设备树出错。</strong></p>
<p>通过上面的分析，<strong>我们怀疑很可能是设备树出了问题</strong>，那下面我们对设备树进行检查。首先介绍一下设备树相关文件，打开**&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts<strong>可以看到我们我们前面拷贝到TF卡KERNEL分区的设备树文件，</strong>其中.dtsi文件为“头文件”，储存一个主控芯片的共同信息，供针对相同主控芯片不同开发板的设备树源文件.dts文件调用，编译后生成设备树文件.dtb。**</p>
<img src="/posts/undefined/eb3e061a68c2eb42fd75840a44e71475.png" class="" title="img">

<p>打开**&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts<strong>目录下的</strong>suniv-f1c100s-licheepi-nano.dts、suniv-f1c100s.dtsi<strong>，在dtsi文件中并</strong>没有发现mmc的内容，<strong>也就是如<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43850980/article/details/125931067?spm=1001.2101.3001.6650.7&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-7-125931067-blog-77833552.pc_relevant_3mothn_strategy_recovery&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-7-125931067-blog-77833552.pc_relevant_3mothn_strategy_recovery&utm_relevant_index=9">orange2c</a>所说，是因为我们使用的</strong>主线Linux内核源码，<strong>而主线Linux设备树中并</strong>没有开启mmc。**</p>
<h3 id="6、mmc功能开启"><a href="#6、mmc功能开启" class="headerlink" title="6、mmc功能开启"></a>6、mmc功能开启</h3><p>参考荔枝派<a target="_blank" rel="noopener" href="https://blog.csdn.net/u012577474/article/details/102855237">设备树源码，</a>进行以下修改。首先添加头文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;dt-bindings&#x2F;clock&#x2F;suniv-ccu-f1c100s.h&gt;</span><br><span class="line">#include &lt;dt-bindings&#x2F;reset&#x2F;suniv-ccu-f1c100s.h&gt;</span><br></pre></td></tr></table></figure>

<p>然后在soc结点下的pio添加如下代码，其中<strong>PF0、PF1、PF2、PF3、PF4、PF5为TF卡相关引脚，</strong>详见<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41709234/article/details/124389957%E3%80%82">https://blog.csdn.net/qq_41709234/article/details/124389957。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mmc0_pins: mmc0-pins &#123;</span><br><span class="line">                pins &#x3D; &quot;PF0&quot;, &quot;PF1&quot;, &quot;PF2&quot;, &quot;PF3&quot;, &quot;PF4&quot;, &quot;PF5&quot;;</span><br><span class="line">                function &#x3D; &quot;mmc0&quot;;</span><br><span class="line">            &#125;;</span><br></pre></td></tr></table></figure>

<p>在soc结点下添加如下代码，使用<strong>pinctrl子系统</strong>初始化引脚，其中<strong>compatible变量</strong>保存着mmc对应的驱动。其他时钟总线之类的我就不详细解释了，因为我也不懂，哈哈。<strong>但是一定要注意，.dtsi文件里面是默认关闭mm功能的（可以看到下面的status是disabled状态），需要在.dts里面使能。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mmc0: mmc@1c0f000 &#123;</span><br><span class="line">            compatible &#x3D; &quot;allwinner,suniv-f1c100s-mmc&quot;,</span><br><span class="line">                     &quot;allwinner,sun7i-a20-mmc&quot;;</span><br><span class="line">            reg &#x3D; &lt;0x01c0f000 0x1000&gt;;</span><br><span class="line">            clocks &#x3D; &lt;&amp;ccu CLK_BUS_MMC0&gt;,</span><br><span class="line">                 &lt;&amp;ccu CLK_MMC0&gt;,</span><br><span class="line">                 &lt;&amp;ccu CLK_MMC0_OUTPUT&gt;,</span><br><span class="line">                 &lt;&amp;ccu CLK_MMC0_SAMPLE&gt;;</span><br><span class="line">            clock-names &#x3D; &quot;ahb&quot;,</span><br><span class="line">                          &quot;mmc&quot;,</span><br><span class="line">                          &quot;output&quot;,</span><br><span class="line">                          &quot;sample&quot;;</span><br><span class="line">            resets &#x3D; &lt;&amp;ccu RST_BUS_MMC0&gt;;</span><br><span class="line">            reset-names &#x3D; &quot;ahb&quot;;</span><br><span class="line">            interrupts &#x3D; &lt;23&gt;;</span><br><span class="line">            pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">            pinctrl-0 &#x3D; &lt;&amp;mmc0_pins&gt;;</span><br><span class="line">            status &#x3D; &quot;disabled&quot;;</span><br><span class="line">            #address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">            #size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure>

<p> <strong>.dtsi文件</strong>修改完成后如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: (GPL-2.0+ OR X11)</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Copyright 2018 Icenowy Zheng &lt;icenowy@aosc.io&gt;</span><br><span class="line"> * Copyright 2018 Mesih Kilinc &lt;mesihkilinc@gmail.com&gt;</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; modify by kashine</span><br><span class="line">#include &lt;dt-bindings&#x2F;clock&#x2F;suniv-ccu-f1c100s.h&gt;</span><br><span class="line">#include &lt;dt-bindings&#x2F;reset&#x2F;suniv-ccu-f1c100s.h&gt;</span><br><span class="line"></span><br><span class="line">&#x2F; &#123;</span><br><span class="line">	#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">	#size-cells &#x3D; &lt;1&gt;;</span><br><span class="line">	interrupt-parent &#x3D; &lt;&amp;intc&gt;;</span><br><span class="line"></span><br><span class="line">	clocks &#123;</span><br><span class="line">		osc24M: clk-24M &#123;</span><br><span class="line">			#clock-cells &#x3D; &lt;0&gt;;</span><br><span class="line">			compatible &#x3D; &quot;fixed-clock&quot;;</span><br><span class="line">			clock-frequency &#x3D; &lt;24000000&gt;;</span><br><span class="line">			clock-output-names &#x3D; &quot;osc24M&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		osc32k: clk-32k &#123;</span><br><span class="line">			#clock-cells &#x3D; &lt;0&gt;;</span><br><span class="line">			compatible &#x3D; &quot;fixed-clock&quot;;</span><br><span class="line">			clock-frequency &#x3D; &lt;32768&gt;;</span><br><span class="line">			clock-output-names &#x3D; &quot;osc32k&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	cpus &#123;</span><br><span class="line">		cpu &#123;</span><br><span class="line">			compatible &#x3D; &quot;arm,arm926ej-s&quot;;</span><br><span class="line">			device_type &#x3D; &quot;cpu&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	soc &#123;</span><br><span class="line">		compatible &#x3D; &quot;simple-bus&quot;;</span><br><span class="line">		#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		#size-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		ranges;</span><br><span class="line"></span><br><span class="line">		sram-controller@1c00000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-system-control&quot;,</span><br><span class="line">				     &quot;allwinner,sun4i-a10-system-control&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c00000 0x30&gt;;</span><br><span class="line">			#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">			#size-cells &#x3D; &lt;1&gt;;</span><br><span class="line">			ranges;</span><br><span class="line"></span><br><span class="line">			sram_d: sram@10000 &#123;</span><br><span class="line">				compatible &#x3D; &quot;mmio-sram&quot;;</span><br><span class="line">				reg &#x3D; &lt;0x00010000 0x1000&gt;;</span><br><span class="line">				#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">				#size-cells &#x3D; &lt;1&gt;;</span><br><span class="line">				ranges &#x3D; &lt;0 0x00010000 0x1000&gt;;</span><br><span class="line"></span><br><span class="line">				otg_sram: sram-section@0 &#123;</span><br><span class="line">					compatible &#x3D; &quot;allwinner,suniv-f1c100s-sram-d&quot;,</span><br><span class="line">						     &quot;allwinner,sun4i-a10-sram-d&quot;;</span><br><span class="line">					reg &#x3D; &lt;0x0000 0x1000&gt;;</span><br><span class="line">					status &#x3D; &quot;disabled&quot;;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		ccu: clock@1c20000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-ccu&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c20000 0x400&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;osc24M&gt;, &lt;&amp;osc32k&gt;;</span><br><span class="line">			clock-names &#x3D; &quot;hosc&quot;, &quot;losc&quot;;</span><br><span class="line">			#clock-cells &#x3D; &lt;1&gt;;</span><br><span class="line">			#reset-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		intc: interrupt-controller@1c20400 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-ic&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c20400 0x400&gt;;</span><br><span class="line">			interrupt-controller;</span><br><span class="line">			#interrupt-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		pio: pinctrl@1c20800 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-pinctrl&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c20800 0x400&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;38&gt;, &lt;39&gt;, &lt;40&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu 37&gt;, &lt;&amp;osc24M&gt;, &lt;&amp;osc32k&gt;;</span><br><span class="line">			clock-names &#x3D; &quot;apb&quot;, &quot;hosc&quot;, &quot;losc&quot;;</span><br><span class="line">			gpio-controller;</span><br><span class="line">			interrupt-controller;</span><br><span class="line">			#interrupt-cells &#x3D; &lt;3&gt;;</span><br><span class="line">			#gpio-cells &#x3D; &lt;3&gt;;</span><br><span class="line"></span><br><span class="line">			uart0_pe_pins: uart0-pe-pins &#123;</span><br><span class="line">				pins &#x3D; &quot;PE0&quot;, &quot;PE1&quot;;</span><br><span class="line">				function &#x3D; &quot;uart0&quot;;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			&#x2F;&#x2F; modify by kashine</span><br><span class="line">			mmc0_pins: mmc0-pins &#123;</span><br><span class="line">                pins &#x3D; &quot;PF0&quot;, &quot;PF1&quot;, &quot;PF2&quot;, &quot;PF3&quot;, &quot;PF4&quot;, &quot;PF5&quot;;</span><br><span class="line">                function &#x3D; &quot;mmc0&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		timer@1c20c00 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-timer&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c20c00 0x90&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;13&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;osc24M&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		wdt: watchdog@1c20ca0 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-wdt&quot;,</span><br><span class="line">				     &quot;allwinner,sun4i-a10-wdt&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c20ca0 0x20&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		uart0: serial@1c25000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;snps,dw-apb-uart&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c25000 0x400&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;1&gt;;</span><br><span class="line">			reg-shift &#x3D; &lt;2&gt;;</span><br><span class="line">			reg-io-width &#x3D; &lt;4&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu 38&gt;;</span><br><span class="line">			resets &#x3D; &lt;&amp;ccu 24&gt;;</span><br><span class="line">			status &#x3D; &quot;disabled&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		uart1: serial@1c25400 &#123;</span><br><span class="line">			compatible &#x3D; &quot;snps,dw-apb-uart&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c25400 0x400&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;2&gt;;</span><br><span class="line">			reg-shift &#x3D; &lt;2&gt;;</span><br><span class="line">			reg-io-width &#x3D; &lt;4&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu 39&gt;;</span><br><span class="line">			resets &#x3D; &lt;&amp;ccu 25&gt;;</span><br><span class="line">			status &#x3D; &quot;disabled&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		uart2: serial@1c25800 &#123;</span><br><span class="line">			compatible &#x3D; &quot;snps,dw-apb-uart&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c25800 0x400&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;3&gt;;</span><br><span class="line">			reg-shift &#x3D; &lt;2&gt;;</span><br><span class="line">			reg-io-width &#x3D; &lt;4&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu 40&gt;;</span><br><span class="line">			resets &#x3D; &lt;&amp;ccu 26&gt;;</span><br><span class="line">			status &#x3D; &quot;disabled&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; modify by kashine</span><br><span class="line">		mmc0: mmc@1c0f000 &#123;</span><br><span class="line">            compatible &#x3D; &quot;allwinner,suniv-f1c100s-mmc&quot;,</span><br><span class="line">                     &quot;allwinner,sun7i-a20-mmc&quot;;</span><br><span class="line">            reg &#x3D; &lt;0x01c0f000 0x1000&gt;;</span><br><span class="line">            clocks &#x3D; &lt;&amp;ccu CLK_BUS_MMC0&gt;,</span><br><span class="line">                 &lt;&amp;ccu CLK_MMC0&gt;,</span><br><span class="line">                 &lt;&amp;ccu CLK_MMC0_OUTPUT&gt;,</span><br><span class="line">                 &lt;&amp;ccu CLK_MMC0_SAMPLE&gt;;</span><br><span class="line">            clock-names &#x3D; &quot;ahb&quot;,</span><br><span class="line">                          &quot;mmc&quot;,</span><br><span class="line">                          &quot;output&quot;,</span><br><span class="line">                          &quot;sample&quot;;</span><br><span class="line">            resets &#x3D; &lt;&amp;ccu RST_BUS_MMC0&gt;;</span><br><span class="line">            reset-names &#x3D; &quot;ahb&quot;;</span><br><span class="line">            interrupts &#x3D; &lt;23&gt;;</span><br><span class="line">            pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">            pinctrl-0 &#x3D; &lt;&amp;mmc0_pins&gt;;</span><br><span class="line">            status &#x3D; &quot;disabled&quot;;</span><br><span class="line">            #address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">            #size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">        &#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p> 在**.dts文件<strong>里面进行以下修改，首先</strong>使能mmc：**</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;mmc0 &#123;</span><br><span class="line">        vmmc-supply &#x3D; &lt;&amp;reg_vcc3v3&gt;;</span><br><span class="line">        bus-width &#x3D; &lt;4&gt;;</span><br><span class="line">        broken-cd;</span><br><span class="line">        status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后这个是<strong>墨云****在根节点下</strong>添加的一个结点，他并没有说明为什么添加，我百度了一下，这是一个<strong>电源管理</strong>相关的结点，<strong>使用regulator-fixed来实现使用GPIO控制某个电源开关 ，</strong>希望在开机时尽快输出高低电平来控制电源。详见<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43245753/article/details/125380619">。Rockchip RK3588 kernel dts解析之regulator-fixed</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">reg_vcc3v3: vcc3v3 &#123;</span><br><span class="line">        compatible &#x3D; &quot;regulator-fixed&quot;;</span><br><span class="line">        regulator-name &#x3D; &quot;vcc3v3&quot;;</span><br><span class="line">        regulator-min-microvolt &#x3D; &lt;3300000&gt;;</span><br><span class="line">        regulator-max-microvolt &#x3D; &lt;3300000&gt;;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>.dts文件修改完成之后下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: (GPL-2.0+ OR X11)</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Copyright 2018 Icenowy Zheng &lt;icenowy@aosc.io&gt;</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;dts-v1&#x2F;;</span><br><span class="line">#include &quot;suniv-f1c100s.dtsi&quot;</span><br><span class="line"></span><br><span class="line">&#x2F; &#123;</span><br><span class="line">	model &#x3D; &quot;Lichee Pi Nano&quot;;</span><br><span class="line">	compatible &#x3D; &quot;licheepi,licheepi-nano&quot;, &quot;allwinner,suniv-f1c100s&quot;;</span><br><span class="line"></span><br><span class="line">	aliases &#123;</span><br><span class="line">		serial0 &#x3D; &amp;uart0;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	chosen &#123;</span><br><span class="line">		stdout-path &#x3D; &quot;serial0:115200n8&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F; modify by kashine</span><br><span class="line">	reg_vcc3v3: vcc3v3 &#123;</span><br><span class="line">		compatible &#x3D; &quot;regulator-fixed&quot;;</span><br><span class="line">		regulator-name &#x3D; &quot;vcc3v3&quot;;</span><br><span class="line">		regulator-min-microvolt &#x3D; &lt;3300000&gt;;</span><br><span class="line">		regulator-max-microvolt &#x3D; &lt;3300000&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;uart0 &#123;</span><br><span class="line">	pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">	pinctrl-0 &#x3D; &lt;&amp;uart0_pe_pins&gt;;</span><br><span class="line">	status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; modify by kashine</span><br><span class="line">&amp;mmc0 &#123;</span><br><span class="line">        vmmc-supply &#x3D; &lt;&amp;reg_vcc3v3&gt;;</span><br><span class="line">        bus-width &#x3D; &lt;4&gt;;</span><br><span class="line">        broken-cd;</span><br><span class="line">        status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="7、设备树编译与下载"><a href="#7、设备树编译与下载" class="headerlink" title="7、设备树编译与下载"></a>7、设备树编译与下载</h3><p>在Linux内核根目录下，使用以下命令重新编译设备树，内核无需重新编译。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make dtbs</span><br></pre></td></tr></table></figure>

<p>在内核源码根目录使用<strong>make dtbs</strong>编译变成后生成设备树文件，如下图所示。</p>
<img src="/posts/undefined/016df9392a916bc2589868fa1d114caf.png" class="" title="img">

<p>编译完成后，将<strong>新的设备树文件（.dtb）</strong>拷贝到<strong>TF卡的第二分区，**zImage无需修改，*<em><strong>打开串口调试助手，上电复位，</strong>成功启动根文件系统！！！</em>*，成功打印出“Welcome to kashine linux system.”，</strong>root为管理员用户名，密码为前面设置的“good luck！”，**将路径切换到根目录之后，查看根目录的文件夹，如下图所示。</p>
<img src="/posts/undefined/639c6985e0ba0bdb02ef1502577c2783.png" class="" title="img">

<p> 在上电成功启动根文件系统之后，不要直接拔掉USB断电，可能造成根文件系统损坏，使用<strong>poweroff命令****关闭根文件系统</strong>后断电。</p>
<img src="/posts/undefined/ce20f3dbc1e60e81a10ce5222c787027.png" class="" title="img">




<h1 id="Debian系统"><a href="#Debian系统" class="headerlink" title="Debian系统"></a>Debian系统</h1><h2 id="一、Debian系统介绍"><a href="#一、Debian系统介绍" class="headerlink" title="一、Debian系统介绍"></a>一、Debian系统介绍</h2><p>Debian GNU&#x2F;Linux 是 Linux 操作系统的一个特定发行版，以及在其上运行的众多软件包。Debian项目由 Ian Murdock 于 1993 年发起，是在Linux发行版的概念还很新的时候获得广泛认可的首批自由软件项目之一。Debian 这个名字——发音为 deb-EE-uhn——是一个合成词，它混合了创建者的名字 Ian 和他妻子 Debra 的名字。</p>
<hr>
<h2 id="二、Linux发行版和Linux内核的关系"><a href="#二、Linux发行版和Linux内核的关系" class="headerlink" title="二、Linux发行版和Linux内核的关系"></a>二、Linux发行版和Linux内核的关系</h2><p>**内核：**位于应用软件和底层硬件系统之间。它直接与硬件通信，传递应用软件的任何请求。****一个简单的例子来说明这一点，就是在手机上录制视频。当你点击相机应用程序时，该软件将向内核传达它想要使用相机和麦克风的信息。然后，内核将通知摄像头和麦克风硬件唤醒并做好准备。那么现在，软件和硬件将协同工作，为你录制好视频。</p>
<p>**操作系统：**主要目的是管理系统进程和资源。它包含内核，因此执行内核可以执行的所有任务。****此外，它还确保系统保护和安全。操作系统充当用户和底层硬件系统之间的接口。所有应用程序都在操作系统创建的封闭环境中运行。因此，没有操作系统就无法使用系统。</p>
<p><strong>Linux 本身就是一个内核。然后，开发人员在其基础上进行构建，以提供当今可用的各种 Linux 发行版。</strong></p>
<hr>
<h2 id="三、Debian文件系统制作"><a href="#三、Debian文件系统制作" class="headerlink" title="三、Debian文件系统制作"></a>三、Debian文件系统制作</h2><blockquote>
<p>由于F1C200s的RAM只有64M，无法支持像是Ubuntu-Core这样的文件系统（最低RAM需求512M），所以一般只能用buildroot来生成简单的文件系统，或者裸机开发。</p>
<p>但是为了方便地使用Debian系的丰富软件，我们可以自己构建Debian最小系统，最小rootfs在180MB左右。</p>
<p><strong>– 稚辉君</strong></p>
</blockquote>
<h3 id="1、环境配置"><a href="#1、环境配置" class="headerlink" title="1、环境配置"></a>1、环境配置</h3><p>首先下载两个工具：<strong>qemu-arm-static和debootstrap。</strong></p>
<p><strong>🥝 qemu-arm-static：</strong>通过qemu-arm-static，我们在x86的Ubuntu PC机上，可以<strong>模拟ARM处理器，</strong>就像运行在ARM上一样进行各种操作。这样<strong>既实现了ARM环境，又利用了x86 PC的处理能力。</strong></p>
<p><strong>🥝 debootstrap：</strong>是Debian&#x2F;Ubuntu下的一个工具，<strong>用来构建一套基本的系统(根文件系统)。</strong>生成的目录符合Linux文件系统标准(FHS)，即包含了&#x2F;boot、&#x2F;etc、&#x2F;bin、&#x2F;usr等等目录，但<strong>它比发行版本的Linux体积小很多，</strong>当然功能也没那么强大，因此，只能说是“基本的系统”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install qemu-user-static -y</span><br><span class="line">sudo apt install debootstrap -y</span><br><span class="line">mkdir Debian_rootfs</span><br></pre></td></tr></table></figure>

<h3 id="2、Debian文件系统构建"><a href="#2、Debian文件系统构建" class="headerlink" title="2、Debian文件系统构建"></a>2、Debian文件系统构建</h3><p><strong>由于我们的Ubuntu是Linux系统，而开发板是ARM系统，在使用bootstrap为外部体系结构引导发行版时，才需要分开两个阶段。</strong>请参见<a target="_blank" rel="noopener" href="http://linux.die.net/man/8/debootstrap">手册页</a>–foreign上的选项说明。</p>
<p>例如，使用x64机器为嵌入式ARM系统创建Debian安装系统。<strong>第一阶段</strong>将下载所需的.deb文件并将其解压缩到您指定的目录中。<strong>第二阶段</strong>解压运行所有程序包配置脚本，这些脚本必须使用<strong>目标体系结构或使用qemu-user-static模拟目标体系结构</strong>来完成，在此处我们使用<strong>qemu-user-static模拟ARM系统来完成</strong>。在完成两个阶段的配置后，还需要进入qemu模拟器进行一些<strong>必要配置。</strong></p>
<h4 id="🍟-第一阶段"><a href="#🍟-第一阶段" class="headerlink" title="🍟 第一阶段"></a><strong>🍟</strong> <strong>第一阶段</strong></h4><p>使用华为镜像源抽取根文件系统<strong>**（下载deb软件包）**，**命令如下，</strong>bootstrap<strong>命令详解见<a target="_blank" rel="noopener" href="https://blog.csdn.net/talkxin/article/details/84075368">Bootstrap命令详解</a>。其中</strong>foreign<strong>表示若目标架构与本机架构不符时，需要携带该参数；</strong>arch<strong>代表架构，armhf (支持硬件浮点)、armel (软浮点)；</strong>verbose<strong>表示不打印wget等包下载数据，进行静默安装；</strong>buster**代表Debian发行版本代号。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo debootstrap --foreign --verbose --arch&#x3D;armel  buster rootfs http:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;debian&#x2F;</span><br></pre></td></tr></table></figure>

<p>其中，不同<strong>Debian发行版代号</strong>如下。命令执行完成后就是大家最常见的linux根文件系统，但是目前还不能直接使用，还需要对其做一些其他的配置。 </p>
<table>
<thead>
<tr>
<th><strong>版本号</strong></th>
<th><strong>代号</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Debian 11</strong></td>
<td><strong>bullseye</strong></td>
<td><strong>稳定版</strong></td>
</tr>
<tr>
<td><strong>Debian 10</strong></td>
<td><strong>buster</strong></td>
<td><strong>旧稳定版</strong></td>
</tr>
<tr>
<td><strong>Debian 9</strong></td>
<td><strong>stretch</strong></td>
<td><strong>旧稳定版</strong></td>
</tr>
<tr>
<td><strong>Debian 8</strong></td>
<td><strong>jessie</strong></td>
<td><strong>已存档版</strong></td>
</tr>
<tr>
<td><strong>Debian 7</strong></td>
<td><strong>wheezy</strong></td>
<td><strong>被淘汰版</strong></td>
</tr>
<tr>
<td><strong>Debian 6</strong></td>
<td><strong>squeeze</strong></td>
<td><strong>被淘汰版</strong></td>
</tr>
<tr>
<td><strong>Debian 5</strong></td>
<td><strong>lenny</strong></td>
<td><strong>被淘汰版</strong></td>
</tr>
</tbody></table>
<p>至此,已经下载了<strong>最小的Debian系统,</strong> 你也可以将它想象为”最小系统”类似的存在,没有其他 “外设” 。下图是我补充的图片，所在文件夹名字和上面不同。</p>
<img src="/posts/undefined/08f88522f395f4d9428589319926c724.png" class="" title="img">

<h4 id="🍟-第二阶段"><a href="#🍟-第二阶段" class="headerlink" title="🍟 第二阶段"></a><strong>🍟</strong> <strong>第二阶段</strong></h4><p>上面讲在第二阶段我们应该使用<strong>qemu-user-static模拟ARM系统</strong>运行所有程序包配置脚本，怎么模拟ARM系统呢？使用qemu这个虚拟机。简而言之，我们需要在<strong>qemu模拟出的ARM系统中执行一个Debian系统配置，</strong>相当于把Debian放到ARM开发板上配置。<strong>具体操作为：文件夹挂载 + chroot切换根目录。</strong></p>
<p><strong>1）文件挂载：</strong></p>
<p>首先对文件夹按照下面的命令进行挂载，这里<strong>为什么需要挂载呢？</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd rootfs</span><br><span class="line">sudo mount --bind &#x2F;dev dev&#x2F;</span><br><span class="line">sudo mount --bind &#x2F;sys sys&#x2F;</span><br><span class="line">sudo mount --bind &#x2F;proc proc&#x2F;</span><br><span class="line">sudo mount --bind &#x2F;dev&#x2F;pts dev&#x2F;pts&#x2F;</span><br></pre></td></tr></table></figure>

<p>我的理解是：因为在<strong>宿主（Ubuntu虚拟机）是x64架构</strong>，不能安装<strong>arm架构</strong>的软件，需要依靠<strong>qemu-arm-static</strong>来<strong>模拟成arm环境</strong>进行安装，而模拟arm环境相当于，以指定的某个目录为新的根目录，如果不更改挂载点，直接下载一些软件或者依赖项就会下载到原来的挂载点而出错。</p>
<p>通俗一点的理解：虽然更新了根目录，如果没有挂载新文件系统的&#x2F;dev等文件夹，如果再去操作&#x2F;dev，相当于还是在操作Ubuntu的&#x2F;dev，只有挂载了这个文件夹之后，再操作才相当于真正操作Debian新的根文件系统的&#x2F;dev。评论区讨论吧！欢迎指正！</p>
<p><strong>2）chroot切换根目录：</strong></p>
<p>chroot，即 change root directory (更改 root 目录)。在 linux 系统中，系统默认的目录结构都是以 &#x2F;，即以根 (root) 开始的。而在使用 chroot 之后，系统的目录结构将以指定的位置作为 &#x2F; 位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp &#x2F;usr&#x2F;bin&#x2F;qemu-arm-static  usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<p>使用上面的命令将我们之前安装的<strong>qemu复制到&#x2F;rootfs&#x2F;usr&#x2F;bin目录下</strong>，可以看到我们具有该文件的<strong>读、写、可执行权限。</strong></p>
<img src="/posts/undefined/f20fa610319ba7b63d613e8a10a61c35.png" class="" title="img">

<p>然后<strong>在Debian_rootfs目录下</strong>执行下面的命令，该命令意思是<strong>设置一些环境变量，</strong>并使用<strong>chroot命令将rootfs切换为新的根目录，</strong>执行目录<strong>rootfs&#x2F;debootstrap下的命令: debootstrap –second-stage，</strong>后面的是debootstrap可执行文件的两个参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo LC_ALL&#x3D;C LANGUAGE&#x3D;C LANG&#x3D;C chroot rootfs &#x2F;debootstrap&#x2F;debootstrap --second-stage --verbose</span><br></pre></td></tr></table></figure>

<p><strong>该命令的主要作用是：对拉取的Debian根文件系统进行配置。</strong>这主要是由上面的–foreign选项决定的。这里是使用qemu-user-static模拟目标体系结构来完成的，因为我们使用的chroot更改了根目录，并挂载了新的文件系统的文件夹，相当于使用chroot命令+挂载，完成arm架构的模拟。</p>
<hr>
<h2 id="三、Debian文件系统配置"><a href="#三、Debian文件系统配置" class="headerlink" title="三、Debian文件系统配置"></a>三、Debian文件系统配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo LC_ALL&#x3D;C LANGUAGE&#x3D;C LANG&#x3D;C chroot rootfs</span><br></pre></td></tr></table></figure>

<p>使用上面的命令<strong>进入qemu虚拟器，</strong>相当于进入ARM系统下的Debian文件系统中，如下图所示。chroot rootfs 后面不加命令相当于执行chroot rootfs &#x2F;bin&#x2F;bash，也就是打开一个shell，详见<a target="_blank" rel="noopener" href="https://www.cnblogs.com/sparkdev/p/8556075.html">chroot语法。</a></p>
<img src="/posts/undefined/8a2125e9f686eb426eb89f7f3557d165.png" class="" title="img">

<h4 id="1、更新源"><a href="#1、更新源" class="headerlink" title="*1、更新源*"></a><em><strong>*1、更新源*</strong></em></h4><p>更新源为<strong>国内源</strong>可以提高后续软件下载速度，具体命令如下。因为默认的源是 http 的，但是如果准备使用的镜像源是https 的，所以需要额外的安装有关 HTTPS 的包。所以安装这两个包之后就可以正常拉取https的源了：<strong>apt-transport-https和ca-certificates。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;apt&#x2F;sources.list</span><br><span class="line">#写入： deb http:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;debian buster main</span><br><span class="line">apt-get update</span><br></pre></td></tr></table></figure>

<h4 id="2、安装网络相关库"><a href="#2、安装网络相关库" class="headerlink" title="*2、安装网络相关库*"></a><em><strong>*2、安装网络相关库*</strong></em></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apt-get install wpasupplicant #安装WIFI配置相关的组件</span><br><span class="line">apt-get install net-tools     #安装网络基础组件、如使用ifconfig等</span><br><span class="line">apt-get install udhcpc        #当wifi连接成功后，需要用这个组件去获取IP地址</span><br><span class="line"></span><br><span class="line">apt-get install evtest        #触摸屏测试</span><br><span class="line">apt-get install mplayer</span><br><span class="line">apt-get install alsa-utils    #音频测试</span><br><span class="line"></span><br><span class="line">## 其他组件</span><br><span class="line">apt-get install wireless-tools </span><br><span class="line">apt install sudo vim openssh-server htop</span><br><span class="line">apt install pciutils usbutils acpi #acpi我没有安装成功，换了其他的源也不可以</span><br></pre></td></tr></table></figure>

<h4 id="3、配置账号"><a href="#3、配置账号" class="headerlink" title="*3、配置账号*"></a><em><strong>*3、配置账号*</strong></em></h4><p>设置root账号密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd root</span><br></pre></td></tr></table></figure>

<h4 id="4、配置时区"><a href="#4、配置时区" class="headerlink" title="*4、配置时区*"></a><em><strong>*4、配置时区*</strong></em></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;Asia&#x2F;Shanghai &#x2F;etc&#x2F;localtime</span><br></pre></td></tr></table></figure>

<h4 id="5、配置SSH"><a href="#5、配置SSH" class="headerlink" title="*5、配置SSH*"></a><em><strong>*5、配置SSH*</strong></em></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;ssh&#x2F;sshd_config</span><br><span class="line">#写入： PermitRootLogin yes</span><br></pre></td></tr></table></figure>

<h4 id="6、rootfs打包"><a href="#6、rootfs打包" class="headerlink" title="*6、rootfs打包*"></a><em><strong>*6、rootfs打包*</strong></em></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apt clean #清理</span><br><span class="line">exit #退出chroot</span><br><span class="line">rm rootfs&#x2F;usr&#x2F;bin&#x2F;qemu-arm-static #删除之前拷贝的文件</span><br><span class="line">cd rootfs</span><br><span class="line">sudo umount   dev&#x2F;pts&#x2F; # 一定要在&#x2F;dev前面umount</span><br><span class="line">sudo umount   dev&#x2F;</span><br><span class="line">sudo umount   sys&#x2F;</span><br><span class="line">sudo umount   proc&#x2F;</span><br><span class="line">sudo tar cvf ..&#x2F;rootfs.tar .&#x2F; #在rootfs目录下执行</span><br></pre></td></tr></table></figure>

<p>最终生成了Debian文件系统压缩包，解压即可使用。</p>
<h4 id="7、Debian文件系统启动"><a href="#7、Debian文件系统启动" class="headerlink" title="*7、Debian文件系统启动*"></a><em><strong>*7、Debian文件系统启动*</strong></em></h4><p>在<strong>rootfs.tar文件</strong>目录终端中，输入以下命令解压到TF卡的rootfs分区，也就是第二分区。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -vxf .&#x2F;rootfs.tar -C &#x2F;media&#x2F;project01&#x2F;rootfs&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>注意：一定要等待拷贝完成，再拔出TF卡，</strong>我的转接器上有指示灯，等待指示灯常亮，不再闪烁即可拔出。将TF卡插到开发板上，上电启动复位，等待，启动成功！！！</p>
<img src="/posts/undefined/c883c629eea516375bfbf77afe890d80.png" class="" title="img">

<hr>
<h2 id="四、增加swap分区"><a href="#四、增加swap分区" class="headerlink" title="四、增加swap分区"></a>四、增加swap分区</h2><blockquote>
<p>芯片的SiP内存只有64MB，大部分情况下都不够用，所以需要开启swap使用内存卡的一部分空间来作为交换内存。</p>
</blockquote>
<blockquote>
<p>在使用一些软件的过程中，会遇到系统崩溃，尤其是使用 apt-get install 的时候，所以需要加入swap分区，可以简单理解为虚拟内存。</p>
</blockquote>
<p>这十分类似于Windows的虚拟内存，<strong>虚拟内存</strong>其实就是<strong>将硬盘的一部分容量当内存使用</strong>，从而弥补物理内存不足的问题。</p>
<p>我们可以通过<strong>free -m</strong>来查看下<strong>内存使用状况，</strong>此处我直接在qemu虚拟器中查看：</p>
<img src="/posts/undefined/06cc1d8987eed57e16072098dd76046d.png" class="" title="img">

<p> 使用如下命令创建你想要添加swap分区的大小：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;swap1 bs&#x3D;1M count&#x3D;512  #count是SWAP大小，512就是512MB</span><br></pre></td></tr></table></figure>

<p>设置swap分区文件，然后激活分区：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 设置分区文件</span><br><span class="line">mkswap &#x2F;swap1</span><br><span class="line"># 激活swap分区</span><br><span class="line">swapon &#x2F;swap1</span><br><span class="line">vi &#x2F;etc&#x2F;fstab</span><br><span class="line"># 最后一行添加 </span><br><span class="line"># &#x2F;swap1 swap swap defaults 0 0</span><br></pre></td></tr></table></figure>

<p> 将新的根文件系统拷贝到TF卡的第二分区，重新上电启动，查看交换分区大小，的确为我们设置的512M。</p>
<img src="/posts/undefined/a5b1c2ac211d085037cc50e947161494.png" class="" title="img">


<h1 id="正点原子4-3寸RGB屏幕驱动"><a href="#正点原子4-3寸RGB屏幕驱动" class="headerlink" title="正点原子4.3寸RGB屏幕驱动"></a>正点原子4.3寸RGB屏幕驱动</h1><h2 id="一、RGB屏幕介绍"><a href="#一、RGB屏幕介绍" class="headerlink" title="一、RGB屏幕介绍"></a>一、RGB屏幕介绍</h2><p>正点原子ATK4384<strong>显示屏，</strong>分辨率<strong>800*480，</strong>支持RGB接口，详细资料下载地址为：<a target="_blank" rel="noopener" href="http://47.111.11.73/docs/modules/lcd/4.3-RGBLCD-800480.html">4.3寸RGBLCD电容触摸屏800*480</a>。RGB LCD接口信号线如下所示：</p>
<table>
<thead>
<tr>
<th><strong>信号线</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>R[7:0]</strong></td>
<td><strong>数据线</strong></td>
</tr>
<tr>
<td><strong>G[7:0]</strong></td>
<td><strong>数据线</strong></td>
</tr>
<tr>
<td><strong>B[7:0]</strong></td>
<td><strong>数据线</strong></td>
</tr>
<tr>
<td><strong>DE</strong></td>
<td><strong>数据使能线</strong></td>
</tr>
<tr>
<td><strong>VSYNC</strong></td>
<td><strong>垂直同步信号线</strong></td>
</tr>
<tr>
<td><strong>HSYNC</strong></td>
<td><strong>水平同步信号线</strong></td>
</tr>
<tr>
<td><strong>PCLK</strong></td>
<td><strong>像素钟信号线</strong></td>
</tr>
</tbody></table>
<p>屏幕的参数如下所示，其中<strong>各参数的含义</strong>详见<a target="_blank" rel="noopener" href="https://blog.csdn.net/Richard_LiuJH/article/details/46352857">这篇博客</a>，解释的比较详细，我就不再重复造轮子了。</p>
<table>
<thead>
<tr>
<th><strong>参数</strong></th>
<th><strong>值</strong></th>
<th><strong>单位</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>水平显示区域</strong></td>
<td><strong>800</strong></td>
<td><strong>每时钟 (tCLK)</strong></td>
</tr>
<tr>
<td><strong>HSPW (thp)</strong></td>
<td><strong>48</strong></td>
<td><strong>每时钟 (tCLK)</strong></td>
</tr>
<tr>
<td><strong>HBP (thb)</strong></td>
<td><strong>88</strong></td>
<td><strong>每时钟 (tCLK)</strong></td>
</tr>
<tr>
<td><strong>HFP (thf)</strong></td>
<td><strong>40</strong></td>
<td><strong>每时钟 (tCLK)</strong></td>
</tr>
<tr>
<td><strong>垂直显示区域</strong></td>
<td><strong>480</strong></td>
<td><strong>每行 (th)</strong></td>
</tr>
<tr>
<td><strong>VSPW (tvp)</strong></td>
<td><strong>3个</strong></td>
<td><strong>每行 (th)</strong></td>
</tr>
<tr>
<td><strong>VBP (tvb)</strong></td>
<td><strong>32</strong></td>
<td><strong>每行 (th)</strong></td>
</tr>
<tr>
<td><strong>VFP (tvf)</strong></td>
<td><strong>13</strong></td>
<td><strong>每行 (th)</strong></td>
</tr>
</tbody></table>
<p>我的板子上存在两个屏幕接口， 1.14寸ips屏幕、ATK4384的40pinrgb屏幕，由于1.14寸屏幕实在是太小了，因此，本系统使用的<strong>40PinRGB屏幕接口</strong>如图所示。由下面的硬件原理图可以看出我们采用的屏<strong>**数据格式是RGB666**，**当然，</strong>I2C接口<strong>用作</strong>触摸屏数据传输**，本文暂时用不到。</p>
<img src="/posts/undefined/3a3c60956eda74885ee7511e2e863906.png" class="" title="img">

<hr>
<h2 id="二、RGB屏幕驱动"><a href="#二、RGB屏幕驱动" class="headerlink" title="二、RGB屏幕驱动"></a>二、RGB屏幕驱动</h2><p>linux内核<strong>已经配备</strong>了RGB模式下的LCD驱动<strong>（见drivers&#x2F;gpu&#x2F;drm&#x2F;panel&#x2F;panel-simple.c，也就是DRM驱动）</strong>，而我们的F1C200s支持RGB模式的LCD，我们<strong>不需要从零写一个屏幕驱动，</strong>我们只需要简单几步即可驱动LCD屏幕。F1C200s虽然不像IMX6ULL那样配备eLCDIF接口，但只需要符合RGB接口的时序即可点亮。</p>
<p><strong>注意：内核配置文件和之前相同！</strong></p>
<h3 id="1、设备树修改"><a href="#1、设备树修改" class="headerlink" title="1、设备树修改"></a>1、设备树修改</h3><p><strong>.dtsi文件</strong>中做以下修改，代码修改处添加了<strong>modify by kashine</strong>的标注。其中，加入reset和clock两个文件夹下的<strong>suniv-ccu-f1c100s.h文件</strong>，是为了<strong>提供一些宏定义</strong>；<strong>设备树de结点</strong>是display engine驱动初始化结点，官方解释为：<strong>Allwinner A10 Display Engine DRM&#x2F;KMS Driver，</strong>关于DRM驱动的知识，这里不在赘述；<strong>tcon0结点</strong>对应<strong>时序控制驱动</strong>，官方解释为：<strong>Allwinner A10 Timing Controller Driver</strong>；pio结点中加入RGB屏幕的管脚信息；<strong>fe0结点和be0结点</strong>为RGB显示的前后端驱动程序；<strong>pwm结点</strong>用于背光显示，亮度调节。</p>
<p>我们来详细分析一下代码中的各个部分。</p>
<ol>
<li>display-engine：描述了显示引擎，这是 F1C100s 处理器中的一个重要组件，用于处理图像数据。它与显示前端（display-frontend）和显示后端（display-backend），相连接包含一条pipeline fe0。</li>
<li>tcon0：代表了时序控制器（Timing Controller，简称 TCON），它负责生成正确的时序信号，以驱动显示面板。这部分代码中，我们可以看到 TCON 的寄存器地址、中断号、时钟和复位信号等信息。此外，还定义了输入和输出端口，分别连接到显示后端和显示面板。</li>
<li>lcd_rgb666_pins：定义了与 RGB 屏幕连接的引脚，这里使用了 18 位的 RGB666 接口。</li>
<li>display-frontend 和 display-backend：显示前端和显示后端分别负责图像数据的预处理和后处理。显示前端接收原始图像数据，对其进行缩放、色彩空间转换等操作；显示后端则负责图像数据的合成、alpha 混合等功能。这两个部分通过端口和端点（endpoint）进行连接。</li>
<li>panel：描述了显示面板，定义了使用的LCD panel参数。这里使用了一个兼容于 “alientek,alientek_4p3_inch” 和 “simple-panel” 的面板。面板的输入端口与 TCON 的输出端口相连接。</li>
<li>reg_vcc3v3：描述了一个固定电压的电源，为面板提供 3.3V 电源。</li>
</ol>
<p>最后，在设备树末尾，启用了 be0（显示后端）、de（显示引擎）和 tcon0（时序控制器）节点。</p>
<p>从这段代码中可以看出，该 RGB 屏幕驱动确实使用了 DRM 框架。其工作原理大致如下：</p>
<ol>
<li>显示前端接收原始图像数据，进行预处理。</li>
<li>处理后的图像数据传递给显示后端，进行后处理和合成。</li>
<li>处理后的图像数据通过 TCON 生成正确的时序信号，驱动显示面板。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: (GPL-2.0+ OR X11)</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Copyright 2018 Icenowy Zheng &lt;icenowy@aosc.io&gt;</span><br><span class="line"> * Copyright 2018 Mesih Kilinc &lt;mesihkilinc@gmail.com&gt;</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; modify by kashine</span><br><span class="line">#include &lt;dt-bindings&#x2F;clock&#x2F;suniv-ccu-f1c100s.h&gt;&#x2F;&#x2F; 下面引用该文件中的一些宏定义</span><br><span class="line">#include &lt;dt-bindings&#x2F;reset&#x2F;suniv-ccu-f1c100s.h&gt;</span><br><span class="line"></span><br><span class="line">&#x2F; &#123;</span><br><span class="line">	#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">	#size-cells &#x3D; &lt;1&gt;;</span><br><span class="line">	interrupt-parent &#x3D; &lt;&amp;intc&gt;;</span><br><span class="line"></span><br><span class="line">	clocks &#123;</span><br><span class="line">		osc24M: clk-24M &#123;</span><br><span class="line">			#clock-cells &#x3D; &lt;0&gt;;</span><br><span class="line">			compatible &#x3D; &quot;fixed-clock&quot;;</span><br><span class="line">			clock-frequency &#x3D; &lt;24000000&gt;;</span><br><span class="line">			clock-output-names &#x3D; &quot;osc24M&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		osc32k: clk-32k &#123;</span><br><span class="line">			#clock-cells &#x3D; &lt;0&gt;;</span><br><span class="line">			compatible &#x3D; &quot;fixed-clock&quot;;</span><br><span class="line">			clock-frequency &#x3D; &lt;32768&gt;;</span><br><span class="line">			clock-output-names &#x3D; &quot;osc32k&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	cpus &#123;</span><br><span class="line">		cpu &#123;</span><br><span class="line">			compatible &#x3D; &quot;arm,arm926ej-s&quot;;</span><br><span class="line">			device_type &#x3D; &quot;cpu&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; modify by kashine</span><br><span class="line">	de: display-engine &#123;</span><br><span class="line">		compatible &#x3D; &quot;allwinner,suniv-f1c100s-display-engine&quot;;</span><br><span class="line">		allwinner,pipelines &#x3D; &lt;&amp;fe0&gt;;</span><br><span class="line">		status &#x3D; &quot;disabled&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	soc &#123;</span><br><span class="line">		compatible &#x3D; &quot;simple-bus&quot;;</span><br><span class="line">		#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		#size-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		ranges;</span><br><span class="line"></span><br><span class="line">		sram-controller@1c00000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-system-control&quot;,</span><br><span class="line">				     &quot;allwinner,sun4i-a10-system-control&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c00000 0x30&gt;;</span><br><span class="line">			#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">			#size-cells &#x3D; &lt;1&gt;;</span><br><span class="line">			ranges;</span><br><span class="line"></span><br><span class="line">			sram_d: sram@10000 &#123;</span><br><span class="line">				compatible &#x3D; &quot;mmio-sram&quot;;</span><br><span class="line">				reg &#x3D; &lt;0x00010000 0x1000&gt;;</span><br><span class="line">				#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">				#size-cells &#x3D; &lt;1&gt;;</span><br><span class="line">				ranges &#x3D; &lt;0 0x00010000 0x1000&gt;;</span><br><span class="line"></span><br><span class="line">				otg_sram: sram-section@0 &#123;</span><br><span class="line">					compatible &#x3D; &quot;allwinner,suniv-f1c100s-sram-d&quot;,</span><br><span class="line">						     &quot;allwinner,sun4i-a10-sram-d&quot;;</span><br><span class="line">					reg &#x3D; &lt;0x0000 0x1000&gt;;</span><br><span class="line">					status &#x3D; &quot;disabled&quot;;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; modify by kashine</span><br><span class="line">		tcon0: lcd-controller@1c0c000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-tcon&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c0c000 0x1000&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;29&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu CLK_BUS_LCD&gt;,</span><br><span class="line">				 &lt;&amp;ccu CLK_TCON&gt;;</span><br><span class="line">			clock-names &#x3D; &quot;ahb&quot;,</span><br><span class="line">				      &quot;tcon-ch0&quot;;</span><br><span class="line">			clock-output-names &#x3D; &quot;tcon-pixel-clock&quot;;</span><br><span class="line">			resets &#x3D; &lt;&amp;ccu RST_BUS_LCD&gt;;</span><br><span class="line">			reset-names &#x3D; &quot;lcd&quot;;</span><br><span class="line">			status &#x3D; &quot;disabled&quot;;</span><br><span class="line"></span><br><span class="line">			ports &#123;</span><br><span class="line">				#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">				#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line"></span><br><span class="line">				tcon0_in: port@0 &#123;</span><br><span class="line">					#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">					#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">					reg &#x3D; &lt;0&gt;;</span><br><span class="line"></span><br><span class="line">					tcon0_in_be0: endpoint@0 &#123;</span><br><span class="line">						reg &#x3D; &lt;0&gt;;</span><br><span class="line">						remote-endpoint &#x3D; &lt;&amp;be0_out_tcon0&gt;;</span><br><span class="line">					&#125;;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				tcon0_out: port@1 &#123;</span><br><span class="line">					#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">					#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">					reg &#x3D; &lt;1&gt;;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		ccu: clock@1c20000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-ccu&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c20000 0x400&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;osc24M&gt;, &lt;&amp;osc32k&gt;;</span><br><span class="line">			clock-names &#x3D; &quot;hosc&quot;, &quot;losc&quot;;</span><br><span class="line">			#clock-cells &#x3D; &lt;1&gt;;</span><br><span class="line">			#reset-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		intc: interrupt-controller@1c20400 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-ic&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c20400 0x400&gt;;</span><br><span class="line">			interrupt-controller;</span><br><span class="line">			#interrupt-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		pio: pinctrl@1c20800 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-pinctrl&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c20800 0x400&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;38&gt;, &lt;39&gt;, &lt;40&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu 37&gt;, &lt;&amp;osc24M&gt;, &lt;&amp;osc32k&gt;;</span><br><span class="line">			clock-names &#x3D; &quot;apb&quot;, &quot;hosc&quot;, &quot;losc&quot;;</span><br><span class="line">			gpio-controller;</span><br><span class="line">			interrupt-controller;</span><br><span class="line">			#interrupt-cells &#x3D; &lt;3&gt;;</span><br><span class="line">			#gpio-cells &#x3D; &lt;3&gt;;</span><br><span class="line"></span><br><span class="line">			uart0_pe_pins: uart0-pe-pins &#123;</span><br><span class="line">				pins &#x3D; &quot;PE0&quot;, &quot;PE1&quot;;</span><br><span class="line">				function &#x3D; &quot;uart0&quot;;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			&#x2F;&#x2F; modify by kashine</span><br><span class="line">			lcd_rgb666_pins: lcd-rgb666-pins &#123;</span><br><span class="line">				pins &#x3D; &quot;PD0&quot;, &quot;PD1&quot;, &quot;PD2&quot;, &quot;PD3&quot;, &quot;PD4&quot;,</span><br><span class="line">				       &quot;PD5&quot;, &quot;PD6&quot;, &quot;PD7&quot;, &quot;PD8&quot;, &quot;PD9&quot;,</span><br><span class="line">				       &quot;PD10&quot;, &quot;PD11&quot;, &quot;PD12&quot;, &quot;PD13&quot;, &quot;PD14&quot;,</span><br><span class="line">				       &quot;PD15&quot;, &quot;PD16&quot;, &quot;PD17&quot;, &quot;PD18&quot;, &quot;PD19&quot;,</span><br><span class="line">				       &quot;PD20&quot;, &quot;PD21&quot;;</span><br><span class="line">				function &#x3D; &quot;lcd&quot;;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			&#x2F;&#x2F; modify by kashine</span><br><span class="line">			mmc0_pins: mmc0-pins &#123;</span><br><span class="line">				pins &#x3D; &quot;PF0&quot;, &quot;PF1&quot;, &quot;PF2&quot;, &quot;PF3&quot;, &quot;PF4&quot;, &quot;PF5&quot;;</span><br><span class="line">				function &#x3D; &quot;mmc0&quot;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		timer@1c20c00 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-timer&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c20c00 0x90&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;13&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;osc24M&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		wdt: watchdog@1c20ca0 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-wdt&quot;,</span><br><span class="line">				     &quot;allwinner,sun4i-a10-wdt&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c20ca0 0x20&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		uart0: serial@1c25000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;snps,dw-apb-uart&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c25000 0x400&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;1&gt;;</span><br><span class="line">			reg-shift &#x3D; &lt;2&gt;;</span><br><span class="line">			reg-io-width &#x3D; &lt;4&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu 38&gt;;</span><br><span class="line">			resets &#x3D; &lt;&amp;ccu 24&gt;;</span><br><span class="line">			status &#x3D; &quot;disabled&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		uart1: serial@1c25400 &#123;</span><br><span class="line">			compatible &#x3D; &quot;snps,dw-apb-uart&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c25400 0x400&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;2&gt;;</span><br><span class="line">			reg-shift &#x3D; &lt;2&gt;;</span><br><span class="line">			reg-io-width &#x3D; &lt;4&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu 39&gt;;</span><br><span class="line">			resets &#x3D; &lt;&amp;ccu 25&gt;;</span><br><span class="line">			status &#x3D; &quot;disabled&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		uart2: serial@1c25800 &#123;</span><br><span class="line">			compatible &#x3D; &quot;snps,dw-apb-uart&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c25800 0x400&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;3&gt;;</span><br><span class="line">			reg-shift &#x3D; &lt;2&gt;;</span><br><span class="line">			reg-io-width &#x3D; &lt;4&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu 40&gt;;</span><br><span class="line">			resets &#x3D; &lt;&amp;ccu 26&gt;;</span><br><span class="line">			status &#x3D; &quot;disabled&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; modify by kashine</span><br><span class="line">		mmc0: mmc@1c0f000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-mmc&quot;,</span><br><span class="line">				     &quot;allwinner,sun7i-a20-mmc&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01c0f000 0x1000&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu CLK_BUS_MMC0&gt;,</span><br><span class="line">				 &lt;&amp;ccu CLK_MMC0&gt;,</span><br><span class="line">				 &lt;&amp;ccu CLK_MMC0_OUTPUT&gt;,</span><br><span class="line">				 &lt;&amp;ccu CLK_MMC0_SAMPLE&gt;;</span><br><span class="line">			clock-names &#x3D; &quot;ahb&quot;,</span><br><span class="line">					      &quot;mmc&quot;,</span><br><span class="line">					      &quot;output&quot;,</span><br><span class="line">				    	  &quot;sample&quot;;</span><br><span class="line">			resets &#x3D; &lt;&amp;ccu RST_BUS_MMC0&gt;;</span><br><span class="line">			reset-names &#x3D; &quot;ahb&quot;;</span><br><span class="line">			interrupts &#x3D; &lt;23&gt;;</span><br><span class="line">			pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">			pinctrl-0 &#x3D; &lt;&amp;mmc0_pins&gt;;</span><br><span class="line">			status &#x3D; &quot;disabled&quot;;</span><br><span class="line">			#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">			#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; modify by kashine</span><br><span class="line">		fe0: display-frontend@1e00000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-display-frontend&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01e00000 0x20000&gt;;</span><br><span class="line">			interrupts &#x3D; &lt;30&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu CLK_BUS_DE_FE&gt;, &lt;&amp;ccu CLK_DE_FE&gt;,</span><br><span class="line">				 &lt;&amp;ccu CLK_DRAM_DE_FE&gt;;</span><br><span class="line">			clock-names &#x3D; &quot;ahb&quot;, &quot;mod&quot;,</span><br><span class="line">				      &quot;ram&quot;;</span><br><span class="line">			resets &#x3D; &lt;&amp;ccu RST_BUS_DE_FE&gt;;</span><br><span class="line">			status &#x3D; &quot;disabled&quot;;</span><br><span class="line"></span><br><span class="line">			ports &#123;</span><br><span class="line">				#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">				#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line"></span><br><span class="line">				fe0_out: port@1 &#123;</span><br><span class="line">					#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">					#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">					reg &#x3D; &lt;1&gt;;</span><br><span class="line"></span><br><span class="line">					fe0_out_be0: endpoint@0 &#123;</span><br><span class="line">						reg &#x3D; &lt;0&gt;;</span><br><span class="line">						remote-endpoint &#x3D; &lt;&amp;be0_in_fe0&gt;;</span><br><span class="line">					&#125;;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; modify by kashine</span><br><span class="line">		be0: display-backend@1e60000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,suniv-f1c100s-display-backend&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01e60000 0x10000&gt;;</span><br><span class="line">			reg-names &#x3D; &quot;be&quot;;</span><br><span class="line">			interrupts &#x3D; &lt;31&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;ccu CLK_BUS_DE_BE&gt;, &lt;&amp;ccu CLK_DE_BE&gt;,</span><br><span class="line">				 &lt;&amp;ccu CLK_DRAM_DE_BE&gt;;</span><br><span class="line">			clock-names &#x3D; &quot;ahb&quot;, &quot;mod&quot;,</span><br><span class="line">				      &quot;ram&quot;;</span><br><span class="line">			resets &#x3D; &lt;&amp;ccu RST_BUS_DE_BE&gt;;</span><br><span class="line">			reset-names &#x3D; &quot;be&quot;;</span><br><span class="line">			assigned-clocks &#x3D; &lt;&amp;ccu CLK_DE_BE&gt;;</span><br><span class="line">			assigned-clock-rates &#x3D; &lt;300000000&gt;;</span><br><span class="line"></span><br><span class="line">			ports &#123;</span><br><span class="line">				#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">				#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line"></span><br><span class="line">				be0_in: port@0 &#123;</span><br><span class="line">					#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">					#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">					reg &#x3D; &lt;0&gt;;</span><br><span class="line"></span><br><span class="line">					be0_in_fe0: endpoint@0 &#123;</span><br><span class="line">						reg &#x3D; &lt;0&gt;;</span><br><span class="line">						remote-endpoint &#x3D; &lt;&amp;fe0_out_be0&gt;;</span><br><span class="line">					&#125;;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				be0_out: port@1 &#123;</span><br><span class="line">					#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">					#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">					reg &#x3D; &lt;1&gt;;</span><br><span class="line"></span><br><span class="line">					be0_out_tcon0: endpoint@0 &#123;</span><br><span class="line">						reg &#x3D; &lt;0&gt;;</span><br><span class="line">						remote-endpoint &#x3D; &lt;&amp;tcon0_in_be0&gt;;</span><br><span class="line">					&#125;;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; modify by kashine</span><br><span class="line">		pwm: pwm@1c21000 &#123;</span><br><span class="line">			compatible &#x3D; &quot;allwinner,sun4i-a10-pwm&quot;;</span><br><span class="line">			reg &#x3D; &lt;0x01C21000 0x08&gt;;</span><br><span class="line">			clocks &#x3D; &lt;&amp;osc24M&gt;;</span><br><span class="line">			#pwm-cells &#x3D; &lt;3&gt;;</span><br><span class="line">			status &#x3D; &quot;disabled&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>.dts文件</strong>做以下修改，添加了一个<strong>panel面板设备结点，</strong>对应4.3寸RGB屏幕，其compatible属性对应指定的显示驱动，我们将在后面提到；添加了<strong>backlight背光调节结点，</strong>设置了不同的背光等级；然后打开或修改了.dtsi文件中结点的功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SPDX-License-Identifier: (GPL-2.0+ OR X11)</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Copyright 2018 Icenowy Zheng &lt;icenowy@aosc.io&gt;</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;dts-v1&#x2F;;</span><br><span class="line">#include &quot;suniv-f1c100s.dtsi&quot;</span><br><span class="line">&#x2F;&#x2F; modify by kashine</span><br><span class="line">#include &lt;dt-bindings&#x2F;gpio&#x2F;gpio.h&gt;</span><br><span class="line">#include &lt;dt-bindings&#x2F;input&#x2F;input.h&gt;</span><br><span class="line">#include &lt;dt-bindings&#x2F;interrupt-controller&#x2F;irq.h&gt;</span><br><span class="line"></span><br><span class="line">&#x2F; &#123;</span><br><span class="line">	model &#x3D; &quot;Lichee Pi Nano&quot;;</span><br><span class="line">	compatible &#x3D; &quot;licheepi,licheepi-nano&quot;, &quot;allwinner,suniv-f1c100s&quot;;</span><br><span class="line"></span><br><span class="line">	aliases &#123;</span><br><span class="line">		serial0 &#x3D; &amp;uart0;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	chosen &#123;</span><br><span class="line">		stdout-path &#x3D; &quot;serial0:115200n8&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; modify by kashine </span><br><span class="line">	panel: panel &#123;&#x2F;&#x2F;ampire_am800480r3tmqwa1h_mode</span><br><span class="line">		compatible &#x3D; &quot;alientek,alientek_4p3_inch&quot;, &quot;simple-panel&quot;;</span><br><span class="line">		#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">		reset-gpios &#x3D; &lt;&amp;pio 4 4 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">		power-supply &#x3D; &lt;&amp;reg_vcc3v3&gt;;</span><br><span class="line">		&#x2F;&#x2F;backlight &#x3D; &lt;&amp;backlight&gt;;</span><br><span class="line"> 		port@0 &#123;</span><br><span class="line">			reg &#x3D; &lt;0&gt;;</span><br><span class="line">			#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">			#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line"></span><br><span class="line"> 			panel_input: endpoint@0 &#123;</span><br><span class="line">				reg &#x3D; &lt;0&gt;;</span><br><span class="line">				remote-endpoint &#x3D; &lt;&amp;tcon0_out_lcd&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; modify by kashine</span><br><span class="line">	reg_vcc3v3: vcc3v3 &#123;</span><br><span class="line">		compatible &#x3D; &quot;regulator-fixed&quot;;</span><br><span class="line">		regulator-name &#x3D; &quot;vcc3v3&quot;;</span><br><span class="line">		regulator-min-microvolt &#x3D; &lt;3300000&gt;;</span><br><span class="line">		regulator-max-microvolt &#x3D; &lt;3300000&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; modify by kashine</span><br><span class="line">	backlight: backlight &#123;</span><br><span class="line">		compatible &#x3D; &quot;pwm-backlight&quot;;</span><br><span class="line">		pwms &#x3D; &lt;&amp;pwm 1 500000 0&gt;;</span><br><span class="line">		pwm-names &#x3D; &quot;backlight&quot;;</span><br><span class="line"></span><br><span class="line">		brightness-levels &#x3D; &lt;0 4 8 16 32 64 128 255&gt;;</span><br><span class="line">		default-brightness-level &#x3D; &lt;7&gt;;</span><br><span class="line">		status &#x3D; &quot;okay&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;uart0 &#123;</span><br><span class="line">	pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">	pinctrl-0 &#x3D; &lt;&amp;uart0_pe_pins&gt;;</span><br><span class="line">	status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; modify by kashine all down</span><br><span class="line">&amp;mmc0 &#123;</span><br><span class="line">	vmmc-supply &#x3D; &lt;&amp;reg_vcc3v3&gt;;</span><br><span class="line">	bus-width &#x3D; &lt;4&gt;;</span><br><span class="line">	broken-cd;</span><br><span class="line">	status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;be0 &#123;</span><br><span class="line">	status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;de &#123;</span><br><span class="line">	status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;tcon0 &#123;</span><br><span class="line">	pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">	pinctrl-0 &#x3D; &lt;&amp;lcd_rgb666_pins&gt;;</span><br><span class="line">	status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;tcon0_out &#123;</span><br><span class="line">	tcon0_out_lcd: endpoint@0 &#123;</span><br><span class="line">		reg &#x3D; &lt;0&gt;;</span><br><span class="line">		remote-endpoint &#x3D; &lt;&amp;panel_input&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;pio &#123;</span><br><span class="line">	pwm1_pin: pwm1_pin &#123;</span><br><span class="line">		pins &#x3D; &quot;PE6&quot;;</span><br><span class="line">		function &#x3D; &quot;pwm1&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;pwm &#123;</span><br><span class="line">	pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">	pinctrl-0 &#x3D; &lt;&amp;pwm1_pin&gt;;</span><br><span class="line">	status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2、屏幕信息添加"><a href="#2、屏幕信息添加" class="headerlink" title="2、屏幕信息添加"></a>2、屏幕信息添加</h3><p>本文使用<strong>正点原子40Pin RGB 屏幕，分辨率为800*480，</strong>根据正点原子提供的资料，在内核目录**&#x2F;drivers&#x2F;gpu&#x2F;drm&#x2F;panel&#x2F;panel_simple.c<strong>中，填写屏幕</strong>时序信息**如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; modify by kashine</span><br><span class="line">static const struct drm_display_mode alientek_4p3_inch_mode &#x3D; &#123;</span><br><span class="line">	.clock &#x3D; 31000,</span><br><span class="line">	.hdisplay &#x3D; 800,</span><br><span class="line">	.hsync_start &#x3D; 800 + 40,</span><br><span class="line">	.hsync_end &#x3D; 800 + 40 + 48,</span><br><span class="line">	.htotal &#x3D; 800 + 40 + 48 + 88,</span><br><span class="line">	.vdisplay &#x3D; 480,</span><br><span class="line">	.vsync_start &#x3D; 480 + 13,</span><br><span class="line">	.vsync_end &#x3D; 480 + 13 + 3,</span><br><span class="line">	.vtotal &#x3D; 480 + 13 + 3 + 32,</span><br><span class="line">	.vrefresh &#x3D; 60,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct panel_desc alientek_4p3_inch &#x3D; &#123;</span><br><span class="line">	.modes &#x3D; &amp;alientek_4p3_inch_mode,</span><br><span class="line">	.num_modes &#x3D; 1,</span><br><span class="line">	.bpc &#x3D; 6,</span><br><span class="line">	.size &#x3D; &#123;</span><br><span class="line">		.width &#x3D; 154,</span><br><span class="line">		.height &#x3D; 85,</span><br><span class="line">	&#125;,</span><br><span class="line">	.bus_format &#x3D; MEDIA_BUS_FMT_RGB666_1X18,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>首先来解释<strong>alientek_4p3_inch_mode结构体</strong>中的<strong>参数含义</strong>，主要为<strong>屏幕的时序信息</strong>，设置错误可能导致显示错位、不完整。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">clock： RGB屏幕需要使用的时钟频率</span><br><span class="line">hdisplay：有效显示区水平像素数量，800*480中的800，对应Active Width</span><br><span class="line">hsync_start：水平同步开始，对应hdispay + HFP</span><br><span class="line">hsync_end：水平同步结束，对应hdisplay + HFP + HSYNC width(HSPW)</span><br><span class="line">htotal：水平总像素，对应hdisplay + HFP + HSYNC width + HBP</span><br><span class="line"></span><br><span class="line">vdisplay：垂直显示像素，800*480中的480，对应Active Height</span><br><span class="line">vsync_start：垂直同步开始，对应vdispay + VFP</span><br><span class="line">vsync_end：垂直像素结束，对应vdisplay + VFP + VSYNC width(VSPW)</span><br><span class="line">vtotal：垂直总像素，对应vdisplay + VFP + VSYNC width + VBP</span><br><span class="line"></span><br><span class="line">vrefresh：刷新率</span><br><span class="line"></span><br><span class="line">原文链接：https:&#x2F;&#x2F;blog.csdn.net&#x2F;u012794472&#x2F;article&#x2F;details&#x2F;124868025</span><br></pre></td></tr></table></figure>

<p><strong>alientek_4p3_inch结构体</strong>主要用来描述所用屏幕的信息，包括<strong>显示模式、像素格式等。</strong>其中<strong>MEDIA_BUS_FMT_RGB666_1X18</strong>的含义详见<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/userspace-api/media/v4l/subdev-formats.html?highlight=media_bus_fmt_uyvy8_2x8">The Linux Kernel documentation</a>。<strong>width、height为液晶的尺寸，</strong>需要根据屏幕的用户<strong>使用手册</strong>进行设置，如下图所示为本文使用的ATK4384屏幕尺寸图。</p>
<img src="/posts/undefined/1b4c1bc5fa42ef9c8a7a396ed065a7cb.png" class="" title="img">

<p>另一处需要修改的地方如下所示，添加设备树对应的<strong>设备驱动绑定信息。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	.data &#x3D; &amp;vl050_8048nt_c01,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	.compatible &#x3D; &quot;winstar,wf35ltiacd&quot;,</span><br><span class="line">	.data &#x3D; &amp;winstar_wf35ltiacd,</span><br><span class="line">&#125;, &#123;&#x2F;&#x2F; modify by kashine</span><br><span class="line">		.compatible &#x3D; &quot;alientek,alientek_4p3_inch&quot;,</span><br><span class="line">		.data &#x3D; &amp;alientek_4p3_inch,</span><br><span class="line">&#125;,&#123;</span><br><span class="line">	&#x2F;* Must be the last entry *&#x2F;</span><br><span class="line">	.compatible &#x3D; &quot;panel-dpi&quot;,</span><br><span class="line">	.data &#x3D; &amp;panel_dpi,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	&#x2F;* sentinel *&#x2F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、内核驱动修改"><a href="#3、内核驱动修改" class="headerlink" title="3、内核驱动修改"></a>3、内核驱动修改</h3><p>以下为核心内容，本人尝试了<strong>坑网、CSDN、荔枝派、芒果派</strong>等的众多教程，历经多次内核修改与编译，最终整理出<strong>关于F1C200s在**Linux5.7.1内核**下的RGB驱动修改方法**如下。主要修改文件为内核目录</strong>&#x2F;drivers&#x2F;gpu&#x2F;drm&#x2F;sun4i&#x2F;<strong>文件夹下的三个文件，分别为</strong>sun4i_tcon.c、sun4i_drv.c、sun4i_backend.c。**以下修改内容主要是为了使驱动适配F1C200s这款芯片。</p>
<p><strong>可以根据代码中注释及前后内容，定位三个文件需要修改的地方。</strong></p>
<p><strong>&#x2F;&#x2F; sun4i_backend.c文件修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; modify by kashine </span><br><span class="line">static const struct sun4i_backend_quirks suniv_backend_quirks &#x3D; &#123;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct sun4i_backend_quirks sun4i_backend_quirks &#x3D; &#123;</span><br><span class="line">	.needs_output_muxing &#x3D; true,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct sun4i_backend_quirks sun5i_backend_quirks &#x3D; &#123;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct sun4i_backend_quirks sun6i_backend_quirks &#x3D; &#123;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct sun4i_backend_quirks sun7i_backend_quirks &#x3D; &#123;</span><br><span class="line">	.needs_output_muxing &#x3D; true,</span><br><span class="line">	.supports_lowest_plane_alpha &#x3D; true,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct sun4i_backend_quirks sun8i_a33_backend_quirks &#x3D; &#123;</span><br><span class="line">	.supports_lowest_plane_alpha &#x3D; true,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct sun4i_backend_quirks sun9i_backend_quirks &#x3D; &#123;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct of_device_id sun4i_backend_of_table[] &#x3D; &#123;</span><br><span class="line">	&#123;&#x2F;&#x2F; modify by kashine</span><br><span class="line">		.compatible &#x3D; &quot;allwinner,suniv-f1c100s-display-backend&quot;,</span><br><span class="line">		.data &#x3D; &amp;suniv_backend_quirks,</span><br><span class="line">	&#125;,</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		.compatible &#x3D; &quot;allwinner,sun4i-a10-display-backend&quot;,</span><br><span class="line">		.data &#x3D; &amp;sun4i_backend_quirks,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.compatible &#x3D; &quot;allwinner,sun5i-a13-display-backend&quot;,</span><br><span class="line">		.data &#x3D; &amp;sun5i_backend_quirks,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.compatible &#x3D; &quot;allwinner,sun6i-a31-display-backend&quot;,</span><br><span class="line">		.data &#x3D; &amp;sun6i_backend_quirks,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.compatible &#x3D; &quot;allwinner,sun7i-a20-display-backend&quot;,</span><br><span class="line">		.data &#x3D; &amp;sun7i_backend_quirks,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.compatible &#x3D; &quot;allwinner,sun8i-a23-display-backend&quot;,</span><br><span class="line">		.data &#x3D; &amp;sun8i_a33_backend_quirks,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.compatible &#x3D; &quot;allwinner,sun8i-a33-display-backend&quot;,</span><br><span class="line">		.data &#x3D; &amp;sun8i_a33_backend_quirks,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.compatible &#x3D; &quot;allwinner,sun9i-a80-display-backend&quot;,</span><br><span class="line">		.data &#x3D; &amp;sun9i_backend_quirks,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>&#x2F;&#x2F; sun4i_drv.c文件修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">static bool sun4i_drv_node_is_frontend(struct device_node *node)</span><br><span class="line">&#123;</span><br><span class="line">		&#x2F;&#x2F; modify by kashine</span><br><span class="line">	return of_device_is_compatible(node, &quot;allwinner,suniv-f1c100s-display-frontend&quot;) ||</span><br><span class="line">	    of_device_is_compatible(node, &quot;allwinner,sun4i-a10-display-frontend&quot;) ||</span><br><span class="line">		of_device_is_compatible(node, &quot;allwinner,sun5i-a13-display-frontend&quot;) ||</span><br><span class="line">		of_device_is_compatible(node, &quot;allwinner,sun6i-a31-display-frontend&quot;) ||</span><br><span class="line">		of_device_is_compatible(node, &quot;allwinner,sun7i-a20-display-frontend&quot;) ||</span><br><span class="line">		of_device_is_compatible(node, &quot;allwinner,sun8i-a23-display-frontend&quot;) ||</span><br><span class="line">		of_device_is_compatible(node, &quot;allwinner,sun8i-a33-display-frontend&quot;) ||</span><br><span class="line">		of_device_is_compatible(node, &quot;allwinner,sun9i-a80-display-frontend&quot;);</span><br><span class="line">&#125;</span><br><span class="line">static const struct of_device_id sun4i_drv_of_table[] &#x3D; &#123;</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,suniv-f1c100s-display-engine&quot; &#125;,&#x2F;&#x2F; modify by kashine</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun4i-a10-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun5i-a10s-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun5i-a13-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun6i-a31-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun6i-a31s-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun7i-a20-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a23-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a33-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a83t-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-h3-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-r40-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-v3s-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun9i-a80-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun50i-a64-display-engine&quot; &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun50i-h6-display-engine&quot; &#125;,</span><br><span class="line">	&#123; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p> <strong>&#x2F;&#x2F; sun4i_tcon.c文件修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; modify by kashine</span><br><span class="line">static const struct sun4i_tcon_quirks suniv_f1c100s_quirks &#x3D; &#123;</span><br><span class="line">	&#x2F;*</span><br><span class="line">	 * The F1C100s SoC has a second channel in TCON, but the clock input of</span><br><span class="line">	 * it is not documented.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	.has_channel_0		&#x3D; true,</span><br><span class="line">	&#x2F;&#x2F;.has_channel_1	&#x3D; true,</span><br><span class="line">	.dclk_min_div		&#x3D; 1,&#x2F;&#x2F; Linux5.2不需要加，5.7.1不加该代码会白屏</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct sun4i_tcon_quirks sun4i_a10_quirks &#x3D; &#123;</span><br><span class="line">	.has_channel_0		&#x3D; true,</span><br><span class="line">	.has_channel_1		&#x3D; true,</span><br><span class="line">	.dclk_min_div		&#x3D; 4,</span><br><span class="line">	.set_mux		&#x3D; sun4i_a10_tcon_set_mux,</span><br><span class="line">&#125;;</span><br><span class="line">&#x2F;* sun4i_drv uses this list to check if a device node is a TCON *&#x2F;</span><br><span class="line">const struct of_device_id sun4i_tcon_of_table[] &#x3D; &#123;</span><br><span class="line">	&#123;.compatible &#x3D; &quot;allwinner,suniv-f1c100s-tcon&quot;, .data &#x3D; &amp;suniv_f1c100s_quirks &#125;,&#x2F;&#x2F; modify by kashine</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun4i-a10-tcon&quot;, .data &#x3D; &amp;sun4i_a10_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun5i-a13-tcon&quot;, .data &#x3D; &amp;sun5i_a13_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun6i-a31-tcon&quot;, .data &#x3D; &amp;sun6i_a31_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun6i-a31s-tcon&quot;, .data &#x3D; &amp;sun6i_a31s_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun7i-a20-tcon&quot;, .data &#x3D; &amp;sun7i_a20_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun7i-a20-tcon0&quot;, .data &#x3D; &amp;sun7i_a20_tcon0_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun7i-a20-tcon1&quot;, .data &#x3D; &amp;sun7i_a20_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a23-tcon&quot;, .data &#x3D; &amp;sun8i_a33_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a33-tcon&quot;, .data &#x3D; &amp;sun8i_a33_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a83t-tcon-lcd&quot;, .data &#x3D; &amp;sun8i_a83t_lcd_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a83t-tcon-tv&quot;, .data &#x3D; &amp;sun8i_a83t_tv_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-r40-tcon-tv&quot;, .data &#x3D; &amp;sun8i_r40_tv_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-v3s-tcon&quot;, .data &#x3D; &amp;sun8i_v3s_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun9i-a80-tcon-lcd&quot;, .data &#x3D; &amp;sun9i_a80_tcon_lcd_quirks &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun9i-a80-tcon-tv&quot;, .data &#x3D; &amp;sun9i_a80_tcon_tv_quirks &#125;,</span><br><span class="line">	&#123; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4、开机logo显示"><a href="#4、开机logo显示" class="headerlink" title="4、开机logo显示"></a>4、开机logo显示</h3><p>使用<strong>make menuconfig</strong>打开图形化配置界面，打开Bootup logo，其中的<strong>三个选项全部选中。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-&gt; Device Drivers</span><br><span class="line">	 -&gt; Graphics support </span><br><span class="line">		 -&gt; Bootup logo (LOGO [&#x3D;y]) </span><br><span class="line">		 	-&gt; Standard black and white Linux logo </span><br><span class="line">		 	-&gt; Standard 16-color Linux logo </span><br><span class="line">		 	-&gt; Standard 224-color Linux logo</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/74b3b4970c6753717f3bb64136e14546.png" class="" title="img">

<p><strong>背光选项</strong>记得勾上（其实不勾也可以）。</p>
<img src="/posts/undefined/4ba183fcb645e81a0055b540cdbd00e8.png" class="" title="img">

<hr>
<h2 id="三、RGB屏幕显示功能测试"><a href="#三、RGB屏幕显示功能测试" class="headerlink" title="三、RGB屏幕显示功能测试"></a>三、RGB屏幕显示功能测试</h2><p>修改完上述内核文件后，<strong>重新编译，</strong>编译所需的时间相比于初次编译要短很多。在uboot的<strong>bootargs参数</strong>中添加如下内容****可使内核输出更多drm相关信息，****便于调试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drm.debug&#x3D;0x1f debug</span><br></pre></td></tr></table></figure>

<p>如图所示为开发板<strong>上电启动</strong>过程中<strong>RGB屏幕显示的内容，</strong>启动时左上角<strong>显示Linux logo，</strong>符合我们的预期。</p>
<img src="/posts/undefined/40078685723141a92e1f0690baad9ec0.jpeg" class="" title="img">

<img src="/posts/undefined/e7ce14f948df141a0cf540516d52c95a.jpeg" class="" title="img">

<img src="/posts/undefined/b6b9a37ad3171b4367a49ad6e24b5767.jpeg" class="" title="img">

<p>进入Debian文件系统后，可以使用如下命令<strong>查看日志的输出级别</strong>（在Linux中日志一共分为8个等级，数值越小，优先级越高）下面的四个数字是由<strong>kernel&#x2F;printk.c</strong>文件中定义的一个数组决定的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;printk</span><br><span class="line"># 默认输出7 4 1 7</span><br></pre></td></tr></table></figure>

<p>上面四个数字的<strong>含别如下：</strong></p>
<blockquote>
<p><strong>控制台日志级别：</strong>优先级高于该值的消息将被打印至控制台<br><strong>默认的消息日志级别：</strong>将用该优先级来打印没有优先级的消息<br><strong>最低的控制台日志级别：</strong>控制台日志级别可被设置的最小值(最高优先级)<br><strong>默认的控制台日志级别：</strong>控制台日志级别的缺省值</p>
</blockquote>
<p>如果觉得开机之后输出的<strong>日志信息太多</strong>，可以使用如下命令修改打印的日志信息级别，减少不必要的信息干扰。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 屏蔽掉所有的内核printk打印</span><br><span class="line">echo 0 4 1 7 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;printk </span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、屏幕背光调节功能测试"><a href="#四、屏幕背光调节功能测试" class="headerlink" title="四、屏幕背光调节功能测试"></a>四、屏幕背光调节功能测试</h2><img src="/posts/undefined/2d6e05c914c3bd9742a6da2c13f15b0f.png" class="" title="img">

<p>通过<strong>PE6管脚</strong>输出PWM波，控制屏幕<strong>背光引脚</strong>，进而控制屏幕亮度，本文在设备树中设置了<strong>八个亮度等级，</strong>通过在<strong>脚本（.sh文件，并chomd权限）</strong>中输入以下代码可以<strong>控制亮度变化。</strong>（这里有个小问题，输入零的时候并没有熄屏，留个小坑吧）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">while true</span><br><span class="line">do</span><br><span class="line">        for i in &#123;7..1&#125;</span><br><span class="line">        do</span><br><span class="line">                sleep 0.2</span><br><span class="line">                echo $i &gt; &#x2F;sys&#x2F;class&#x2F;backlight&#x2F;backlight&#x2F;brightness</span><br><span class="line">        done</span><br><span class="line"></span><br><span class="line">        for j in &#123;1..7&#125;</span><br><span class="line">        do</span><br><span class="line">                echo $j &gt; &#x2F;sys&#x2F;class&#x2F;backlight&#x2F;backlight&#x2F;brightness</span><br><span class="line">                sleep 0.2</span><br><span class="line">        done</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、主要参考内容"><a href="#五、主要参考内容" class="headerlink" title="五、主要参考内容"></a>五、主要参考内容</h2><p>1.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27350133/article/details/124602894">RGB接口 LCD驱动适配</a>；</p>
<p>2.<a target="_blank" rel="noopener" href="https://blog.csdn.net/GJF712/article/details/126446054">Lctech Pi(F1C200S)4.3寸(480*272)16位RGB565LCD屏驱动适配</a> ；</p>
<p>3.<a target="_blank" rel="noopener" href="https://whycan.com/t_2896.html">解决f1c100s 主线Linux 升级到 4.19 之后的版本没有 framebuffer(fb0)设备问题(Linux5.2)</a>；</p>
<p>4.<a target="_blank" rel="noopener" href="https://blog.csdn.net/GUOYIHONEY/article/details/46928317">修改Linux kernel中打印的级别</a>；</p>
<p>5.<a target="_blank" rel="noopener" href="https://whycan.com/t_7627.html">f1c100s驱动rgb屏求助</a>；</p>
<p>6.<a target="_blank" rel="noopener" href="https://whycan.com/t_8630.html">更换正点原子7寸RGB LCD(1024*600)，启动失败</a></p>
<p>7.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21792169/article/details/51034165">ttyS、ttySAC、tty、ttyn的区别_HeroKern的博客-CSDN博客_ttytcu0和ttyths0的区别</a>。</p>
<h1 id="GT1151触摸屏驱动"><a href="#GT1151触摸屏驱动" class="headerlink" title="GT1151触摸屏驱动"></a>GT1151触摸屏驱动</h1><h2 id="一、AT4384-RGB屏幕触摸芯片"><a href="#一、AT4384-RGB屏幕触摸芯片" class="headerlink" title="一、AT4384 RGB屏幕触摸芯片"></a>一、AT4384 RGB屏幕触摸芯片</h2><p>使用正点原子屏幕的朋友<strong>一定要注意</strong>，<strong>以前原子的触摸屏的触摸芯片是gt9147的</strong>，教程里的也是gt9147的驱动，后来，大概在2021年5月份前后，原子的4.3寸屏<strong>更换了触摸芯片</strong>了，触摸芯片型号是<strong>gt1151</strong>的。所以，后期买屏幕的朋友可能拿到屏幕的芯片不是gt9147的了，所以按照教程或者前面的帖子来改的话，可能是无法触摸的。<strong>所以说，一定要先确定自己触摸屏幕的触摸芯片型号。</strong></p>
<img src="/posts/undefined/91b0d9622140496ef88ccd5382568427.png" class="" title="img"><img src="/posts/undefined/34162a1faf92c78e40ba0e92dd99a3b8.png" class="" title="img">

<hr>
<h2 id="二、设备树修改"><a href="#二、设备树修改" class="headerlink" title="二、设备树修改"></a>二、设备树修改</h2><h3 id="1、-dtsi文件修改"><a href="#1、-dtsi文件修改" class="headerlink" title="1、.dtsi文件修改"></a>1、.dtsi文件修改</h3><p>dtsi文件中添加如下内容，在<strong>pio结点</strong>下对本次实验所用到的管脚进行<strong>功能复用</strong>，所用到的功能为<strong>I2C通信功能、GPIO输出复位功能、中断检测功能。</strong>其中，I2C选择i2c0，也就是PE11、PE12，复位管脚选择PE4，中断检测管脚选择PE3，这是我们的<strong>硬件决定</strong>的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">pio: pinctrl@1c20800 &#123;</span><br><span class="line">	compatible &#x3D; &quot;allwinner,suniv-f1c100s-pinctrl&quot;;</span><br><span class="line">	reg &#x3D; &lt;0x01c20800 0x400&gt;;</span><br><span class="line">	interrupts &#x3D; &lt;38&gt;, &lt;39&gt;, &lt;40&gt;;</span><br><span class="line">	clocks &#x3D; &lt;&amp;ccu 37&gt;, &lt;&amp;osc24M&gt;, &lt;&amp;osc32k&gt;;</span><br><span class="line">	clock-names &#x3D; &quot;apb&quot;, &quot;hosc&quot;, &quot;losc&quot;;</span><br><span class="line">	gpio-controller;</span><br><span class="line">	interrupt-controller;</span><br><span class="line">	#interrupt-cells &#x3D; &lt;3&gt;;</span><br><span class="line">	#gpio-cells &#x3D; &lt;3&gt;;</span><br><span class="line"></span><br><span class="line">	uart0_pe_pins: uart0-pe-pins &#123;</span><br><span class="line">		pins &#x3D; &quot;PE0&quot;, &quot;PE1&quot;;</span><br><span class="line">		function &#x3D; &quot;uart0&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; modify by kashine</span><br><span class="line">	lcd_rgb666_pins: lcd-rgb666-pins &#123;</span><br><span class="line">		pins &#x3D; &quot;PD0&quot;, &quot;PD1&quot;, &quot;PD2&quot;, &quot;PD3&quot;, &quot;PD4&quot;,</span><br><span class="line">			   &quot;PD5&quot;, &quot;PD6&quot;, &quot;PD7&quot;, &quot;PD8&quot;, &quot;PD9&quot;,</span><br><span class="line">			   &quot;PD10&quot;, &quot;PD11&quot;, &quot;PD12&quot;, &quot;PD13&quot;, &quot;PD14&quot;,</span><br><span class="line">			   &quot;PD15&quot;, &quot;PD16&quot;, &quot;PD17&quot;, &quot;PD18&quot;, &quot;PD19&quot;,</span><br><span class="line">			   &quot;PD20&quot;, &quot;PD21&quot;;</span><br><span class="line">		function &#x3D; &quot;lcd&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; modify by kashine</span><br><span class="line">	mmc0_pins: mmc0-pins &#123;</span><br><span class="line">		pins &#x3D; &quot;PF0&quot;, &quot;PF1&quot;, &quot;PF2&quot;, &quot;PF3&quot;, &quot;PF4&quot;, &quot;PF5&quot;;</span><br><span class="line">		function &#x3D; &quot;mmc0&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; modify by kashine 2</span><br><span class="line">	i2c0_pins: i2c0_pins &#123;</span><br><span class="line">		pins &#x3D; &quot;PE11&quot;, &quot;PE12&quot;;</span><br><span class="line">		function &#x3D; &quot;i2c0&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; modify by kashine 2</span><br><span class="line">	ts_reset_pin: ts_reset_pin &#123;</span><br><span class="line">		pins &#x3D; &quot;PE4&quot;;</span><br><span class="line">		function &#x3D; &quot;gpio_out&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line">	ts_int_pin: ts_int_pin &#123;</span><br><span class="line">		pins &#x3D; &quot;PE3&quot;;</span><br><span class="line">		function &#x3D; &quot;gpio_in&quot;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在<strong>soc结点</strong>下添加<strong>i2c0结点</strong>， 描述了i2c0对应的驱动、时钟和所用管脚等信息，在.dtsi文件中该结点的状态属性值为disabled，这意味着需要在.dts文件中<strong>使能</strong>该结点功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">i2c0: i2c@1C27000 &#123;</span><br><span class="line">	compatible &#x3D; &quot;allwinner,sun6i-a31-i2c&quot;;</span><br><span class="line">	reg &#x3D; &lt;0x01C27000 0x400&gt;;</span><br><span class="line">	interrupts &#x3D; &lt;7&gt;;</span><br><span class="line">	clocks &#x3D; &lt;&amp;ccu CLK_BUS_I2C0&gt;;</span><br><span class="line">	resets &#x3D; &lt;&amp;ccu RST_BUS_I2C0&gt;;</span><br><span class="line">	pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">	pinctrl-0 &#x3D; &lt;&amp;i2c0_pins&gt;;</span><br><span class="line">	status &#x3D; &quot;disabled&quot;;</span><br><span class="line">	#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">	#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2、-dts文件修改"><a href="#2、-dts文件修改" class="headerlink" title="2、.dts文件修改"></a>2、.dts文件修改</h3><p>dts文件添加以下内容，<strong>gt1151触摸屏</strong>对应的驱动为<strong>**goodix,gt1151ATK4384，*<em><strong>对于该驱动的编写，我们将在下一节进行描述。</strong>注意：gt1151器件地址和gt9147相同，都是0x14。</em>*每个I2C器件都有一个设备地址，通过发送具体的设备地址来决定访问哪个I2C器件。</strong>I2C设备的读写地址和I2C设备地址不同<strong>，I2C设备的读写地址是一个</strong>8位的数据，<strong>其中高7位是</strong>设备地址，<strong>最后1位是</strong>读写位，**为1的话表示这是一个读操作，为0的话表示这是一个写操作。 I2C设备的写地址 &#x3D; I2C设备地址 &lt;&lt; 1，I2C设备的读地址 &#x3D; (I2C设备地址 &lt;&lt; 1) + 1。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c0 &#123;</span><br><span class="line">    status &#x3D; &quot;okay&quot;;</span><br><span class="line"></span><br><span class="line">    gt1151: touchscreen@14 &#123;</span><br><span class="line">        compatible &#x3D; &quot;goodix,gt1151ATK4384&quot;;&#x2F;&#x2F; &quot;goodix,gt1151&quot;;</span><br><span class="line">        reg &#x3D; &lt;0x14&gt;;&#x2F;&#x2F; gt1151器件地址，器件地址是I2C器件固有的地址编码，器件出厂时已经给定，不可更改</span><br><span class="line">        interrupt-parent &#x3D; &lt;&amp;pio&gt;;</span><br><span class="line">        interrupts &#x3D; &lt;4 3 IRQ_TYPE_EDGE_FALLING&gt;; &#x2F;* (PE3) *&#x2F;</span><br><span class="line">        pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">		pinctrl-0 &#x3D; &lt;&amp;ts_int_pin&gt;;</span><br><span class="line">        reset-gpios &#x3D; &lt;&amp;pio 4 4 GPIO_ACTIVE_LOW&gt;; &#x2F;* RST (PE4) *&#x2F;</span><br><span class="line">        interrupt-gpios &#x3D; &lt;&amp;pio 4 3 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">		touchscreen-size-x &#x3D; &lt;800&gt;;</span><br><span class="line">		touchscreen-size-y &#x3D; &lt;480&gt;;</span><br><span class="line">		touchscreen-swapped-x-y;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、驱动编写"><a href="#三、驱动编写" class="headerlink" title="三、驱动编写"></a>三、驱动编写</h2><h3 id="1、驱动分析"><a href="#1、驱动分析" class="headerlink" title="1、驱动分析"></a>1、驱动分析</h3><p>驱动程序编写主要参考《正点原子开发指南》，在裸机开发中进行触摸屏的驱动，主要流程如下：</p>
<blockquote>
<p> ①、电容触摸屏是<strong>IIC接口的</strong>，需要触摸 IC，以正点原子的 ATK4384 为例，其所使用的触<br>摸屏控制 IC 为GT1151，因此所谓的电容触摸驱动就是 IIC设备驱动。<br> ②、触摸IC提供了<strong>中断信号引脚(INT)，</strong>可以通过中断来获取触摸信息。<br> ③、电容触摸屏得到的是触摸位置绝对信息以及触摸屏是否有按下。<br> ④、电容触摸屏不需要校准，当然了，这只是理论上的，如果电容触摸屏质量比较差，或<br>者触摸玻璃和 TFT 之间没有完全对齐，那么也是需要校准的。 </p>
</blockquote>
<p> 那么电容触摸屏的Linux驱动主要需要以下<strong>几个驱动框架的组合：</strong></p>
<blockquote>
<p> ①、IIC 设备驱动，因为电容触摸IC基本<strong>都是IIC接口的</strong>，因此大框架就是<em><strong>*IIC设备驱动。*</strong></em><br> ②、<strong>通过中断引脚(INT)<strong>向linux内核上报触摸信息，因此需要用到linux</strong>中断驱动框架。</strong>坐<br>标的上报在中断服务函数中完成。<br> ③、触摸屏的<strong>坐标信息、屏幕按下和抬起信息</strong>都属于linux的<strong>input子系统</strong>，因此向 linux 内<br>核上报触摸屏坐标信息就得使用input子系统。</p>
</blockquote>
<h3 id="2、驱动代码"><a href="#2、驱动代码" class="headerlink" title="2、驱动代码"></a>2、驱动代码</h3><p>我们根据上面的分析编写了如下的<strong>gt1151的触摸屏驱动程序，</strong>至于代码的的<strong>详细解释</strong>，请参考正点原子官方文档，或者代码中注释，不在此处赘述。<strong>设备（设备树结点）和驱动匹配成功之后，gt1151probe函数就会执行，</strong>在该函数内部获取设备树终端和复位引脚、复位并初始化gt1151、获取设备信息后注册input设备，最后初始化中断。<strong>注意：设备树匹配表gt1151_of_match_table中的.compatible &#x3D; “goodix,gt1151ATK4384”用来连接设备树和驱动，在设备树中的compatible一定要于此处完全相同！</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; gt1151驱动代码</span><br><span class="line">#include &lt;linux&#x2F;module.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;i2c.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;regmap.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;gpio&#x2F;consumer.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;of_irq.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;interrupt.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;input.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;input&#x2F;mt.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;debugfs.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;delay.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;slab.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;gpio.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;of_gpio.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;input&#x2F;mt.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;input&#x2F;touchscreen.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;i2c.h&gt;</span><br><span class="line">#include &lt;asm&#x2F;unaligned.h&gt;</span><br><span class="line"></span><br><span class="line">#define GT_CTRL_REG 	        0X8040  &#x2F;* GT1151控制寄存器         *&#x2F;</span><br><span class="line">#define GT_MODSW_REG 	        0X804D  &#x2F;* GT1151模式切换寄存器        *&#x2F;</span><br><span class="line">#define GT_9xx_CFGS_REG 	    0X8047  &#x2F;* GT1151配置起始地址寄存器    *&#x2F;</span><br><span class="line">#define GT_1xx_CFGS_REG 	    0X8050  &#x2F;* GT1151配置起始地址寄存器    *&#x2F;</span><br><span class="line">#define GT_CHECK_REG 	        0X80FF  &#x2F;* GT1151校验和寄存器       *&#x2F;</span><br><span class="line">#define GT_PID_REG 		        0X8140  &#x2F;* GT1151产品ID寄存器       *&#x2F;</span><br><span class="line"></span><br><span class="line">#define GT_GSTID_REG 	        0X814E  &#x2F;* GT1151当前检测到的触摸情况 *&#x2F;</span><br><span class="line">#define GT_TP1_REG 		        0X814F  &#x2F;* 第一个触摸点数据地址 *&#x2F;</span><br><span class="line">#define GT_TP2_REG 		        0X8157	&#x2F;* 第二个触摸点数据地址 *&#x2F;</span><br><span class="line">#define GT_TP3_REG 		        0X815F  &#x2F;* 第三个触摸点数据地址 *&#x2F;</span><br><span class="line">#define GT_TP4_REG 		        0X8167  &#x2F;* 第四个触摸点数据地址  *&#x2F;</span><br><span class="line">#define GT_TP5_REG 		        0X816F	&#x2F;* 第五个触摸点数据地址   *&#x2F;</span><br><span class="line">#define MAX_SUPPORT_POINTS      5       &#x2F;* 最多5点电容触摸 *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 存放电容触摸设备相关属性信息</span><br><span class="line">struct gt1151_dev &#123;</span><br><span class="line">	int irq_pin,reset_pin;					&#x2F;* 中断和复位IO		*&#x2F;</span><br><span class="line">	int irqnum;								&#x2F;* 中断号    		*&#x2F;</span><br><span class="line">	int irqtype;							&#x2F;* 中断类型         *&#x2F;</span><br><span class="line">	int max_x;								&#x2F;* 最大横坐标   	*&#x2F;</span><br><span class="line">	int max_y; 								&#x2F;* 最大纵坐标		*&#x2F;</span><br><span class="line">	void *private_data;						&#x2F;* 私有数据 		*&#x2F;</span><br><span class="line">	struct input_dev *input;				&#x2F;* input结构体 		*&#x2F;</span><br><span class="line">	struct i2c_client *client;				&#x2F;* I2C客户端 		*&#x2F;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line">struct gt1151_dev gt1151;</span><br><span class="line"></span><br><span class="line">const u8 irq_table[] &#x3D; &#123;IRQ_TYPE_EDGE_RISING, IRQ_TYPE_EDGE_FALLING, IRQ_TYPE_LEVEL_LOW, IRQ_TYPE_LEVEL_HIGH&#125;;  &#x2F;* 触发方式 *&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 复位GT1151</span><br><span class="line">static int gt1151_ts_reset(struct i2c_client *client, struct gt1151_dev *dev)</span><br><span class="line">&#123;</span><br><span class="line">	int ret &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    &#x2F;* 申请复位IO*&#x2F;</span><br><span class="line">	if (gpio_is_valid(dev-&gt;reset_pin)) &#123;  		</span><br><span class="line">		&#x2F;* 申请复位IO，并且默认输出高电平 *&#x2F;</span><br><span class="line">		ret &#x3D; devm_gpio_request_one(&amp;client-&gt;dev,	</span><br><span class="line">					dev-&gt;reset_pin, GPIOF_OUT_INIT_HIGH,</span><br><span class="line">					&quot;gt1151 reset&quot;);</span><br><span class="line">		if (ret) &#123;</span><br><span class="line">			return ret;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;* 初始化GT1151，要严格按照GT1151时序要求 *&#x2F;</span><br><span class="line">    gpio_set_value(dev-&gt;reset_pin, 0); &#x2F;* 复位GT1151 *&#x2F;</span><br><span class="line">    msleep(10);</span><br><span class="line"></span><br><span class="line">    gpio_set_value(dev-&gt;reset_pin, 1); &#x2F;* 停止复位GT1151 *&#x2F;</span><br><span class="line">    msleep(10);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; gpio_set_value(dev-&gt;irq_pin, 0);    &#x2F;* 拉低INT引脚 *&#x2F;</span><br><span class="line">    &#x2F;&#x2F; msleep(50);</span><br><span class="line">	</span><br><span class="line">    &#x2F;&#x2F; gpio_direction_input(dev-&gt;irq_pin); &#x2F;* INT引脚设置为输入 *&#x2F;</span><br><span class="line">	</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 从GT1151读取多个寄存器数据</span><br><span class="line">static int gt1151_read_regs(struct gt1151_dev *dev, u16 reg, u8 *buf, int len)</span><br><span class="line">&#123;</span><br><span class="line">	int ret;</span><br><span class="line">    u8 regdata[2];</span><br><span class="line">	struct i2c_msg msg[2];</span><br><span class="line">	struct i2c_client *client &#x3D; (struct i2c_client *)dev-&gt;client;</span><br><span class="line">    </span><br><span class="line">    &#x2F;* GT1151寄存器长度为2个字节 *&#x2F;</span><br><span class="line">    regdata[0] &#x3D; reg &gt;&gt; 8;</span><br><span class="line">    regdata[1] &#x3D; reg &amp; 0xFF;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 别和SPI通信方式搞混了</span><br><span class="line">	&#x2F;* msg[0]为发送要读取的首地址 *&#x2F;</span><br><span class="line">	msg[0].addr &#x3D; client-&gt;addr;			&#x2F;* gt1151地址 应该是设备树中的器件地址 *&#x2F;</span><br><span class="line">	msg[0].flags &#x3D; !I2C_M_RD;			&#x2F;* 标记为发送数据 *&#x2F;</span><br><span class="line">	msg[0].buf &#x3D; &amp;regdata[0];			&#x2F;* 读取的首地址 *&#x2F;</span><br><span class="line">	msg[0].len &#x3D; 2;						&#x2F;* reg长度*&#x2F;</span><br><span class="line"></span><br><span class="line">	&#x2F;* msg[1]读取数据 *&#x2F;</span><br><span class="line">	msg[1].addr &#x3D; client-&gt;addr;			&#x2F;* gt1151地址 *&#x2F;</span><br><span class="line">	msg[1].flags &#x3D; I2C_M_RD;			&#x2F;* 标记为读取数据*&#x2F;</span><br><span class="line">	msg[1].buf &#x3D; buf;					&#x2F;* 读取数据缓冲区 *&#x2F;</span><br><span class="line">	msg[1].len &#x3D; len;					&#x2F;* 要读取的数据长度*&#x2F;</span><br><span class="line"></span><br><span class="line">	ret &#x3D; i2c_transfer(client-&gt;adapter, msg, 2);</span><br><span class="line">	if(ret &#x3D;&#x3D; 2) &#123;</span><br><span class="line">		ret &#x3D; 0;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		ret &#x3D; -EREMOTEIO;</span><br><span class="line">	&#125;</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 向GT1151多个寄存器写入数据</span><br><span class="line">static s32 gt1151_write_regs(struct gt1151_dev *dev, u16 reg, u8 *buf, u8 len)</span><br><span class="line">&#123;</span><br><span class="line">	u8 b[256];</span><br><span class="line">	struct i2c_msg msg;</span><br><span class="line">	struct i2c_client *client &#x3D; (struct i2c_client *)dev-&gt;client;</span><br><span class="line">	</span><br><span class="line">	b[0] &#x3D; reg &gt;&gt; 8;			&#x2F;* 寄存器首地址低8位 *&#x2F;</span><br><span class="line">    b[1] &#x3D; reg &amp; 0XFF;			&#x2F;* 寄存器首地址高8位 *&#x2F;</span><br><span class="line">	memcpy(&amp;b[2],buf,len);		&#x2F;* 将要写入的数据拷贝到数组b里面 *&#x2F;</span><br><span class="line"></span><br><span class="line">	msg.addr &#x3D; client-&gt;addr;	&#x2F;* gt1151地址 *&#x2F;</span><br><span class="line">	msg.flags &#x3D; 0;				&#x2F;* 标记为写数据 *&#x2F;</span><br><span class="line"></span><br><span class="line">	msg.buf &#x3D; b;				&#x2F;* 要写入的数据缓冲区 *&#x2F;</span><br><span class="line">	msg.len &#x3D; len + 2;			&#x2F;* 要写入的数据长度 *&#x2F;</span><br><span class="line"></span><br><span class="line">	return i2c_transfer(client-&gt;adapter, &amp;msg, 1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 中断服务函数</span><br><span class="line">static irqreturn_t gt1151_irq_handler(int irq, void *dev_id)</span><br><span class="line">&#123;</span><br><span class="line">    int touch_num &#x3D; 0;</span><br><span class="line">    int input_x, input_y;</span><br><span class="line">    int id &#x3D; 0;</span><br><span class="line">    int ret &#x3D; 0;</span><br><span class="line">    u8 data;</span><br><span class="line">    u8 touch_data[5];</span><br><span class="line">    struct gt1151_dev *dev &#x3D; dev_id;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; printk(&quot;enter irq handler!\r\n&quot;);</span><br><span class="line"></span><br><span class="line">    ret &#x3D; gt1151_read_regs(dev, GT_GSTID_REG, &amp;data, 1);&#x2F;&#x2F; GT1151当前检测到的触摸情况</span><br><span class="line">    if (data &#x3D;&#x3D; 0x00)  &#123;     &#x2F;* 没有触摸数据，直接返回 *&#x2F;</span><br><span class="line">        goto fail;</span><br><span class="line">    &#125; else &#123;                 &#x2F;* 统计触摸点数据 *&#x2F;</span><br><span class="line">        touch_num &#x3D; data &amp; 0x0f;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;* 由于GT1151没有硬件检测每个触摸点按下和抬起，因此每个触摸点的抬起和按</span><br><span class="line">     * 下不好处理，尝试过一些方法，但是效果都不好，因此这里暂时使用单点触摸 </span><br><span class="line">     *&#x2F;</span><br><span class="line">    if(touch_num) &#123;         &#x2F;* 单点触摸按下 *&#x2F;</span><br><span class="line">        gt1151_read_regs(dev, GT_TP1_REG, touch_data, 5);</span><br><span class="line">        id &#x3D; touch_data[0] &amp; 0x0F;</span><br><span class="line">        if(id &#x3D;&#x3D; 0) &#123; &#x2F;&#x2F;读取成功</span><br><span class="line">            input_x  &#x3D; touch_data[1] | (touch_data[2] &lt;&lt; 8);</span><br><span class="line">            input_y  &#x3D; touch_data[3] | (touch_data[4] &lt;&lt; 8);</span><br><span class="line"></span><br><span class="line">			&#x2F;&#x2F; 单点id一直等于0即可</span><br><span class="line">            input_mt_slot(dev-&gt;input, 0);</span><br><span class="line">		    input_mt_report_slot_state(dev-&gt;input, MT_TOOL_FINGER, true);</span><br><span class="line">		    input_report_abs(dev-&gt;input, ABS_MT_POSITION_X, input_x);</span><br><span class="line">		    input_report_abs(dev-&gt;input, ABS_MT_POSITION_Y, input_y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if(touch_num &#x3D;&#x3D; 0)&#123;                &#x2F;* 单点触摸释放 *&#x2F;</span><br><span class="line">        input_mt_slot(dev-&gt;input, id);</span><br><span class="line">        input_mt_report_slot_state(dev-&gt;input, MT_TOOL_FINGER, false);&#x2F;&#x2F; 删除触摸点</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	input_mt_report_pointer_emulation(dev-&gt;input, true);&#x2F;&#x2F; 没有出现硬件检测到的点比上报的触摸点多的情况</span><br><span class="line">    input_sync(dev-&gt;input);</span><br><span class="line"></span><br><span class="line">    data &#x3D; 0x00;                &#x2F;* 向0X814E寄存器写0 *&#x2F;</span><br><span class="line">    gt1151_write_regs(dev, GT_GSTID_REG, &amp;data, 1);</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">	return IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; GT1151中断初始化</span><br><span class="line">static int gt1151_ts_irq(struct i2c_client *client, struct gt1151_dev *dev)</span><br><span class="line">&#123;</span><br><span class="line">	int ret &#x3D; 0;</span><br><span class="line">	&#x2F;&#x2F; 由于触摸IC复位需要用到两个IO 在前面已经request了</span><br><span class="line">	&#x2F;* 2，申请中断,client-&gt;irq就是IO中断， *&#x2F;</span><br><span class="line">	ret &#x3D; devm_request_threaded_irq(&amp;client-&gt;dev, client-&gt;irq, NULL,</span><br><span class="line">					gt1151_irq_handler, irq_table[dev-&gt;irqtype] | IRQF_ONESHOT,</span><br><span class="line">					client-&gt;name, &amp;gt1151);</span><br><span class="line">	if (ret) &#123;</span><br><span class="line">		dev_err(&amp;client-&gt;dev, &quot;Unable to request touchscreen IRQ.\n&quot;);</span><br><span class="line">		return ret;</span><br><span class="line">	&#125;else</span><br><span class="line">	&#123;</span><br><span class="line">		printk(&quot;irq init!\r\n&quot;);</span><br><span class="line">		printk(&quot;dev-&gt;irqtype &#x3D; %d\r\n&quot;, dev-&gt;irqtype);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; GT1151读取固件</span><br><span class="line">static int gt1151_read_firmware(struct i2c_client *client, struct gt1151_dev *dev)</span><br><span class="line">&#123;</span><br><span class="line">	int ret &#x3D; 0, version &#x3D; 0;</span><br><span class="line">	u16 id &#x3D; 0;</span><br><span class="line">	u8 data[7]&#x3D;&#123;0&#125;;</span><br><span class="line">	char id_str[5];</span><br><span class="line">	ret &#x3D; gt1151_read_regs(dev, GT_PID_REG, data, 6);</span><br><span class="line">	if (ret) &#123;</span><br><span class="line">		dev_err(&amp;client-&gt;dev, &quot;Unable to read PID.\n&quot;);</span><br><span class="line">		return ret;</span><br><span class="line">	&#125;</span><br><span class="line">	memcpy(id_str, data, 4);</span><br><span class="line">	id_str[4] &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    if (kstrtou16(id_str, 10, &amp;id))id &#x3D; 0x1001;</span><br><span class="line"></span><br><span class="line">	version &#x3D; get_unaligned_le16(&amp;data[4]);</span><br><span class="line">	</span><br><span class="line">	dev_info(&amp;client-&gt;dev, &quot;ID %d, version: %04x\n&quot;, id, version);</span><br><span class="line">	switch (id) &#123;    &#x2F;* 由于不同的芯片配置寄存器地址不一样需要判断一下  *&#x2F;</span><br><span class="line">    case 1151:</span><br><span class="line">    case 1158:</span><br><span class="line">    case 5663:</span><br><span class="line">    case 5688:    &#x2F;* 读取固件里面的配置信息  *&#x2F;</span><br><span class="line">        ret &#x3D; gt1151_read_regs(dev, GT_1xx_CFGS_REG, data, 7);  </span><br><span class="line">		break;</span><br><span class="line">    default:</span><br><span class="line">        ret &#x3D; gt1151_read_regs(dev, GT_1xx_CFGS_REG, data, 7);</span><br><span class="line">		break;</span><br><span class="line">    &#125;</span><br><span class="line">	if (ret) &#123;</span><br><span class="line">		dev_err(&amp;client-&gt;dev, &quot;Unable to read Firmware.\n&quot;);</span><br><span class="line">		return ret;</span><br><span class="line">	&#125;</span><br><span class="line">	dev-&gt;max_x &#x3D; (data[2] &lt;&lt; 8) + data[1];</span><br><span class="line">	dev-&gt;max_y &#x3D; (data[4] &lt;&lt; 8) + data[3];</span><br><span class="line">	dev-&gt;irqtype &#x3D; data[6] &amp; 0x3;</span><br><span class="line">	printk(&quot;X_MAX: %d, Y_MAX: %d, TRIGGER: 0x%02x&quot;, dev-&gt;max_x, dev-&gt;max_y, dev-&gt;irqtype);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; probe函数</span><br><span class="line">int gt1151_probe(struct i2c_client *client, const struct i2c_device_id *id)</span><br><span class="line">&#123;</span><br><span class="line">    u8 data, ret;</span><br><span class="line">    gt1151.client &#x3D; client;</span><br><span class="line">	printk(&quot;Driver and device has mached!!!\r\n&quot;);</span><br><span class="line"></span><br><span class="line"> 	&#x2F;* 1，获取设备树中的中断和复位引脚 *&#x2F;</span><br><span class="line">	gt1151.irq_pin &#x3D; of_get_named_gpio(client-&gt;dev.of_node, &quot;interrupt-gpios&quot;, 0);</span><br><span class="line">	gt1151.reset_pin &#x3D; of_get_named_gpio(client-&gt;dev.of_node, &quot;reset-gpios&quot;, 0);</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; printk(&quot;irq_pin&#x3D;%d, reset_pin&#x3D;%d\r\n&quot;, gt1151.irq_pin, gt1151.reset_pin);</span><br><span class="line">	&#x2F;* 2，复位GT1151 *&#x2F;</span><br><span class="line">	ret &#x3D; gt1151_ts_reset(client, &amp;gt1151);</span><br><span class="line">	if(ret &lt; 0) &#123;</span><br><span class="line">		goto fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;* 3，初始化GT1151 *&#x2F;</span><br><span class="line">    data &#x3D; 0x02;</span><br><span class="line">    gt1151_write_regs(&amp;gt1151, GT_CTRL_REG, &amp;data, 1); &#x2F;* 软复位 *&#x2F;</span><br><span class="line">    mdelay(100);</span><br><span class="line">    data &#x3D; 0x0;</span><br><span class="line">    gt1151_write_regs(&amp;gt1151, GT_CTRL_REG, &amp;data, 1); &#x2F;* 停止软复位 *&#x2F;</span><br><span class="line">    mdelay(100);</span><br><span class="line"></span><br><span class="line">    &#x2F;* 4,初始化GT1151，读取固件 *&#x2F; &#x2F;&#x2F; 应该是读触摸设备的信息</span><br><span class="line">	ret &#x3D; gt1151_read_firmware(client, &amp;gt1151);</span><br><span class="line">	if(ret !&#x3D; 0) &#123;</span><br><span class="line">		printk(&quot;Fail !!! check !!\r\n&quot;);</span><br><span class="line">		goto fail;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    &#x2F;* 5，input设备注册 *&#x2F;</span><br><span class="line">	gt1151.input &#x3D; devm_input_allocate_device(&amp;client-&gt;dev);</span><br><span class="line">	if (!gt1151.input) &#123;</span><br><span class="line">		ret &#x3D; -ENOMEM;</span><br><span class="line">		goto fail;</span><br><span class="line">	&#125;</span><br><span class="line">	gt1151.input-&gt;name &#x3D; client-&gt;name;</span><br><span class="line">	gt1151.input-&gt;id.bustype &#x3D; BUS_I2C;</span><br><span class="line">	gt1151.input-&gt;dev.parent &#x3D; &amp;client-&gt;dev;</span><br><span class="line"></span><br><span class="line">	__set_bit(EV_KEY, gt1151.input-&gt;evbit);</span><br><span class="line">	__set_bit(EV_ABS, gt1151.input-&gt;evbit);</span><br><span class="line">	__set_bit(BTN_TOUCH, gt1151.input-&gt;keybit);</span><br><span class="line"></span><br><span class="line">	input_set_abs_params(gt1151.input, ABS_X, 0, gt1151.max_x, 0, 0);</span><br><span class="line">	input_set_abs_params(gt1151.input, ABS_Y, 0, gt1151.max_y, 0, 0);</span><br><span class="line">	input_set_abs_params(gt1151.input, ABS_MT_POSITION_X,0, gt1151.max_x, 0, 0);</span><br><span class="line">	input_set_abs_params(gt1151.input, ABS_MT_POSITION_Y,0, gt1151.max_y, 0, 0);	     </span><br><span class="line">	ret &#x3D; input_mt_init_slots(gt1151.input, MAX_SUPPORT_POINTS, 0);</span><br><span class="line">	if (ret) &#123;</span><br><span class="line">		goto fail;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret &#x3D; input_register_device(gt1151.input);</span><br><span class="line">	if (ret)</span><br><span class="line">		goto fail;</span><br><span class="line"></span><br><span class="line">    &#x2F;* 6，最后初始化中断 *&#x2F;</span><br><span class="line">	ret &#x3D; gt1151_ts_irq(client, &amp;gt1151);</span><br><span class="line">	if(ret &lt; 0) &#123;</span><br><span class="line">		goto fail;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; i2c驱动的remove函数</span><br><span class="line">int gt1151_remove(struct i2c_client *client)</span><br><span class="line">&#123;</span><br><span class="line">    input_unregister_device(gt1151.input);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 传统驱动匹配表</span><br><span class="line">const struct i2c_device_id gt1151_id_table[] &#x3D; &#123;</span><br><span class="line">	&#123; &quot;goodix,gt1151ATK4384&quot;, 0, &#125;,</span><br><span class="line">    &#123; &#x2F;* sentinel *&#x2F; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 设备树匹配表 </span><br><span class="line">const struct of_device_id gt1151_of_match_table[] &#x3D; &#123;</span><br><span class="line">    &#123;.compatible &#x3D; &quot;goodix,gt1151ATK4384&quot; &#125;,</span><br><span class="line">    &#123; &#x2F;* sentinel *&#x2F; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;* i2c驱动结构体 *&#x2F;	</span><br><span class="line">struct i2c_driver gt1151_i2c_driver &#x3D; &#123;</span><br><span class="line">    .driver &#x3D; &#123;</span><br><span class="line">        .name  &#x3D; &quot;gt1151&quot;,</span><br><span class="line">        .owner &#x3D; THIS_MODULE,</span><br><span class="line">        .of_match_table &#x3D; gt1151_of_match_table,</span><br><span class="line">    &#125;,</span><br><span class="line">    .id_table &#x3D; gt1151_id_table,</span><br><span class="line">    .probe  &#x3D; gt1151_probe,</span><br><span class="line">    .remove &#x3D; gt1151_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">module_i2c_driver(gt1151_i2c_driver);&#x2F;&#x2F; 展开后和module_init module_exit一样，类似于module_platform_driver</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br><span class="line">MODULE_AUTHOR(&quot;kashine&quot;);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、内核配置"><a href="#四、内核配置" class="headerlink" title="四、内核配置"></a>四、内核配置</h2><h3 id="1、IIC设备使能"><a href="#1、IIC设备使能" class="headerlink" title="1、IIC设备使能"></a>1、IIC设备使能</h3><p>首先<strong>使能IIC控制器和设备树对i2c设备的支持，</strong>使用<strong>make menuconfig</strong>命令打开<strong>图形化配置界面</strong>，打开以下路径的<strong>Marvell mv64xxx I2C Controller：</strong></p>
<blockquote>
<p>Device Drivers</p>
<p>​    -&gt; I2C support</p>
<p>​        -&gt; I2C Hardware Bus support</p>
</blockquote>
<p>全志芯片使用的是<strong>marvell的i2c控制器</strong>（参考Documentation&#x2F;devicetree&#x2F;bindings&#x2F;i2c&#x2F;i2c-mv64xxx.txt），该选项默认处于使能状态。 </p>
<img src="/posts/undefined/597b49a9dcfaffd23160e6b51144785b.png" class="" title="img">

<p>打开以下路径中的<strong>I2C device interface</strong>选项： </p>
<blockquote>
<p>Device Drivers</p>
<p>​    -&gt; I2C support</p>
</blockquote>
<img src="/posts/undefined/b1640941b2ca41e308d31c6a9960ba88.png" class="" title="img">

<h3 id="2、内核驱动添加"><a href="#2、内核驱动添加" class="headerlink" title="2、内核驱动添加"></a>2、内核驱动添加</h3><p>将上一节编写的驱动代码<strong>命名为gt1151.c，</strong>并放在<strong>linux-5.7.1&#x2F;drivers&#x2F;input&#x2F;touchscreen</strong>目录下，如下图所示，可以看到touchscreen内有很多屏幕的适配驱动。其实<strong>gt1151官方也有适配的驱动</strong>，就是gt1151.c上方的<strong>goodix.c，</strong>这是汇顶触摸IC对应的<strong>gt系列驱动，</strong>那为什么我们还要自己编写呢？因为对于本文所用的硬件接线以及正点原子屏幕的定义，导致使用该驱动对正点原子屏幕的识别出错，得到的x、y坐标是反着的，因此需要对goodix.c进行修改，那就不如自己写喽。</p>
<img src="/posts/undefined/85b1bb6ce4b6c32441fa9bc2e7d925e6.png" class="" title="img">

<p> 仅仅将驱动文件放到对应的文件夹下面并不可以，因为内核不知道有这么个tg1151驱动文件，我们需要在<strong>touchscreen文件夹</strong>下的<strong>Makfile</strong>进行修改，在最后方添加对gt1151.c的<strong>编译请求。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-$(CONFIG_TOUCHSCREEN_GT1151)	+&#x3D; gt1151.o</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/3e2b6f9557e47974ece39c2eece5a407.png" class="" title="img">

<p>我们都知道在make menuconfig图形化配置界面可以<strong>对驱动进行使能、关闭、编译为模块的配置，</strong>如果想要我们的gt1151驱动编译选项能够在make menuconfig调出的<strong>图形化配置界面中配置</strong>，还需要在<strong>touchscreen文件夹</strong>下的<strong>Kconfig文件</strong>中添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">config TOUCHSCREEN_GT1151</span><br><span class="line">	tristate &quot;GT1151 touchscreen controller&quot;</span><br><span class="line">	depends on I2C</span><br><span class="line">	</span><br><span class="line">	help</span><br><span class="line">	  Say Y to enable support for the GT1151</span><br><span class="line">	  family of trackpad&#x2F;touchscreen controllers.</span><br><span class="line"></span><br><span class="line">	  To compile this driver as a module, choose M here: the</span><br><span class="line">	  module will be called gt1151.</span><br><span class="line"></span><br><span class="line">endif #非添加内容！！！</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/a48f61e19b4af5b95b20f54690d0ca5c.png" class="" title="img">

<h3 id="3、gt1151驱动使能"><a href="#3、gt1151驱动使能" class="headerlink" title="3、gt1151驱动使能"></a>3、gt1151驱动使能</h3><p>添加完驱动，并提供了图形化界面配置信息后，我们还要在make menuconfig提供的图形化配置界面中<strong>使能</strong>我们添加的<strong>gt1151驱动。</strong>如下图所示，我们需要<strong>使能GT1151 touchscreen controller选项</strong><strong>(将驱动编译进内核)，</strong>也就是我们上面添加的选项。</p>
<img src="/posts/undefined/c59eeb7f0e38a5cfd0e736612c76a17a.png" class="" title="img">

<p>我们<strong>自定义了gt1151的驱动，</strong>因此<strong>goodix.c</strong>中的驱动我们就不需要了，所以在相同路径中，<strong>失能goodix</strong>驱动选项****Goodix I2C touchscreen，****如下图所示：</p>
<img src="/posts/undefined/afb9c565f89070a49cfe3dd5e0244bb1.png" class="" title="img">

<hr>
<h2 id="五、触摸测试"><a href="#五、触摸测试" class="headerlink" title="五、触摸测试"></a>五、触摸测试</h2><h3 id="1、启动与文件检查"><a href="#1、启动与文件检查" class="headerlink" title="1、启动与文件检查"></a>1、启动与文件检查</h3><p>经过前几节的配置，我们<strong>重新对内核和设备树进行编译，</strong>然后上电运行开发板，<strong>查看输出信息，</strong>发现内核启动时<strong>先后加载了i2c驱动和gt1151驱动，并且初始化中断功能</strong>，Debian系统启动后直接进入<strong>root用户空间。*<em>注意：输出Driver and device has mached!!!代表设备树设备和驱动匹配成功，这是由驱动probe函数中的printk决定的！*</em></strong></p>
<img src="/posts/undefined/637c4769d13d097bf7faed6aa195ad1f.png" class="" title="img">

<p>下面这张图是我们在 <strong>“Debian根文件系统制作”</strong>这一小节中<strong>安装的一些组件，</strong>其中evtest是为本节安装的触摸屏测试软件，当时大家可能比较疑惑，现在我们<strong>使用该软件测试触摸屏触摸是否正常，</strong>当然大家也可以使用hexdump、<strong>tslib</strong>（非常直观，我移植了两天，宣告失败，有兴趣的尝试尝试，做出来记得@我，F1C200s下tslib移植到Debian文件系统哦）。</p>
<img src="/posts/undefined/3f8a5d5f3ef993114787db9286812d74.png" class="" title="img">

<p>进入root用户空间后，首先查看路径**&#x2F;dev&#x2F;input&#x2F;event0、&#x2F;dev&#x2F;fb0<strong>中是否存在对应的文件，其中</strong>event0代表我们的电容触摸屏，<strong>不同的平台 event 序号不同，</strong>也可能是 event3，event4 等，**一切以实际情况为准！我的是event0，如下图所示。</p>
<img src="/posts/undefined/9b9672ac4dcaea034118c22adcf8ec13.png" class="" title="img">

<p>如果<strong>不存在event0，</strong>或者<strong>不存在input文件夹，</strong>首先检查**&#x2F;driver&#x2F;input&#x2F;touchscreen<strong>文件夹下面有没有产生</strong>gt1151.o文件，<strong>如果没有说明</strong>没有编译，<strong>检查</strong>Kconfig、Makfile、图形化配置使能<strong>；如果有检查</strong>compatible属性值，<strong>或是检查启动log有无输出</strong>Driver and device has mached!!!**。</p>
<h3 id="2、触摸测试"><a href="#2、触摸测试" class="headerlink" title="2、触摸测试"></a>2、触摸测试</h3><p>很幸运你能看到这里，应该庆幸欣慰，给你点赞👍👍👍👍👍👍。在顺利完成上述操作后，我们使用evtest软件对触摸屏进行测试，使用如下命令进入测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evtest &#x2F;dev&#x2F;input&#x2F;event0</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/78e49afd32be59bef0a53187aae46727.png" class="" title="img">

<p> 从上面的图中可以看出，该软件<strong>正确识别</strong>到了我们的屏幕，<strong>分辨率为800*480，上报X坐标事件码为53，上报Y坐标事件码为54，</strong>现在我们来分别触摸屏幕的<strong>右下角、右上角、左下角、中间：</strong></p>
<img src="/posts/undefined/4dfe9a5038cc90f37f09503b06a7a93b.png" class="" title="img">

<img src="/posts/undefined/a815bb3dc48a93c1696c23a1f86815f3.png" class="" title="img">

<p>通过串口打印的坐标基本符合我们的触摸位置，至此，触摸IC驱动移植结束，恭喜完成本节，离offer又进一步！ 🎉🎉🎉</p>
<hr>
<h2 id="六、主要参考内容"><a href="#六、主要参考内容" class="headerlink" title="六、主要参考内容"></a>六、主要参考内容</h2><p>1.[【f1c200s&#x2F;f1c100s】FT5426触摸屏驱动适配_Liangtao&#96;的博客-CSDN博客_ft5426](<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27350133/article/details/124974526?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~Rate-1-124974526-blog-127501970.pc_relevant_multi_platform_whitelistv3&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~Rate-1-124974526-blog-127501970.pc_relevant_multi_platform_whitelistv3&amp;utm_relevant_index=1)%EF%BC%9B">https://blog.csdn.net/qq_27350133/article/details/124974526?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~Rate-1-124974526-blog-127501970.pc_relevant_multi_platform_whitelistv3&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~Rate-1-124974526-blog-127501970.pc_relevant_multi_platform_whitelistv3&amp;utm_relevant_index=1)；</a></p>
<p>2.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34440409/article/details/122994396"> linux设备适配触摸屏（gt1151）_星星-点灯的博客-CSDN博客</a>；</p>
<p>3.<a target="_blank" rel="noopener" href="http://47.111.11.73/docs/boards/arm-linux/zdyz-i.mx6ull.html">《正点原子驱动开发指南》</a></p>
<h1 id="USB驱动"><a href="#USB驱动" class="headerlink" title="USB驱动"></a>USB驱动</h1><h2 id="一、前言-1"><a href="#一、前言-1" class="headerlink" title="一、前言"></a>一、前言</h2><h3 id="1、USB-host和USB-device的区别"><a href="#1、USB-host和USB-device的区别" class="headerlink" title="1、USB host和USB device的区别"></a>1、USB host和USB device的区别</h3><p>不知道你能否<strong>区分什么是USB host、什么是USB device？</strong>下面做一些简单的介绍，用<strong>最简单的语言</strong>描述大致的原理：</p>
<ul>
<li><strong>USB Host（主设备）：</strong>字面意思为<strong>USB主机，</strong>****类似于电脑的USB接口，****可以连接移动硬盘、鼠标、键盘等等；</li>
<li><strong>USB Device（从设备）****：</strong>字面意思是<strong>USB设备，</strong>概念与USB host<strong>相对</strong>，类似于我们的<strong>移动硬盘。</strong></li>
<li><strong>注意：只有USB host和USB device连接时，数据才能正确传输。</strong></li>
</ul>
<p>那什么是<strong>USB otg</strong>呢？ <strong>USB otg既可以做USB host也可以做USB device，</strong>通过ID信号来控制<strong>主、从切换。</strong>otg技术就是实现host设备不存的的情况下，设备间的数据传输。</p>
<h3 id="2、硬件解析"><a href="#2、硬件解析" class="headerlink" title="2、硬件解析"></a>2、硬件解析</h3><blockquote>
<p>F1C200s芯片支持USB的<strong>OTG模式，</strong>也就是可以通过更改<strong>usbid</strong>拉低或拉高方式定义当前的开发板可以作为<strong>host还是device。</strong></p>
</blockquote>
<ul>
<li><strong>usbid 拉高</strong>时，开发板作为<strong>外设方式。</strong></li>
<li><strong>usbid 拉低</strong>时，开发板作为<strong>主机方式。</strong></li>
</ul>
<p>F1C200s中<strong>PE2引脚</strong>具有usbid功能，来决定开发板作为<strong>外设方式或是主机方式，</strong>本文直接将PE2拉高，也即将<strong>开发板作为外设方式（device），</strong>有的朋友可能会问，<em><strong>*我们写USB驱动是为了外接键鼠、U盘等设备，但此处为什么作为外设方式呢？*</strong></em></p>
<p>墨云说 ”<strong>是为了利用****sunxi-tool烧录工具，并且硬件电路里面把PE2拉高了，也就是默认是otg模式。</strong>“（本系统硬件电路主要参考墨云和稚辉君，至于这里为什么设置为外设方式，说下我的理解，大概是因为需要通过sunxi-tool将编译后的文件下载到RAM或者flash中，需要将板子作为从机，关于sunxi-tool详见<a target="_blank" rel="noopener" href="https://blog.csdn.net/u012577474/article/details/103346601">sunxi-tools工具的使用</a>）。</p>
<blockquote>
<p>后记：在询问过晕哥之后，得知这个引脚其实不用拉高也可以，所以这里大家不用care，因为我们可以使用软件设置otg方式。<a target="_blank" rel="noopener" href="https://debugdump.com/topic/2889/sunxi-tool%E5%85%B7%E4%BD%93%E4%BD%9C%E7%94%A8%E6%98%AF%E4%BB%80%E4%B9%88-f1c200s-sd%E5%8D%A1-%E8%83%BD%E5%90%A6%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%E5%B7%A5%E5%85%B7?_=1673762240401">sunxi-tool具体作用是什么？F1C200s &amp; SD卡，能否使用这个工具？</a></p>
</blockquote>
<p>那我们就不能将开发板<strong>作为host外接其他设备</strong>了嘛？不是。因为我们不仅可以通过<strong>硬件修改</strong>OTG模式，还可以通过<strong>软件修改。</strong></p>
<img src="/posts/undefined/c9633039194d873361ede34a037bee87.png" class="" title="img">

<hr>
<h2 id="二、设备树修改-1"><a href="#二、设备树修改-1" class="headerlink" title="二、设备树修改"></a>二、设备树修改</h2><h3 id="1、-dtsi文件修改-1"><a href="#1、-dtsi文件修改-1" class="headerlink" title="1、.dtsi文件修改"></a>1、.dtsi文件修改</h3><p>在soc结点下<strong>添加</strong>如下两个结点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; modify by kashine 3</span><br><span class="line">usb_otg: usb@1c13000 &#123;</span><br><span class="line">	compatible &#x3D; &quot;allwinner,suniv-musb&quot;;</span><br><span class="line">	reg &#x3D; &lt;0x01c13000 0x0400&gt;;</span><br><span class="line">	clocks &#x3D; &lt;&amp;ccu CLK_BUS_OTG&gt;;</span><br><span class="line">	resets &#x3D; &lt;&amp;ccu RST_BUS_OTG&gt;;</span><br><span class="line">	interrupts &#x3D; &lt;26&gt;;</span><br><span class="line">	interrupt-names &#x3D; &quot;mc&quot;;</span><br><span class="line">	phys &#x3D; &lt;&amp;usbphy 0&gt;;</span><br><span class="line">	phy-names &#x3D; &quot;usb&quot;;</span><br><span class="line">	extcon &#x3D; &lt;&amp;usbphy 0&gt;;</span><br><span class="line">	allwinner,sram &#x3D; &lt;&amp;otg_sram 1&gt;;</span><br><span class="line">	status &#x3D; &quot;disabled&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; modify by kashine 3</span><br><span class="line">usbphy: phy@1c13400 &#123;</span><br><span class="line">	compatible &#x3D; &quot;allwinner,suniv-usb-phy&quot;;</span><br><span class="line">	reg &#x3D; &lt;0x01c13400 0x10&gt;;</span><br><span class="line">	reg-names &#x3D; &quot;phy_ctrl&quot;;</span><br><span class="line">	clocks &#x3D; &lt;&amp;ccu CLK_USB_PHY0&gt;;</span><br><span class="line">	clock-names &#x3D; &quot;usb0_phy&quot;;</span><br><span class="line">	resets &#x3D; &lt;&amp;ccu RST_USB_PHY0&gt;;</span><br><span class="line">	reset-names &#x3D; &quot;usb0_reset&quot;;</span><br><span class="line">	#phy-cells &#x3D; &lt;1&gt;;</span><br><span class="line">	status &#x3D; &quot;disabled&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2、-dts文件修改-1"><a href="#2、-dts文件修改-1" class="headerlink" title="2、.dts文件修改"></a>2、.dts文件修改</h3><p>使能一些功能，**USB otg设置为**主机方式，*<em><strong>因为我们要连接类似</strong>鼠标、键盘、U盘等的外设，</em>*也就是开发板作为主机。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; modify by kahsine 3</span><br><span class="line">&amp;otg_sram &#123;</span><br><span class="line">        status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; modify by kahsine 3</span><br><span class="line">&amp;usb_otg &#123;</span><br><span class="line">        dr_mode &#x3D; &quot;host&quot;; &#x2F;* 三个可选项: otg &#x2F; host &#x2F; peripheral  我在这里指定为host模式*&#x2F;</span><br><span class="line">        status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; modify by kahsine 3</span><br><span class="line">&amp;usbphy &#123;</span><br><span class="line">        usb0_id_det-gpio &#x3D; &lt;&amp;pio 4 2 GPIO_ACTIVE_HIGH&gt;; &#x2F;* PE2 *&#x2F;</span><br><span class="line">        status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、驱动修改"><a href="#三、驱动修改" class="headerlink" title="三、驱动修改"></a>三、驱动修改</h2><h3 id="1、phy-sun4i-usb-c文件修改"><a href="#1、phy-sun4i-usb-c文件修改" class="headerlink" title="1、phy-sun4i-usb.c文件修改"></a>1、phy-sun4i-usb.c文件修改</h3><p><strong>&#x2F;&#x2F; 枚举变量修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">enum sun4i_usb_phy_type &#123;</span><br><span class="line">	suniv_phy,&#x2F;&#x2F; modify by kashine 3</span><br><span class="line">	sun4i_a10_phy,</span><br><span class="line">	sun6i_a31_phy,</span><br><span class="line">	sun8i_a33_phy,</span><br><span class="line">	sun8i_a83t_phy,</span><br><span class="line">	sun8i_h3_phy,</span><br><span class="line">	sun8i_r40_phy,</span><br><span class="line">	sun8i_v3s_phy,</span><br><span class="line">	sun50i_a64_phy,</span><br><span class="line">	sun50i_h6_phy,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>&#x2F;&#x2F; 结构体声明</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; modify by kashine 3</span><br><span class="line">static const struct sun4i_usb_phy_cfg suniv_cfg &#x3D; &#123;</span><br><span class="line">    .num_phys &#x3D; 1,</span><br><span class="line">    .type &#x3D; suniv_phy,</span><br><span class="line">    .disc_thresh &#x3D; 3,</span><br><span class="line">    .phyctl_offset &#x3D; REG_PHYCTL_A10,</span><br><span class="line">    .dedicated_clocks &#x3D; true,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>&#x2F;&#x2F; compatible驱动匹配表属性修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static const struct of_device_id sun4i_usb_phy_of_match[] &#x3D; &#123;</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,suniv-usb-phy&quot;, .data &#x3D; &amp;suniv_cfg &#125;, &#x2F;&#x2F; modify by kashine 3</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun4i-a10-usb-phy&quot;, .data &#x3D; &amp;sun4i_a10_cfg &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun5i-a13-usb-phy&quot;, .data &#x3D; &amp;sun5i_a13_cfg &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun6i-a31-usb-phy&quot;, .data &#x3D; &amp;sun6i_a31_cfg &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun7i-a20-usb-phy&quot;, .data &#x3D; &amp;sun7i_a20_cfg &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a23-usb-phy&quot;, .data &#x3D; &amp;sun8i_a23_cfg &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a33-usb-phy&quot;, .data &#x3D; &amp;sun8i_a33_cfg &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a83t-usb-phy&quot;, .data &#x3D; &amp;sun8i_a83t_cfg &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-h3-usb-phy&quot;, .data &#x3D; &amp;sun8i_h3_cfg &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-r40-usb-phy&quot;, .data &#x3D; &amp;sun8i_r40_cfg &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-v3s-usb-phy&quot;, .data &#x3D; &amp;sun8i_v3s_cfg &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun50i-a64-usb-phy&quot;,</span><br><span class="line">	  .data &#x3D; &amp;sun50i_a64_cfg&#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun50i-h6-usb-phy&quot;, .data &#x3D; &amp;sun50i_h6_cfg &#125;,</span><br><span class="line">	&#123; &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2、sunxi-c文件修改"><a href="#2、sunxi-c文件修改" class="headerlink" title="2、sunxi.c文件修改"></a>2、sunxi.c文件修改</h3><p><strong>&#x2F;&#x2F; sunxi_musb_probe函数修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">static int sunxi_musb_probe(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">	struct musb_hdrc_platform_data	pdata;</span><br><span class="line">	struct platform_device_info	pinfo;</span><br><span class="line">	struct sunxi_glue		*glue;</span><br><span class="line">	struct device_node		*np &#x3D; pdev-&gt;dev.of_node;</span><br><span class="line">	int ret;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">	glue-&gt;dev &#x3D; &amp;pdev-&gt;dev;</span><br><span class="line">	INIT_WORK(&amp;glue-&gt;work, sunxi_musb_work);</span><br><span class="line">	glue-&gt;host_nb.notifier_call &#x3D; sunxi_musb_host_notifier;</span><br><span class="line"></span><br><span class="line">	if (of_device_is_compatible(np, &quot;allwinner,sun4i-a10-musb&quot;) || of_device_is_compatible(np, &quot;allwinner,suniv-musb&quot;))&#x2F;&#x2F; modify by kashine 3</span><br><span class="line">		set_bit(SUNXI_MUSB_FL_HAS_SRAM, &amp;glue-&gt;flags);</span><br><span class="line"></span><br><span class="line">	if (of_device_is_compatible(np, &quot;allwinner,sun6i-a31-musb&quot;))</span><br><span class="line">		set_bit(SUNXI_MUSB_FL_HAS_RESET, &amp;glue-&gt;flags);</span><br><span class="line"></span><br><span class="line">	if (of_device_is_compatible(np, &quot;allwinner,sun8i-a33-musb&quot;) ||</span><br><span class="line">	    of_device_is_compatible(np, &quot;allwinner,sun8i-h3-musb&quot;) || </span><br><span class="line">		of_device_is_compatible(np, &quot;allwinner,suniv-musb&quot;) ) &#123;&#x2F;&#x2F; modify by kashine 3</span><br><span class="line">		set_bit(SUNXI_MUSB_FL_HAS_RESET, &amp;glue-&gt;flags);</span><br><span class="line">		set_bit(SUNXI_MUSB_FL_NO_CONFIGDATA, &amp;glue-&gt;flags);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>&#x2F;&#x2F; 驱动匹配表修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static const struct of_device_id sunxi_musb_match[] &#x3D; &#123;</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,suniv-musb&quot;, &#125;, &#x2F;&#x2F; modify by kashine 3</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun4i-a10-musb&quot;, &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun6i-a31-musb&quot;, &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-a33-musb&quot;, &#125;,</span><br><span class="line">	&#123; .compatible &#x3D; &quot;allwinner,sun8i-h3-musb&quot;, &#125;,</span><br><span class="line">	&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、驱动使能"><a href="#四、驱动使能" class="headerlink" title="四、驱动使能"></a>四、驱动使能</h2><p>通过make menuconfig图形化配置界面，进入下方路径中<strong>使能驱动。</strong></p>
<blockquote>
<p>Device Drivers</p>
<p>​    -&gt; USB support</p>
</blockquote>
<img src="/posts/undefined/1f8a2dd127da50f8c80bf5cc140a49f4.png" class="" title="img">

<img src="/posts/undefined/c4eeef35e790c50e5ed7799ea97cb62c.png" class="" title="img">

<img src="/posts/undefined/6a87b2bd1be09cb7b7eeb4f711b1352b.png" class="" title="img">

<h2 id="五、U盘读取测试"><a href="#五、U盘读取测试" class="headerlink" title="五、U盘读取测试"></a>五、U盘读取测试</h2><p><strong>重新编译，</strong>得到新的zImage、设备树，上电启动，观察输出信息，</p>
<img src="/posts/undefined/6d1bd6f966bcc6cd22a25ab0b2bb9fd4.png" class="" title="img">

<p>进入Debian系统后，<strong>将U盘插入到任意一个USB接口</strong>，串口打印出下面的信息，可以看到，我们插入的<strong>3.0接口</strong>的<strong>U盘容量</strong>和<strong>可用大小</strong>，还需要注意一个重要的信息，我们的<strong>U盘在系统下面盘符为sda，只有一个分区sda1。</strong>  </p>
<img src="/posts/undefined/c0c66cdd50fd5d7a96737c27558de581.png" class="" title="img">

<p>使用<strong>df -h命令</strong>查看<strong>Debian系统磁盘占用情况：</strong></p>
<img src="/posts/undefined/7af2a87480324ba026a3ed3cdb0031f2.png" class="" title="img">

<p>咦，怎么没有我们的U盘？因为<strong>没有挂载</strong>，😂😂😂。使用如下命令将我们的U盘挂载在**&#x2F;media&#x2F;UPan<strong>目录下，UPan文件夹是我们</strong>新建<strong>的哈。挂载完成重新使用</strong>df -h命令<strong>查看磁盘状况，发现了我们的U盘，也就是</strong>红色箭头**指向的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount &#x2F;dev&#x2F;sda1 &#x2F;media&#x2F;UPan&#x2F;</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/219c6b3e6e1d11a08a34fefc4c771d0f.png" class="" title="img">

<p>进入U盘内部，<strong>测试能否正常查看其中的文件，</strong>如下图所示，U盘内的确为我备份的一些文件，一切正常。</p>
<img src="/posts/undefined/f2714fbdf456ef1a5a6de98990c8b18f.png" class="" title="img">

<p>在<strong>拔出</strong>U盘之前最好先将<strong>U盘卸载（umount）</strong>，使用如下命令卸载U盘后拔出即可。</p>
<img src="/posts/undefined/eb3546810ec7561f09c59703a6dd1c65.png" class="" title="img">

<p>有关USB驱动我们就不详细分析了（其实我不会，哈哈哈），先照葫芦画个瓢吧。USB驱动是一门很庞大、很复杂的内容，后面有时间多了解下。</p>
<hr>
<h2 id="六、主要参考内容-1"><a href="#六、主要参考内容-1" class="headerlink" title="六、主要参考内容"></a>六、主要参考内容</h2><p>1.<a target="_blank" rel="noopener" href="https://blog.csdn.net/xzongyuan/article/details/25209465">USB device 和 USB host区别</a>；</p>
<p>2.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34440409/article/details/122994396"> </a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/twzy/p/15243838.html">小白自制Linux开发板 七. USB驱动配置 - 淡墨青云 - 博客园</a>；（本文主要参bai考piao）</p>
<p>\3. <a target="_blank" rel="noopener" href="https://javonpeng.blog.csdn.net/article/details/112719638?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~Rate-1-112719638-blog-103346601.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~Rate-1-112719638-blog-103346601.pc_relevant_default&utm_relevant_index=1">全志sunxi-tools烧录工具安装和使用</a>；</p>
<p>\4. <a target="_blank" rel="noopener" href="https://debugdump.com/topic/2889/sunxi-tool%E5%85%B7%E4%BD%93%E4%BD%9C%E7%94%A8%E6%98%AF%E4%BB%80%E4%B9%88-f1c200s-sd%E5%8D%A1-%E8%83%BD%E5%90%A6%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%E5%B7%A5%E5%85%B7">sunxi-tool具体作用是什么？F1C200s &amp; SD卡，能否使用这个工具？</a>；</p>
<p>\5. <a target="_blank" rel="noopener" href="https://blog.csdn.net/u011329967/article/details/106756242">USB PHY芯片_时光-易逝的博客-CSDN博客_usb phy</a>。</p>
<h1 id="音频驱动"><a href="#音频驱动" class="headerlink" title="音频驱动"></a>音频驱动</h1><h2 id="一、前言-2"><a href="#一、前言-2" class="headerlink" title="一、前言"></a>一、前言</h2><blockquote>
<p>F1C200s是全志的一款高度集成、低功耗的移动应用处理器，可用于<strong>多种多媒体音视频设备中。</strong></p>
<p>全志F1C200s基于ARM 9架构，集成了DDR。它支持<strong>高清视频解码</strong>，包括<strong>H.264、H.263、MPEG 1&#x2F;2&#x2F;4等。</strong>它还集成了<strong>音频编解码器和I2S&#x2F;PCM接口，</strong>以增强用户体验。</p>
</blockquote>
<p>由上面的介绍可以看出，F1C200s具有<strong>高清视频解码功能，</strong>因此本文使用F1C200s<strong>完成音视频播放功能。</strong>由于本文<strong>对输出音频的品质没有要求，</strong>因此本文<strong>未采用I2S声卡</strong>（ I2S总线有时候也写作 IIS，I2S 是飞利浦公司提出的一种用于数字音频设备之间进行音频数据传输的总线），直接使用F1C200s自带的声卡，<strong>注意，F1C200s自带的声卡比较差劲，对声音品质要求较高请勿采用此方案。</strong></p>
<blockquote>
<p>既然<strong>音频CODEC的本质是ADC和DAC，</strong>那么<strong>采样率和采样位数</strong>就是衡量一款音频CODEC最重要的指标。比如常见音频采样率有8K、44.1K、48K、192K甚至384K和768K，采样位数常见的有8位、16位、24位、32位。</p>
<p>– 正点原子</p>
</blockquote>
<p>理解一下上面的概念，后面会提到：</p>
<p><strong>采样位数</strong>——可以理解数字音频设备处理声音的解析度，即<strong>对声音的辨析度</strong>。就像表示颜色的位数一样（8位表示256种颜色，16位表示65536种颜色），有8位，16位，24位等。这个数值越大，解析度就越高，录制和回放的声音就越真实。</p>
<p><strong>采样频率</strong>——就是对声音信息<strong>1秒钟采样多少次</strong>，以记录成数字信息。如CD音频是44.1KHz采样率，它对声音以每秒44100次的频率来记录信息。原则上采样率越高，声音的质量越好。</p>
<hr>
<h2 id="二、驱动修改"><a href="#二、驱动修改" class="headerlink" title="二、驱动修改"></a><strong>二、驱动修改</strong></h2><blockquote>
<p>接下来在Linux内核目录中替换下面<strong>补丁包</strong>中的代码，本补丁包在Linux5.7.1下测试成功，其他版本请<strong>备份源码</strong>后尝试，这里的代码是通过<strong>改造sun4i-codec解码方案而来。</strong></p>
<p>– 墨云</p>
</blockquote>
<p><strong>具体修改内容详见</strong><a target="_blank" rel="noopener" href="https://lkml.org/lkml/2018/12/2/259%EF%BC%8C%E6%88%96%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E5%A2%A8%E4%BA%91%E6%8F%90%E4%BE%9B%E7%9A%84%E5%86%85%E6%A0%B8%E8%A1%A5%E4%B8%81%E5%8C%85%EF%BC%88%E8%BF%99%E6%98%AFAllwinner">https://lkml.org/lkml/2018/12/2/259，或直接使用墨云提供的内核补丁包（这是Allwinner</a> suniv F1C100s支持DMA和音频解码器的RFC补丁），相关讨论详见此处<a target="_blank" rel="noopener" href="https://whycan.com/t_2041.html">请问有没有大神搞定了f1c100s的主线kernel4.19下的声卡驱动？</a>，本文直接使用墨云提供的补丁包。</p>
<p>Suniv F1C100s具有与sun4i<strong>非常相似的DMA。</strong>但也有一些不同之处。 Suniv在时钟控制单元中有一个DMA复位位。它有更小的DMA通道数。几个寄存器有不同的地址。 它的<strong>最大突发大小是 4而不是8，添加一个 quirk 字段以区分它们。</strong>DMA端点编号也不同。</p>
<hr>
<h2 id="三、设备树修改"><a href="#三、设备树修改" class="headerlink" title="三、设备树修改"></a>三、设备树修改</h2><h3 id="1、-dtsi文件修改-2"><a href="#1、-dtsi文件修改-2" class="headerlink" title="1、.dtsi文件修改"></a>1、.dtsi文件修改</h3><p>首先在.dtsi文件中添加头文件的引用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;dt-bindings&#x2F;dma&#x2F;sun4i-a10.h&gt; </span><br></pre></td></tr></table></figure>

<p>然后在<strong>soc结点</strong>下添加如下结点，F1C200s利用<strong>DMA通道</strong>发送和接收ADC-DAC样本，所以需要DMA支持。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">dma: dma-controller@1c02000 &#123;</span><br><span class="line">    compatible &#x3D; &quot;allwinner,suniv-f1c100s-dma&quot;;</span><br><span class="line">    reg &#x3D; &lt;0x01c02000 0x1000&gt;;</span><br><span class="line">    interrupts &#x3D; &lt;18&gt;;</span><br><span class="line">    clocks &#x3D; &lt;&amp;ccu CLK_BUS_DMA&gt;;</span><br><span class="line">    resets &#x3D; &lt;&amp;ccu RST_BUS_DMA&gt;;</span><br><span class="line">    #dma-cells &#x3D; &lt;2&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">codec: codec@1c23c00 &#123;</span><br><span class="line">    compatible &#x3D; &quot;allwinner,suniv-f1c100s-codec&quot;;</span><br><span class="line">    reg &#x3D; &lt;0x01c23c00 0x400&gt;;</span><br><span class="line">    interrupts &#x3D; &lt;21&gt;;</span><br><span class="line">    clocks &#x3D; &lt;&amp;ccu CLK_BUS_CODEC&gt;,</span><br><span class="line">         &lt;&amp;ccu CLK_CODEC&gt;;</span><br><span class="line">    clock-names &#x3D; &quot;apb&quot;, &quot;codec&quot;;</span><br><span class="line">    resets &#x3D; &lt;&amp;ccu RST_BUS_CODEC&gt;;</span><br><span class="line">    dmas &#x3D; &lt;&amp;dma SUN4I_DMA_NORMAL 0x0c&gt;, </span><br><span class="line">         &lt;&amp;dma SUN4I_DMA_NORMAL 0x0c&gt;;</span><br><span class="line">    dma-names &#x3D; &quot;rx&quot;, &quot;tx&quot;;</span><br><span class="line">    status &#x3D; &quot;disabled&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2、-dts文件修改-2"><a href="#2、-dts文件修改-2" class="headerlink" title="2、.dts文件修改"></a>2、.dts文件修改</h3><p>Allwinner suniv F1C200s 现在具有<strong>基本的音频编解码器支持</strong>，在设备树dts文件中为Lichee Pi Nano开发板激活它。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&amp;codec &#123;</span><br><span class="line">    allwinner,audio-routing &#x3D;</span><br><span class="line">    &quot;Headphone&quot;, &quot;HP&quot;,</span><br><span class="line">    &quot;Headphone&quot;, &quot;HPCOM&quot;,</span><br><span class="line">    &quot;MIC&quot;, &quot;Mic&quot;;</span><br><span class="line">    status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、驱动使能-1"><a href="#四、驱动使能-1" class="headerlink" title="四、驱动使能"></a>四、驱动使能</h2><p>使用<strong>make menuconfig</strong>图形化配置驱动，进入如下路径，<strong>使能</strong>对应的驱动。<strong>注意：这两个驱动默认处于使能状态。</strong></p>
<blockquote>
<p>Device Drivers</p>
<p>​    -&gt; Sound card support</p>
<p>​        -&gt; Advanced Linux Sound Architecture</p>
<p>​            -&gt; ALSA for SoC audio support     </p>
<p>​                -&gt; Allwinner SoC Audio support<strong>（使能该驱动）</strong></p>
</blockquote>
<blockquote>
<p> Device Drivers</p>
<p>​    -&gt; DMA Engine support<strong>（使能）</strong></p>
</blockquote>
<hr>
<h2 id="五、启动测试与配置"><a href="#五、启动测试与配置" class="headerlink" title="五、启动测试与配置"></a>五、启动测试与配置</h2><h3 id="1、启动与检查"><a href="#1、启动与检查" class="headerlink" title="1、启动与检查"></a>1、启动与检查</h3><p>重新编译，并上电，可以看到<strong>F1c100s Audio Codec 的声卡配置</strong>如下：</p>
<img src="/posts/undefined/0f712e64062355b7dbc61aa660337370.png" class="" title="img">

<p>使用如下命令<strong>检查声卡，</strong>确实是否正确启动，如下图所示为正常启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;asound&#x2F;cards</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/30f72be22bfdd73b62e793fbdfb38131.png" class="" title="img">

<h3 id="2、默认声卡配置"><a href="#2、默认声卡配置" class="headerlink" title="2、默认声卡配置"></a>2、默认声卡配置</h3><p>使用如下命令<strong>打开asound.conf文件</strong>输入下方内容，Debian文件系统中<strong>可能不存在</strong>这个文件，自行创建即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;asound.conf</span><br><span class="line">defaults.ctl.card 1</span><br><span class="line">defaults.pcm.card 1</span><br><span class="line">defaults.timer.card 1</span><br></pre></td></tr></table></figure>

<p>如果<strong>未正确配置默认声卡，</strong>在<strong>播放mp3文件</strong>的时候<strong>可能报错</strong>如下：</p>
<img src="/posts/undefined/d09a930149599441fa133b5cbc4ed84e.png" class="" title="img">

<hr>
<h2 id="六、音频视频播放测试"><a href="#六、音频视频播放测试" class="headerlink" title="六、音频视频播放测试"></a>六、音频视频播放测试</h2><h3 id="1、mplayer与alsa-utils安装"><a href="#1、mplayer与alsa-utils安装" class="headerlink" title="1、mplayer与alsa-utils安装"></a>1、mplayer与alsa-utils安装</h3><p>使用如下命令在我们的开发板中（如果已经配置好无线网卡），或者是qemu模拟器中<strong>安装</strong>两个软件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install mplayer</span><br><span class="line">sudo apt-get install alsa-utils</span><br></pre></td></tr></table></figure>

<p>在<strong>qemu模拟器中</strong>安装<strong>mplayer</strong>报错如下，经过后续测试<strong>并不影响使用。</strong></p>
<img src="/posts/undefined/66378e67d0fa7c516112411c0612b2c7.png" class="" title="img">

<h3 id="2、音频播放测试"><a href="#2、音频播放测试" class="headerlink" title="2、音频播放测试"></a>2、音频播放测试</h3><p>使用如下命令播放准备好的mp3文件，等待<strong>输出以下内容</strong>后开始播放音乐，<strong>按0键增加音量，按9键减小音量。</strong>经测试，音频播放正常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mplayer audio.mp3</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/96aaa0fd0158ab996a47840b6c4a0f93.png" class="" title="img">

<h3 id="3、视频播放测试"><a href="#3、视频播放测试" class="headerlink" title="3、视频播放测试"></a>3、视频播放测试</h3><p>本文使用mplayer进行视频播放测试，使用以下命令查看驱mplayer的帮助信息，从帮助信息中可以看出，**<em>*-vo选项*<em>是用来选择*<em>视频输出驱动的。*</em></em></em></p>
<img src="/posts/undefined/5eee8f8650ccceebc5bedab12e131acd.png" class="" title="img">

<p>使用<strong>命令mplayer -vo help</strong>显示支持的视频驱动，本文使用<strong>fbdev2</strong>进行播放（因为只有fbdev2才能播放，不清楚墨云为什么使用fbdev可以播放）。</p>
<img src="/posts/undefined/9922c9416356a3945a7ad0e5c26c873b.png" class="" title="img">

<p>由于F1C200s的<strong>性能有限</strong>（实在是太有限了），<strong>视频的分辨率和帧率</strong>已经很低很低了，仍然提示系统性能<strong>不支持播放较高分辨率的视频</strong>，如果在项目中使用，建议直接I2S，外接音频解码芯片。如果你<strong>所使用的芯片性能比较差的话mplayer会给你提示如下：</strong></p>
<img src="/posts/undefined/d695224105c18a43899e3396eec95f99.png" class="" title="img">

<p>本文选用<strong>分辨率400x240、帧率5帧</strong>的视频，其<strong>音频采样率为24000，音频质量为64k，****注意视频分辨率不能大于800x480，也就是屏幕分辨率，</strong>使用如下命令播放，同样是<strong>按0键增加音量，按9键减小音量。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mplayer -vo fbdev2 400x240_5_24000_64k.mp4 </span><br></pre></td></tr></table></figure>

<p>经测试视频正常播放，视频<strong>正常播放时</strong>日志输出如下： </p>
<img src="/posts/undefined/b56b80e2d282662a3f6639418a5e2b35.png" class="" title="img">

<hr>
<h2 id="七、音频输入测试"><a href="#七、音频输入测试" class="headerlink" title="七、音频输入测试"></a>七、音频输入测试</h2><p>输入<strong>alsamixer</strong>命令得到以下图形界面配置，<strong>**（这里还有一点需要补充，按说应该在上一小节说明的，第二个Headphone选项一定要选择DAC，否则无法正常输出音视频），**按下F4**进入</strong>Capture**配置。（F1是帮助）</p>
<img src="/posts/undefined/c813d5c7c5aeeab17fcfde9a5c8115a6.png" class="" title="img">

<p><strong>Mic Boost设置为100，ADC Mixer Mic捕获使能，</strong>或者通过<strong>amixer -c 1 cset numid&#x3D;14 on命令</strong>使能捕获。</p>
<img src="/posts/undefined/2a2b1cba90b2d48e04052c2635e94f4a.png" class="" title="img">

<p>使用<strong>areconrd -l</strong>命令列出捕获<strong>硬件设备列表</strong>，很明显我们要使用<strong>card 1。</strong></p>
<img src="/posts/undefined/281eb6326cd006f52ada208bf0e17776.png" class="" title="img">

<p>根据<a target="_blank" rel="noopener" href="https://blog.csdn.net/zkw_1998/article/details/104540239">arecord录音_zkw_1998的博客-CSDN博客_arecord没有声音</a>所说的内容，并参考<a target="_blank" rel="noopener" href="https://whycan.com/t_5996.html">如何测试音频驱动比如录音，播放声音？</a>，如下图所示，<strong>指定设备为card 1，设置录音格式为wav，录音10秒。</strong></p>
<img src="/posts/undefined/9365fb23d240edbde5adb84209a64eb3.png" class="" title="img">

<p>根据上面分析得到录音指令为： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arecord -D &quot;plughw:1,0&quot; -f S16_LE -r 16000 -d 10 -t wav file.wav</span><br></pre></td></tr></table></figure>

<p>录音完毕，使用<strong>mplay file.wav</strong>进行播放。经测试，一切正常。</p>
<p>注：音频播放延迟问题解决方法：**#27楼解决**</p>
<p><a target="_blank" rel="noopener" href="https://whycan.com/t_1791.html">V3s linux 4.13 音频播放延迟了,开始以为是线程同步问题，纠结了很久</a></p>
<hr>
<h2 id="八、主要参考内容"><a href="#八、主要参考内容" class="headerlink" title="八、主要参考内容"></a>八、主要参考内容</h2><p>1.<a target="_blank" rel="noopener" href="https://whycan.com/t_6113.html">为了精华特意制作F1c200s-MP4播放器，支持硬件H264（开源板子和原理给个精华） &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a></p>
<p>\2. <a target="_blank" rel="noopener" href="https://whycan.com/t_2891.html">荔枝派音频驱动 &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a></p>
<p>3.<a target="_blank" rel="noopener" href="https://whycan.com/t_5779.html">探讨一下全志芯片的音频接口硬件电路连接应该怎么使用最好 &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a></p>
<p>4.<a target="_blank" rel="noopener" href="https://whycan.com/t_2686.html">请教一下V3S怎么外接扬声器 &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a> </p>
<p>5.<a target="_blank" rel="noopener" href="https://whycan.com/t_7583.html">白嫖党的胜利！开源F1C200S桌面小音箱！【验证通过】 &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a></p>
<p>6.<a target="_blank" rel="noopener" href="https://whycan.com/t_6376.html">V3S CODEC的使用及驱动测试（声音播放功能） &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a> </p>
<p>\7. [请问有没有大神搞定了f1c100s的主线kernel4.19下的声卡驱动？<a target="_blank" rel="noopener" href="https://whycan.com/t_2041.html">13楼@wammaw1314搞定声卡驱动,欢迎测试] &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a></p>
<p>8.[<a target="_blank" rel="noopener" href="https://whycan.com/t_5793.html">慢更]小白探索如何使用V3s播放音乐 &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a> </p>
<p>9.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/tankiii/p/13172007.html">mplayer 移植 - Tankiii - 博客园</a></p>
<p>10.<a target="_blank" rel="noopener" href="https://whycan.com/t_1791.html">V3s linux 4.13 音频播放延迟了,开始以为是线程同步问题，纠结了很久 （问题由 @Andy1234 解决，欢迎大家验证） &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a></p>
<p>11.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/twzy/p/15356109.html">小白自制Linux开发板 八. Linux音频驱动配置 - 淡墨青云 - 博客园</a></p>
<p>12.<a target="_blank" rel="noopener" href="https://whycan.com/t_5996.html">各侠大神，v3s BSP内核 如何测试音频驱动比如录音，播放声音？ &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a></p>
<p>13.<a target="_blank" rel="noopener" href="https://blog.csdn.net/zkw_1998/article/details/104540239">arecord录音_zkw_1998的博客-CSDN博客_arecord没有声音</a></p>
<p>14.<a target="_blank" rel="noopener" href="https://lkml.org/lkml/2018/12/2/259%E3%80%82">https://lkml.org/lkml/2018/12/2/259。</a></p>
<h1 id="WiFi驱动"><a href="#WiFi驱动" class="headerlink" title="WiFi驱动"></a>WiFi驱动</h1><h2 id="一、ESP-12F作无线网卡"><a href="#一、ESP-12F作无线网卡" class="headerlink" title="一、ESP-12F作无线网卡"></a>一、ESP-12F作无线网卡</h2><p>本文重点参考<a target="_blank" rel="noopener" href="https://whycan.com/viewtopic.php?id=4149&action=onlyshowauthor">众人拾柴-F1C200S通过SPI使用ESP8089或ESP8266做无线网卡</a>和<a target="_blank" rel="noopener" href="https://www.cnblogs.com/twzy/p/15160808.html">四. 通过SPI使用ESP8266做无线网卡</a>。通过使用<strong>去掉Flash的ESP-12F</strong>作为F1C200s的无线网卡，使F1C200s获得访问外网的能力。本文配置无线网卡驱动，在对ESP-12F<strong>复位</strong>之后，利用F1C200s通过SPI通信将**固件**下载*<em><strong>到ESP-12F，并通过SPI接口进行</strong>网络数据传输</em>*（我的理解，如有错误，欢迎评论区指正）。至于本文的硬件电路，详见本专栏的第一篇文章。</p>
<blockquote>
<p>Linux驱动有<strong>两种运行方式</strong>，第一种就是将驱动<strong>编译进Linux内核</strong>中，这样当Linux内核启动的时候就会自动运行驱动程序。第二种就是将驱动<strong>编译成模块</strong>(Linux下模块扩展名为.ko)，在Linux内核启动以后使用<strong>“insmod”命令或“modprobe”命令</strong>加载驱动模块。在调试驱动的时候一般都选择将其编译为模块，这样我们修改驱动以后只需要编译一下驱动代码即可，不需要编译整个 Linux 代码。</p>
</blockquote>
<blockquote>
<p><strong>再次强调：如果使用ESP-12F模块，请务必去掉模块中的Flash芯片！</strong></p>
</blockquote>
<hr>
<h2 id="二、模块化WiFi驱动"><a href="#二、模块化WiFi驱动" class="headerlink" title="二、模块化WiFi驱动"></a>二、模块化WiFi驱动</h2><p>本节首先<strong>下载ESP8089无线驱动源码（ESP12-F同样适用）</strong>，对源码进行修改后编译生成模块化驱动（.ko文件）,在<strong>Debian文件系统</strong>中加载该驱动，解决加载过程中出现的<strong>一系列问题，</strong>最终配置网络，成功<strong>ping通百度。</strong></p>
<p><strong>驱动的移植工作主要是：</strong></p>
<ul>
<li><strong>配置复位引脚，完成对ESP-12F的复位；</strong></li>
<li><strong>配置SPI通信，完成固件下载与网络通信；</strong></li>
<li><strong>配置中断引脚，辅助通信。</strong></li>
</ul>
<h3 id="1、无线驱动源码下载"><a href="#1、无线驱动源码下载" class="headerlink" title="1、无线驱动源码下载"></a>1、无线驱动源码下载</h3><p>在此处<a target="_blank" rel="noopener" href="https://github.com/notabucketofspam/ESP8089-SPI/blob/master/README.md">ESP8089-SPI&#x2F;README.md at master · notabucketofspam&#x2F;ESP8089-SPI · GitHub</a>下载<strong>esp8089无线网卡驱动，</strong>（是的我们又是用的别人写好的驱动，慢慢来吧，先按照步骤做出来现象，后面理解原理），并在Linux5.7.1<strong>源码根目录</strong>下<strong>创建spiwifi</strong>文件夹，将下载的源码放到该文件夹中。</p>
<img src="/posts/undefined/754348c5f01983dea6ce74f684309a9e.png" class="" title="img">

<h3 id="2、无线驱动源码适配"><a href="#2、无线驱动源码适配" class="headerlink" title="2、无线驱动源码适配"></a>2、无线驱动源码适配</h3><p>首先修改<strong>无线驱动项目的**KBUILD*<em>*<em><strong>，</strong>使其指向 <strong>Linux-5.7.1</strong>内核构建树的路径（</em>*内核源码目录</em>*）。KBUILD变量主要用来</strong>生成<strong>一些和</strong>汇编有关<strong>的文件（Kconfig是图形界面的描述文件）。并且添加架构和交叉编译器信息，至于本文为何使用</strong>arm-linux-gnueabi-编译器，**怎么和迪卡、墨云等人的不同，原因见这里<a target="_blank" rel="noopener" href="https://debugdump.com/topic/2894/f1c200s%E6%97%A0%E7%BA%BF%E7%BD%91%E5%8D%A1%E9%97%AE%E9%A2%98%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91?_=1674179508025">F1C200s无线网卡问题源码编译？</a>。</p>
<img src="/posts/undefined/784df72c8dbf40ba5ab9c61283328f40.png" class="" title="img">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># modify by kashine 5</span><br><span class="line"># KBUILD ?&#x3D; $(shell readlink -f &#x2F;lib&#x2F;modules&#x2F;$(KVERS_UNAME)&#x2F;build)</span><br><span class="line">KBUILD ?&#x3D; &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;</span><br><span class="line">ARCH ?&#x3D; arm</span><br><span class="line">CROSS_COMPILE ?&#x3D; arm-linux-gnueabi-</span><br></pre></td></tr></table></figure>

<p>修改<strong>KBUILD、ARCH、CROSS_COMPILE</strong>之后，使用<strong>make命令</strong>进行编译。然而并没有像迪卡那样报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*** WARNING: This kernel lacks wireless extensions.</span><br><span class="line">Wireless drivers will not work properly.</span><br></pre></td></tr></table></figure>

<p>为了不影响后续的操作，我们同样进行对****内核源码目录*<em><strong>中的</strong></em>*&#x2F;net&#x2F;wireless&#x2F;Kconfig文件*<em><strong>开头部分进行以下</strong>修改</em>*：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config WIRELESS_EXT</span><br><span class="line">    bool</span><br><span class="line">    #更改为</span><br><span class="line">    def_bool y</span><br></pre></td></tr></table></figure>

<p>前面我们提到需要对<strong>ESP12F进行复位</strong>，并且需要<strong>中断支持，</strong>一方面需要<strong>配置设备树，</strong>另一方面需要对<strong>驱动源码</strong>进行修改。在无线驱动源码目录中的<strong>spi_stub.c文件</strong>中进行如下修改，<strong>管脚编号对应关系为：PA0 – 0；PB0 – 32；PC0 – 64；PD0 – 96；PE0 – 128。</strong></p>
<img src="/posts/undefined/6ccf45352c2b1a7fb850d7adfff14a03.png" class="" title="img">

<img src="/posts/undefined/b3983e2121a1feeb3f5ec56e9e0ae9f2.png" class="" title="img">

<img src="/posts/undefined/00fb17896fc1226c497e61e654047049.png" class="" title="img">

<p>修改完成以后，使用<strong>重新编译，</strong>编译<strong>输出log</strong>如下，警告可以忽略（变量声明位置不合适）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">make -C &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F; M&#x3D;&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github</span><br><span class="line">make[1]: Entering directory &#39;&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#39;</span><br><span class="line">  AR      &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;built-in.a</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_debug.o</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;sdio_sif_esp.o</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.o</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_io.o</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_file.o</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_main.o</span><br><span class="line">In file included from .&#x2F;include&#x2F;linux&#x2F;mm_types.h:12:0,</span><br><span class="line">                 from .&#x2F;include&#x2F;linux&#x2F;mmzone.h:21,</span><br><span class="line">                 from .&#x2F;include&#x2F;linux&#x2F;gfp.h:6,</span><br><span class="line">                 from .&#x2F;include&#x2F;linux&#x2F;slab.h:15,</span><br><span class="line">                 from .&#x2F;include&#x2F;linux&#x2F;crypto.h:19,</span><br><span class="line">                 from .&#x2F;include&#x2F;crypto&#x2F;hash.h:11,</span><br><span class="line">                 from .&#x2F;include&#x2F;linux&#x2F;uio.h:10,</span><br><span class="line">                 from .&#x2F;include&#x2F;linux&#x2F;socket.h:8,</span><br><span class="line">                 from .&#x2F;include&#x2F;linux&#x2F;compat.h:15,</span><br><span class="line">                 from .&#x2F;include&#x2F;linux&#x2F;ethtool.h:17,</span><br><span class="line">                 from .&#x2F;include&#x2F;linux&#x2F;netdevice.h:37,</span><br><span class="line">                 from &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_main.c:17:</span><br><span class="line">&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_main.c: In function ‘esp_pub_init_all’:</span><br><span class="line">.&#x2F;include&#x2F;linux&#x2F;completion.h:54:2: warning: ISO C90 forbids mixed declarations and code [-Wdeclaration-after-statement]</span><br><span class="line">  struct completion work &#x3D; COMPLETION_INITIALIZER(work)</span><br><span class="line">  ^</span><br><span class="line">.&#x2F;include&#x2F;linux&#x2F;completion.h:74:43: note: in expansion of macro ‘DECLARE_COMPLETION’</span><br><span class="line"> # define DECLARE_COMPLETION_ONSTACK(work) DECLARE_COMPLETION(work)</span><br><span class="line">                                           ^~~~~~~~~~~~~~~~~~</span><br><span class="line">&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_main.c:81:2: note: in expansion of macro ‘DECLARE_COMPLETION_ONSTACK’</span><br><span class="line">  DECLARE_COMPLETION_ONSTACK(complete);</span><br><span class="line">  ^~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">In file included from &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_main.c:221:0:</span><br><span class="line">&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;eagle_fw1.h: In function ‘esp_download_fw’:</span><br><span class="line">&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;eagle_fw1.h:8:1: warning: ISO C90 forbids mixed declarations and code [-Wdeclaration-after-statement]</span><br><span class="line"> static u8 eagle_fw1[] &#x3D;</span><br><span class="line"> ^~~~~~</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_sip.o</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_ext.o</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_ctrl.o</span><br><span class="line">&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_ctrl.c: In function ‘sip_send_ampdu_action’:</span><br><span class="line">&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_ctrl.c:479:29: warning: this statement may fall through [-Wimplicit-fallthrough&#x3D;]</span><br><span class="line">                 action-&gt;ssn &#x3D; ssn;</span><br><span class="line">                 ~~~~~~~~~~~~^~~~~</span><br><span class="line">&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_ctrl.c:480:9: note: here</span><br><span class="line">         case SIP_AMPDU_RX_STOP:</span><br><span class="line">         ^~~~</span><br><span class="line">&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_ctrl.c:481:31: warning: this statement may fall through [-Wimplicit-fallthrough&#x3D;]</span><br><span class="line">                 action-&gt;index &#x3D; index;</span><br><span class="line">                 ~~~~~~~~~~~~~~^~~~~~~</span><br><span class="line">&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_ctrl.c:482:9: note: here</span><br><span class="line">         case SIP_AMPDU_TX_OPERATIONAL:</span><br><span class="line">         ^~~~</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_mac80211.o</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_utils.o</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp_pm.o</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;testmode.o</span><br><span class="line">  LD [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp8089-spi.o</span><br><span class="line">  MODPOST 1 modules</span><br><span class="line">  CC [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp8089-spi.mod.o</span><br><span class="line">  LD [M]  &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;esp8089-spi.ko</span><br><span class="line">make[1]: Leaving directory &#39;&#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#39;</span><br></pre></td></tr></table></figure>

<h3 id="3、设备树修改"><a href="#3、设备树修改" class="headerlink" title="3、设备树修改"></a>3、设备树修改</h3><p>添加<strong>SPI管脚复用</strong>与<strong>spi0结点</strong>，注意在dtsi中<strong>未对spi0进行使能。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 在pio分组添加</span><br><span class="line">spi0_pc_pins: spi0-pc-pins &#123;</span><br><span class="line">                pins &#x3D; &quot;PC0&quot;,&quot;PC1&quot;,&quot;PC2&quot;,&quot;PC3&quot;;</span><br><span class="line">                function &#x3D; &quot;spi0&quot;;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 在soc分组下添加</span><br><span class="line">spi0:spi@1c05000 &#123;</span><br><span class="line">	compatible &#x3D; &quot;allwinner,suniv-spi&quot;,</span><br><span class="line">				&quot;allwinner,sun8i-h3-spi&quot;;</span><br><span class="line">	reg &#x3D; &lt;0x01c05000 0x1000&gt;;</span><br><span class="line">	interrupts &#x3D; &lt;10&gt;;</span><br><span class="line">	clocks &#x3D; &lt;&amp;ccu CLK_BUS_SPI0&gt;, &lt;&amp;ccu CLK_BUS_SPI0&gt;;</span><br><span class="line">	clock-names &#x3D; &quot;ahb&quot;, &quot;mod&quot;;</span><br><span class="line">	resets &#x3D; &lt;&amp;ccu RST_BUS_SPI0&gt;;</span><br><span class="line">	status &#x3D; &quot;disabled&quot;;</span><br><span class="line">	#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">	#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">	pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">	pinctrl-0 &#x3D; &lt;&amp;spi0_pc_pins&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在dts文件中对<strong>spi0结点进行使能，**为什么没有添加中断复位引脚呢？*<em><strong>因为我们下载的源码是</strong>板级描述文件</em>*（</strong>大概意思是，驱动源码和设备树没有关系，直接在代码中获取硬件信息**），直接在源码中指定即可，也就是上一小节指定的中断和复位引脚。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;spi0 &#123;</span><br><span class="line">        status &#x3D; &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>需要注意的一点是，我们需要在<strong>使能SPI驱动配置，</strong>在.config中保证如下驱动处于<strong>使能状态：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SPI&#x3D;y</span><br><span class="line">CONFIG_SPI_MASTER&#x3D;y</span><br><span class="line">CONFIG_SPI_SUN4I&#x3D;y</span><br><span class="line">CONFIG_SPI_SPIDEV&#x3D;y</span><br><span class="line">CONFIG_SPI_SUN6I&#x3D;y</span><br></pre></td></tr></table></figure>

<p>此处有个坑，我们在配置.config文件的时候，<strong>一定要删除对应的注释，</strong>比如我们要配置使能<strong>CONFIG_SPI_ALTERA</strong>，那么一定要将对应的注释<strong>“CONIFG_SPI_ALTERA is not set”<strong>删除，否则</strong>可能无法成功使能</strong>对应驱动。详见<a target="_blank" rel="noopener" href="https://blog.csdn.net/whahu1989/article/details/86516233">warning: override: reassigning to symbol 问题解决。</a></p>
<img src="/posts/undefined/40f69e9cc9fd74c7656d9cedcd943308.png" class="" title="img">

<h3 id="4、模块驱动加载"><a href="#4、模块驱动加载" class="headerlink" title="4、模块驱动加载"></a>4、模块驱动加载</h3><p>将编译产生的<strong>esp8089-spi.ko驱动文件</strong>拷贝到<strong>Debian根文件系统</strong>（TF卡rootfs分区）的**&#x2F;lib&#x2F;*<em><strong>modules&#x2F;5.7.1</strong>文件夹下，如果</em><em>文件夹路径不存在<strong>需要</strong>手动创建<strong>对应的文件夹，文件夹名字一定要下配置正确，5.7.1是</strong>内核版本号，<strong>需要根据实际情况修改，当然，重新编译过的Linux</strong>内核镜像文件<strong>与</strong>设备树文件<strong>也需要更新。</strong>注意：本文直接使用的Debian根文件系统，因为buildroot制作的根文件系统各种命令都缺，而buildroot编译过于繁琐耗时。*</em></p>
<h4 id="📌-模块驱动加载命令"><a href="#📌-模块驱动加载命令" class="headerlink" title="📌 模块驱动加载命令"></a>📌 模块驱动加载命令</h4><p>更新对应的文件之后，上电启动，使用<strong>ls命令</strong>可以看到我们编译产生的驱动文件。我们首先说明模块驱动的加载方式：</p>
<blockquote>
<p>驱动编译完成以后<strong>扩展名为.ko，</strong>有两种命令可以**加载驱动模块：*<em>insmod和modprobe。*</em> **insmod 命令不能解决模块的依赖关系，*<em><strong>比如 drv.ko 依赖 first.ko 这个模块，就必须先使用insmod 命令加载 first.ko 这个模块，然后再加载 drv.ko 这个模块。</strong>而modprobe 会分析模块的依赖关系，</em>*然后会将所有的依赖模块都加载到内核中，modprobe 命令默认会去&#x2F;lib&#x2F;modules&#x2F;<kernel-version>目录中查找模块。</p>
</blockquote>
<blockquote>
<p>另外有一点需要注意，<strong>使用modprobe命令之前需要使用depmod命令，</strong>depmod命令可检测<strong>模块的相依性</strong>，供modprobe在安装模块时使用。</p>
</blockquote>
<h4 id="📌-驱动加载、遇到的问题、解决方法"><a href="#📌-驱动加载、遇到的问题、解决方法" class="headerlink" title="📌 驱动加载、遇到的问题、解决方法"></a>📌 驱动加载、遇到的问题、解决方法</h4><p>进入**&#x2F;lib&#x2F;modules&#x2F;5.7.1<strong>文件夹，使用</strong>depmod**命令检测驱动模块相依性，但是会报错如下，提示没有对应的文件（挠头，怎么会没有文件呢？）。</p>
<img src="/posts/undefined/e27805be29ea570cbf35e07e2504ce30.png" class="" title="img">

<p>参考这个博客<a target="_blank" rel="noopener" href="https://blog.csdn.net/linfengXBB/article/details/122511860">depmod: ERROR: could not open directory &#x2F;lib&#x2F;modules&#x2F;5.2.0-licheepi-zero+: No such file or dir</a>，将内核中的<strong>modules.order和modules.builtin</strong>这两个文件拷贝到根文件系统的**&#x2F;lib&#x2F;modules&#x2F;5.7.1**文件夹中，这两个文件在内核源码根目录下，如下图所示：</p>
<img src="/posts/undefined/e78f2e8c42996fbc06648dfbd1f69060.png" class="" title="img">

<p>复制完成，重新上电启动，在**&#x2F;lib&#x2F;modules&#x2F;5.7.1<strong>文件夹使用</strong>depmod命令<strong>不再出现报错，使用depmod完成模块相依性检测后，通过</strong>modprobe命令<strong>加载驱动，需注意的是，以下两个命令只有</strong>后者才可以正常执行。**</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">modprobe esp-8089.ko # 无法正常运行</span><br><span class="line">modprobe esp-8089    # 可正常运行</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/f32915e272ac25a1119383ac4e4dd52f.png" class="" title="img">

<h4 id="📌-驱动问题解决"><a href="#📌-驱动问题解决" class="headerlink" title="📌 驱动问题解决"></a>📌 驱动问题解决</h4><p><strong>modprobe执行成功，</strong>但是我们的<strong>驱动并没有正确加载</strong>，细心的朋友可以发现在加载完驱动之后，打印出以下信息，这说明我们的<strong>驱动代码既没有找到SPI主设备，有没有创建SPI从设备，</strong>这显然是不允许的，因为<strong>SPI是我们进行无线通信的基础。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">esp8089_spi: FAILED to find master</span><br><span class="line">esp8089_spi: FAILED to create slave</span><br></pre></td></tr></table></figure>

<p> 经过迪卡大佬的排查，发现是无线驱动代码中<strong>spi_stub.c文件</strong>出错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct spi_device* sif_platform_new_device(void) &#123;</span><br><span class="line">  master &#x3D; spi_busnum_to_master(esp_board_spi_devices[0].bus_num);</span><br><span class="line">  if(!master)</span><br><span class="line">    printk(&quot;esp8089_spi: FAILED to find master\n&quot;);&#x2F;&#x2F; 报错</span><br><span class="line">  spi &#x3D; spi_new_device( master, esp_board_spi_devices );</span><br><span class="line">  if(!spi)</span><br><span class="line">    printk(&quot;esp8089_spi: FAILED to create slave\n&quot;);&#x2F;&#x2F; 报错</span><br><span class="line">  printk(&quot;esp8089_spi: I will go dead\n&quot;);</span><br><span class="line">  if(spi_setup(spi))</span><br><span class="line">    printk(&quot;esp8089_spi: FAILED to setup slave\n&quot;); </span><br><span class="line">  printk(&quot;esp8089_spi: I am OK\n&quot;);</span><br><span class="line">  return spi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说下面的代码出了问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">master &#x3D; spi_busnum_to_master(esp_board_spi_devices[0].bus_num);</span><br></pre></td></tr></table></figure>

<p>其中，<strong>esp_board_spi_devices[]<strong>为</strong>spi_stub.c文件</strong>前面定义的结构体：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static struct spi_board_info esp_board_spi_devices[] &#x3D; &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    .modalias &#x3D; &quot;ESP8089_0&quot;,</span><br><span class="line">    .max_speed_hz &#x3D; MAX_SPEED_HZ,</span><br><span class="line">    .bus_num &#x3D; 1,</span><br><span class="line">    .chip_select &#x3D; 0,</span><br><span class="line">    .mode &#x3D; 0,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>迪卡分析：</strong></p>
<p>bus_num就是1；spi_busnum_to_master(1)研究一下；每个master都对应一个bus num。<br><strong>注册spi slave设备（ESP-12F SPI），由dts解析得到，dts会指定spi slave挂载在哪个bus num下，由bus num就可以得到对应的spi master 了。（可能不合理，但能跑）</strong></p>
</blockquote>
<p> ****将bus_num改为0后，**重新编译无线驱动代码并上电运行，**打印信息如下：</p>
<img src="/posts/undefined/7c86865c8be03390097858ca76f248a0.png" class="" title="img">

<p>奇怪不奇怪，我们的<strong>spi0</strong>分明<strong>没有作为其他设备</strong>的通信接口，但是报错信息提示我们<strong>片选地址已被使用。</strong> </p>
<blockquote>
<p><strong>墨云分析：</strong></p>
<p>可见<strong>spi_master已经注册成功</strong>，但是<strong>chipselect 0 already in use</strong>，说明当前配置SPI0，中<strong>片选为0的地址已经被使用，</strong>实时上我们并未链接其他设备，所以怀疑是其他问题，通过查找资料SPI通信模式分为4中模式，经过逐一测试发现SPI_MODE_3也就是(4)可用。</p>
</blockquote>
<p>根据墨云的分析对<strong>无线驱动代码spi_stub.c文件</strong>中的代码进行修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static struct spi_board_info esp_board_spi_devices[] &#x3D; &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    .modalias &#x3D; &quot;ESP8089_0&quot;,</span><br><span class="line">    .max_speed_hz &#x3D; MAX_SPEED_HZ,</span><br><span class="line">    .bus_num &#x3D; 0,&#x2F;&#x2F; modify by kashine 5</span><br><span class="line">    .chip_select &#x3D; 0,</span><br><span class="line">    .mode &#x3D; SPI_MODE_3,&#x2F;&#x2F; modify by kashine 5</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>修改后重新编译，上电后加载esp-8089驱动。****注意，如果使用我的硬件电路，一定要注意，如果屏幕较大，并且同时使用无线模块，可能导致供电不足，现象是屏幕熄灭、串口关闭，解决办法是除串口USB之外，利用USB HUB扩展的USB接口增加一个USB供电。**模块驱动加载日志**如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">root@likaiqin-virtual-machine:&#x2F;lib&#x2F;modules&#x2F;5.7.1# modprobe esp8089-spi</span><br><span class="line">[  128.493238] esp8089_spi: loading out-of-tree module taints kernel.</span><br><span class="line">[  128.508273] esp8089_spi: EAGLE DRIVER VER bdf5087c3deb</span><br><span class="line">[  129.114478] esp8089_spi: esp_spi_dummy_probe enter</span><br><span class="line">[  129.120111] esp8089_spi: register board OK</span><br><span class="line">[  129.124623] esp8089_spi: sem_timeout &#x3D; 0</span><br><span class="line">[  129.340023] esp8089_spi: ESP8089 power up OK</span><br><span class="line">[  129.345448] esp8089_spi: esp_spi_probe ENTER</span><br><span class="line">[  129.350322] esp8089_spi: esp_setup_spi</span><br><span class="line">[  129.354477] esp8089_spi: sif_spi_protocol_init</span><br><span class="line">[  129.359437] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1559</span><br><span class="line">[  129.370920] esp8089_spi: fail_count &#x3D; 0</span><br><span class="line">[  129.498009] rx:[0x00],[0x00],[0x00],[0x00],[0x00],[0x00],[0x00],[0x00],[0x00],[0x00]</span><br><span class="line">[  129.606625] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1559</span><br><span class="line">[  129.618134] esp8089_spi: fail_count &#x3D; 1</span><br><span class="line">[  129.733228] rx:[0x3f],[0x09],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  129.841860] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1559</span><br><span class="line">[  129.853379] esp8089_spi: fail_count &#x3D; 2</span><br><span class="line">[  130.054228] rx:[0xff],[0xff],[0x01],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  130.661815] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1578</span><br><span class="line">[  130.679097] rx:[0xff],[0xff],[0x01],[0x10],[0xff],[0xff],[0x00],[0xff],[0xff],[0xff]</span><br><span class="line">[  131.186870] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1591</span><br><span class="line">[  131.230265] rx:[0xff],[0xff],[0x00],[0x90],[0xff],[0xff],[0x00],[0xff],[0xff],[0xff]</span><br><span class="line">[  131.751505] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1603</span><br><span class="line">[  131.795833] rx:[0xff],[0x00],[0x02],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  132.317567] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1617</span><br><span class="line">[  132.363805] rx:[0xff],[0x00],[0x03],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  132.886662] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1630</span><br><span class="line">[  132.935628] rx:[0xff],[0x00],[0x02],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  133.459909] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1643</span><br><span class="line">[  133.512035] rx:[0xff],[0x00],[0x03],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  134.037354] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1655</span><br><span class="line">[  134.091882] rx:[0xff],[0xff],[0x00],[0x00],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  134.617589] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1655</span><br><span class="line">[  134.672142] rx:[0xff],[0xff],[0x00],[0x25],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  135.198185] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1655</span><br><span class="line">[  135.254763] rx:[0xff],[0xff],[0x00],[0x10],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  135.780766] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1655</span><br><span class="line">[  135.834891] rx:[0xff],[0xff],[0x00],[0x12],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  136.361421] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1655</span><br><span class="line">[  136.416215] rx:[0xff],[0xff],[0x00],[0x00],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  136.942723] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1655</span><br><span class="line">[  136.997550] rx:[0xff],[0xff],[0x00],[0x06],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  137.523992] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1655</span><br><span class="line">[  137.578214] rx:[0xff],[0xff],[0x00],[0x00],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  138.104701] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1655</span><br><span class="line">[  138.159169] rx:[0xff],[0xff],[0x00],[0x00],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  138.685676] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1668</span><br><span class="line">[  138.740390] rx:[0xff],[0x00],[0x00],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  138.767739] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1681</span><br><span class="line">[  138.834001] rx:[0xff],[0x00],[0x02],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  138.861304] esp8089_spi: &#x2F;home&#x2F;project01&#x2F;pro01&#x2F;new_kernel&#x2F;linux-5.7.1&#x2F;spiwifi&#x2F;ESP8089-SPI-github&#x2F;spi_sif_esp.c, 1694</span><br><span class="line">[  138.963902] rx:[0xff],[0x00],[0x01],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff],[0xff]</span><br><span class="line">[  139.998233] esp8089_spi: esp_pub_init_all</span><br><span class="line">[  140.021398] esp8089_spi: esp_download_fw</span><br><span class="line">[  140.459848] esp8089_spi: sif_platform_irq_init enter</span><br><span class="line">[  150.889369] resetting event timeout</span><br><span class="line">[  150.910574] esp8089_spi: esp_init_all failed: -110</span><br><span class="line">[  150.932966] esp8089_spi: first error exit</span><br><span class="line">[  150.954067] esp8089_spi: esp_spi_probe EXIT</span><br><span class="line">[  150.975268] esp8089_spi: sem_timeout &#x3D; 0</span><br><span class="line">[  150.995481] esp8089_spi: esp_spi_init err 0</span><br><span class="line">root@likaiqin-virtual-machine:&#x2F;lib&#x2F;modules&#x2F;5.7.1# </span><br></pre></td></tr></table></figure>

<p>从上面的驱动加载日志中可以就看出<strong>两个信息</strong>，<strong>一个是固件下载成功，一个是超时问题。</strong></p>
<img src="/posts/undefined/8305e8218100d01d981566e9b5374900.png" class="" title="img">

<p>针对<strong>超时问题，</strong>采用迪卡的<strong>屏蔽操作</strong>，相当于强制跳过超时警告执行。修改<strong>无线驱动源码的****esp_sip.c文件</strong>如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">extern struct task_struct *sif_irq_thread;&#x2F;&#x2F; 声明变量</span><br><span class="line">sip_poll_bootup_event(struct esp_sip *sip)</span><br><span class="line">&#123;</span><br><span class="line">	int ret &#x3D; 0;</span><br><span class="line"></span><br><span class="line">        esp_dbg(ESP_DBG_TRACE, &quot;polling bootup event... \n&quot;);</span><br><span class="line"></span><br><span class="line">	if (gl_bootup_cplx)</span><br><span class="line">		ret &#x3D; wait_for_completion_timeout(gl_bootup_cplx, 2 * HZ);</span><br><span class="line"></span><br><span class="line">	esp_dbg(ESP_DBG_TRACE, &quot;******time remain****** &#x3D; [%d]\n&quot;, ret);</span><br><span class="line">	if (ret &lt;&#x3D; 0) &#123;</span><br><span class="line">		esp_dbg(ESP_DBG_ERROR, &quot;bootup event timeout\n&quot;);</span><br><span class="line">	</span><br><span class="line">                &#x2F;&#x2F; modify by kashine 5</span><br><span class="line">                &#x2F;&#x2F; return -ETIMEDOUT;</span><br><span class="line">                sip-&gt;epub-&gt;wait_reset &#x3D; 0;</span><br><span class="line">                wake_up_process(sif_irq_thread);</span><br><span class="line">                esp_dbg(ESP_DBG_ERROR, &quot;for unknow reason,we may not be informed the boot&#x2F;rst complete event, assume it completed and continue here\n&quot;);</span><br><span class="line">                msleep(50);</span><br><span class="line">        &#125;    </span><br><span class="line"></span><br><span class="line">	if(sif_get_ate_config() &#x3D;&#x3D; 0)&#123;</span><br><span class="line">		ret &#x3D; esp_register_mac80211(sip-&gt;epub);</span><br><span class="line">	&#125;</span><br><span class="line">sip_poll_resetting_event(struct esp_sip *sip)</span><br><span class="line">&#123;</span><br><span class="line">	int ret &#x3D; 0;</span><br><span class="line"></span><br><span class="line">        esp_dbg(ESP_DBG_TRACE, &quot;polling resetting event... \n&quot;);</span><br><span class="line"></span><br><span class="line">	if (gl_bootup_cplx)</span><br><span class="line">		ret &#x3D; wait_for_completion_timeout(gl_bootup_cplx, 10 * HZ);</span><br><span class="line"></span><br><span class="line">	esp_dbg(ESP_DBG_TRACE, &quot;******time remain****** &#x3D; [%d]\n&quot;, ret);</span><br><span class="line">	if (ret &lt;&#x3D; 0) &#123;</span><br><span class="line">		esp_dbg(ESP_DBG_ERROR, &quot;resetting event timeout\n&quot;);</span><br><span class="line">                &#x2F;&#x2F; modify by kashine 5</span><br><span class="line">                &#x2F;&#x2F; return -ETIMEDOUT;</span><br><span class="line">                sip-&gt;epub-&gt;wait_reset &#x3D; 0;</span><br><span class="line">                wake_up_process(sif_irq_thread);</span><br><span class="line">                esp_dbg(ESP_DBG_ERROR, &quot;for unknow reason,we may not be informed the boot&#x2F;rst complete event, assume it completed and continue here\n&quot;);</span><br><span class="line">                msleep(50);</span><br><span class="line">        &#125;    </span><br><span class="line">      </span><br><span class="line">        esp_dbg(ESP_DBG_TRACE, &quot;target resetting %d %p\n&quot;, ret, gl_bootup_cplx);</span><br></pre></td></tr></table></figure>

<p>修改完成，<strong>重新编译</strong>上电启动，加载驱动后， 输出日志如下（部分）：</p>
<img src="/posts/undefined/f1ff4f1747002bf4b78843013292919e.png" class="" title="img">

<h3 id="5、启动网卡"><a href="#5、启动网卡" class="headerlink" title="5、启动网卡"></a>5、启动网卡</h3><p>至此，<strong>需要加载esp8089无线驱动，</strong>然后使用命令<strong>ifconfig wlan0 up启动网卡：</strong></p>
<img src="/posts/undefined/9ab34caf5e587aae741b42db241e4333.png" class="" title="img">

<p>使用<strong>ifconfig查看网卡：</strong></p>
<img src="/posts/undefined/0d96788e43d1f051a6ef6ee28a559bf8.png" class="" title="img">

<h3 id="6、连接互联网"><a href="#6、连接互联网" class="headerlink" title="6、连接互联网"></a>6、连接互联网</h3><p>在<strong>Debian根文件系统制作</strong>的时候，我们已经<strong>安装了对应的网络组件，</strong>此处我们<strong>使用组件wpa_supplicant连接wifi，</strong>wifi为我的手机热点。在<strong>Debian根文件系统的&#x2F;etc目录下</strong>创建配置文件，并按照以下格式<strong>输入wifi信息：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;wpa_supplicant.conf</span><br><span class="line">network&#x3D;&#123;</span><br><span class="line">  ssid&#x3D;&quot;wifi名称&quot;</span><br><span class="line">  psk&#x3D;&quot;wifi密码&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后执行如下指令进行wifi连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wpa_supplicant -B -d -i wlan0 -c &#x2F;etc&#x2F;wpa_supplicant.conf</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/415f08b0f8898fe9f9e972bd6a8d27a6.png" class="" title="img">

<img src="/posts/undefined/06398bad6c8f654fe38d6a772551ad1d.png" class="" title="img">

<p>**执行*<em>udhcpc -i wlan0*<em>命令，获取IP地址：</em></em></p>
<img src="/posts/undefined/794f0909dd796e97df91aab2f9966498.png" class="" title="img">

<p> <strong>ping一下百度试试：</strong></p>
<img src="/posts/undefined/73618b5b0db458276fc4f2e15f3247a9.png" class="" title="img">

<h3 id="7、apt-get命令测试"><a href="#7、apt-get命令测试" class="headerlink" title="7、apt-get命令测试"></a>7、apt-get命令测试</h3><p>之前我们在<strong>制作Debian根文件系统</strong>的时候，安装过<strong>evtest触摸屏测试</strong>软件，现在我们把它<strong>卸载</strong>掉，然后<strong>重新安装</strong>，以此测试<strong>apt-get安装软件</strong>是否正常。首先使用<strong>dpkg –list</strong>查看是否安装了evtest软件。</p>
<img src="/posts/undefined/62328a4b6ccd62e329e47006ed64e4b4.png" class="" title="img">

<p>如果安装了evtest软件，使用<strong>apt-get remove命令卸载</strong>，在卸载过程中，弹出了一堆的<strong>报错信息</strong>如下，我们来分析一下，<strong>systemd-journal invoked oom-killer，</strong>提示进程被杀掉，OOM killer(Out Of Memory killer)，该机制会<strong>监控那些占用内存过大</strong>，尤其是<strong>瞬间占用内存很快</strong>的进程，<strong>防止内存耗尽</strong>而自动把该进程杀掉。<em><strong>*这样看应该是内核检测到系统内存不足、挑选并杀掉某个进程。*</strong></em></p>
<img src="/posts/undefined/c9706b3f11c0e6b56170f5ddd8ff0930.png" class="" title="img">

<p>为什么会内存不足呢？DDR有64M，我们在<strong>制作根文件系统</strong>的时候添加了<strong>swap分区，</strong>将一部分硬盘作为<strong>虚拟内存，</strong>使用<strong>free命令</strong>查看一下内存的使用情况，咦，<strong>swap分区怎么是0？</strong>后来发现我多次制作根文件系统，在<strong>重新制作根文件系统</strong>的时候没有添加swap分区。</p>
<img src="/posts/undefined/07c45a78f0a6f6efe93c11f7a6b1c513.png" class="" title="img">

<p>按照Debian根文件系统制作博客的教程<strong>重新建立swap分区</strong>，如下：</p>
<img src="/posts/undefined/19961f5e53be6a00c7cb9fa794a0aec0.png" class="" title="img">

<p>重新卸载<strong>evtest软件，</strong>不再报错。</p>
<img src="/posts/undefined/66acc46d39339cac4323bbe8ef531589.png" class="" title="img">

<p> 使用<strong>dpkg –list命令</strong>查看是否成功卸载，发现不存在evtest软件，<strong>正常卸载。</strong></p>
<img src="/posts/undefined/4413562f035878e54fb627b2099f5e5f.png" class="" title="img">

<p>重新安装evtest软件，正常安装。<strong>至此，F1C200s无线网卡驱动完成，可以直接使用apt-get命令安装软件了，不必在Ubuntu下使用qemu模拟器安装。</strong></p>
<img src="/posts/undefined/85766069075a43d5023e943d00b0ba8d.png" class="" title="img">

<h3 id="8、文件传输"><a href="#8、文件传输" class="headerlink" title="8、文件传输"></a>8、文件传输</h3><p><strong>如何在虚拟机中的Ubuntu和我们的开发板之间传输文件呢？</strong></p>
<p>首先保证我们的<strong>物理机、Ubuntu虚拟机、开发板</strong>在同一个热点的<strong>同一个网段</strong>下，可以<strong>相互ping通，</strong>如下图所示，这里我就不再赘述，详细内容参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41709234/article/details/124175809">linux开发板访问互联网 笔记本win10中虚拟机_Kashine的博客-CSDN博客</a>。</p>
<img src="/posts/undefined/2942c4ace6cf53540457d3da7e5752fe.png" class="" title="img">

<img src="/posts/undefined/35c919fd794327e327748acc463b4711.png" class="" title="img">

<p>为了防止混淆，使用<strong>vi &#x2F;etc&#x2F;hostname</strong>命令<strong>修改主机名，</strong>将主机Ubuntu命名为<strong>Ubuntu，</strong>开发板命名为：<strong>Debian。</strong></p>
<img src="/posts/undefined/1cad0dbef099f5553835ffe36282b131.png" class="" title="img">

<img src="/posts/undefined/018c548b52fae84450114d94df2aef5d.png" class="" title="img">

<p>Debian和Ubuntu都要打开允许ssh以root登录， 使用 <strong>vi &#x2F;etc&#x2F;ssh&#x2F;sshd_config命令</strong>打开文件写入<strong>PermitRootLogin yes，</strong>如果未使能<strong>服务端SSH服务配置了root用户登录策略，</strong>会产生<strong>“Permission denied, please try again.”</strong>的报错提示。</p>
<img src="/posts/undefined/801e11fa7c01f03f101394c6e166eac7.png" class="" title="img">

<img src="/posts/undefined/34a2a195a4c466a779cf4e36f3ed44ae.png" class="" title="img">

<img src="/posts/undefined/cbed3e023d55d1ab7f7cf45f6dfecc13.png" class="" title="img">

<p>配置完成后，使用如下命令<strong>进入Debian:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ssh root@Debian ip</span><br><span class="line">ssh root@192.168.180.164</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/ccaffc285cf97b06a558cef85f5580c7.png" class="" title="img">

<p> 可以<strong>在Ubuntu中控制Debian</strong>播放<strong>mp3文件或者是mp4文件：</strong></p>
<img src="/posts/undefined/0983e83d806329002b5ef0e544de2154.png" class="" title="img">

<img src="/posts/undefined/a5a1ef096faeb64864904c5b981e3ba2.png" class="" title="img">

<p>跑题了，跑题了，怎么放音乐看视频去了，大年初一可以放松一下，哈哈。来看<strong>文件传输，</strong>首先使用<strong>exit命令</strong>退出上面的<strong>远程访问。</strong>如果<strong>欲将Ubuntu中的文件复制到Debian中，</strong>应该怎么操作呢？在Debian中使用指令<strong>scp <a href="mailto:&#114;&#x6f;&#x6f;&#x74;&#x40;&#x31;&#57;&#50;&#x2e;&#49;&#x36;&#56;&#46;&#49;&#56;&#x30;&#46;&#49;&#54;&#52;">&#114;&#x6f;&#x6f;&#x74;&#x40;&#x31;&#57;&#50;&#x2e;&#49;&#x36;&#56;&#46;&#49;&#56;&#x30;&#46;&#49;&#54;&#52;</a>(Ubuntu的ip):&#x2F;Ubuntu中文件路径 &#x2F;拷贝到Debian中的位置</strong>可以将Ubuntu中文件拷贝到Debian中。可以看到<strong>传输速度为734.4KB&#x2F;s</strong>还可以吧，说的过去，<strong>整个过程不消耗流量哦（我是用的手机热点）。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp root@192.168.180.59:&#x2F;mnt&#x2F;hgfs&#x2F;Desktop&#x2F;opencv3.4.13bit32.rar .&#x2F;</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/c94fffc8e38119212c1577af33f8ca0b.png" class="" title="img">

<img src="/posts/undefined/902bfc1914286dcd5d2ae62b36db2f1d.png" class="" title="img">

<p>至此， 本文的需求全部解决，至于墨云所说开发板<strong>只要大量发送数据，</strong>比如作为Web服务器被访问，<strong>wifi就挂了，</strong>本文测试了在Ubuntu下<strong>将Debian中的文件拷贝到Ubuntu，</strong>也就是<strong>开发板发送数据，</strong>并未出现报错或者wifi断开的情况。</p>
<img src="/posts/undefined/35803ad1bd3fcc7a0cf1c0bf9c7458da.png" class="" title="img">

<p>我错了我错了，又试了一次，<strong>wifi挂了。</strong></p>
<img src="/posts/undefined/4c80941c372d773fd1ef9eeb2afe26db.png" class="" title="img">

<p>Debian<strong>接收数据</strong>经过<strong>连续多次测试正常。</strong></p>
<img src="/posts/undefined/d542b963d5f70286bf8ffff6bd1246cb.png" class="" title="img">

<p>经连<strong>续多次测试</strong>发现<strong>发送数据</strong>也没有问题，bug无法复现，可能是发送的文件太小，随缘解决吧。</p>
<img src="/posts/undefined/d6f032538e17aef39fcaa34a8fdef281.png" class="" title="img">

<p>至此，无线网卡功能全部实现，但我们发现<strong>每次上电之后都需要加载驱动，</strong>很是麻烦，能不能直接<strong>将驱动编译到内核</strong>呢？当然可以。 </p>
<hr>
<h2 id="三、内核WiFi驱动"><a href="#三、内核WiFi驱动" class="headerlink" title="三、内核WiFi驱动"></a>三、内核WiFi驱动</h2><h3 id="1、内核驱动代码下载"><a href="#1、内核驱动代码下载" class="headerlink" title="1、内核驱动代码下载"></a>1、内核驱动代码下载</h3><p>首先在<a target="_blank" rel="noopener" href="https://whycan.com/t_5870.html">F1C200S修改ESP8089源码，由原来板极描述文件改为设备树，一键配置</a></p>
<p>或者墨云提供的下载链接<a target="_blank" rel="noopener" href="https://files.cnblogs.com/files/twzy/esp8089.zip%EF%BC%88%E5%A4%8D%E5%88%B6%E5%88%B0%E5%9C%B0%E5%9D%80%E6%A0%8F%E4%B8%8B%E8%BD%BD%EF%BC%89%E4%B8%8B%E8%BD%BD**%E5%86%85%E6%A0%B8wifi%E9%A9%B1%E5%8A%A8%E4%BB%A3%E7%A0%81%E6%BA%90%E7%A0%81%EF%BC%8C**%E5%85%B6%E5%AE%9E%E6%AD%A4%E6%BA%90%E7%A0%81**%E5%A4%A7%E9%83%A8%E5%88%86%E5%92%8C%E4%B8%8A%E9%9D%A2%E6%A8%A1%E5%9D%97%E5%8C%96%E9%A9%B1%E5%8A%A8%E7%9B%B8%E5%90%8C%EF%BC%8C**%E5%8F%AA%E6%98%AF%E6%AD%A4%E5%A4%84%E4%BD%BF%E7%94%A8%E8%AE%BE%E5%A4%87%E6%A0%91%E8%8E%B7%E5%8F%96%E8%AE%BE%E5%A4%87%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%B0%86%E9%A9%B1%E5%8A%A8%E6%96%87%E4%BB%B6**%E7%9B%B4%E6%8E%A5%E7%BC%96%E8%AF%91%E5%88%B0%E5%86%85%E6%A0%B8%E3%80%82**%E4%B8%8B%E8%BD%BD%E7%9A%84%E4%BB%A3%E7%A0%81%E4%B9%9F%E6%98%AF%E5%9C%A8%E4%B8%8A%E9%9D%A2%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8A%E4%BF%AE%E6%94%B9%E8%80%8C%E6%9D%A5%E7%9A%84%EF%BC%8C%E8%AF%A6%E8%A7%81%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%93%BE%E6%8E%A5%E3%80%82">https://files.cnblogs.com/files/twzy/esp8089.zip（复制到地址栏下载）下载**内核wifi驱动代码源码，**其实此源码**大部分和上面模块化驱动相同，**只是此处使用设备树获取设备信息，将驱动文件**直接编译到内核。**下载的代码也是在上面的基础上修改而来的，详见第一个链接。</a></p>
<h3 id="2、设备树修改"><a href="#2、设备树修改" class="headerlink" title="2、设备树修改"></a>2、设备树修改</h3><p>设备树修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&amp;spi0 &#123;</span><br><span class="line">        status &#x3D; &quot;okay&quot;;   </span><br><span class="line">        esp8089@0 &#123;</span><br><span class="line">            status &#x3D; &quot;okay&quot;;</span><br><span class="line">            compatible &#x3D; &quot;boss,esp8089&quot;;</span><br><span class="line">            spi-cpol;</span><br><span class="line">            spi-cpha;</span><br><span class="line">            reg &#x3D; &lt;0&gt;;</span><br><span class="line">            spi-max-frequency &#x3D; &lt;30000000&gt;;</span><br><span class="line">            reset&#x3D; &lt;135&gt;; &#x2F;&#x2F;PE7</span><br><span class="line">            interrupt&#x3D; &lt;136&gt;; &#x2F;&#x2F;PE8</span><br><span class="line">            debug&#x3D; &lt;0&gt;;</span><br><span class="line">        &#125;; </span><br><span class="line">&#125;;</span><br><span class="line">spi0:spi@1c05000 &#123;</span><br><span class="line">	compatible &#x3D; &quot;allwinner,suniv-spi&quot;,</span><br><span class="line">				&quot;allwinner,sun8i-h3-spi&quot;;</span><br><span class="line">	reg &#x3D; &lt;0x01c05000 0x1000&gt;;</span><br><span class="line">	interrupts &#x3D; &lt;10&gt;;</span><br><span class="line">	clocks &#x3D; &lt;&amp;ccu CLK_BUS_SPI0&gt;, &lt;&amp;ccu CLK_BUS_SPI0&gt;;</span><br><span class="line">	clock-names &#x3D; &quot;ahb&quot;, &quot;mod&quot;;</span><br><span class="line">	resets &#x3D; &lt;&amp;ccu RST_BUS_SPI0&gt;;</span><br><span class="line">	status &#x3D; &quot;disabled&quot;;</span><br><span class="line">	#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">	#size-cells &#x3D; &lt;0&gt;;</span><br><span class="line">	pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">	pinctrl-0 &#x3D; &lt;&amp;spi0_pc_pins&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3、内核无线驱动源码修改"><a href="#3、内核无线驱动源码修改" class="headerlink" title="3、内核无线驱动源码修改"></a>3、内核无线驱动源码修改</h3><p>首先将内核无线驱动源码<strong>复制到内核源码的&#x2F;drivers&#x2F;sta****ging&#x2F;<strong>目录下，因为我们</strong>使用的是SPI0，</strong>因此<strong>无线驱动源码中的spi_stub.c文件</strong>需要修改如上一小节所示。</p>
<img src="/posts/undefined/323216bba976a2e6e8ede3d258d2a2e9.png" class="" title="img">

<p>然后在<strong>spi_stub.c文件</strong>对我们使用的<strong>管脚进行修改，</strong>需要修改吗？是不需要的，我们之前对管脚进行修改是因为我们用的<strong>spi_stub.c文件</strong>中的变量描述硬件信息，现在我们使用<strong>设备树描述硬件设备信息，</strong>我们下载的代码中已经<strong>集成设备树解析函数，</strong>因此我们无需再次在代码中指定硬件信息。</p>
<p>加入防止超时的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extern struct task_struct *sif_irq_thread;</span><br></pre></td></tr></table></figure>

<img src="/posts/undefined/03fe130cfe4945726596d2d09f3a4f0c.png" class="" title="img">

<img src="/posts/undefined/39a904febda051e93bec2f3e16cb7b40.png" class="" title="img">

<p>修改完成使用<strong>make命令进行编译，</strong>发现以下<strong>错误，</strong>提示的意思是<strong>函数本来是void类型，结果我们按照有返回值的形式使用函数，</strong>对<strong>esp_debug.c文件</strong>中的内容进行修改：</p>
<img src="/posts/undefined/2f47d747e17d6a1f4685698e3160472c.png" class="" title="img">

<p> <strong>esp_debug.c文件</strong>修改完成如下所示，重新使用<strong>make命令</strong>编译内核，不再报错。</p>
<img src="/posts/undefined/55b9ffbe2a3374d2ab4074d66a6267e3.png" class="" title="img">

<img src="/posts/undefined/b3ae7632b63333909b6cb4315f7f229a.png" class="" title="img">

<h3 id="4、无线网卡测试"><a href="#4、无线网卡测试" class="headerlink" title="4、无线网卡测试"></a>4、无线网卡测试</h3><p><strong>编译完成，</strong>更新内核镜像文件，上电启动，内核<strong>自动加载</strong>无线驱动，<strong>无需</strong>手动modprobe esp8089.ko，进入Debian系统后，依次输入如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ifconfig wlan0 up #启动网卡</span><br><span class="line">ifconfig #查看现有网卡</span><br><span class="line"></span><br><span class="line">vi &#x2F;etc&#x2F;wpa_supplicant.conf # 配置WiFi信息</span><br><span class="line"></span><br><span class="line">network&#x3D;&#123;</span><br><span class="line">  ssid&#x3D;&quot;热点&quot;</span><br><span class="line">  psk&#x3D;&quot;密码&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wpa_supplicant -B -i wlan0 -c &#x2F;etc&#x2F;wpa_supplicant.conf</span><br><span class="line"></span><br><span class="line">udhcpc -i wlan0</span><br><span class="line"></span><br><span class="line">ping www.baidu.com</span><br></pre></td></tr></table></figure>

<p><strong>成功ping通百度，</strong>此次连接的不是手机热点，而是WiFi，延迟略微降低。对于文件传输等请自行测试，本文不再赘述。</p>
<img src="/posts/undefined/7b18af4e15dac9559c239faba439a3c6.png" class="" title="img">

<hr>
<h2 id="四、参考内容"><a href="#四、参考内容" class="headerlink" title="四、参考内容"></a>四、参考内容</h2><p>\1. <a target="_blank" rel="noopener" href="https://whycan.com/viewtopic.php?id=4149&action=onlyshowauthor">众人拾柴-F1C200S通过SPI使用ESP8089或ESP8266做无线网卡 &#x2F; 全志 SOC &#x2F; WhyCan Forum(哇酷开发者社区)</a></p>
<p>\2. <a target="_blank" rel="noopener" href="https://www.cnblogs.com/twzy/p/15160808.html">小白自制Linux开发板 四. 通过SPI使用ESP8266做无线网卡 - 淡墨青云 - 博客园</a></p>
<p>\3. [<a target="_blank" rel="noopener" href="https://whycan.com/t_5870.html">ESP8089-SPI移植支持设备树]F1C200S修改ESP8089源码，由原来板极描述文件改为设备树，一键配置。</a></p>
<p>4.<a target="_blank" rel="noopener" href="http://47.111.11.73/docs/boards/arm-linux/zdyz-i.mx6ull.html">i.MX6ULL Linux阿尔法开发板 — 正点原子资料下载中心 1.0.0 文档</a></p>
<p>\5. <a target="_blank" rel="noopener" href="https://blog.csdn.net/linfengXBB/article/details/122511860">depmod: ERROR: could not open directory &#x2F;lib&#x2F;modules&#x2F;5.2.0-licheepi-zero+: No such file or dir</a></p>
<p>6.<a target="_blank" rel="noopener" href="https://blog.csdn.net/jazzsoldier/article/details/70053495">modprobe: FATAL: Module xxx.ko not found in directory &#x2F;lib&#x2F;modules&#x2F;$(uname -r)_SoldierJazz2021的博客-CSDN博客</a></p>
<p>7.<a target="_blank" rel="noopener" href="https://blog.csdn.net/whahu1989/article/details/86516233">warning: override: reassigning to symbol 问题解决_爱就是恒久忍耐的博客-CSDN博客_reassigning to symbol</a></p>
<p>8.<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/372994818">腾讯云的轻量应用服务器修改主机名hostname的方法 - 知乎</a></p>
<p>9.<a target="_blank" rel="noopener" href="https://blog.csdn.net/mainmaster/article/details/124317752">使用ssh 连接linux 并传送文件_SIXTOME的博客-CSDN博客_linux ssh 传文件</a></p>
<h1 id="NES游戏移植"><a href="#NES游戏移植" class="headerlink" title="NES游戏移植"></a>NES游戏移植</h1><h2 id="一、前言-3"><a href="#一、前言-3" class="headerlink" title="一、前言"></a>一、前言</h2><p>经过前面<strong>十篇文章，</strong>我们的小电脑现拥有自己的<strong>Debian系统，</strong>可以进行<strong>屏幕显示与触摸，</strong>可以播放<strong>音频、视频，</strong>可以<strong>连接键盘、U盘</strong>等设备，也可以连接<strong>无线络</strong>下载软件、<strong>远程访问</strong>与<strong>文件传输</strong>等等。虽然小电脑功能已经非常齐全了，但是我们它还是个空空荡荡的小电脑，<strong>我们是不是应该娱乐一下、放松一下呢？必须滴啊，开始整活。</strong></p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><hr>
<h3 id="二、环境搭建"><a href="#二、环境搭建" class="headerlink" title="二、环境搭建"></a>二、环境搭建</h3><h3 id="1、GCC、G-编译器安装"><a href="#1、GCC、G-编译器安装" class="headerlink" title="1、GCC、G++编译器安装"></a>1、GCC、G++编译器安装</h3><p>通过上一篇文章的学习，我们可以使用<strong>无线网进行软件安装，</strong>使用<strong>apt-get命令****安装gcc、g++编译器：</strong></p>
<img src="/posts/undefined/a6f8f951ac5885bd8ca334401b115127.png" class="" title="img">

<p>安装完成，使用<strong>gcc -v验证是否安装成功，</strong>如下图所示为安装成功输出日志。</p>
<img src="/posts/undefined/967b3890f32c2be550c9427662ba9208.png" class="" title="img">

<img src="/posts/undefined/0f9dc3fe557f4ff8f5fc30099ffa2725.png" class="" title="img">

<h3 id="2、音频组件alsa-utils安装"><a href="#2、音频组件alsa-utils安装" class="headerlink" title="2、音频组件alsa-utils安装"></a>2、音频组件alsa-utils安装</h3><p>移植NES<strong>游戏机模拟器程序</strong>，这里使用InfoNes，<strong>InfoNES音频部分</strong>需要<strong>alsa相关的组件。</strong></p>
<p>前面我们已经安装过<strong>alsa-utils，</strong>此处就无需安装，如果前面没有安装，使用如下指令<strong>安装组件。</strong></p>
<img src="/posts/undefined/1d7352fd4d4b255ff48bb9217219be7b.png" class="" title="img">

<h2 id="3、其他组件安装"><a href="#3、其他组件安装" class="headerlink" title="3、其他组件安装"></a>3、其他组件安装</h2><p>make组件安装，安装完成后</p>
<img src="/posts/undefined/b8cbfd5c97c971f85bded2c279bc3555.png" class="" title="img">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libsdl1.2-dev # 漫长的等待</span><br><span class="line">apt-get install libasound2-dev # 可能不需要安装</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="三、NES模拟器编译"><a href="#三、NES模拟器编译" class="headerlink" title="三、NES模拟器编译"></a>三、NES模拟器编译</h2><p>编译NES，进入NES源码&#x2F;arm-NES-linux-master&#x2F;linux&#x2F;文件夹下（使用墨云提供的源码，详细修改时内容详见墨云），使用make命令进行编译，然后是漫长的等待。编译完成后，在当前目录下生成InfoNES文件，这便是我们的模拟器。</p>
<img src="/posts/undefined/4971460ba1b2e36f4c4910907a607b03.png" class="" title="img">

<p>自行准备.nes后缀的游戏文件，想必能够做到此处的朋友们找个nes游戏应该不成问题，将NES游戏复制到Debian的&#x2F;home&#x2F;用户名目录中，使用如下命令启动模拟器打开游戏：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;InfoNES ..&#x2F;..&#x2F;hundouluo.nes # &#x2F;arm-NES-linux-master&#x2F;linux所在目录</span><br></pre></td></tr></table></figure>

<p>然后就是娱乐时刻：</p>
<img src="/posts/undefined/12b830c1b3e8148e67b273a896b50c30.png" class="" title="img">

<img src="/posts/undefined/96a74ab3c02f9a5188326a3d8d5356e8.png" class="" title="img">

<img src="/posts/undefined/a61a80dd5170a6d55c601158bb441f24.png" class="" title="img">

<img src="/posts/undefined/d1e4877dba2bb572aa28fb267f5b063d.png" class="" title="img">

<h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><hr>
<h2 id="四、参考内容-1"><a href="#四、参考内容-1" class="headerlink" title="四、参考内容"></a>四、参考内容</h2><p>\1. <a target="_blank" rel="noopener" href="https://www.cnblogs.com/twzy/p/15356127.html">小白自制Linux开发板 十. NES游戏玩起来 - 淡墨青云 - 博客园</a></p>
<h1 id="【项目原理】多点触摸屏驱动原理"><a href="#【项目原理】多点触摸屏驱动原理" class="headerlink" title="【项目原理】多点触摸屏驱动原理"></a>【项目原理】多点触摸屏驱动原理</h1><h2 id="一、屏幕介绍"><a href="#一、屏幕介绍" class="headerlink" title="一、屏幕介绍"></a>一、屏幕介绍</h2><p>ATK-7016 这款屏幕其实是由 TFT LCD+触摸屏组合起来的。底下是 LCD 面板，上面是触摸面板，将两个封装到一起就成了带有触摸屏的 LCD 屏幕。电容触摸屏也是需要一个驱动 IC的，驱动 IC 一般会提供一个 I2C 接口给主控制器，主控制器可以通过 I2C 接口来读取驱动 IC里面的触摸坐标数据。ATK-7016、ATK-7084 这两款屏幕使用的触摸控制 IC 是 FT5426，ATK-4342 使用的驱动 IC 是 GT9147，<strong>ATK-4384 使用的驱动 IC 是 GT1151。</strong>这些电容屏触摸 IC 都是 I2C 接口的，使用方法基本一样。</p>
<p>ATK-4384 的电容触摸屏部分有 4 个 IO 用于连接主控制器：SCL、SDA、RST 和 INT，SCL 和 SDA 是 I2C 引脚，RST 是复位引脚，INT 是中断引脚。<strong>一般通过 INT 引脚来通知主控制器有触摸点按下，然后在 INT 中断服务函数中读取触摸数据。</strong>也可以不使用中断功能，采用轮询的方式不断查询是否有触摸点按下，本章实验我们使用中断方式来获取触摸数据。</p>
<h2 id="-2"><a href="#-2" class="headerlink" title=""></a></h2><hr>
<h2 id="二、触摸驱动分析"><a href="#二、触摸驱动分析" class="headerlink" title="二、触摸驱动分析"></a>二、触摸驱动分析</h2><h3 id="1、驱动框架分析"><a href="#1、驱动框架分析" class="headerlink" title="1、驱动框架分析"></a>1、驱动框架分析</h3><p>按照<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41709234/article/details/128661071%E7%9A%84%E8%AF%B4%E6%B3%95%EF%BC%9A">https://blog.csdn.net/qq_41709234/article/details/128661071的说法：</a></p>
<p>驱动程序编写主要参考《正点原子开发指南》，在裸机开发中进行触摸屏的驱动，主要流程如下：</p>
<blockquote>
<p> ①、电容触摸屏是<strong>IIC接口的，</strong>需要触摸 IC，以正点原子的 ATK4384 为例，其所使用的触摸屏控制 IC 为GT1151，因此所谓的电容触摸驱动就是 IIC设备驱动。<br> ②、触摸IC提供了<strong>中断信号引脚(INT)，</strong>可以通过中断来获取触摸信息。<br> ③、电容触摸屏得到的是触摸位置绝对信息以及触摸屏是否有按下。<br> ④、电容触摸屏不需要校准，当然了，这只是理论上的，如果电容触摸屏质量比较差，或者触摸玻璃和 TFT 之间没有完全对齐，那么也是需要校准的。 </p>
</blockquote>
<p>那么电容触摸屏的Linux驱动主要需要以下<strong>几个驱动框架的组合：</strong></p>
<blockquote>
<p> ①、IIC 设备驱动，因为电容触摸IC基本都是<strong>IIC接口的，</strong>因此大框架就是<strong>IIC设备驱动。</strong><br> ②、<strong>通过中断引脚(INT)<strong>向linux内核上报触摸信息，因此需要用到</strong>linux中断驱动框架。</strong>坐标的上报在中断服务函数中完成。<br> ③、触摸屏的坐标信息、屏幕按下和抬起信息都属于<strong>linux的input子系统，</strong>因此向 linux 内核上报触摸屏坐标信息就得使用input子系统。</p>
</blockquote>
<h3 id="2、多点触摸-MT-协议详解"><a href="#2、多点触摸-MT-协议详解" class="headerlink" title="2、多点触摸(MT)协议详解"></a>2、多点触摸(MT)协议详解</h3><p><strong>MT 协议隶属于 linux的 input 子系统，</strong>驱动通过大量的 ABS_MT 事件向 linux 内核上报多点触摸坐标数据。<strong>根据触摸 IC 的不同，分为 Type A 和 Type B 两种类型，</strong>目前使用最多的是 Type B 类型。</p>
<p>老版本的 linux 内核是不支持多点电容触摸的(Multi-touch，简称 MT)，MT 协议是后面加入的，因此如果使用 2.x 版本 linux 内核的话可能找不到 MT 协议。</p>
<p>触摸点的信息通过一系列的 ABS_MT 事件(有的资料也叫消息)上报给 linux 内核，只有ABS_MT 事件是用于多点触摸的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">852 #define ABS_MT_SLOT        0x2f &#x2F;* MT slot being modified *&#x2F; </span><br><span class="line">853 #define ABS_MT_TOUCH_MAJOR  0x30 &#x2F;* Major axis of touching ellipse *&#x2F; </span><br><span class="line">854 #define ABS_MT_TOUCH_MINOR  0x31 &#x2F;* Minor axis (omit if circular) *&#x2F; </span><br><span class="line">855 #define ABS_MT_WIDTH_MAJOR  0x32 &#x2F;* Major axis of approaching ellipse *&#x2F; </span><br><span class="line">856 #define ABS_MT_WIDTH_MINOR  0x33 &#x2F;* Minor axis (omit if circular) *&#x2F; </span><br><span class="line">857 #define ABS_MT_ORIENTATION  0x34 &#x2F;* Ellipse orientation *&#x2F; </span><br><span class="line">858 #define ABS_MT_POSITION_X   0x35 &#x2F;* Center X touch position *&#x2F; </span><br><span class="line">859 #define ABS_MT_POSITION_Y   0x36 &#x2F;* Center Y touch position *&#x2F; </span><br><span class="line">860 #define ABS_MT_TOOL_TYPE    0x37 &#x2F;* Type of touching device *&#x2F; </span><br><span class="line">861 #define ABS_MT_BLOB_ID       0x38 &#x2F;* Group a set of packets as a blob *&#x2F; </span><br><span class="line">862 #define ABS_MT_TRACKING_ID  0x39 &#x2F;* Unique ID of initiated contact *&#x2F; </span><br><span class="line">863 #define ABS_MT_PRESSURE     0x3a &#x2F;* Pressure on contact area *&#x2F; </span><br><span class="line">864 #define ABS_MT_DISTANCE      0x3b &#x2F;* Contact hover distance *&#x2F; </span><br><span class="line">865 #define ABS_MT_TOOL_X        0x3c &#x2F;* Center X tool position *&#x2F; </span><br><span class="line">866 #define ABS_MT_TOOL_Y        0x3d &#x2F;* Center Y tool position *&#x2F; </span><br></pre></td></tr></table></figure>

<h4 id="🎍-TypeA"><a href="#🎍-TypeA" class="headerlink" title="🎍 TypeA"></a>🎍 TypeA</h4><p>对于 Type A 类型的设备，通过 <strong>input_mt_sync()函数来隔离不同的触摸点数据信息：</strong></p>
<blockquote>
<p>void input_mt_sync(struct input_dev *dev) </p>
</blockquote>
<p><strong>该函数会触发 SYN_MT_REPORT 事件，此事件会通知接收者获取当前触摸数据，并且准备接收下一个触摸点数据。</strong> </p>
<p>不管是哪个类型的设备，<strong>最终都要调用 input_sync()函数来标识多点触摸信息传输完成，告诉接收者处理之前累计的所有消息，并且准备好下一次接收。</strong></p>
<p>对于 Type A 类型的设备，发送触摸点信息的时序如下所示，<strong>这里以 2 个触摸点为例：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ABS_MT_POSITION_X x[0]&#x2F;&#x2F; ABS_MT_POSITION_X 、 ABS_MT_POSITION_Y事件</span><br><span class="line">ABS_MT_POSITION_Y y[0]&#x2F;&#x2F; input_report_abs来完成坐标上报</span><br><span class="line">SYN_MT_REPORT&#x2F;&#x2F; input_mt_sync()函数会触发SYN_MT_REPORT事件</span><br><span class="line">ABS_MT_POSITION_X x[1]</span><br><span class="line">ABS_MT_POSITION_Y y[1]</span><br><span class="line">SYN_MT_REPORT</span><br><span class="line">SYN_REPORT</span><br></pre></td></tr></table></figure>

<p> 实例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">static irqreturn_t st1232_ts_irq_handler(int irq, void *dev_id)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F; 获取所有触摸点的信息</span><br><span class="line">    ret &#x3D; st1232_ts_read_data(ts);</span><br><span class="line">    if (ret &lt; 0)</span><br><span class="line">        goto end;</span><br><span class="line"></span><br><span class="line">    &#x2F;* multi touch protocol *&#x2F;</span><br><span class="line">    for (i &#x3D; 0; i &lt; MAX_FINGERS; i++) &#123;</span><br><span class="line">        if (!finger[i].is_valid)</span><br><span class="line">            continue;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 按照TypeA时序上报所有触摸点的信息</span><br><span class="line">        input_report_abs(input_dev, ABS_MT_TOUCH_MAJOR, finger[i].t);&#x2F; ABS_MT_TOUCH_MAJOR常数用于表示触摸接触区域的主轴长度</span><br><span class="line">        input_report_abs(input_dev, ABS_MT_POSITION_X, finger[i].x);</span><br><span class="line">        input_report_abs(input_dev, ABS_MT_POSITION_Y, finger[i].y);</span><br><span class="line">        input_mt_sync(input_dev);</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;* SYN_REPORT *&#x2F;</span><br><span class="line">input_sync(input_dev);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">end: </span><br><span class="line">     return IRQ_HANDLED; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h4 id="🎍-TypeB"><a href="#🎍-TypeB" class="headerlink" title="🎍 TypeB"></a>🎍 TypeB</h4><p><strong>Type B 使用 slot 协议区分具体的触摸点，</strong>Type B 设备驱动需要给每个识别出来的触摸点分配一个 slot，后面使用这个 slot 来上报触摸点信息。可以<strong>通过 slot 的 ABS_MT_TRACKING_ID 来新增、替换或删除触摸点。</strong></p>
<blockquote>
<p><strong>ABS_MT_TRACKING_ID跟踪ID：</strong>一个非负数的 ID 表示一个有效的触摸点，-1 这个 ID 表示未使用 slot。一个以前不存在的 ID 表示这是一个新加的触摸点，一个 ID 如果再也不存在了就表示删除了。</p>
</blockquote>
<p>上报触摸点信息的时候需要通过 <strong>input_mt_slot()函数区分是哪一个触摸点：</strong></p>
<blockquote>
<p>void input_mt_slot(struct input_dev *dev, int slot) </p>
</blockquote>
<p><strong>该函数会触发 ABS_MT_SLOT 事件，此事件会告诉接收者当前正在更新的是哪个触摸点(slot)的数据。</strong> </p>
<p>不管是哪个类型的设备，<strong>最终都要调用 input_sync()函数来标识多点触摸信息传输完成，告诉接收者处理之前累计的所有消息，并且准备好下一次接收。</strong></p>
<p>对于 Type B 类型的设备，发送触摸点信息的时序如下所示，这里以 2 个触摸点为例： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ABS_MT_SLOT 0&#x2F;&#x2F; 使用 input_mt_slot 函数上报当前触摸点的 ABS_MT_SLOT 事件,触摸IC提供</span><br><span class="line">ABS_MT_TRACKING_ID 45&#x2F;&#x2F; input_mt_report_slot_state完成 Type B 的要求，即每个 SLOT 必须关联一个ABS_MT_TRACKING_ID</span><br><span class="line">ABS_MT_POSITION_X x[0]</span><br><span class="line">ABS_MT_POSITION_Y y[0]</span><br><span class="line">ABS_MT_SLOT 1</span><br><span class="line">ABS_MT_TRACKING_ID 46</span><br><span class="line">ABS_MT_POSITION_X x[1]</span><br><span class="line">ABS_MT_POSITION_Y y[1]</span><br><span class="line">SYN_REPORT&#x2F;&#x2F; 当所有的触摸点坐标都上传完毕以后就得发送 SYN_REPORT 事件，使用 input_sync 函数来完成。 </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 当一个触摸点移除以后</span><br><span class="line">ABS_MT_TRACKING_ID -1 &#x2F;&#x2F; 负1表示这个ID不使用SLOT，同样使用input_mt_report_slot_state函数，第三个参数为false即可，无需手动置为-1</span><br><span class="line">SYN_REPORT&#x2F;&#x2F; 使用input_sync函数表示上报结束</span><br></pre></td></tr></table></figure>

<p>实例: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">static void ili210x_report_events(struct input_dev *input, const struct touchdata *touchdata)</span><br><span class="line">&#123;</span><br><span class="line">    int i;</span><br><span class="line">    bool touch;</span><br><span class="line">    unsigned int x, y;</span><br><span class="line">    const struct finger *finger;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 循环上报所有触摸点</span><br><span class="line">    for (i &#x3D; 0; i &lt; MAX_TOUCHES; i++) &#123;</span><br><span class="line">        input_mt_slot(input, i);&#x2F;&#x2F; ABS_MT_SLOT事件</span><br><span class="line"></span><br><span class="line">        finger &#x3D; &amp;touchdata-&gt;finger[i];</span><br><span class="line"></span><br><span class="line">        touch &#x3D; touchdata-&gt;status &amp; (1 &lt;&lt; i);</span><br><span class="line">        input_mt_report_slot_state(input, MT_TOOL_FINGER, touch);&#x2F;&#x2F; 上报ABS_MT_TRACKING_ID事件，也就是给 SLOT 关联一个ABS_MT_TRACKING_ID。</span><br><span class="line">        if (touch) &#123;</span><br><span class="line">            x &#x3D; finger-&gt;x_low | (finger-&gt;x_high &lt;&lt; 8);</span><br><span class="line">            y &#x3D; finger-&gt;y_low | (finger-&gt;y_high &lt;&lt; 8);</span><br><span class="line"></span><br><span class="line">            input_report_abs(input, ABS_MT_POSITION_X, x);</span><br><span class="line">            input_report_abs(input, ABS_MT_POSITION_Y, y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    input_mt_report_pointer_emulation(input, false);</span><br><span class="line">    input_sync(input);&#x2F;&#x2F; 上报SYN_REPORT事件</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="🎍-MT触摸协议A、B总结"><a href="#🎍-MT触摸协议A、B总结" class="headerlink" title="🎍 MT触摸协议A、B总结"></a>🎍 <strong>MT触摸协议A、B总结</strong></h4><img src="/posts/undefined/8cde1ed1a53290e61a515192c7d5b6d8.png" class="" title="img">

<h4 id="🎍-疑问及解答"><a href="#🎍-疑问及解答" class="headerlink" title="🎍 疑问及解答"></a>🎍 疑问及解答</h4><p><strong>1.TypeA和TypeB两种类型的区别如下：</strong> </p>
<blockquote>
<p>Type A：适用于触摸点不能被区分或者追踪，此类型的设备上报原始数据<br>Type B：适用于有硬件追踪并能区分触摸点的触摸设备，此类型设备都通过slot更新某一个触摸点的信息</p>
</blockquote>
<p><strong>2.什么是slot？什么是ID？</strong></p>
<ol>
<li><strong>slot：是一个用于存储触摸点信息的<strong><strong>容器，</strong></strong>包括触摸点的ID和位置信息。</strong>每个触摸点都会被分配一个slot，以便系统能够追踪多个触摸点。</li>
<li><strong>ID：是触摸点的唯一标识符，用于区分不同的触摸点。</strong>系统可以通过ID来追踪触摸点的移动。</li>
</ol>
<blockquote>
<p>总之：</p>
<p>ID：用于跟踪触摸点的唯一标识符。当用户触摸屏幕时，系统会为每个触摸点分配一个唯一的 ID。</p>
<p>slot：每个 Slot 包含了触摸点的各种信息，如坐标（X 和 Y）、面积、压力等。</p>
</blockquote>
<p><strong>3.MT多点触摸协议中TypeB中的slot，按下屏幕上的按键，分配一个slot和一个唯一的ID，在不抬起的情况下移动这个点，slot和ID会发生什么变化？</strong></p>
<ol>
<li>该触摸点所占用的slot和ID不会发生改变。它会继续使用原来分配给它的那个slot和ID。</li>
<li>其他新的触摸点如果产生,会分配新的未使用的slot和新的唯一ID。</li>
<li>如果原来的某个触摸点被抬起,其所占用的slot和ID将被释放,供新触摸点使用。</li>
<li>如果某个触摸点由于移动越过屏幕边缘被结束,其所占用的slot和ID也将被释放。</li>
</ol>
<p><strong>4.MT多点触摸协议中TypeB，如果首先按下一个点，再按下一个点，再次按下一个点，然后抬起第二个按下的点，再按下一个新的点，slot和ID如何发生变化？</strong></p>
<ol>
<li>首先按下第一个点，分配slot 1和 ID 1；</li>
<li>按下第二个点，分配slot 2和 ID 2；</li>
<li>按下第三个点，如果slot 1和2都被占用,会分配slot 3和 ID 3；</li>
<li>抬起第二个点(ID 2)，释放其slot 2；</li>
<li>按下新的第四个点，由于slot 2已空闲，会分配slot 2和新的唯一ID，例如 ID 4。</li>
</ol>
<p><em><strong>*5.为什么需要ID和slot配合，单独使用slot或者ID为什么不能完成多点触摸功能呢？*</strong></em></p>
<ol>
<li>slot 数量是有限的，并且slot的使用可以确保每个触摸点都分配一个独占的通道来传输触摸相关信息<strong>。</strong>但是，<strong>（原因解释）</strong>，如果在同一帧内，其中4个点(A，B，C和D)持续活动，我们可能会分配slot1-4。如果我们增加了第5个和第6个点E和F，slot 5和6也可能被分配,超出原有范围，在这种情况下，slot冲突就可能发生。另一方面，如果在后续帧中，部分点(例如B和D)不再活动，但新的点(G和H)出现，我们会释放slot 2和4，并分配新的slot 5和6。此时，slot 映射会变得非常混乱和不直观。很难通过slot数来确定某个点的信息通道，也就是说，我想对第二个按下的点进行操作，但是slot2并不对应第二个按下的点。</li>
<li>ID只是用来标识每个触摸点的唯一标志符，并不能告诉我们这些触摸点的位置、状态或其他属性。为了实现多点触摸识别功能，我们需要使用ID和其他信息（如坐标、状态、时间戳等）来跟踪和识别每个触摸点，并进行相应的操作。</li>
</ol>
<p><strong>6.什么情况下需要使用 input_mt_report_pointer_emulation() 函数禁止指针模拟器？</strong></p>
<ol>
<li>硬件设备跟踪到的触摸点数量多于正在上报的触摸点数量，启用指针模拟器可能导致触摸点数量不匹配、误判触摸点位置等问题。</li>
<li>应用程序需要精确地跟踪多个触摸点的位置和状态，禁用指针模拟器可以确保触摸点信息能够准确地传递到应用程序中，而不受指针模拟器的影响。</li>
<li>一些应用程序需要使用指针模拟器来模拟单点触控，禁用指针模拟器可能会导致这些应用程序无法正常工作。</li>
<li>在特殊的应用场景下，例如绘图或游戏等需要高精度触摸控制的应用程序中，禁用指针模拟器可以提高触摸点的准确性和响应性。</li>
</ol>
<hr>
<h2 id="三、多点触摸API函数"><a href="#三、多点触摸API函数" class="headerlink" title="三、多点触摸API函数"></a>三、多点触摸API函数</h2><h4 id="1、input-mt-init-slots-函数"><a href="#1、input-mt-init-slots-函数" class="headerlink" title="1、input_mt_init_slots 函数"></a>1、input_mt_init_slots 函数</h4><p><strong>用于初始化 MT 的输入 slots，</strong>编写 MT 驱动的时候必须先调用此函数<strong>初始化 slots：</strong></p>
<blockquote>
<p><strong>int input_mt_init_slots(  struct input_dev   *dev,<br>                     unsigned int    num_slots,<br>                     unsigned int    flags)</strong><br>dev：  MT 设备对应的 input_dev，因为 MT 设备隶属于 input_dev。<br>num_slots：多点触控设备支持的最大触摸点数量。<br>flags：其他一些 flags 信息，可设置的 flags 如下所示： </p>
<p>#define INPUT_MT_POINTER   0x0001  &#x2F;* pointer device, e.g. trackpad <em>&#x2F;<br>#define INPUT_MT_DIRECT   0x0002  &#x2F;</em> direct device, e.g. touchscreen <em>&#x2F;<br>#define INPUT_MT_DROP_UNUSED 0x0004  &#x2F;</em> drop contacts not seen in frame <em>&#x2F;<br>#define INPUT_MT_TRACK   0x0008  &#x2F;</em> use in-kernel tracking <em>&#x2F;<br>#define INPUT_MT_SEMI_MT   0x0010  &#x2F;</em> semi-mt device, finger count handled manually *&#x2F; </p>
<p>可以采用‘|’运算来同时设置多个 flags 标识。<br>返回值：0，成功；负值，失败。 </p>
</blockquote>
<h4 id="2、input-mt-slot-函数"><a href="#2、input-mt-slot-函数" class="headerlink" title="2、input_mt_slot 函数"></a>2、input_mt_slot 函数</h4><p>此函数用于 Type B 类型，此函数用于<strong>产生 ABS_MT_SLOT 事件，</strong>告诉内核当前上报的是哪个触摸点的坐标数据：</p>
<blockquote>
<p><strong>void input_mt_slot(struct input_dev   *dev,<br>                 int      slot)</strong> </p>
<p>dev：  MT 设备对应的 input_dev。<br>slot：当前发送的是哪个 slot 的坐标信息，也就是哪个触摸点。<br>返回值：无。 </p>
</blockquote>
<h4 id="3、input-mt-report-slot-state-函数"><a href="#3、input-mt-report-slot-state-函数" class="headerlink" title="3、input_mt_report_slot_state 函数"></a>3、input_mt_report_slot_state 函数</h4><p>此函数用于 Type B 类型，用于<strong>产生 ABS_MT_TRACKING_ID 和 ABS_MT_TOOL_TYPE事 件</strong> ， ABS_MT_TRACKING_ID 事 件 给 slot 关 联 一 个 ABS_MT_TRACKING_ID ，ABS_MT_TOOL_TYPE 事件指定触摸 型（是笔还是手指等）：</p>
<blockquote>
<p><strong>void input_mt_report_slot_state(  struct input_dev   *dev,<br>                           unsigned int    tool_type,<br>                           bool     active)</strong><br>dev：  MT 设备对应的 input_dev。<br>tool_type：触摸类型，可以选择 MT_TOOL_FINGER(手指)、MT_TOOL_PEN(笔)或<br>MT_TOOL_PALM(手掌)，对于多点电容触摸屏来说一般都是手指。<br>active：true，连续触摸，input 子系统内核会自动分配一个 ABS_MT_TRACKING_ID 给slot。<br>false，触摸点抬起，表示某个触摸点无效了，input 子系统内核会分配一个-1 给 slot，表示触摸点溢出。<br>返回值：无。</p>
</blockquote>
<h4 id="4、input-report-abs-函数"><a href="#4、input-report-abs-函数" class="headerlink" title="4、input_report_abs 函数"></a>4、input_report_abs 函数</h4><p>Type A 和 Type B 类型都使用此函数上报触摸点坐标信息，通过 ABS_MT_POSITION_X 和ABS_MT_POSITION_Y 事件实现 X 和 Y 轴坐标信息上报。</p>
<blockquote>
<p>void input_report_abs( struct input_dev   *dev,<br>                   unsigned int    code,<br>                   int      value) </p>
<p>dev：  MT 设备对应的 input_dev。<br>code：要上报的是什么数据，可以设置为 ABS_MT_POSITION_X 或ABS_MT_POSITION_Y，也就是 X 轴或者 Y 轴坐标数据。<br>value：具体的 X 轴或 Y 轴坐标数据值。<br>返回值：无。 </p>
</blockquote>
<h4 id="5、input-mt-report-pointer-emulation-函数"><a href="#5、input-mt-report-pointer-emulation-函数" class="headerlink" title="5、input_mt_report_pointer_emulation 函数"></a>5、input_mt_report_pointer_emulation 函数</h4><p>如果追踪到的触摸点数量多于当前上报的数量，驱动程序使用 BTN_TOOL_TAP 事件来通知用户空间当前追踪到的触摸点总数量，然后调用 input_mt_report_pointer_emulation 函数将 use_count 参数设置为 false。否则的话将 use_count 参数设置为 true，表示当前的触摸点数量(此函数会获取到具体的触摸点数量，不需要用户给出)：</p>
<blockquote>
<p>void input_mt_report_pointer_emulation(struct input_dev  *dev,<br>                                 bool     use_count)<br>dev：  MT 设备对应的 input_dev。<br>use_count：true，有效的触摸点数量；false，追踪到的触摸点数量多于当前上报的数量。<br>返回值：无。 </p>
</blockquote>
<hr>
<h2 id="四、多点电容触摸驱动框架分析"><a href="#四、多点电容触摸驱动框架分析" class="headerlink" title="四、多点电容触摸驱动框架分析"></a>四、多点电容触摸驱动框架分析</h2><h3 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h3><p>①、多点电容触摸芯片的接口，一般都为 I2C 接口，因此驱动主框架肯定是 I2C。<br>②、linux 里面一般都是通过中断来上报触摸点坐标信息，因此需要用到中断框架。<br>③、多点电容触摸属于 input 子系统，因此还要用到 input 子系统框架。<br>④、在中断处理程序中按照 linux 的 MT 协议上报坐标信息。 </p>
<h3 id="2、I2C框架"><a href="#2、I2C框架" class="headerlink" title="2、I2C框架"></a>2、I2C框架</h3><p>I2C框架类似于platform框架，比较好理解，如果实在是不明白请看正点原子驱动指南I2C部分。<strong>当设备树中触摸 IC的设备节点和驱动匹配以后，gt1151_probe 函数就会执行，我们可以在此函数中初始化触摸 IC，中断和 input 子系统等。</strong> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// probe函数</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gt1151_probe</span><span class="params">(struct i2c_client *client, <span class="keyword">const</span> struct i2c_device_id *id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// i2c驱动的remove函数</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gt1151_remove</span><span class="params">(struct i2c_client *client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    input_unregister_device(gt1151.input);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 传统驱动匹配表</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">gt1151_id_table</span>[] =</span> &#123;</span><br><span class="line">	&#123; <span class="string">&quot;goodix,gt1151ATK4384&quot;</span>, <span class="number">0</span>, &#125;,</span><br><span class="line">    &#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">// 设备树匹配表 </span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">gt1151_of_match_table</span>[] =</span> &#123;</span><br><span class="line">    &#123;.compatible = <span class="string">&quot;goodix,gt1151ATK4384&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* i2c驱动结构体 */</span>	</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">gt1151_i2c_driver</span> =</span> &#123;</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name  = <span class="string">&quot;gt1151&quot;</span>,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .of_match_table = gt1151_of_match_table,</span><br><span class="line">    &#125;,</span><br><span class="line">    .id_table = gt1151_id_table,</span><br><span class="line">    .probe  = gt1151_probe,</span><br><span class="line">    .remove = gt1151_remove,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">module_i2c_driver(gt1151_i2c_driver);<span class="comment">// 展开后和module_init module_exit一样，类似于module_platform_driver</span></span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;kashine&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2、初始化触摸IC、中断、input子系统初始化"><a href="#2、初始化触摸IC、中断、input子系统初始化" class="headerlink" title="2、初始化触摸IC、中断、input子系统初始化"></a>2、初始化触摸IC、中断、input子系统初始化</h3><p>初始化触摸芯片，包括芯片的相关 IO，比如复位、中断等 IO 引脚，然后就是芯片本身的初始化，也就是配置触摸芯片的相关寄存器。 </p>
<p>设置 input_dev 需要上报的事件为 EV_ABS 和 BTN_TOUCH，因为多点电容屏的触摸坐标为绝对值，因此需要上报 EV_ABS 事件。触摸屏有按下和抬起之分，因此需要上报 BTN_TOUCH 按键。 </p>
<p>调用 input_set_abs_params 函数设置 EV_ABS 事件需要上报 ABS_X、ABS_Y、ABS_MT_POSITION_X 和 ABS_MT_POSITION_Y。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// probe函数</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gt1151_probe</span><span class="params">(struct i2c_client *client, <span class="keyword">const</span> struct i2c_device_id *id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u8 data, ret;</span><br><span class="line">    gt1151.client = client;</span><br><span class="line">	printk(<span class="string">&quot;Driver and device has mached!!!\r\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 1、初始化触摸IC */</span></span><br><span class="line"> 	<span class="comment">/* 获取设备树中的中断和复位引脚 */</span></span><br><span class="line">	gt1151.irq_pin = of_get_named_gpio(client-&gt;dev.of_node, <span class="string">&quot;interrupt-gpios&quot;</span>, <span class="number">0</span>);</span><br><span class="line">	gt1151.reset_pin = of_get_named_gpio(client-&gt;dev.of_node, <span class="string">&quot;reset-gpios&quot;</span>, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// printk(&quot;irq_pin=%d, reset_pin=%d\r\n&quot;, gt1151.irq_pin, gt1151.reset_pin);</span></span><br><span class="line">	<span class="comment">/* 复位GT1151 */</span></span><br><span class="line">	ret = gt1151_ts_reset(client, &amp;gt1151);</span><br><span class="line">	<span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 初始化GT1151 */</span></span><br><span class="line">    data = <span class="number">0x02</span>;</span><br><span class="line">    gt1151_write_regs(&amp;gt1151, GT_CTRL_REG, &amp;data, <span class="number">1</span>); <span class="comment">/* 软复位 */</span></span><br><span class="line">    mdelay(<span class="number">100</span>);</span><br><span class="line">    data = <span class="number">0x0</span>;</span><br><span class="line">    gt1151_write_regs(&amp;gt1151, GT_CTRL_REG, &amp;data, <span class="number">1</span>); <span class="comment">/* 停止软复位 */</span></span><br><span class="line">    mdelay(<span class="number">100</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 初始化GT1151，读取固件 */</span> <span class="comment">// 应该是读触摸设备的信息</span></span><br><span class="line">	ret = gt1151_read_firmware(client, &amp;gt1151);</span><br><span class="line">	<span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;Fail !!! check !!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/* 2、input设备申请与初始化 */</span></span><br><span class="line">	gt1151.input = devm_input_allocate_device(&amp;client-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (!gt1151.input) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line">	gt1151.input-&gt;name = client-&gt;name;</span><br><span class="line">	gt1151.input-&gt;id.bustype = BUS_I2C;</span><br><span class="line">	gt1151.input-&gt;dev.parent = &amp;client-&gt;dev;</span><br><span class="line"> </span><br><span class="line">	__set_bit(EV_KEY, gt1151.input-&gt;evbit);<span class="comment">// 支持按键事件</span></span><br><span class="line">    __set_bit(BTN_TOUCH, gt1151.input-&gt;keybit);<span class="comment">// 设置按键位图为抬起和按下之分的按键</span></span><br><span class="line">	__set_bit(EV_ABS, gt1151.input-&gt;evbit);<span class="comment">// 支持绝对坐标事件</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 设置 EV_ABS 事件需要上报 ABS_X、ABS_Y、ABS_MT_POSITION_X 和 ABS_MT_POSITION_Y。 */</span></span><br><span class="line">	input_set_abs_params(gt1151.input, ABS_X, <span class="number">0</span>, gt1151.max_x, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	input_set_abs_params(gt1151.input, ABS_Y, <span class="number">0</span>, gt1151.max_y, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	input_set_abs_params(gt1151.input, ABS_MT_POSITION_X,<span class="number">0</span>, gt1151.max_x, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	input_set_abs_params(gt1151.input, ABS_MT_POSITION_Y,<span class="number">0</span>, gt1151.max_y, <span class="number">0</span>, <span class="number">0</span>);	     </span><br><span class="line">	ret = input_mt_init_slots(gt1151.input, MAX_SUPPORT_POINTS, <span class="number">0</span>);<span class="comment">// 初始化slot</span></span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 注册input_dev */</span></span><br><span class="line">	ret = input_register_device(gt1151.input);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 3、最后初始化中断 */</span></span><br><span class="line">	ret = gt1151_ts_irq(client, &amp;gt1151);</span><br><span class="line">	<span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">fail:</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、上报坐标信息"><a href="#3、上报坐标信息" class="headerlink" title="3、上报坐标信息"></a>3、上报坐标信息</h3><p>进入中断处理程序以后首先肯定是从触摸 IC 里面读取触摸坐标以及触摸点数量，假设触摸点数量保存到 num 变量，触摸点坐标存放到 x，y 数组里面。</p>
<p>每一轮触摸点坐标上报完毕以后就调用一次 input_sync 函数发送一个SYN_REPORT 事件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 中断服务函数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">irqreturn_t</span> <span class="title">gt1151_irq_handler</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *dev_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> touch_num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> input_x, input_y;</span><br><span class="line">    <span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    u8 data;</span><br><span class="line">    u8 touch_data[<span class="number">5</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gt1151_dev</span> *<span class="title">dev</span> =</span> dev_id;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// printk(&quot;enter irq handler!\r\n&quot;);</span></span><br><span class="line"> </span><br><span class="line">    ret = gt1151_read_regs(dev, GT_GSTID_REG, &amp;data, <span class="number">1</span>);<span class="comment">// GT1151当前检测到的触摸情况</span></span><br><span class="line">    <span class="keyword">if</span> (data == <span class="number">0x00</span>)  &#123;     <span class="comment">/* 没有触摸数据，直接返回 */</span></span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;                 <span class="comment">/* 统计触摸点数据 */</span></span><br><span class="line">        touch_num = data &amp; <span class="number">0x0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* 由于GT1151没有硬件检测每个触摸点按下和抬起，因此每个触摸点的抬起和按</span></span><br><span class="line"><span class="comment">     * 下不好处理，尝试过一些方法，但是效果都不好，因此这里暂时使用单点触摸 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span>(touch_num) &#123;         <span class="comment">/* 单点触摸按下 */</span></span><br><span class="line">        gt1151_read_regs(dev, GT_TP1_REG, touch_data, <span class="number">5</span>);</span><br><span class="line">        id = touch_data[<span class="number">0</span>] &amp; <span class="number">0x0F</span>;</span><br><span class="line">        <span class="keyword">if</span>(id == <span class="number">0</span>) &#123; <span class="comment">//读取成功</span></span><br><span class="line">            input_x  = touch_data[<span class="number">1</span>] | (touch_data[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>);</span><br><span class="line">            input_y  = touch_data[<span class="number">3</span>] | (touch_data[<span class="number">4</span>] &lt;&lt; <span class="number">8</span>);</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// 单点id一直等于0即可</span></span><br><span class="line">            input_mt_slot(dev-&gt;input, <span class="number">0</span>);</span><br><span class="line">		    input_mt_report_slot_state(dev-&gt;input, MT_TOOL_FINGER, <span class="literal">true</span>);</span><br><span class="line">		    input_report_abs(dev-&gt;input, ABS_MT_POSITION_X, input_x);</span><br><span class="line">		    input_report_abs(dev-&gt;input, ABS_MT_POSITION_Y, input_y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(touch_num == <span class="number">0</span>)&#123;                <span class="comment">/* 单点触摸释放 */</span></span><br><span class="line">        input_mt_slot(dev-&gt;input, id);</span><br><span class="line">        input_mt_report_slot_state(dev-&gt;input, MT_TOOL_FINGER, <span class="literal">false</span>);<span class="comment">// 删除触摸点</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">	input_mt_report_pointer_emulation(dev-&gt;input, <span class="literal">true</span>);<span class="comment">// 没有出现硬件检测到的点比上报的触摸点多的情况</span></span><br><span class="line">    input_sync(dev-&gt;input);</span><br><span class="line"> </span><br><span class="line">    data = <span class="number">0x00</span>;                <span class="comment">/* 向0X814E寄存器写0 */</span></span><br><span class="line">    gt1151_write_regs(dev, GT_GSTID_REG, &amp;data, <span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">fail:</span><br><span class="line">	<span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="项目原理】DRM驱动概念、组成、框架、源码分析"><a href="#项目原理】DRM驱动概念、组成、框架、源码分析" class="headerlink" title="项目原理】DRM驱动概念、组成、框架、源码分析"></a>项目原理】DRM驱动概念、组成、框架、源码分析</h1><h2 id="一、DRM与Framebuffer"><a href="#一、DRM与Framebuffer" class="headerlink" title="一、DRM与Framebuffer"></a>一、DRM与Framebuffer</h2><p>Linux 中的 <strong>DRM(Direct Rendering Manager)</strong> 驱动和 <strong>Framebuffer (fbdev)</strong> 驱动是两种不同的图形驱动方式，它们之间有一些区别。</p>
<p>Framebuffer驱动：</p>
<ul>
<li>直接控制显卡的帧缓冲区，提供基本的显卡输出功能；</li>
<li>使用一些内核数据结构和API来管理图形界面，并提供一组接口与用户空间的应用程序进行通信；</li>
<li>相对简单，适合于嵌入式系统或者不需要高性能图形的应用场景。</li>
</ul>
<p>DRM驱动：</p>
<ul>
<li>提供一种分离的图形驱动架构，<strong>将硬件驱动程序、内核模块和用户空间驱动程序进行分离；</strong></li>
<li>支持多个应用程序同时访问显卡，并提供了更丰富的图形功能，例如硬件加速和3D加速；</li>
<li>提供了一些内核接口，可以让用户空间应用程序与驱动程序进行交互；</li>
<li>支持多显示器和多GPU的配置。</li>
</ul>
<p>总之，一句话，DRM是Linux目前主流的图形显示框架，相比FB架构，DRM更能适应当前日益更新的显示硬件。<strong>尽管FB退出历史舞台，在DRM 中也并未将其遗弃，而是集合到DRM中，供部分嵌入式设备使用。</strong></p>
<hr>
<h2 id="二、DRM驱动"><a href="#二、DRM驱动" class="headerlink" title="二、DRM驱动"></a>二、DRM驱动</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zichuanning520/article/details/127047436">linux驱动系列学习之DRM（十）_linux drm_紫川宁520的博客-CSDN博客</a></p>
<h3 id="1、概述-1"><a href="#1、概述-1" class="headerlink" title="1、概述"></a>1、概述</h3><p>DRM从模块上划分，可以简单分为3部分：<strong>libdrm、KMS、GEM。</strong></p>
<h4 id="libdrm（DRM框架在用户空间的Lib）"><a href="#libdrm（DRM框架在用户空间的Lib）" class="headerlink" title="libdrm（DRM框架在用户空间的Lib）"></a><strong>libdrm（DRM框架在用户空间的Lib）</strong></h4><blockquote>
<p><strong>libdrm</strong>是一个用户空间的DRM库，<strong>提供了DRM驱动的用户空间接口。</strong>用户或应用程序在用户空间调用<strong>libdrm提供的库函数，</strong> 即可访问到显示的资源，并对显示资源进行管理和使用。</p>
</blockquote>
<h4 id="KMS（内核显示模式设置）"><a href="#KMS（内核显示模式设置）" class="headerlink" title="KMS（内核显示模式设置）"></a><strong>KMS（内核显示模式设置）</strong></h4><blockquote>
<p>KMS属于DRM框架下的一个大模块，<strong>主要负责两个功能：显示参数及显示控制。</strong> 这两个基本功能可以说是显示驱动必须具备的能力，在DRM框架下， 为了将这两部分适配得符合现代显示设备逻辑，又分出了几部分子模块配合框架（<strong>CRTC，ENCODER，CONNECTOR，PLANE，FB，VBLANK，property）</strong>。</p>
<p><strong>更新画面</strong>：显示buffer的切换，多图层的合成方式，以及每个图层的显示位置。<br><strong>设置显示参数</strong>：包括分辨率、刷新率、电源状态（休眠唤醒）等。</p>
</blockquote>
<h4 id="GMS（图形执行管理器）"><a href="#GMS（图形执行管理器）" class="headerlink" title="GMS（图形执行管理器）"></a><strong>GMS（图形执行管理器）</strong></h4><blockquote>
<p>它提供了一种<strong><em>*抽象的*</em>*<em>显存管理*</em>**方式**（主要负责显示buffer的分配和释放）**，使用户空间应用程序可以更方便地管理显存，而不需要了解底层硬件的细节。（</strong>DUMB、PRIME、fence）**</p>
</blockquote>
<img src="/posts/undefined/b8530def6ef20500472895d5ff25f45b.png" class="" title="在这里插入图片描述">

<p><strong>基本元素</strong></p>
<p>DRM框架涉及到的元素很多，大致如下：</p>
<p>KMS：<strong>CRTC，ENCODER，CONNECTOR，PLANE，FB，VBLANK，property</strong></p>
<p>GEM：<strong>DUMB、PRIME、fence</strong></p>
<blockquote>
<p>学习DRM驱动其实就是学习上面各个元素的实现及用法，如果你能掌握这些知识点，那么在编写DRM驱动的时候就能游刃有余。</p>
</blockquote>
<img src="/posts/undefined/c0131052a585d4c497f612384d98ead4.png" class="" title="在这里插入图片描述">

<img src="/posts/undefined/76382e53fc4867c145b4d440f07dec76.jpeg" class="" title="在这里插入图片描述">

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/dearsq/article/details/78394388">Linux DRM（二）基本概念和特性_Younix脏羊的博客-CSDN博客</a></p>
<table>
<thead>
<tr>
<th align="left">元素</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CRTC</td>
<td align="left">电子束控制器，用于控制显卡输出信号，将帧缓存中的图像数据按照一定的方式输出到显示器上，并控制显示器的显示模式、分辨率、刷新率等参数。在DRM里有多个显存，可以通过操作CRTC来控制要显示的那个显存。</td>
</tr>
<tr>
<td align="left">ENCODER</td>
<td align="left">编码器，用于将 CRTC 输出的图像信号转换成一定格式的数字信号，通常用于连接显示器或 TV 等设备。如 HDMI、DisplayPort、DVI 等。每个 CRTC 可以有一个或多个 Encoder。</td>
</tr>
<tr>
<td align="left">CONNECTOR</td>
<td align="left">通常是用于将 Encoder 输出的信号传递给显示器，并与显示器建立连接。每个 Encoder 可以有一个或多个 Connector。</td>
</tr>
<tr>
<td align="left">PLANE</td>
<td align="left">硬件图层，负责获取显存，再输出到CRTC里，可以看作是一个显示器的图层，每个 crtc 至少要有一个 plane。通常会有多个 plane，每个 plane 可以分别设置自己的属性，从而实现多个图像内容的叠加。例如，在一个视频播放应用中，可以使用一个 plane 显示视频内容，另一个 plane 显示控制面板或字幕等内容，从而实现多个图像内容的同时显示。</td>
</tr>
<tr>
<td align="left">Framebuffer</td>
<td align="left">帧缓存，用于存储屏幕上的每个像素点的颜色信息。只用于描述显存信息（如 format、pitch、size 等），不负责显存的分配释放</td>
</tr>
<tr>
<td align="left">VBLANK</td>
<td align="left">软件和硬件的同步机制，RGB时序中的垂直消影区，软件通常使用硬件VSYNC来实现</td>
</tr>
<tr>
<td align="left">property</td>
<td align="left">原子操作的基础，任何你想设置的参数，都可以做成property，供用户空间使用，是DRM驱动中最灵活、最方便的Mode setting机制</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">DUMB</td>
<td align="left">是一个dumb缓冲区，负责一些简单的buffer显示，可以通过CPU直接渲染</td>
</tr>
<tr>
<td align="left">PRIME</td>
<td align="left">连续、非连续物理内存都支持，基于DMA-BUF机制，可以实现buffer共享，多用于大内存复杂场景</td>
</tr>
<tr>
<td align="left">fence</td>
<td align="left">buffer同步机制，基于内核dma_fence机制实现，用于防止显示内容出现异步问题</td>
</tr>
</tbody></table>
<blockquote>
<p>以上内容来自：参考内容1&amp;2。</p>
</blockquote>
<h3 id="-3"><a href="#-3" class="headerlink" title=""></a></h3><h3 id="2、DRM内部Objects"><a href="#2、DRM内部Objects" class="headerlink" title="2、DRM内部Objects"></a>2、DRM内部Objects</h3><img src="/posts/undefined/dcaf498811af9864c547cf527566c572.png" class="" title="在这里插入图片描述">

<p>上图<strong>蓝色部分则是对物理硬件的抽象，黄色部分则是对软件的抽象。</strong>虚线以上的为<strong>drm_mode_object</strong>，虚线以下为 <strong>drm_gem_object。</strong></p>
<img src="/posts/undefined/8a775c35c19860bb690c953b9820be9c.png" class="" title="在这里插入图片描述">

<p>上面这些objects的关系如下图所示：</p>
<p>通过上图可以看到，<strong>plane 是连接 framebuffer 和 crtc 的纽带，而 encoder 则是连接 crtc 和 connector 的纽带。*<em>与物理 buffer 直接打交道的是 gem 而不是 framebuffer。*</em></strong></p>
<blockquote>
<p>个人理解：</p>
<p>buffer是硬件存储设备， 由gem分配和释放，framebuffer用于描述分配的显存的信息（如 format、pitch、size 等），而plane用于描述图层信息，描述的是framebuffer中哪些点处于同一个图层，多个plane隶属于同一个crtc，crtc控制显卡输出图像信号，encoder将 crtc 输出的图像信号转换成一定格式的数字信号，如 HDMI、DisplayPort、DVI 等， connector用于将 Encoder 输出的信号传递给显示器，并与显示器建立连接。</p>
</blockquote>
<p>需要注意的是，上图蓝色部分即使没有实际的硬件与之对应，在软件驱动中也需要实现这些 objects，否则 DRM 子系统无法正常运行。</p>
<h3 id="3、drm-panel"><a href="#3、drm-panel" class="headerlink" title="3、drm_panel"></a>3、drm_panel</h3><blockquote>
<p>Encoder 驱动程序负责将图形数据转换为 LCD 显示器所需的视频信号，而 Connector 驱动程序则负责将这些信号发送到正确的显示设备上。<strong>LCD 驱动程序需要和Encoder、Connector 这两个驱动程序进行交互，以完成图形输出的控制。</strong></p>
</blockquote>
<img src="/posts/undefined/d7e190b7026e1322c9b430bc327d082f.png" class="" title="在这里插入图片描述">

<blockquote>
<p>耦合的产生：<br>（1）connector 的主要作用就是获取显示参数，所以会在 LCD 驱动中去构造 connector object。但是 connector 初始化时需要 attach 上一个 encoder object，而这个 encoder object 往往是在另一个硬件驱动中生成的，为了访问该 encoder object，势必会产生一部分耦合的代码。<br>（2）encoder 除了扮演信号转换的角色，还担任着通知显示设备休眠唤醒的角色。因此，当 encoder 通知 LCD 驱动执行相应的 enable&#x2F;disable 操作时，就一定会调用 LCD 驱动导出的全局函数，这也必然会产生一部分的耦合代码。</p>
</blockquote>
<blockquote>
<p>Encoder 驱动与 LCD 驱动之间的耦合会造成以下问题：</p>
<ol>
<li>可维护性下降：耦合代码过多，使得维护代码变得困难。</li>
<li>可移植性下降：由于硬件平台的不同，encoder 驱动的实现可能不同，这就导致了 LCD 驱动对 encoder 驱动的依赖程度变高，降低了代码的可移植性。</li>
<li>系统可扩展性下降：由于 encoder 驱动与 LCD 驱动的紧耦合关系，当系统需要支持新的显示设备时，需要修改大量的代码，增加了系统扩展性的难度。</li>
</ol>
</blockquote>
<p><strong>为了解决该耦合的问题，</strong>DRM 子系统为开发人员<strong>提供了 drm_panel 结构体，</strong>该结构体封装了 connector &amp; encoder 对 LCD 访问的常用接口。</p>
<img src="/posts/undefined/875b41f94b9882f49c43a6796a850aad.png" class="" title="在这里插入图片描述">

<blockquote>
<p>于是，原来的 Encoder 驱动和 LCD 驱动之间的耦合，就转变成了上图中 Encoder 驱动与 drm_panel、drm_panel 与 LCD 驱动之间的“耦合”，从而实现了 Encoder 驱动与 LCD 驱动之间的解耦合。</p>
</blockquote>
<blockquote>
<p>drm_panel 不属于 objects 的范畴，它只是<strong>一堆回调函数的集合。</strong>但它的存在降低了 LCD 驱动与 encoder 驱动之间的耦合度。</p>
</blockquote>
<hr>
<h2 id="三、DRM-驱动常用结构体"><a href="#三、DRM-驱动常用结构体" class="headerlink" title="三、DRM 驱动常用结构体"></a>三、DRM 驱动常用结构体</h2><h3 id="🍚-drm-mode-object"><a href="#🍚-drm-mode-object" class="headerlink" title="🍚 *drm_mode_object*"></a>🍚 <em><strong>*drm_mode_object*</strong></em></h3><p>对于plane、crtc、encoder、connector 几个对象，DRM框架将其称作“对象”，<strong>有一个公共基类struct drm_mode_object，</strong>这几个对象都由此基类扩展而来（该类作为crtc等结构体的成员）。</p>
<p><strong>如 struct crtc 结构体中存在****基类成员</strong> <strong>struct drm_mode_object：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * struct drm_crtc - central CRTC control structure</span><br><span class="line"> *</span><br><span class="line"> * Each CRTC may have one or more connectors associated with it.  This structure</span><br><span class="line"> * allows the CRTC to be controlled.</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct drm_crtc &#123;</span><br><span class="line">	&#x2F;*挂载到&amp;drm_mode_config.crtc_list*&#x2F;</span><br><span class="line">	struct list_head head;</span><br><span class="line">	&#x2F;** crtc名称 *&#x2F;</span><br><span class="line">	char *name;</span><br><span class="line">	&#x2F;** kms mode对象 *&#x2F;</span><br><span class="line">	struct drm_mode_object base;&#x2F;&#x2F; 基类</span><br><span class="line">	&#x2F;*primary层*&#x2F;</span><br><span class="line">	struct drm_plane *primary;</span><br><span class="line">	&#x2F;*鼠标层*&#x2F;</span><br><span class="line">	struct drm_plane *cursor;</span><br><span class="line">	&#x2F;*序号*&#x2F;</span><br><span class="line">	unsigned index;</span><br><span class="line">    ...</span><br><span class="line"> </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>事实上，这个基类扩展出来的子类并不是只有上面提到的几种，本文只考虑以上四种。以下为结构体 <strong>drm_mode_object 的定义：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct drm_mode_object &#123;</span><br><span class="line">  uint32_t id;</span><br><span class="line">  uint32_t type;</span><br><span class="line">  struct drm_object_properties *properties;</span><br><span class="line">  struct kref refcount;</span><br><span class="line">  void (*free_cb)(struct kref *kref);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>struct drm_mode_object</strong> 中 id 和 type 分别为这个对象在KMS子系统中的ID和类型（即上面提到的plane、CRTC等）。drm_mode_object 从的定义中即可发现其实现了<strong>两个比较重要的功能：</strong></p>
<blockquote>
<p><strong>kref 引用计数及生命周期管理：</strong></p>
<p>指 drm_mode_object 对象在内核中的生命周期的管理。每个 drm_mode_object 对象都有一个引用计数，当一个对象被创建时，它的引用计数被初始化为1。每当一个新的引用指向该对象时，它的引用计数就会增加1，每当一个引用被释放时，它的引用计数就会减少1。当对象的引用计数降为0时，内核会自动释放该对象。这种方式确保了内核中不会存在不再使用的对象，从而避免了内存泄漏。</p>
</blockquote>
<blockquote>
<p><strong>drm_object_properties</strong> <strong>属性管理：</strong></p>
<p>属性管理是指在DRM驱动中，每个对象都可以拥有一组属性（例如分辨率、刷新率等），并且可以动态地增加、删除或修改属性。这些属性可以被用户空间的应用程序或者其他驱动程序获取或者设置。</p>
</blockquote>
<h3 id="🍚-Framebuffer"><a href="#🍚-Framebuffer" class="headerlink" title="🍚 Framebuffer"></a>🍚 Framebuffer</h3><p>注意framebuffer没有对应的回调函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; include&#x2F;drm&#x2F;drm_framebuffer.h</span><br><span class="line">struct drm_framebuffer &#123; </span><br><span class="line">	struct drm_device *dev;</span><br><span class="line">	struct list_head head;</span><br><span class="line">	struct drm_mode_object base;</span><br><span class="line">	const struct drm_format_info *format; &#x2F;&#x2F; drm格式信息</span><br><span class="line">	const struct drm_framebuffer_funcs *funcs;</span><br><span class="line">	unsigned int pitches[4]; &#x2F;&#x2F; Line stride per buffer</span><br><span class="line">	unsigned int offsets[4]; &#x2F;&#x2F; Offset from buffer start to the actual pixel data in bytes, per buffer.</span><br><span class="line">	uint64_t modifier; &#x2F;&#x2F; Data layout modifier</span><br><span class="line">	unsigned int width;</span><br><span class="line">	unsigned int height;</span><br><span class="line">	int flags;</span><br><span class="line">	int hot_x;</span><br><span class="line">	int hot_y;</span><br><span class="line">	struct list_head filp_head;</span><br><span class="line">	struct drm_gem_object *obj[4];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>struct drm_framebuffer 主要元素的展示如下图所示(来自brezillon-drm-kms)，内存缓冲区组织，采取FOURCC格式代码：</p>
<img src="/posts/undefined/7be9e44bac7b7519255f0a434ddfa387.png" class="" title="在这里插入图片描述">

<h3 id="🍚-Plane"><a href="#🍚-Plane" class="headerlink" title="🍚 Plane"></a>🍚 Plane</h3><p>drm_plane结构体详见：<a target="_blank" rel="noopener" href="https://lxr.missinglinkelectronics.com/linux/include/drm/drm_plane.h#L595">LXR linux&#x2F;include&#x2F;drm&#x2F;drm_plane.h</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">struct drm_plane_funcs 结构体成员：</span><br><span class="line">1、	update_plane：为给定的CRTC和framebuffer启用并配置平面</span><br><span class="line">2、	disable_plane：关闭plane</span><br><span class="line">3、	destroy：清除plane所有的资源</span><br><span class="line">4、	reset：复位软硬件状态为关闭</span><br><span class="line">5、	set_property：更新plane的property</span><br><span class="line">6、	atomic_duplicate_state：复制当前的plane状态并返回</span><br><span class="line">7、	atomic_destroy_state：销毁当前的plane状态</span><br><span class="line">8、	atomic_set&#x2F;get_property:原子操作设置&#x2F;获得property</span><br><span class="line">9、	format_mod_supported：该可选挂钩用于DRM，以确定给定的格式&#x2F;修饰符组合是否对平面有效</span><br><span class="line">struct drm_plane_helper_funcs结构体成员：</span><br><span class="line">1、	prepare_fb：该钩子通过固定其后备存储器或将其重新定位到连续的VRAM块，为扫描准备帧缓冲区。其他可能的准备工作包括冲洗缓存。</span><br><span class="line">2、	cleanup_fb：清除在prepare_fb分配的给framebuffer和plane的资源</span><br><span class="line">3、	atomic_check：检查该挂钩中的plane特定约束</span><br><span class="line">4、	atomic_update：更新plane状态</span><br><span class="line">5、	atomic_disable：关闭</span><br><span class="line">6、	atomic_async_check：异步检查</span><br><span class="line">7、	atomic_async_update：异步更新状态</span><br></pre></td></tr></table></figure>

<h3 id="🍚-Crtc"><a href="#🍚-Crtc" class="headerlink" title="🍚 Crtc"></a>🍚 Crtc</h3><p>drm_crtc结构体详见：<a target="_blank" rel="noopener" href="https://lxr.missinglinkelectronics.com/linux/include/drm/drm_crtc.h#L946">LXR linux&#x2F;include&#x2F;drm&#x2F;drm_crtc.h</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">struct drm_crtc_funcs结构体成员：</span><br><span class="line">1、	reset;复位，设置为关闭状态</span><br><span class="line">2、	destroy：清除CRTC资源</span><br><span class="line">3、	cursor_set：更新鼠标图像</span><br><span class="line">4、	cursor_move：更新光标位置</span><br><span class="line">5、	gamma_set：gamma设置</span><br><span class="line">6、	set_config：修改配置</span><br><span class="line">7、	page_flip：修改帧缓冲页，避免垂直消影期间用新的缓冲区替代时产生撕裂</span><br><span class="line">8、	set_property：设置property</span><br><span class="line">9、	atomic_duplicate_state：复制当前的状态</span><br><span class="line">10、	atomic_destroy_state：销毁复制的状态</span><br><span class="line">11、	atomic_get_property：获取atomic_get_property</span><br><span class="line">12、	set_crc_source：更改CRC的来源</span><br><span class="line">13、	get_vblank_counter 获取CRTC的vblank计数器</span><br><span class="line">14、	disable_vblank：关闭消影</span><br><span class="line">struct drm_crtc_helper_funcs结构体成员</span><br><span class="line">1、	dpms：控制CRTC电源功率</span><br><span class="line">2、	commit：提交新的模式</span><br><span class="line">3、	mode_valid：用于检查特定模式在此crtc中是否有效</span><br><span class="line">4、	mode_fixup：用于验证模式</span><br><span class="line">5、	mode_set:设置模式</span><br><span class="line">6、	mode_set_nofb：用于更新CRTC的显示模式，而不更改主平面配置的任何内容</span><br><span class="line">7、	mode_set_base：设置新的帧缓冲区和扫描位置</span><br><span class="line">8、	atomic_flush：完成CRTC上多个平面的更新</span><br><span class="line">9、	atomic_enable&#x2F;disable:打开&#x2F;关闭</span><br></pre></td></tr></table></figure>

<h3 id="🍚-Encoder"><a href="#🍚-Encoder" class="headerlink" title="🍚 Encoder"></a>🍚 Encoder</h3><p>drm_encoder结构体详见：<a target="_blank" rel="noopener" href="https://lxr.missinglinkelectronics.com/linux/include/drm/drm_encoder.h#L98">LXR linux&#x2F;include&#x2F;drm&#x2F;drm_encoder.h</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static const struct drm_encoder_funcs ltdc_encoder_funcs &#x3D; &#123;</span><br><span class="line">	.destroy &#x3D; drm_encoder_cleanup,</span><br><span class="line">&#125;;</span><br><span class="line">static const struct drm_encoder_helper_funcs ltdc_encoder_helper_funcs &#x3D; &#123;</span><br><span class="line">	.disable &#x3D; ltdc_encoder_disable,</span><br><span class="line">	.enable &#x3D; ltdc_encoder_enable,</span><br><span class="line">	.mode_set &#x3D; ltdc_encoder_mode_set,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="🍚-helper-函数与使用"><a href="#🍚-helper-函数与使用" class="headerlink" title="🍚 helper 函数与使用"></a>🍚 helper 函数与使用</h3><p>很多文章对 helper 函数和 drm_xxx_helper_funcs 函数产生了混淆！！！以下是我的理解，有错误评论区指出。</p>
<blockquote>
<ul>
<li><strong>drm_xxx_funcs 和 drm_xxx_helper_funcs 结构体是用于表示某个组件的基本操作和辅助操作的结构体；</strong></li>
<li><strong>而 helper 函数是 DRM 框架提供的通用函数，用于实现 DRM 驱动程序中常见的操作。</strong></li>
</ul>
</blockquote>
<blockquote>
<p>在 Linux DRM 驱动中，helper 函数指的是由 DRM 框架提供的一组辅助函数，用于简化驱动程序的实现。这些函数包括了多种类型的操作，如模式设置、原子操作、缓冲区管理等。</p>
<p>常见的helper函数：</p>
<img src="/posts/undefined/4a1986a3b135b11c5cd8f885b50b48fc.png" class="" title="img">



<img src="/posts/undefined/fa4e3ca48f9d63dfbb57d9223ab20dd0.png" class="" title="img">
</blockquote>
<blockquote>
<p><strong>在 drm_xxx_funcs 可以自定义回调函数（完全不使用helper函数），或者使用DRM驱动提供的helper函数直接填充（使用helper函数），如果直接使用helper函数填充不足以满足要求，还可以使用 drm_xxx_helper_funcs 中的回调函数进行补充、修改、覆盖****！</strong></p>
<p>终于理解了！如果你觉着有用，点个赞鼓励一下吧！</p>
</blockquote>
<h3 id="🍚-drm-xxx-funcs-和-drm-xxx-helper-funcs-区别"><a href="#🍚-drm-xxx-funcs-和-drm-xxx-helper-funcs-区别" class="headerlink" title="🍚 drm_xxx_funcs 和 drm_xxx_helper_funcs 区别"></a>🍚 drm_xxx_funcs 和 drm_xxx_helper_funcs 区别</h3><p>****在DRM子系统中，当需要执行特定组件的操作时，就会调用对应的回调函数，这些回调函数会根据其实现的功能，对特定组件进行相应的操作。****比如当系统检测到连接状态发生变化时，会调用drm_connector_funcs中的detect函数，该函数会根据当前连接状态，更新drm_connector的状态，并将状态通知给上层应用程序和显示管道。</p>
<p><strong>drm_xxx_funcs 和 drm_xxx_helper_funcs 都是用来定义回调函数的结构体，它们之间的区别在于它们包含的函数指针的类型和含义不同。</strong></p>
<p>它们的区别在于，<strong>drm_xxx_funcs</strong> 中包含一些<strong>必要的、基本的</strong>由驱动程序实现的函数指针，而 <strong>drm_xxx_helper_funcs</strong> 中包含一些<strong>可选的、辅助的</strong>由驱动程序选择性实现的辅助函数指针。</p>
<blockquote>
<p><strong>总结（来自参考文献，并进行修改）：</strong></p>
<p>drm_xxx_funcs 是 drm ioctl 操作的最终入口，但是对于大多数 SoC 厂商来说，它们的 drm_xxx_funcs 操作流程基本相同（你抄我，我抄你），只是在寄存器配置上存在差异，因此开发者们将那些 common 的操作流程抽象成了 helper 库函数，而将那些厂商差异化的代码放到了 drm_xxx_helper_funcs 中去，用于补充和客制化 helper 库函数。</p>
<p><strong>架构优势：</strong></p>
<p>这样双层的实现即能保证开发者有足够高的自由度（完全不用helper函数），也能简化开发者的开发（使用helper函数），同时提供给开发者hook（修改或者覆盖）特定helper函数的能力。</p>
</blockquote>
<hr>
<h2 id="四、DRM驱动框架（VKMS）"><a href="#四、DRM驱动框架（VKMS）" class="headerlink" title="四、DRM驱动框架（VKMS）"></a>四、DRM驱动框架（VKMS）</h2><h3 id="1、VKMS-简介"><a href="#1、VKMS-简介" class="headerlink" title="1、VKMS 简介"></a>1、VKMS 简介</h3><p><strong>VKMS 是 “Virtual Kernel Mode Setting” 的缩写，</strong>它于2018年7月5日被合入到 linux-4.19 主线版本中，并存放在 drivers&#x2F;gpu&#x2F;drm&#x2F;vkms 目录下。之所以称它为 Virtual KMS，是因为该驱动不需要真实的硬件，它完全是一个软件虚拟的“显示”设备，甚至连显示都算不上，因为当它运行时，你看不到任何显示内容。它唯一能提供的，就是一个由高精度 timer 模拟的 VSYNC 中断信号！</p>
<p>该驱动存在的目的，<strong>主要是为了 DRM 框架自测试，</strong>以及方便那些无头显示器设备的调试应用。虽然我们看不到 VKMS 的显示效果，但是在驱动流程上，它实现了 modesetting 该有的基本操作（Modesetting是指在显示器上渲染图像的过程中，调整显示器的分辨率、刷新率、像素格式等参数，以适应不同的应用场景和显示设备。）。<strong>因其逻辑简单，代码量少，拿来做学习案例讲解再好不过。</strong></p>
<img src="/posts/undefined/3aa2f87db6c6e7c307038c22231d767a.png" class="" title="img">**VKMS在Linux源码下的分布**

<p>随着内核版本的不断升级，添加到 VKMS 的功能也越来越多，截止到内核版本 kernel 5.7-rc2，该 VKMS 驱动已经集成了如下功能：</p>
<ul>
<li>Atomic Modeset</li>
<li>VBlank</li>
<li>Dumb Buffer</li>
<li>Cursor &amp; Primary Plane</li>
<li>Framebuffer CRC 校验</li>
<li>Plane Composition</li>
<li>GEM Prime Import</li>
</ul>
<p>下面我们将一步一步学习如何从零开始撰写一个VKMS驱动。 </p>
<h3 id="2、最简单的VKMS驱动"><a href="#2、最简单的VKMS驱动" class="headerlink" title="2、最简单的VKMS驱动"></a>2、最简单的VKMS驱动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;drm&#x2F;drmP.h&gt;</span><br><span class="line"></span><br><span class="line">static struct drm_device drm;&#x2F;&#x2F; 用于抽象一个完整的DRM设备</span><br><span class="line"></span><br><span class="line">static struct drm_driver vkms_driver &#x3D; &#123;</span><br><span class="line">	.name			&#x3D; &quot;vkms&quot;,</span><br><span class="line">	.desc			&#x3D; &quot;Virtual Kernel Mode Setting&quot;,</span><br><span class="line">	.date			&#x3D; &quot;20180514&quot;,</span><br><span class="line">	.major			&#x3D; 1,</span><br><span class="line">	.minor			&#x3D; 0,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int __init vkms_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	drm_dev_init(&amp;drm, &amp;vkms_driver, NULL);</span><br><span class="line">	drm_dev_register(&amp;drm, 0);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vkms_init);</span><br></pre></td></tr></table></figure>

<p>我们将该驱动以 build-in 方式编译进内核，然后启动内核，如果你在 kernel log 中仔细查找，会发现有如下 drm log, 这些信息正是从上面的 name、date、major、minor 字段中获取的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[drm] Initialized vkms 1.0.0 20180514 for virtual device on minor 0</span><br></pre></td></tr></table></figure>

<p>除此之外，DRM 框架还为我们做了下面这些事情：</p>
<blockquote>
<p>创建设备节点：&#x2F;dev&#x2F;dri&#x2F;card0</p>
<p>创建 sysfs 节点：&#x2F;sys&#x2F;class&#x2F;drm&#x2F;card0</p>
<p>创建 debugfs 节点：&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;dri&#x2F;0</p>
</blockquote>
<p>当然，简单是以牺牲功能为代价的。该驱动目前什么事情也做不了，你唯一能做的就是查看该驱动的名字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;dri&#x2F;0&#x2F;name</span><br><span class="line">vkms unique&#x3D;vkms</span><br></pre></td></tr></table></figure>

<h3 id="3、VKMS驱动添加-fops-操作接口"><a href="#3、VKMS驱动添加-fops-操作接口" class="headerlink" title="3、VKMS驱动添加 fops 操作接口"></a>3、VKMS驱动添加 fops 操作接口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;drm&#x2F;drmP.h&gt;</span><br><span class="line"></span><br><span class="line">static struct drm_device drm;&#x2F;&#x2F; 用于抽象一个完整的DRM设备</span><br><span class="line"></span><br><span class="line">static const struct file_operations vkms_fops &#x3D; &#123;</span><br><span class="line">	.owner &#x3D; THIS_MODULE,</span><br><span class="line">	.open &#x3D; drm_open,</span><br><span class="line">	.release &#x3D; drm_release,</span><br><span class="line">	.unlocked_ioctl &#x3D; drm_ioctl,</span><br><span class="line">	.poll &#x3D; drm_poll,</span><br><span class="line">	.read &#x3D; drm_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct drm_driver vkms_driver &#x3D; &#123;</span><br><span class="line">	.fops			&#x3D; &amp;vkms_fops,</span><br><span class="line"></span><br><span class="line">	.name			&#x3D; &quot;vkms&quot;,</span><br><span class="line">	.desc			&#x3D; &quot;Virtual Kernel Mode Setting&quot;,</span><br><span class="line">	.date			&#x3D; &quot;20180514&quot;,</span><br><span class="line">	.major			&#x3D; 1,</span><br><span class="line">	.minor			&#x3D; 0,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int __init vkms_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	drm_dev_init(&amp;drm, &amp;vkms_driver, NULL);</span><br><span class="line">	drm_dev_register(&amp;drm, 0);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vkms_init);</span><br></pre></td></tr></table></figure>

<p>有了 fops，我们就<strong>可以对 card0 进行 open &#x2F; read 操作了。</strong>更重要的是，我们现在可以进行一些简单的 ioctl 操作了（DRM相关只读的操作，且不需要调用DRM相关回调函数的操作）！但是，到目前为止，<strong>凡是和 modesetting 相关的操作，我们还是操作不了。</strong></p>
<h3 id="4、添加-drm-mode-objects"><a href="#4、添加-drm-mode-objects" class="headerlink" title="4、添加 drm mode objects"></a>4、添加 drm mode objects</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;drm&#x2F;drmP.h&gt;</span><br><span class="line">#include &lt;drm&#x2F;drm_encoder.h&gt;</span><br><span class="line"></span><br><span class="line">static struct drm_device drm;&#x2F;&#x2F; 用于抽象一个完整的DRM设备</span><br><span class="line">static struct drm_plane primary;</span><br><span class="line">static struct drm_crtc crtc;</span><br><span class="line">static struct drm_encoder encoder;</span><br><span class="line">static struct drm_connector connector;</span><br><span class="line"></span><br><span class="line">static const struct drm_plane_funcs vkms_plane_funcs;</span><br><span class="line">static const struct drm_crtc_funcs vkms_crtc_funcs;</span><br><span class="line">static const struct drm_encoder_funcs vkms_encoder_funcs;</span><br><span class="line">static const struct drm_connector_funcs vkms_connector_funcs;</span><br><span class="line"></span><br><span class="line">static const u32 vkms_formats[] &#x3D; &#123;</span><br><span class="line">	DRM_FORMAT_XRGB8888,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static void vkms_modeset_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	drm_mode_config_init(&amp;drm);&#x2F;&#x2F; 初始化KMS框架(初始化一些全局结构体），本质上是初始化drm_device中mode_config结构体</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 初始化drm_device中包含的drm_connector，drm_crtc等对象</span><br><span class="line">	drm_universal_plane_init(&amp;drm, &amp;primary, 0, &amp;vkms_plane_funcs,</span><br><span class="line">				 vkms_formats, ARRAY_SIZE(vkms_formats),</span><br><span class="line">				 NULL, DRM_PLANE_TYPE_PRIMARY, NULL);</span><br><span class="line"></span><br><span class="line">	drm_crtc_init_with_planes(&amp;drm, &amp;crtc, &amp;primary, NULL, &amp;vkms_crtc_funcs, NULL);</span><br><span class="line"></span><br><span class="line">	drm_encoder_init(&amp;drm, &amp;encoder, &amp;vkms_encoder_funcs, DRM_MODE_ENCODER_VIRTUAL, NULL);</span><br><span class="line"></span><br><span class="line">	drm_connector_init(&amp;drm, &amp;connector, &amp;vkms_connector_funcs, DRM_MODE_CONNECTOR_VIRTUAL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const struct file_operations vkms_fops &#x3D; &#123;</span><br><span class="line">	.owner &#x3D; THIS_MODULE,</span><br><span class="line">	.open &#x3D; drm_open,</span><br><span class="line">	.release &#x3D; drm_release,</span><br><span class="line">	.unlocked_ioctl &#x3D; drm_ioctl,</span><br><span class="line">	.poll &#x3D; drm_poll,</span><br><span class="line">	.read &#x3D; drm_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct drm_driver vkms_driver &#x3D; &#123;</span><br><span class="line">	.driver_features &#x3D; DRIVER_MODESET, &#x2F;&#x2F; 添加上 DRIVER_MODESET 标志位，告诉 DRM Core 当前驱动支持 modesetting 操作</span><br><span class="line">	.fops			&#x3D; &amp;vkms_fops,</span><br><span class="line"></span><br><span class="line">	.name			&#x3D; &quot;vkms&quot;,</span><br><span class="line">	.desc			&#x3D; &quot;Virtual Kernel Mode Setting&quot;,</span><br><span class="line">	.date			&#x3D; &quot;20180514&quot;,</span><br><span class="line">	.major			&#x3D; 1,</span><br><span class="line">	.minor			&#x3D; 0,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int __init vkms_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	drm_dev_init(&amp;drm, &amp;vkms_driver, NULL);</span><br><span class="line"></span><br><span class="line">	vkms_modeset_init();</span><br><span class="line"></span><br><span class="line">	drm_dev_register(&amp;drm, 0);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vkms_init);</span><br></pre></td></tr></table></figure>

<p>由于上面4个 objects 在创建时，它们的 <strong>callback funcs 没有赋初值，</strong>所以真正的 <strong>modeset 操作目前还无法正常执行，</strong>不过我们至少可以使用一些只读的 modeset IOCTL 了（DRM objects 相关只读的操作，且不需要调用DRM相关回调函数的操作）。</p>
<h3 id="5、添加-FB-和-GEM-支持"><a href="#5、添加-FB-和-GEM-支持" class="headerlink" title="5、添加 FB 和 GEM 支持"></a>5、添加 FB 和 GEM 支持</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;drm&#x2F;drmP.h&gt;</span><br><span class="line">#include &lt;drm&#x2F;drm_encoder.h&gt;</span><br><span class="line">#include &lt;drm&#x2F;drm_fb_cma_helper.h&gt;</span><br><span class="line">#include &lt;drm&#x2F;drm_gem_cma_helper.h&gt;</span><br><span class="line"></span><br><span class="line">static struct drm_device drm;&#x2F;&#x2F; 用于抽象一个完整的DRM设备</span><br><span class="line">static struct drm_plane primary;</span><br><span class="line">static struct drm_crtc crtc;</span><br><span class="line">static struct drm_encoder encoder;</span><br><span class="line">static struct drm_connector connector;</span><br><span class="line"></span><br><span class="line">static const struct drm_plane_funcs vkms_plane_funcs;</span><br><span class="line">static const struct drm_crtc_funcs vkms_crtc_funcs;</span><br><span class="line">static const struct drm_encoder_funcs vkms_encoder_funcs;</span><br><span class="line">static const struct drm_connector_funcs vkms_connector_funcs;</span><br><span class="line"></span><br><span class="line">&#x2F;* add here *&#x2F;</span><br><span class="line">&#x2F;&#x2F; 定义了一组函数指针，用于管理驱动程序中的显示模式配置。</span><br><span class="line">&#x2F;&#x2F; 这些函数指针包括添加和删除连接器、CRTC和编解码器，以及更新显示模式等功能。</span><br><span class="line">&#x2F;&#x2F; 这些函数在驱动程序中被调用以进行显示模式的管理和配置。</span><br><span class="line">static const struct drm_mode_config_funcs vkms_mode_funcs &#x3D; &#123;</span><br><span class="line">	.fb_create &#x3D; drm_fb_cma_create, &#x2F;&#x2F; 根据给定的帧缓冲参数，创建一个新的帧缓冲对象，并返回其句柄</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const u32 vkms_formats[] &#x3D; &#123;</span><br><span class="line">	DRM_FORMAT_XRGB8888,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static void vkms_modeset_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	drm_mode_config_init(&amp;drm);&#x2F;&#x2F; 初始化KMS框架，本质上是初始化drm_device中的mode_config结构体</span><br><span class="line">    &#x2F;&#x2F; 填充mode_config中int min_width, min_height; int max_width, max_height的值，这些值是framebuffer的大小限制</span><br><span class="line">	drm.mode_config.max_width &#x3D; 8192;</span><br><span class="line">	drm.mode_config.max_height &#x3D; 8192;</span><br><span class="line">	&#x2F;* add here *&#x2F;</span><br><span class="line">    &#x2F;&#x2F; 设置mode_config-&gt;funcs指针，本质是一组由驱动实现的回调函数，涵盖KMS中一些相当基本的操作</span><br><span class="line">	drm.mode_config.funcs &#x3D; &amp;vkms_mode_funcs;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 初始化drm_device中包含的drm_connector，drm_crtc等对象</span><br><span class="line">	drm_universal_plane_init(&amp;drm, &amp;primary, 0, &amp;vkms_plane_funcs,</span><br><span class="line">				 vkms_formats, ARRAY_SIZE(vkms_formats),</span><br><span class="line">				 NULL, DRM_PLANE_TYPE_PRIMARY, NULL);</span><br><span class="line"></span><br><span class="line">	drm_crtc_init_with_planes(&amp;drm, &amp;crtc, &amp;primary, NULL, &amp;vkms_crtc_funcs, NULL);</span><br><span class="line"></span><br><span class="line">	drm_encoder_init(&amp;drm, &amp;encoder, &amp;vkms_encoder_funcs, DRM_MODE_ENCODER_VIRTUAL, NULL);</span><br><span class="line"></span><br><span class="line">	drm_connector_init(&amp;drm, &amp;connector, &amp;vkms_connector_funcs, DRM_MODE_CONNECTOR_VIRTUAL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 文件操作回调函数</span><br><span class="line">static const struct file_operations vkms_fops &#x3D; &#123;</span><br><span class="line">	.owner &#x3D; THIS_MODULE,</span><br><span class="line">	.open &#x3D; drm_open,</span><br><span class="line">	.release &#x3D; drm_release,</span><br><span class="line">	.unlocked_ioctl &#x3D; drm_ioctl,</span><br><span class="line">	.poll &#x3D; drm_poll,</span><br><span class="line">	.read &#x3D; drm_read,</span><br><span class="line">	&#x2F;* add here *&#x2F;</span><br><span class="line">	.mmap &#x3D; drm_gem_cma_mmap, &#x2F;&#x2F; DRM的GEM对象映射到用户空间，以便用户空间可以使用它</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct drm_driver vkms_driver &#x3D; &#123;</span><br><span class="line">	.driver_features &#x3D; DRIVER_MODESET | DRIVER_GEM, &#x2F;&#x2F; 添加DRIVER_GEM 标志位，告诉 DRM Core 该驱动支持 GEM 操作</span><br><span class="line">	.fops			&#x3D; &amp;vkms_fops,</span><br><span class="line"></span><br><span class="line">	&#x2F;* add here *&#x2F;</span><br><span class="line">	.dumb_create	&#x3D; drm_gem_cma_dumb_create, &#x2F;&#x2F; </span><br><span class="line">	.gem_vm_ops		&#x3D; &amp;drm_gem_cma_vm_ops,</span><br><span class="line">	.gem_free_object_unlocked &#x3D; drm_gem_cma_free_object,</span><br><span class="line"></span><br><span class="line">	.name			&#x3D; &quot;vkms&quot;,</span><br><span class="line">	.desc			&#x3D; &quot;Virtual Kernel Mode Setting&quot;,</span><br><span class="line">	.date			&#x3D; &quot;20180514&quot;,</span><br><span class="line">	.major			&#x3D; 1,</span><br><span class="line">	.minor			&#x3D; 0,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int __init vkms_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	drm_dev_init(&amp;drm, &amp;vkms_driver, NULL);</span><br><span class="line"></span><br><span class="line">	vkms_modeset_init();</span><br><span class="line"></span><br><span class="line">	drm_dev_register(&amp;drm, 0);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vkms_init);</span><br></pre></td></tr></table></figure>

<p>现在，我们可以使用 IOCTL 来进行一些标准的 GEM 和 FB 操作了！</p>
<h4 id="驱动解析1"><a href="#驱动解析1" class="headerlink" title="驱动解析1 :"></a><strong>驱动解析1 :</strong></h4><p>我们知道drm_device用于抽象一个完整的DRM设备，而其中与<strong>Mode Setting相关的部分则由drm_mode_config 进行管理。</strong>drm_mode_config 的主要功能之一是<strong>提供对显示器模式的管理和配置。</strong>这包括添加、删除、修改和查询显示器模式的能力。此外，drm_mode_config还提供了与模式相关的配置选项，例如色彩空间、刷新率、分辨率等等。</p>
<p><strong>在 drm_device 中存在 mode_config 这个 drm_mode_config 结构体:</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">* struct drm_device - DRM device structure</span><br><span class="line">*</span><br><span class="line">* This structure represent a complete card that</span><br><span class="line">* may contain multiple heads.</span><br><span class="line">*&#x2F;</span><br><span class="line">struct drm_device &#123;</span><br><span class="line">    &#x2F;** @if_version: Highest interface version set *&#x2F;</span><br><span class="line">    int if_version;</span><br><span class="line"></span><br><span class="line">    &#x2F;** @ref: Object ref-count *&#x2F;</span><br><span class="line">    struct kref ref;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    &#x2F;** @mode_config: Current mode config *&#x2F;</span><br><span class="line">    struct drm_mode_config mode_config;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在 mode_config 这个 *<em>drm_mode_config 结构体中存在一个*<em>类*<em>型为 drm_mode_config_func 的回调函数 func。</em></em></em>*drm_mode_config_func是一个函数指针结构体，用于驱动程序向内核注册显示器模式配置的回调函数。**这些函数指针包括添加和删除连接器、CRTC和编解码器，以及更新显示模式等功能。当内核需要对显示器模式进行配置或管理时，它将调用这些回调函数以执行相应操作。</p>
<blockquote>
<p>drm_mode_config_funcs结构体中的 fb_create 作用：</p>
<p>fb_create 函数的作用是根据给定的帧缓冲参数，创建一个新的**帧缓冲对象**（并不是分配内存，只是创建帧缓冲对象，因为 framebuffer 不涉及内存的分配与释放）****，并返回其句柄。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">* struct drm_mode_config - Mode configuration control structure</span><br><span class="line">* @min_width: minimum fb pixel width on this device</span><br><span class="line">* @min_height: minimum fb pixel height on this device</span><br><span class="line">* @max_width: maximum fb pixel width on this device</span><br><span class="line">* @max_height: maximum fb pixel height on this device</span><br><span class="line">* @funcs: core driver provided mode setting functions</span><br><span class="line">* @fb_base: base address of the framebuffer</span><br><span class="line">* @poll_enabled: track polling support for this device</span><br><span class="line">* @poll_running: track polling status for this device</span><br><span class="line">* @delayed_event: track delayed poll uevent deliver for this device</span><br><span class="line">* @output_poll_work: delayed work for polling in process context</span><br><span class="line">* @preferred_depth: preferred RBG pixel depth, used by fb helpers</span><br><span class="line">* @prefer_shadow: hint to userspace to prefer shadow-fb rendering</span><br><span class="line">* @cursor_width: hint to userspace for max cursor width</span><br><span class="line">* @cursor_height: hint to userspace for max cursor height</span><br><span class="line">* @helper_private: mid-layer private data</span><br><span class="line">*</span><br><span class="line">* Core mode resource tracking structure.  All CRTC, encoders, and connectors</span><br><span class="line">* enumerated by the driver are added here, as are global properties.  Some</span><br><span class="line">* global restrictions are also here, e.g. dimension restrictions.</span><br><span class="line">*&#x2F;</span><br><span class="line">struct drm_mode_config &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    int min_width, min_height;</span><br><span class="line">    int max_width, max_height;</span><br><span class="line">    const struct drm_mode_config_funcs *funcs;</span><br><span class="line">    resource_size_t fb_base;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="驱动解析2"><a href="#驱动解析2" class="headerlink" title="驱动解析2 :"></a><strong>驱动解析2 :</strong></h4><blockquote>
<p><em>*<em>*dumb_create： struct drm_driver 结构体中的一个函数指针，它指向的函数用于在 DRM 子系统中*</em>*<em>创建 dumb buffer，也就是一个简单的、未映射的内存区域，*</em>*<em>通常用于测试或临时存储。*</em>*</em></p>
</blockquote>
<p>dumb_create：分配 dumb buffer 的回调接口，主要完成三件事：<br>（1）创建 gem object<br>（2）创建 gem handle<br>（3）分配物理 buffer （也可以等到后面再分配）<br>本例中直接使用 CMA helper 函数实现，该函数内部会分配最终的物理 buffer。</p>
<blockquote>
<p><strong>GEM分配的内存区域通过映射之后交给Frame buffer驱动程序使用。*<em>Frame buffer驱动程序不直接分配内存，而是通过访问GEM对象来获取内存区域的物理地址等信息，以便正确地管理和利用帧缓冲区中的显示数据。*</em></strong></p>
<p>在将GEM映射到帧缓冲区时，需要经过以下两个步骤：</p>
<ol>
<li>将GEM对象中的内存区域映射到内核空间的虚拟地址空间中。</li>
<li>将内核空间中的GEM内存区域映射到显示设备的显存中。</li>
</ol>
</blockquote>
<h4 id="驱动解析3"><a href="#驱动解析3" class="headerlink" title="驱动解析3 :"></a>驱动解析3 :</h4><p><strong>mmp:</strong> 将GEM内存映射到用户控件。创建 dumb buffer 的目的就是要拿去给 CPU 画图，因此没有 mmap 的 dumb buffer 是没有灵魂的，所以必须实现。通常使用 drm_gem_mmap() 来实现。在 kernel 驱动中，实现 mmap 系统调用离不开两个关键步骤：<strong>（1）内存分配 （2） 建立映射关系</strong>。这刚好也对应了 DRM 中的 <em>dumb_create</em> 和 <em>mmap</em> 操作。</p>
<h4 id="驱动解析4"><a href="#驱动解析4" class="headerlink" title="驱动解析4 :"></a>驱动解析4 :</h4><p>gem_vm_ops：该函数指针中包含的各种操作函数，例如 fault, open, close, access 等，都是<strong>用于实现 GEM 内存管理机制的各种功能。</strong></p>
<blockquote>
<ul>
<li>mmap 函数是将设备<strong>内存映射</strong>到进程的<strong>用户空间，</strong>让应用程序可以直接访问设备内存。</li>
<li>gem_vm_ops 函数指针则是在用户空间程序请求显存时被调用(mmp)，用于控制显存的访问权限、分配显存、映射显存到用户空间等操作，从而确保显存的安全性和高效性。</li>
</ul>
</blockquote>
<p>这个过程涉及到分配一块虚拟内存、映射物理内存、建立页表等操作。 因此，在实现 DRM 驱动时，这两个函数通常需要一起实现，以支持对设备内存的映射操作。</p>
<h4 id="驱动解析5"><a href="#驱动解析5" class="headerlink" title="驱动解析5 :"></a>驱动解析5 :</h4><p>gem_free_object_unlocked ：该指针指向一个函数，用于释放GEM对象的资源。具体来说，当一个GEM对象不再被使用时，该函数将被调用来释放该对象的内存、锁定的页面等资源。这个函数指针可以在结构体中 struct drm_driver 定义，作为驱动的一部分，因此在驱动代码中可以使用它来释放GEM对象的资源。</p>
<h3 id="6、实现-callback-funcs-并添加-Legacy-Modeset-支持"><a href="#6、实现-callback-funcs-并添加-Legacy-Modeset-支持" class="headerlink" title="6、实现 callback funcs 并添加 Legacy Modeset 支持"></a>6、实现 callback funcs 并添加 Legacy Modeset 支持</h3><p>Legacy Modeset 是指在 Linux DRM 框架中使用传统的 KMS 模式设置，也称为“旧模式设置”。</p>
<p>在 Legacy Modeset 中，<strong>驱动程序需要执行多个步骤来更改图形模式</strong>，例如分配帧缓冲，设置分辨率和刷新率等。这些步骤是分开执行的，如果其中的任何一步出现错误，整个操作都可能失败。可能会导致画面闪烁、撕裂或丢失帧等问题，而且驱动程序必须花费额外的时间来撤消之前的更改。</p>
<p>因此，Legacy Modeset 的主要缺点是不具备原子性，无法保证更改的一致性和可靠性。这也是 Atom Modeset 出现的主要原因。Atom Modeset 可以将多个操作封装成一个事务并原子地提交给硬件，从而保证所有更改都是一致和可靠的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;drm&#x2F;drm_crtc_helper.h&gt;</span><br><span class="line">#include &lt;drm&#x2F;drm_plane_helper.h&gt;</span><br><span class="line">#include &lt;drm&#x2F;drm_fb_cma_helper.h&gt;</span><br><span class="line">#include &lt;drm&#x2F;drm_gem_cma_helper.h&gt;</span><br><span class="line"></span><br><span class="line">static struct drm_device drm;</span><br><span class="line">static struct drm_plane primary;</span><br><span class="line">static struct drm_crtc crtc;</span><br><span class="line">static struct drm_encoder encoder;</span><br><span class="line">static struct drm_connector connector;</span><br><span class="line"></span><br><span class="line">static void vkms_crtc_dpms(struct drm_crtc *crtc, int mode)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int vkms_crtc_mode_set(struct drm_crtc *crtc,</span><br><span class="line">				struct drm_display_mode *mode,</span><br><span class="line">				struct drm_display_mode *adjusted_mode,</span><br><span class="line">				int x, int y, struct drm_framebuffer *old_fb)</span><br><span class="line">&#123;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void vkms_crtc_prepare(struct drm_crtc *crtc)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void vkms_crtc_commit(struct drm_crtc *crtc)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int vkms_crtc_page_flip(struct drm_crtc *crtc,</span><br><span class="line">				struct drm_framebuffer *fb,</span><br><span class="line">				struct drm_pending_vblank_event *event,</span><br><span class="line">				uint32_t page_flip_flags,</span><br><span class="line">				struct drm_modeset_acquire_ctx *ctx)</span><br><span class="line">&#123;</span><br><span class="line">	unsigned long flags;</span><br><span class="line"></span><br><span class="line">	crtc-&gt;primary-&gt;fb &#x3D; fb;</span><br><span class="line">	if (event) &#123;</span><br><span class="line">		spin_lock_irqsave(&amp;crtc-&gt;dev-&gt;event_lock, flags);</span><br><span class="line">		drm_crtc_send_vblank_event(crtc, event);</span><br><span class="line">		spin_unlock_irqrestore(&amp;crtc-&gt;dev-&gt;event_lock, flags);</span><br><span class="line">	&#125;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const struct drm_crtc_helper_funcs vkms_crtc_helper_funcs &#x3D; &#123;</span><br><span class="line">	.dpms &#x3D; vkms_crtc_dpms,</span><br><span class="line">	.mode_set &#x3D; vkms_crtc_mode_set,</span><br><span class="line">	.prepare &#x3D; vkms_crtc_prepare,</span><br><span class="line">	.commit &#x3D; vkms_crtc_commit,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct drm_crtc_funcs vkms_crtc_funcs &#x3D; &#123;</span><br><span class="line">	.set_config &#x3D; drm_crtc_helper_set_config,</span><br><span class="line">	.page_flip &#x3D; vkms_crtc_page_flip,</span><br><span class="line">	.destroy &#x3D; drm_crtc_cleanup,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct drm_plane_funcs vkms_plane_funcs &#x3D; &#123;</span><br><span class="line">	.update_plane &#x3D; drm_primary_helper_update,</span><br><span class="line">	.disable_plane &#x3D; drm_primary_helper_disable,</span><br><span class="line">	.destroy &#x3D; drm_plane_cleanup,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int vkms_connector_get_modes(struct drm_connector *connector)</span><br><span class="line">&#123;</span><br><span class="line">	int count;</span><br><span class="line"></span><br><span class="line">	count &#x3D; drm_add_modes_noedid(connector, 8192, 8192);</span><br><span class="line">	drm_set_preferred_mode(connector, 1024, 768);</span><br><span class="line"></span><br><span class="line">	return count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static struct drm_encoder *vkms_connector_best_encoder(struct drm_connector *connector)</span><br><span class="line">&#123;</span><br><span class="line">	return &amp;encoder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const struct drm_connector_helper_funcs vkms_conn_helper_funcs &#x3D; &#123;</span><br><span class="line">	.get_modes &#x3D; vkms_connector_get_modes,</span><br><span class="line">	.best_encoder &#x3D; vkms_connector_best_encoder,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static const struct drm_connector_funcs vkms_connector_funcs &#x3D; &#123;</span><br><span class="line">	.dpms &#x3D; drm_helper_connector_dpms,</span><br><span class="line">	.fill_modes &#x3D; drm_helper_probe_single_connector_modes,</span><br><span class="line">	.destroy &#x3D; drm_connector_cleanup,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct drm_encoder_funcs vkms_encoder_funcs &#x3D; &#123;</span><br><span class="line">	.destroy &#x3D; drm_encoder_cleanup,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct drm_mode_config_funcs vkms_mode_funcs &#x3D; &#123;</span><br><span class="line">	.fb_create &#x3D; drm_fb_cma_create,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const u32 vkms_formats[] &#x3D; &#123;</span><br><span class="line">	DRM_FORMAT_XRGB8888,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static void vkms_modeset_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	drm_mode_config_init(&amp;drm);</span><br><span class="line">	drm.mode_config.max_width &#x3D; 8192;</span><br><span class="line">	drm.mode_config.max_height &#x3D; 8192;</span><br><span class="line">	drm.mode_config.funcs &#x3D; &amp;vkms_mode_funcs;</span><br><span class="line"></span><br><span class="line">	drm_universal_plane_init(&amp;drm, &amp;primary, 0, &amp;vkms_plane_funcs,</span><br><span class="line">				 		vkms_formats, ARRAY_SIZE(vkms_formats),</span><br><span class="line">				 		NULL, DRM_PLANE_TYPE_PRIMARY, NULL);</span><br><span class="line"></span><br><span class="line">	drm_crtc_init_with_planes(&amp;drm, &amp;crtc, &amp;primary, NULL, &amp;vkms_crtc_funcs, NULL);</span><br><span class="line">	drm_crtc_helper_add(&amp;crtc, &amp;vkms_crtc_helper_funcs);</span><br><span class="line"></span><br><span class="line">	drm_encoder_init(&amp;drm, &amp;encoder, &amp;vkms_encoder_funcs, DRM_MODE_ENCODER_VIRTUAL, NULL);</span><br><span class="line"></span><br><span class="line">	drm_connector_init(&amp;drm, &amp;connector, &amp;vkms_connector_funcs, DRM_MODE_CONNECTOR_VIRTUAL);</span><br><span class="line">	drm_connector_helper_add(&amp;connector, &amp;vkms_conn_helper_funcs);</span><br><span class="line">	drm_mode_connector_attach_encoder(&amp;connector, &amp;encoder);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const struct file_operations vkms_fops &#x3D; &#123;</span><br><span class="line">	.owner &#x3D; THIS_MODULE,</span><br><span class="line">	.open &#x3D; drm_open,</span><br><span class="line">	.release &#x3D; drm_release,</span><br><span class="line">	.unlocked_ioctl &#x3D; drm_ioctl,</span><br><span class="line">	.poll &#x3D; drm_poll,</span><br><span class="line">	.read &#x3D; drm_read,</span><br><span class="line">	.mmap &#x3D; drm_gem_cma_mmap,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct drm_driver vkms_driver &#x3D; &#123;</span><br><span class="line">	.driver_features	&#x3D; DRIVER_MODESET | DRIVER_GEM,</span><br><span class="line">	.fops			&#x3D; &amp;vkms_fops,</span><br><span class="line"></span><br><span class="line">	.dumb_create	&#x3D; drm_gem_cma_dumb_create,</span><br><span class="line">	.gem_vm_ops		&#x3D; &amp;drm_gem_cma_vm_ops,</span><br><span class="line">	.gem_free_object_unlocked &#x3D; drm_gem_cma_free_object,</span><br><span class="line"></span><br><span class="line">	.name			&#x3D; &quot;vkms&quot;,</span><br><span class="line">	.desc			&#x3D; &quot;Virtual Kernel Mode Setting&quot;,</span><br><span class="line">	.date			&#x3D; &quot;20180514&quot;,</span><br><span class="line">	.major			&#x3D; 1,</span><br><span class="line">	.minor			&#x3D; 0,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int __init vkms_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	drm_dev_init(&amp;drm, &amp;vkms_driver, NULL);</span><br><span class="line"></span><br><span class="line">	vkms_modeset_init();</span><br><span class="line"></span><br><span class="line">	drm_dev_register(&amp;drm, 0);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vkms_init);</span><br></pre></td></tr></table></figure>

<ol>
<li>*<strong>xxx_funcs* 必须有，*xxx_helper_funcs* 可以没有。</strong></li>
<li><em>drm_xxx_init()</em> 必须有，<em>drm_xxx_helper_add()</em> 可以没有。</li>
<li>只有当 <em>xxx_funcs</em> 采用 DRM 标准的 helper 函数实现时，才<strong>有可能</strong> 需要定义 <em>xxx_helper_funcs</em> 接口。</li>
<li><em>xxx_funcs.destroy()</em> 接口必须实现。</li>
</ol>
<p>有了各种 funcs 和 helper funcs，我们现在终于可以执行真正的 modeset 操作了，不过目前只支持 legacy modeset。</p>
<h3 id="7、将-Legacy-code-转换为-Atomic-版本"><a href="#7、将-Legacy-code-转换为-Atomic-版本" class="headerlink" title="7、将 Legacy code 转换为 Atomic 版本"></a>7、将 Legacy code 转换为 Atomic 版本</h3><p>DRM驱动的legacy模式是一种传统的方法，它使用一个内核模块来管理DRM资源，支持在内核空间和用户空间之间进行资源管理。这种模式比较简单，但性能不太好，而且容易出现错误。</p>
<p>Atomic模式是一种更新的模式，它使用多个内核模块来管理DRM资源，并且支持在内核空间和用户空间之间进行原子操作，从而提供更好的性能和可靠性。Atomic模式比legacy模式更复杂，但性能更好，而且更加可靠。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;drm&#x2F;drm_atomic_helper.h&gt;</span><br><span class="line">#include &lt;drm&#x2F;drm_crtc_helper.h&gt;</span><br><span class="line">#include &lt;drm&#x2F;drm_fb_cma_helper.h&gt;</span><br><span class="line">#include &lt;drm&#x2F;drm_gem_cma_helper.h&gt;</span><br><span class="line">#include &lt;linux&#x2F;hrtimer.h&gt;</span><br><span class="line"></span><br><span class="line">static struct drm_device drm;</span><br><span class="line">static struct drm_plane primary;</span><br><span class="line">static struct drm_crtc crtc;</span><br><span class="line">static struct drm_encoder encoder;</span><br><span class="line">static struct drm_connector connector;</span><br><span class="line">static struct hrtimer vblank_hrtimer;</span><br><span class="line"></span><br><span class="line">static enum hrtimer_restart vkms_vblank_simulate(struct hrtimer *timer)</span><br><span class="line">&#123;</span><br><span class="line">	drm_crtc_handle_vblank(&amp;crtc);</span><br><span class="line"></span><br><span class="line">	hrtimer_forward_now(&amp;vblank_hrtimer, 16666667);</span><br><span class="line"></span><br><span class="line">	return HRTIMER_RESTART;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void vkms_crtc_atomic_enable(struct drm_crtc *crtc,</span><br><span class="line">				    struct drm_crtc_state *old_state)</span><br><span class="line">&#123;</span><br><span class="line">	hrtimer_init(&amp;vblank_hrtimer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);</span><br><span class="line">	vblank_hrtimer.function &#x3D; &amp;vkms_vblank_simulate;</span><br><span class="line">	hrtimer_start(&amp;vblank_hrtimer, 16666667, HRTIMER_MODE_REL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void vkms_crtc_atomic_disable(struct drm_crtc *crtc,</span><br><span class="line">				     struct drm_crtc_state *old_state)</span><br><span class="line">&#123;</span><br><span class="line">	hrtimer_cancel(&amp;vblank_hrtimer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void vkms_crtc_atomic_flush(struct drm_crtc *crtc,</span><br><span class="line">				   struct drm_crtc_state *old_crtc_state)</span><br><span class="line">&#123;</span><br><span class="line">	unsigned long flags;</span><br><span class="line"></span><br><span class="line">	if (crtc-&gt;state-&gt;event) &#123;</span><br><span class="line">		spin_lock_irqsave(&amp;crtc-&gt;dev-&gt;event_lock, flags);</span><br><span class="line">		drm_crtc_send_vblank_event(crtc, crtc-&gt;state-&gt;event);</span><br><span class="line">		spin_unlock_irqrestore(&amp;crtc-&gt;dev-&gt;event_lock, flags);</span><br><span class="line"></span><br><span class="line">		crtc-&gt;state-&gt;event &#x3D; NULL;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const struct drm_crtc_helper_funcs vkms_crtc_helper_funcs &#x3D; &#123;</span><br><span class="line">	.atomic_enable	&#x3D; vkms_crtc_atomic_enable,</span><br><span class="line">	.atomic_disable	&#x3D; vkms_crtc_atomic_disable,</span><br><span class="line">	.atomic_flush	&#x3D; vkms_crtc_atomic_flush,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct drm_crtc_funcs vkms_crtc_funcs &#x3D; &#123;</span><br><span class="line">	.set_config             &#x3D; drm_atomic_helper_set_config,</span><br><span class="line">	.page_flip              &#x3D; drm_atomic_helper_page_flip,</span><br><span class="line">	.destroy                &#x3D; drm_crtc_cleanup,</span><br><span class="line">	.reset                  &#x3D; drm_atomic_helper_crtc_reset,</span><br><span class="line">	.atomic_duplicate_state &#x3D; drm_atomic_helper_crtc_duplicate_state,</span><br><span class="line">	.atomic_destroy_state   &#x3D; drm_atomic_helper_crtc_destroy_state,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static void vkms_plane_atomic_update(struct drm_plane *plane,</span><br><span class="line">				      struct drm_plane_state *old_state)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const struct drm_plane_helper_funcs vkms_plane_helper_funcs &#x3D; &#123;</span><br><span class="line">	.atomic_update		&#x3D; vkms_plane_atomic_update,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct drm_plane_funcs vkms_plane_funcs &#x3D; &#123;</span><br><span class="line">	.update_plane		&#x3D; drm_atomic_helper_update_plane,</span><br><span class="line">	.disable_plane		&#x3D; drm_atomic_helper_disable_plane,</span><br><span class="line">	.destroy			&#x3D; drm_plane_cleanup,</span><br><span class="line">	.reset				&#x3D; drm_atomic_helper_plane_reset,</span><br><span class="line">	.atomic_duplicate_state &#x3D; drm_atomic_helper_plane_duplicate_state,</span><br><span class="line">	.atomic_destroy_state	&#x3D; drm_atomic_helper_plane_destroy_state,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int vkms_conn_get_modes(struct drm_connector *connector)</span><br><span class="line">&#123;</span><br><span class="line">	int count;</span><br><span class="line"></span><br><span class="line">	count &#x3D; drm_add_modes_noedid(connector, 8192, 8192);</span><br><span class="line">	drm_set_preferred_mode(connector, 1024, 768);</span><br><span class="line"></span><br><span class="line">	return count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const struct drm_connector_helper_funcs vkms_conn_helper_funcs &#x3D; &#123;</span><br><span class="line">	.get_modes &#x3D; vkms_conn_get_modes,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct drm_connector_funcs vkms_connector_funcs &#x3D; &#123;</span><br><span class="line">	.fill_modes &#x3D; drm_helper_probe_single_connector_modes,</span><br><span class="line">	.destroy &#x3D; drm_connector_cleanup,</span><br><span class="line">	.reset &#x3D; drm_atomic_helper_connector_reset, &#x2F;&#x2F; reset函数通常被用于在DRM模式切换或重置时，重置plane对象的状态。</span><br><span class="line">	.atomic_duplicate_state &#x3D; drm_atomic_helper_connector_duplicate_state,</span><br><span class="line">	.atomic_destroy_state &#x3D; drm_atomic_helper_connector_destroy_state,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 在DRM中，encoder对象的状态更新和禁用等操作都是通过对应的CRTC对象的状态进行修改来实现的，因此在encoder_funcs结构体中确实不需要实现.atomic_duplicate_state成员。encoder对象的状态更新和禁用等操作都是由CRTC对象的状态更新和禁用等操作来完成的。</span><br><span class="line">static const struct drm_encoder_funcs vkms_encoder_funcs &#x3D; &#123;</span><br><span class="line">	.destroy &#x3D; drm_encoder_cleanup, &#x2F;&#x2F; DRM框架中的一个helper函数，用于清理encoder对象的资源。</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct drm_mode_config_funcs vkms_mode_funcs &#x3D; &#123;</span><br><span class="line">	.fb_create &#x3D; drm_fb_cma_create,</span><br><span class="line">	.atomic_check &#x3D; drm_atomic_helper_check, &#x2F;&#x2F; 遍历原子状态中的各个平面状态信息，并进行一些检查，以确保新的状态是合法的，并且可以被应用到显卡硬件上。</span><br><span class="line">	.atomic_commit &#x3D; drm_atomic_helper_commit, &#x2F;&#x2F; 根据原子状态中的各个平面状态信息，计算出新的显卡状态，并将其应用到显卡硬件上，从而实现显示输出</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const u32 vkms_formats[] &#x3D; &#123;</span><br><span class="line">	DRM_FORMAT_XRGB8888,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static void vkms_modeset_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	drm_mode_config_init(&amp;drm);</span><br><span class="line">	drm.mode_config.max_width &#x3D; 8192;</span><br><span class="line">	drm.mode_config.max_height &#x3D; 8192;</span><br><span class="line">	drm.mode_config.funcs &#x3D; &amp;vkms_mode_funcs;</span><br><span class="line"></span><br><span class="line">	drm_universal_plane_init(&amp;drm, &amp;primary, 0, &amp;vkms_plane_funcs,</span><br><span class="line">				 vkms_formats, ARRAY_SIZE(vkms_formats),</span><br><span class="line">				 NULL, DRM_PLANE_TYPE_PRIMARY, NULL);</span><br><span class="line">	drm_plane_helper_add(&amp;primary, &amp;vkms_plane_helper_funcs);</span><br><span class="line"></span><br><span class="line">	drm_crtc_init_with_planes(&amp;drm, &amp;crtc, &amp;primary, NULL, &amp;vkms_crtc_funcs, NULL);</span><br><span class="line">	drm_crtc_helper_add(&amp;crtc, &amp;vkms_crtc_helper_funcs);</span><br><span class="line"></span><br><span class="line">	drm_encoder_init(&amp;drm, &amp;encoder, &amp;vkms_encoder_funcs, DRM_MODE_ENCODER_VIRTUAL, NULL);</span><br><span class="line"></span><br><span class="line">	drm_connector_init(&amp;drm, &amp;connector, &amp;vkms_connector_funcs, DRM_MODE_CONNECTOR_VIRTUAL);</span><br><span class="line">	drm_connector_helper_add(&amp;connector, &amp;vkms_conn_helper_funcs);</span><br><span class="line">	drm_mode_connector_attach_encoder(&amp;connector, &amp;encoder);</span><br><span class="line"></span><br><span class="line">	drm_mode_config_reset(&amp;drm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const struct file_operations vkms_fops &#x3D; &#123;</span><br><span class="line">	.owner &#x3D; THIS_MODULE,</span><br><span class="line">	.open &#x3D; drm_open,</span><br><span class="line">	.release &#x3D; drm_release,</span><br><span class="line">	.unlocked_ioctl &#x3D; drm_ioctl,</span><br><span class="line">	.poll &#x3D; drm_poll,</span><br><span class="line">	.read &#x3D; drm_read,</span><br><span class="line">	.mmap &#x3D; drm_gem_cma_mmap,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct drm_driver vkms_driver &#x3D; &#123;</span><br><span class="line">	.driver_features &#x3D; DRIVER_MODESET | DRIVER_GEM | DRIVER_ATOMIC, &#x2F;&#x2F; 给 driver_features 添加上 DRIVER_ATOMIC 标志位，告诉 DRM Core 该驱动支持 Atomic 操作。</span><br><span class="line">	.fops			&#x3D; &amp;vkms_fops,</span><br><span class="line"></span><br><span class="line">	.dumb_create	&#x3D; drm_gem_cma_dumb_create,</span><br><span class="line">	.gem_vm_ops		&#x3D; &amp;drm_gem_cma_vm_ops,</span><br><span class="line">	.gem_free_object_unlocked &#x3D; drm_gem_cma_free_object,</span><br><span class="line"></span><br><span class="line">	.name			&#x3D; &quot;vkms&quot;,</span><br><span class="line">	.desc			&#x3D; &quot;Virtual Kernel Mode Setting&quot;,</span><br><span class="line">	.date			&#x3D; &quot;20180514&quot;,</span><br><span class="line">	.major			&#x3D; 1,</span><br><span class="line">	.minor			&#x3D; 0,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int __init vkms_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	drm_dev_init(&amp;drm, &amp;vkms_driver, NULL);</span><br><span class="line"></span><br><span class="line">	vkms_modeset_init();</span><br><span class="line"></span><br><span class="line">	drm_vblank_init(&amp;drm, 1);</span><br><span class="line"></span><br><span class="line">	drm.irq_enabled &#x3D; true;</span><br><span class="line"></span><br><span class="line">	drm_dev_register(&amp;drm, 0);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vkms_init);</span><br></pre></td></tr></table></figure>

<h4 id="驱动分析1："><a href="#驱动分析1：" class="headerlink" title="驱动分析1："></a>驱动分析1：</h4><p>atomic_duplicate_state：创建一个新的原子状态，并将原子状态中的所有对象（包括CRTC、connector、encoder等等）进行复制。</p>
<p>atomic_destroy_state：释放原子状态占用的所有资源，包括CRTC、connector、encoder等等。具体来说，该函数会遍历原子状态对象中的所有对象，并依次释放它们占用的资源。另外，该函数还会释放原子状态对象本身。</p>
<h4 id="驱动分析2："><a href="#驱动分析2：" class="headerlink" title="驱动分析2："></a>驱动分析2：</h4><p>drm_mode_config_funcs.atomic_commit() 接口是 atomic 操作的主要入口函数，必须实现。这里直接使用 drm_atomic_helper_commit() 函数实现。</p>
<blockquote>
<p>drm_atomic_helper_commit() 函数的作用是帮助应用程序提交一组关联的对象的更新请求，并保证它们以原子方式生效，从而保证图形显示的稳定性和一致性。</p>
<p>在DRM中，图形显示涉及多个对象，包括CRTC（控制器）、encoder（编码器）和connector（连接器）等。这些对象之间存在复杂的依赖关系，更新请求必须以原子方式提交，以确保它们同时生效，从而避免出现不一致的图形显示。</p>
</blockquote>
<h4 id="驱动分析3："><a href="#驱动分析3：" class="headerlink" title="驱动分析3："></a>驱动分析3：</h4><p>在 plane&#x2F;crtc&#x2F;encoder&#x2F;connector objects 初始化完成之后，一定要调用 drm_mode_config_reset() 来动态创建各个 pipeline 的软件状态（即 drm_xxx_state）。</p>
<h4 id="驱动分析4："><a href="#驱动分析4：" class="headerlink" title="驱动分析4："></a>驱动分析4：</h4><p>与 Legacy 相比，Atomic 的 xxx_funcs 必须 实现如下接口：</p>
<blockquote>
<p>reset()</p>
<p>atomic_duplicate_state()</p>
<p>atomic_destroy_state()</p>
</blockquote>
<p>它们主要用于维护 drm_xxx_state 数据结构，不能省略！</p>
<h4 id="驱动分析5："><a href="#驱动分析5：" class="headerlink" title="驱动分析5："></a>驱动分析5：</h4><p>drm_plane_helper_funcs.atomic_update() 必须实现！（不太理解）</p>
<blockquote>
<p>这个函数用于在DRM原子模式下更新plane对象的状态。如果一个plane对象没有实现.atomic_update函数，那么在使用DRM原子模式时，就无法正确地更新该plane对象的状态，从而导致显示异常或者错误。</p>
</blockquote>
<h4 id="驱动分析6："><a href="#驱动分析6：" class="headerlink" title="驱动分析6："></a>驱动分析6：</h4><p>Atomic 操作依赖 VSYNC 中断（即 VBLANK 事件），因此需要使用 hrtimer 来提供软件中断信号。在驱动初始化时调用 drm_vblank_init()，在 VSYNC 中断处理函数中调用 drm_handle_vblank()。</p>
<hr>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p>要实现一个 DRM KMS 驱动，通常需要实现如下代码：</p>
<blockquote>
<p><strong>fops、drm_driver</strong></p>
<p><strong>dumb_create、fb_create、atomic_commit</strong></p>
<p><strong>drm_xxx_funcs、drm_xxx_helper_funcs</strong></p>
<p><strong>drm_xxx_init()、drm_xxx_helper_add()</strong></p>
<p><strong>drm_dev_init()、drm_dev_register()</strong></p>
</blockquote>
<p>但这都只是表象，核心仍然是上面介绍的7个 objects，一切都围绕着这几个 objects 展开：</p>
<blockquote>
<ul>
<li><strong>为了创建 crtc&#x2F;plane&#x2F;encoder&#x2F;connector objects，需要调用 drm_xxx_init()。</strong></li>
<li><strong>为了创建 framebuffer object，需要实现 fb_create() callback。</strong></li>
<li><strong>为了创建 gem object，需要实现 dumb_create() callback。</strong></li>
<li><strong>为了创建 property objects，需要调用 drm_mode_config_init()。</strong></li>
<li><strong>为了让这些 objects 动起来，需要实现各种 funcs 和 helper funcs。</strong></li>
<li><strong>为了支持 atomic 操作，需要实现 atomic_commit() callback。</strong></li>
</ul>
</blockquote>
<hr>
<h2 id="六、panel-simple-c文件分析"><a href="#六、panel-simple-c文件分析" class="headerlink" title="六、panel-simple.c文件分析"></a>六、panel-simple.c文件分析</h2><p>panel_simple.c只是DRM驱动中用于与RGB屏幕交互的一种手段(相当于connector），它仅适用于简单的设备和场景。</p>
<p>在panel_simple.c中的DRM驱动生成的&#x2F;dev&#x2F;dri&#x2F;card0设备节点同时也会自动生成一个&#x2F;dev&#x2F;fb0设备节点，用于向后兼容传统的Framebuffer接口。</p>
<p>但需要注意的是，这个Framebuffer接口只能使用一些基本的功能，如显存映射和控制台输出等，而不能使用DRM提供的高级功能。</p>
<p>对于全志的DRM架构如下图所示：</p>
<img src="/posts/undefined/c7ea09e82764a0dd07de808cd039984e.png" class="" title="img">

<img src="/posts/undefined/6d6729868043b38e629bc50cb7930884.png" class="" title="img">

<hr>
<h2 id="七、参考内容"><a href="#七、参考内容" class="headerlink" title="七、参考内容"></a>七、参考内容</h2><p>1.<a target="_blank" rel="noopener" href="https://doc.embedfire.com/linux/stm32mp1/driver/zh/latest/linux_driver/framework_drm.html">DRM图形显示框架</a></p>
<p>2.<a target="_blank" rel="noopener" href="https://blog.csdn.net/hexiaolong2009/article/details/83720940">DRM（Direct Rendering Manager）学习简介_何小龙csdn_何小龙的博客-CSDN博客</a> </p>
<p>3.<a target="_blank" rel="noopener" href="https://www.codetd.com/article/14487936">DRM (Direct Rendering Manager) 的基本概念 - 代码天地</a></p>
<p>4.<a target="_blank" rel="noopener" href="https://blog.csdn.net/zichuanning520/article/details/127254426">DRM几个重要的结构体及panel开发_drm panel_紫川宁520的博客-CSDN博客</a></p>
<p>5.<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2021477">《DRM 专栏》| 彻底入门 DRM 驱动 - 腾讯云开发者社区-腾讯云</a></p>
<p>6.<a target="_blank" rel="noopener" href="https://crab2313.github.io/post/drm-legacy-kms/#%E5%AF%B9%E8%B1%A1%E7%AE%A1%E7%90%86">DRM框架分析（二）：KMS</a></p>
<p>7.<a target="_blank" rel="noopener" href="https://blog.csdn.net/hexiaolong2009/article/details/106532966">DRM GEM 驱动程序开发（dumb）_何小龙的博客-CSDN博客</a></p>
<h1 id="参考内容"><a href="#参考内容" class="headerlink" title="参考内容"></a>参考内容</h1><ol>
<li><p>墨云<a target="_blank" rel="noopener" href="https://www.cnblogs.com/twzy/p/14865952.html">uboot移植</a>；</p>
</li>
<li><p>稚辉君<a target="_blank" rel="noopener" href="https://github.com/peng-zhihui/Planck-Pi">github</a>项目；</p>
</li>
<li><p>正点原子《嵌入式Linux驱动开发指南》</p>
</li>
</ol>
<hr>
<h1 id="相关链接（侵删）"><a href="#相关链接（侵删）" class="headerlink" title="相关链接（侵删）"></a>相关链接（侵删）</h1><ol>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/130497208">F1C200s 的 GPIO 编号规则</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/124389957">硬件制作–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/128519540">uboot移植–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/128544843">内核移植–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/128553772">根文件系统–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/128570505">Debian系统–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/128586204">正点原子4.3寸RGB屏幕驱动–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/128661071">GT1151触摸屏驱动–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/128684988">USB驱动–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/128694780">音频驱动–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/128721720">WiFi驱动–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/128758130">NES游戏移植–从零开始自制linux掌上电脑（F1C200S)</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/130235461">【项目原理】多点触摸屏驱动原理</a></li>
<li><a target="_blank" rel="noopener" href="https://download.csdn.net/blog/column/12158774/129472180">项目原理】DRM驱动概念、组成、框架、源码分析</a></li>
</ol>
<hr>
<center><font color=red>=================我是分割线=================</font></center>


<p><strong>欢迎到公众号来唠嗑:</strong></p>
<img src="https://pic4.zhimg.com/80/v2-eedc5dc7d30beedf4c2f1812df8e61a7_720w.jpg">

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://zml3589110.github.io">ZhaoYichen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zml3589110.github.io/posts/2887556754.html">https://zml3589110.github.io/posts/2887556754.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zml3589110.github.io" target="_blank">赵逸尘个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%85%A8%E5%BF%97/">全志</a><a class="post-meta__tags" href="/tags/F1C200S/">F1C200S</a><a class="post-meta__tags" href="/tags/%E5%BC%80%E5%8F%91%E6%9D%BF/">开发板</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/BOOTROM/">BOOTROM</a><a class="post-meta__tags" href="/tags/SPL/">SPL</a><a class="post-meta__tags" href="/tags/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">启动流程</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/posts/740584845.html"><img class="prev-cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">F1C200S在Linux下环境搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/1056682153.html" title="F1C100S-BOOTROM与SPL阶段"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-15</div><div class="title">F1C100S-BOOTROM与SPL阶段</div></div></a></div><div><a href="/posts/3233973243.html" title="全志F1C200S F1C100S 介绍"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-15</div><div class="title">全志F1C200S F1C100S 介绍</div></div></a></div><div><a href="/posts/3905997731.html" title="全志f1c200s开发板设计"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-05</div><div class="title">全志f1c200s开发板设计</div></div></a></div><div><a href="/posts/2357015472.html" title="学习笔记F1C100S之u-boot编译过程记录"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-05</div><div class="title">学习笔记F1C100S之u-boot编译过程记录</div></div></a></div><div><a href="/posts/0.html" title=""><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-05</div><div class="title"></div></div></a></div><div><a href="/posts/3433483963.html" title="小白自制Linux开发板"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-05</div><div class="title">小白自制Linux开发板</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ZhaoYichen</div><div class="author-info__description">直到这一刻微笑着说话为止，我至少留下了一公升眼泪</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">378</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">540</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">219</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zml3589110"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zml3589110" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:zhaominglong_life@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#GPIO-%E7%BC%96%E5%8F%B7%E8%A7%84%E5%88%99"><span class="toc-number">1.</span> <span class="toc-text">GPIO 编号规则</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E5%88%B6%E4%BD%9C"><span class="toc-number">2.</span> <span class="toc-text">硬件制作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83%E5%8F%8A%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">一、工作环境及项目简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%8E%9F%E7%90%86%E5%9B%BE%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.2.</span> <span class="toc-text">二、原理图设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A0%B8%E5%BF%83%E6%9D%BF"><span class="toc-number">2.2.1.</span> <span class="toc-text">1、核心板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8E-%E7%94%B5%E6%BA%90%E7%94%B5%E8%B7%AF"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">🍎 电源电路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8E-%E6%9D%BF%E5%AF%B9%E6%9D%BF%E8%BF%9E%E6%8E%A5%E5%99%A8"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">🍎 板对板连接器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8E-%E5%A4%8D%E4%BD%8D%E7%94%B5%E8%B7%AF"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">🍎 复位电路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8E-%E6%99%B6%E6%8C%AF%E7%94%B5%E8%B7%AF"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">🍎 晶振电路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8E-%E4%B8%BB%E6%8E%A7%E7%94%B5%E8%B7%AF"><span class="toc-number">2.2.1.5.</span> <span class="toc-text">🍎 主控电路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%BA%95%E6%9D%BF"><span class="toc-number">2.2.2.</span> <span class="toc-text">2、底板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8D-%E4%B8%B2%E5%8F%A3%E8%BD%ACUSB%E7%94%B5%E8%B7%AF"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">🍍 串口转USB电路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8D-TF%E5%8D%A1%E7%94%B5%E8%B7%AF"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">🍍 TF卡电路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8D-WIFI%E7%94%B5%E8%B7%AF"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">🍍 WIFI电路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8D-TFT%E5%B1%8F%E5%B9%95"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">🍍 TFT屏幕</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8D-%E9%9F%B3%E9%A2%91"><span class="toc-number">2.2.2.5.</span> <span class="toc-text">🍍 音频</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8D-%E6%9D%BF%E5%AF%B9%E6%9D%BF%E8%BF%9E%E6%8E%A5%E5%99%A8"><span class="toc-number">2.2.2.6.</span> <span class="toc-text">🍍 板对板连接器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8D-40Pin4-3%E5%AF%B8%E5%B1%8F%E5%B9%95"><span class="toc-number">2.2.2.7.</span> <span class="toc-text">🍍 40Pin4.3寸屏幕</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81PCB%E5%B1%95%E7%A4%BA"><span class="toc-number">2.3.</span> <span class="toc-text">三、PCB展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9E%E7%89%A9%E5%B1%95%E7%A4%BA"><span class="toc-number">2.4.</span> <span class="toc-text">四、实物展示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#uboot%E7%A7%BB%E6%A4%8D"><span class="toc-number">3.</span> <span class="toc-text">uboot移植</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="toc-number">3.1.</span> <span class="toc-text">一、前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81F1C200s%E4%B8%8A%E7%94%B5%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F"><span class="toc-number">3.2.</span> <span class="toc-text">二、F1C200s上电启动顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-number">3.3.</span> <span class="toc-text">三、前期准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%96%B0%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="toc-number">3.4.</span> <span class="toc-text">四、新建用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">3.5.</span> <span class="toc-text">五、交叉编译环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81uboot%E7%AE%80%E4%BB%8B"><span class="toc-number">3.6.</span> <span class="toc-text">六、uboot简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81uboot%E7%A7%BB%E6%A4%8D"><span class="toc-number">3.7.</span> <span class="toc-text">七、uboot移植</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8F-uboot%E4%B8%8B%E8%BD%BD"><span class="toc-number">3.7.0.1.</span> <span class="toc-text">🍏 uboot下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8F-uboot%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">3.7.0.2.</span> <span class="toc-text">🍏 uboot默认配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8F-uboot%E5%9B%BE%E5%BD%A2%E7%95%8C%E9%9D%A2%E9%85%8D%E7%BD%AE"><span class="toc-number">3.7.0.3.</span> <span class="toc-text">🍏 uboot图形界面配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8F-uboot%E7%BC%96%E8%AF%91"><span class="toc-number">3.7.0.4.</span> <span class="toc-text">🍏 uboot编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8F-%E7%83%A7%E5%BD%95bin%E6%96%87%E4%BB%B6"><span class="toc-number">3.7.0.5.</span> <span class="toc-text">🍏 烧录bin文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81uboot%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">3.8.</span> <span class="toc-text">八、uboot启动测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E7%A7%BB%E6%A4%8D"><span class="toc-number">4.</span> <span class="toc-text">内核移植</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81bootloader%E3%80%81kernel%E3%80%81rootfs%E8%81%94%E7%B3%BB"><span class="toc-number">4.1.</span> <span class="toc-text">一、bootloader、kernel、rootfs联系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%86%85%E6%A0%B8%E7%A7%BB%E6%A4%8D"><span class="toc-number">4.2.</span> <span class="toc-text">二、内核移植</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%8E%B7%E5%8F%96"><span class="toc-number">4.2.1.</span> <span class="toc-text">1. 内核源码获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE%E4%B8%8E%E7%BC%96%E8%AF%91"><span class="toc-number">4.2.2.</span> <span class="toc-text">2. 内核配置与编译</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8D-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E4%B8%8E%E7%BC%96%E8%AF%91"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">🍍 基础配置与编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8D-TF%E5%8D%A1%E5%88%86%E5%8C%BA"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">🍍 TF卡分区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%8D-%E5%86%85%E6%A0%B8%E7%83%A7%E5%BD%95"><span class="toc-number">4.2.2.3.</span> <span class="toc-text">🍍 内核烧录</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">5.</span> <span class="toc-text">根文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">一、根文件系统介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D"><span class="toc-number">5.2.</span> <span class="toc-text">二、根文件系统移植</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81buildroot%E4%B8%8B%E8%BD%BD"><span class="toc-number">5.2.1.</span> <span class="toc-text">1、buildroot下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%B6%E4%BD%9C"><span class="toc-number">5.2.2.</span> <span class="toc-text">2、根文件系统制作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D"><span class="toc-number">5.2.3.</span> <span class="toc-text">3、根文件系统移植</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8A%A0%E8%BD%BD"><span class="toc-number">5.2.4.</span> <span class="toc-text">4、根文件系统加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81mmc%E8%AE%BE%E5%A4%87%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">5.2.5.</span> <span class="toc-text">5、mmc设备问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81mmc%E5%8A%9F%E8%83%BD%E5%BC%80%E5%90%AF"><span class="toc-number">5.2.6.</span> <span class="toc-text">6、mmc功能开启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E8%AE%BE%E5%A4%87%E6%A0%91%E7%BC%96%E8%AF%91%E4%B8%8E%E4%B8%8B%E8%BD%BD"><span class="toc-number">5.2.7.</span> <span class="toc-text">7、设备树编译与下载</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Debian%E7%B3%BB%E7%BB%9F"><span class="toc-number">6.</span> <span class="toc-text">Debian系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Debian%E7%B3%BB%E7%BB%9F%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.1.</span> <span class="toc-text">一、Debian系统介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Linux%E5%8F%91%E8%A1%8C%E7%89%88%E5%92%8CLinux%E5%86%85%E6%A0%B8%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">6.2.</span> <span class="toc-text">二、Linux发行版和Linux内核的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Debian%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%B6%E4%BD%9C"><span class="toc-number">6.3.</span> <span class="toc-text">三、Debian文件系统制作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.1.</span> <span class="toc-text">1、环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Debian%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA"><span class="toc-number">6.3.2.</span> <span class="toc-text">2、Debian文件系统构建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%9F-%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5"><span class="toc-number">6.3.2.1.</span> <span class="toc-text">🍟 第一阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8D%9F-%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5"><span class="toc-number">6.3.2.2.</span> <span class="toc-text">🍟 第二阶段</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Debian%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.</span> <span class="toc-text">三、Debian文件系统配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%9B%B4%E6%96%B0%E6%BA%90"><span class="toc-number">6.4.0.1.</span> <span class="toc-text">*1、更新源*</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E5%BA%93"><span class="toc-number">6.4.0.2.</span> <span class="toc-text">*2、安装网络相关库*</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E9%85%8D%E7%BD%AE%E8%B4%A6%E5%8F%B7"><span class="toc-number">6.4.0.3.</span> <span class="toc-text">*3、配置账号*</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E9%85%8D%E7%BD%AE%E6%97%B6%E5%8C%BA"><span class="toc-number">6.4.0.4.</span> <span class="toc-text">*4、配置时区*</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E9%85%8D%E7%BD%AESSH"><span class="toc-number">6.4.0.5.</span> <span class="toc-text">*5、配置SSH*</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81rootfs%E6%89%93%E5%8C%85"><span class="toc-number">6.4.0.6.</span> <span class="toc-text">*6、rootfs打包*</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81Debian%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8"><span class="toc-number">6.4.0.7.</span> <span class="toc-text">*7、Debian文件系统启动*</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%A2%9E%E5%8A%A0swap%E5%88%86%E5%8C%BA"><span class="toc-number">6.5.</span> <span class="toc-text">四、增加swap分区</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%AD%A3%E7%82%B9%E5%8E%9F%E5%AD%904-3%E5%AF%B8RGB%E5%B1%8F%E5%B9%95%E9%A9%B1%E5%8A%A8"><span class="toc-number">7.</span> <span class="toc-text">正点原子4.3寸RGB屏幕驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81RGB%E5%B1%8F%E5%B9%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.1.</span> <span class="toc-text">一、RGB屏幕介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81RGB%E5%B1%8F%E5%B9%95%E9%A9%B1%E5%8A%A8"><span class="toc-number">7.2.</span> <span class="toc-text">二、RGB屏幕驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E8%AE%BE%E5%A4%87%E6%A0%91%E4%BF%AE%E6%94%B9"><span class="toc-number">7.2.1.</span> <span class="toc-text">1、设备树修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%B1%8F%E5%B9%95%E4%BF%A1%E6%81%AF%E6%B7%BB%E5%8A%A0"><span class="toc-number">7.2.2.</span> <span class="toc-text">2、屏幕信息添加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E4%BF%AE%E6%94%B9"><span class="toc-number">7.2.3.</span> <span class="toc-text">3、内核驱动修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%BC%80%E6%9C%BAlogo%E6%98%BE%E7%A4%BA"><span class="toc-number">7.2.4.</span> <span class="toc-text">4、开机logo显示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81RGB%E5%B1%8F%E5%B9%95%E6%98%BE%E7%A4%BA%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">7.3.</span> <span class="toc-text">三、RGB屏幕显示功能测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%B1%8F%E5%B9%95%E8%83%8C%E5%85%89%E8%B0%83%E8%8A%82%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">7.4.</span> <span class="toc-text">四、屏幕背光调节功能测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E4%B8%BB%E8%A6%81%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9"><span class="toc-number">7.5.</span> <span class="toc-text">五、主要参考内容</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GT1151%E8%A7%A6%E6%91%B8%E5%B1%8F%E9%A9%B1%E5%8A%A8"><span class="toc-number">8.</span> <span class="toc-text">GT1151触摸屏驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81AT4384-RGB%E5%B1%8F%E5%B9%95%E8%A7%A6%E6%91%B8%E8%8A%AF%E7%89%87"><span class="toc-number">8.1.</span> <span class="toc-text">一、AT4384 RGB屏幕触摸芯片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%AE%BE%E5%A4%87%E6%A0%91%E4%BF%AE%E6%94%B9"><span class="toc-number">8.2.</span> <span class="toc-text">二、设备树修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81-dtsi%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9"><span class="toc-number">8.2.1.</span> <span class="toc-text">1、.dtsi文件修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81-dts%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9"><span class="toc-number">8.2.2.</span> <span class="toc-text">2、.dts文件修改</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%A9%B1%E5%8A%A8%E7%BC%96%E5%86%99"><span class="toc-number">8.3.</span> <span class="toc-text">三、驱动编写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90"><span class="toc-number">8.3.1.</span> <span class="toc-text">1、驱动分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E9%A9%B1%E5%8A%A8%E4%BB%A3%E7%A0%81"><span class="toc-number">8.3.2.</span> <span class="toc-text">2、驱动代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE"><span class="toc-number">8.4.</span> <span class="toc-text">四、内核配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81IIC%E8%AE%BE%E5%A4%87%E4%BD%BF%E8%83%BD"><span class="toc-number">8.4.1.</span> <span class="toc-text">1、IIC设备使能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E6%B7%BB%E5%8A%A0"><span class="toc-number">8.4.2.</span> <span class="toc-text">2、内核驱动添加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81gt1151%E9%A9%B1%E5%8A%A8%E4%BD%BF%E8%83%BD"><span class="toc-number">8.4.3.</span> <span class="toc-text">3、gt1151驱动使能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E8%A7%A6%E6%91%B8%E6%B5%8B%E8%AF%95"><span class="toc-number">8.5.</span> <span class="toc-text">五、触摸测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%90%AF%E5%8A%A8%E4%B8%8E%E6%96%87%E4%BB%B6%E6%A3%80%E6%9F%A5"><span class="toc-number">8.5.1.</span> <span class="toc-text">1、启动与文件检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%A7%A6%E6%91%B8%E6%B5%8B%E8%AF%95"><span class="toc-number">8.5.2.</span> <span class="toc-text">2、触摸测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%B8%BB%E8%A6%81%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9"><span class="toc-number">8.6.</span> <span class="toc-text">六、主要参考内容</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#USB%E9%A9%B1%E5%8A%A8"><span class="toc-number">9.</span> <span class="toc-text">USB驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80-1"><span class="toc-number">9.1.</span> <span class="toc-text">一、前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81USB-host%E5%92%8CUSB-device%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">9.1.1.</span> <span class="toc-text">1、USB host和USB device的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%A1%AC%E4%BB%B6%E8%A7%A3%E6%9E%90"><span class="toc-number">9.1.2.</span> <span class="toc-text">2、硬件解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%AE%BE%E5%A4%87%E6%A0%91%E4%BF%AE%E6%94%B9-1"><span class="toc-number">9.2.</span> <span class="toc-text">二、设备树修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81-dtsi%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9-1"><span class="toc-number">9.2.1.</span> <span class="toc-text">1、.dtsi文件修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81-dts%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9-1"><span class="toc-number">9.2.2.</span> <span class="toc-text">2、.dts文件修改</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%A9%B1%E5%8A%A8%E4%BF%AE%E6%94%B9"><span class="toc-number">9.3.</span> <span class="toc-text">三、驱动修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81phy-sun4i-usb-c%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9"><span class="toc-number">9.3.1.</span> <span class="toc-text">1、phy-sun4i-usb.c文件修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81sunxi-c%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9"><span class="toc-number">9.3.2.</span> <span class="toc-text">2、sunxi.c文件修改</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%A9%B1%E5%8A%A8%E4%BD%BF%E8%83%BD"><span class="toc-number">9.4.</span> <span class="toc-text">四、驱动使能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81U%E7%9B%98%E8%AF%BB%E5%8F%96%E6%B5%8B%E8%AF%95"><span class="toc-number">9.5.</span> <span class="toc-text">五、U盘读取测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%B8%BB%E8%A6%81%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9-1"><span class="toc-number">9.6.</span> <span class="toc-text">六、主要参考内容</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9F%B3%E9%A2%91%E9%A9%B1%E5%8A%A8"><span class="toc-number">10.</span> <span class="toc-text">音频驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80-2"><span class="toc-number">10.1.</span> <span class="toc-text">一、前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E9%A9%B1%E5%8A%A8%E4%BF%AE%E6%94%B9"><span class="toc-number">10.2.</span> <span class="toc-text">二、驱动修改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E8%AE%BE%E5%A4%87%E6%A0%91%E4%BF%AE%E6%94%B9"><span class="toc-number">10.3.</span> <span class="toc-text">三、设备树修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81-dtsi%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9-2"><span class="toc-number">10.3.1.</span> <span class="toc-text">1、.dtsi文件修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81-dts%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9-2"><span class="toc-number">10.3.2.</span> <span class="toc-text">2、.dts文件修改</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%A9%B1%E5%8A%A8%E4%BD%BF%E8%83%BD-1"><span class="toc-number">10.4.</span> <span class="toc-text">四、驱动使能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">10.5.</span> <span class="toc-text">五、启动测试与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%90%AF%E5%8A%A8%E4%B8%8E%E6%A3%80%E6%9F%A5"><span class="toc-number">10.5.1.</span> <span class="toc-text">1、启动与检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E9%BB%98%E8%AE%A4%E5%A3%B0%E5%8D%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">10.5.2.</span> <span class="toc-text">2、默认声卡配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E9%9F%B3%E9%A2%91%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E6%B5%8B%E8%AF%95"><span class="toc-number">10.6.</span> <span class="toc-text">六、音频视频播放测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81mplayer%E4%B8%8Ealsa-utils%E5%AE%89%E8%A3%85"><span class="toc-number">10.6.1.</span> <span class="toc-text">1、mplayer与alsa-utils安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE%E6%B5%8B%E8%AF%95"><span class="toc-number">10.6.2.</span> <span class="toc-text">2、音频播放测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E6%B5%8B%E8%AF%95"><span class="toc-number">10.6.3.</span> <span class="toc-text">3、视频播放测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E9%9F%B3%E9%A2%91%E8%BE%93%E5%85%A5%E6%B5%8B%E8%AF%95"><span class="toc-number">10.7.</span> <span class="toc-text">七、音频输入测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E4%B8%BB%E8%A6%81%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9"><span class="toc-number">10.8.</span> <span class="toc-text">八、主要参考内容</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WiFi%E9%A9%B1%E5%8A%A8"><span class="toc-number">11.</span> <span class="toc-text">WiFi驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81ESP-12F%E4%BD%9C%E6%97%A0%E7%BA%BF%E7%BD%91%E5%8D%A1"><span class="toc-number">11.1.</span> <span class="toc-text">一、ESP-12F作无线网卡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A8%A1%E5%9D%97%E5%8C%96WiFi%E9%A9%B1%E5%8A%A8"><span class="toc-number">11.2.</span> <span class="toc-text">二、模块化WiFi驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%97%A0%E7%BA%BF%E9%A9%B1%E5%8A%A8%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="toc-number">11.2.1.</span> <span class="toc-text">1、无线驱动源码下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%97%A0%E7%BA%BF%E9%A9%B1%E5%8A%A8%E6%BA%90%E7%A0%81%E9%80%82%E9%85%8D"><span class="toc-number">11.2.2.</span> <span class="toc-text">2、无线驱动源码适配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%AE%BE%E5%A4%87%E6%A0%91%E4%BF%AE%E6%94%B9"><span class="toc-number">11.2.3.</span> <span class="toc-text">3、设备树修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%A8%A1%E5%9D%97%E9%A9%B1%E5%8A%A8%E5%8A%A0%E8%BD%BD"><span class="toc-number">11.2.4.</span> <span class="toc-text">4、模块驱动加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8C-%E6%A8%A1%E5%9D%97%E9%A9%B1%E5%8A%A8%E5%8A%A0%E8%BD%BD%E5%91%BD%E4%BB%A4"><span class="toc-number">11.2.4.1.</span> <span class="toc-text">📌 模块驱动加载命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8C-%E9%A9%B1%E5%8A%A8%E5%8A%A0%E8%BD%BD%E3%80%81%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E3%80%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-number">11.2.4.2.</span> <span class="toc-text">📌 驱动加载、遇到的问题、解决方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%93%8C-%E9%A9%B1%E5%8A%A8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-number">11.2.4.3.</span> <span class="toc-text">📌 驱动问题解决</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%90%AF%E5%8A%A8%E7%BD%91%E5%8D%A1"><span class="toc-number">11.2.5.</span> <span class="toc-text">5、启动网卡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E8%BF%9E%E6%8E%A5%E4%BA%92%E8%81%94%E7%BD%91"><span class="toc-number">11.2.6.</span> <span class="toc-text">6、连接互联网</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81apt-get%E5%91%BD%E4%BB%A4%E6%B5%8B%E8%AF%95"><span class="toc-number">11.2.7.</span> <span class="toc-text">7、apt-get命令测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93"><span class="toc-number">11.2.8.</span> <span class="toc-text">8、文件传输</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%86%85%E6%A0%B8WiFi%E9%A9%B1%E5%8A%A8"><span class="toc-number">11.3.</span> <span class="toc-text">三、内核WiFi驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="toc-number">11.3.1.</span> <span class="toc-text">1、内核驱动代码下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%AE%BE%E5%A4%87%E6%A0%91%E4%BF%AE%E6%94%B9"><span class="toc-number">11.3.2.</span> <span class="toc-text">2、设备树修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%86%85%E6%A0%B8%E6%97%A0%E7%BA%BF%E9%A9%B1%E5%8A%A8%E6%BA%90%E7%A0%81%E4%BF%AE%E6%94%B9"><span class="toc-number">11.3.3.</span> <span class="toc-text">3、内核无线驱动源码修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%97%A0%E7%BA%BF%E7%BD%91%E5%8D%A1%E6%B5%8B%E8%AF%95"><span class="toc-number">11.3.4.</span> <span class="toc-text">4、无线网卡测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9"><span class="toc-number">11.4.</span> <span class="toc-text">四、参考内容</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NES%E6%B8%B8%E6%88%8F%E7%A7%BB%E6%A4%8D"><span class="toc-number">12.</span> <span class="toc-text">NES游戏移植</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80-3"><span class="toc-number">12.1.</span> <span class="toc-text">一、前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">12.1.1.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">12.1.2.</span> <span class="toc-text">二、环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81GCC%E3%80%81G-%E7%BC%96%E8%AF%91%E5%99%A8%E5%AE%89%E8%A3%85"><span class="toc-number">12.1.3.</span> <span class="toc-text">1、GCC、G++编译器安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E9%9F%B3%E9%A2%91%E7%BB%84%E4%BB%B6alsa-utils%E5%AE%89%E8%A3%85"><span class="toc-number">12.1.4.</span> <span class="toc-text">2、音频组件alsa-utils安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%85%B6%E4%BB%96%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">12.2.</span> <span class="toc-text">3、其他组件安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81NES%E6%A8%A1%E6%8B%9F%E5%99%A8%E7%BC%96%E8%AF%91"><span class="toc-number">12.3.</span> <span class="toc-text">三、NES模拟器编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-1"><span class="toc-number">12.4.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9-1"><span class="toc-number">12.5.</span> <span class="toc-text">四、参考内容</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%80%90%E9%A1%B9%E7%9B%AE%E5%8E%9F%E7%90%86%E3%80%91%E5%A4%9A%E7%82%B9%E8%A7%A6%E6%91%B8%E5%B1%8F%E9%A9%B1%E5%8A%A8%E5%8E%9F%E7%90%86"><span class="toc-number">13.</span> <span class="toc-text">【项目原理】多点触摸屏驱动原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%B1%8F%E5%B9%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">13.1.</span> <span class="toc-text">一、屏幕介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-2"><span class="toc-number">13.2.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%A7%A6%E6%91%B8%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90"><span class="toc-number">13.3.</span> <span class="toc-text">二、触摸驱动分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90"><span class="toc-number">13.3.1.</span> <span class="toc-text">1、驱动框架分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%A4%9A%E7%82%B9%E8%A7%A6%E6%91%B8-MT-%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">13.3.2.</span> <span class="toc-text">2、多点触摸(MT)协议详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%8D-TypeA"><span class="toc-number">13.3.2.1.</span> <span class="toc-text">🎍 TypeA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%8D-TypeB"><span class="toc-number">13.3.2.2.</span> <span class="toc-text">🎍 TypeB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%8D-MT%E8%A7%A6%E6%91%B8%E5%8D%8F%E8%AE%AEA%E3%80%81B%E6%80%BB%E7%BB%93"><span class="toc-number">13.3.2.3.</span> <span class="toc-text">🎍 MT触摸协议A、B总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%8D-%E7%96%91%E9%97%AE%E5%8F%8A%E8%A7%A3%E7%AD%94"><span class="toc-number">13.3.2.4.</span> <span class="toc-text">🎍 疑问及解答</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%A4%9A%E7%82%B9%E8%A7%A6%E6%91%B8API%E5%87%BD%E6%95%B0"><span class="toc-number">13.4.</span> <span class="toc-text">三、多点触摸API函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81input-mt-init-slots-%E5%87%BD%E6%95%B0"><span class="toc-number">13.4.0.1.</span> <span class="toc-text">1、input_mt_init_slots 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81input-mt-slot-%E5%87%BD%E6%95%B0"><span class="toc-number">13.4.0.2.</span> <span class="toc-text">2、input_mt_slot 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81input-mt-report-slot-state-%E5%87%BD%E6%95%B0"><span class="toc-number">13.4.0.3.</span> <span class="toc-text">3、input_mt_report_slot_state 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81input-report-abs-%E5%87%BD%E6%95%B0"><span class="toc-number">13.4.0.4.</span> <span class="toc-text">4、input_report_abs 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81input-mt-report-pointer-emulation-%E5%87%BD%E6%95%B0"><span class="toc-number">13.4.0.5.</span> <span class="toc-text">5、input_mt_report_pointer_emulation 函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%A4%9A%E7%82%B9%E7%94%B5%E5%AE%B9%E8%A7%A6%E6%91%B8%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90"><span class="toc-number">13.5.</span> <span class="toc-text">四、多点电容触摸驱动框架分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc-number">13.5.1.</span> <span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81I2C%E6%A1%86%E6%9E%B6"><span class="toc-number">13.5.2.</span> <span class="toc-text">2、I2C框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96%E8%A7%A6%E6%91%B8IC%E3%80%81%E4%B8%AD%E6%96%AD%E3%80%81input%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">13.5.3.</span> <span class="toc-text">2、初始化触摸IC、中断、input子系统初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E4%B8%8A%E6%8A%A5%E5%9D%90%E6%A0%87%E4%BF%A1%E6%81%AF"><span class="toc-number">13.5.4.</span> <span class="toc-text">3、上报坐标信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%8E%9F%E7%90%86%E3%80%91DRM%E9%A9%B1%E5%8A%A8%E6%A6%82%E5%BF%B5%E3%80%81%E7%BB%84%E6%88%90%E3%80%81%E6%A1%86%E6%9E%B6%E3%80%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">14.</span> <span class="toc-text">项目原理】DRM驱动概念、组成、框架、源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81DRM%E4%B8%8EFramebuffer"><span class="toc-number">14.1.</span> <span class="toc-text">一、DRM与Framebuffer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81DRM%E9%A9%B1%E5%8A%A8"><span class="toc-number">14.2.</span> <span class="toc-text">二、DRM驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-1"><span class="toc-number">14.2.1.</span> <span class="toc-text">1、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#libdrm%EF%BC%88DRM%E6%A1%86%E6%9E%B6%E5%9C%A8%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E7%9A%84Lib%EF%BC%89"><span class="toc-number">14.2.1.1.</span> <span class="toc-text">libdrm（DRM框架在用户空间的Lib）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#KMS%EF%BC%88%E5%86%85%E6%A0%B8%E6%98%BE%E7%A4%BA%E6%A8%A1%E5%BC%8F%E8%AE%BE%E7%BD%AE%EF%BC%89"><span class="toc-number">14.2.1.2.</span> <span class="toc-text">KMS（内核显示模式设置）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GMS%EF%BC%88%E5%9B%BE%E5%BD%A2%E6%89%A7%E8%A1%8C%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%89"><span class="toc-number">14.2.1.3.</span> <span class="toc-text">GMS（图形执行管理器）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-3"><span class="toc-number">14.2.2.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81DRM%E5%86%85%E9%83%A8Objects"><span class="toc-number">14.2.3.</span> <span class="toc-text">2、DRM内部Objects</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81drm-panel"><span class="toc-number">14.2.4.</span> <span class="toc-text">3、drm_panel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81DRM-%E9%A9%B1%E5%8A%A8%E5%B8%B8%E7%94%A8%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">14.3.</span> <span class="toc-text">三、DRM 驱动常用结构体</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8D%9A-drm-mode-object"><span class="toc-number">14.3.1.</span> <span class="toc-text">🍚 *drm_mode_object*</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8D%9A-Framebuffer"><span class="toc-number">14.3.2.</span> <span class="toc-text">🍚 Framebuffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8D%9A-Plane"><span class="toc-number">14.3.3.</span> <span class="toc-text">🍚 Plane</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8D%9A-Crtc"><span class="toc-number">14.3.4.</span> <span class="toc-text">🍚 Crtc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8D%9A-Encoder"><span class="toc-number">14.3.5.</span> <span class="toc-text">🍚 Encoder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8D%9A-helper-%E5%87%BD%E6%95%B0%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">14.3.6.</span> <span class="toc-text">🍚 helper 函数与使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8D%9A-drm-xxx-funcs-%E5%92%8C-drm-xxx-helper-funcs-%E5%8C%BA%E5%88%AB"><span class="toc-number">14.3.7.</span> <span class="toc-text">🍚 drm_xxx_funcs 和 drm_xxx_helper_funcs 区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81DRM%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%EF%BC%88VKMS%EF%BC%89"><span class="toc-number">14.4.</span> <span class="toc-text">四、DRM驱动框架（VKMS）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81VKMS-%E7%AE%80%E4%BB%8B"><span class="toc-number">14.4.1.</span> <span class="toc-text">1、VKMS 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84VKMS%E9%A9%B1%E5%8A%A8"><span class="toc-number">14.4.2.</span> <span class="toc-text">2、最简单的VKMS驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81VKMS%E9%A9%B1%E5%8A%A8%E6%B7%BB%E5%8A%A0-fops-%E6%93%8D%E4%BD%9C%E6%8E%A5%E5%8F%A3"><span class="toc-number">14.4.3.</span> <span class="toc-text">3、VKMS驱动添加 fops 操作接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%B7%BB%E5%8A%A0-drm-mode-objects"><span class="toc-number">14.4.4.</span> <span class="toc-text">4、添加 drm mode objects</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%B7%BB%E5%8A%A0-FB-%E5%92%8C-GEM-%E6%94%AF%E6%8C%81"><span class="toc-number">14.4.5.</span> <span class="toc-text">5、添加 FB 和 GEM 支持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E8%A7%A3%E6%9E%901"><span class="toc-number">14.4.5.1.</span> <span class="toc-text">驱动解析1 :</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E8%A7%A3%E6%9E%902"><span class="toc-number">14.4.5.2.</span> <span class="toc-text">驱动解析2 :</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E8%A7%A3%E6%9E%903"><span class="toc-number">14.4.5.3.</span> <span class="toc-text">驱动解析3 :</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E8%A7%A3%E6%9E%904"><span class="toc-number">14.4.5.4.</span> <span class="toc-text">驱动解析4 :</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E8%A7%A3%E6%9E%905"><span class="toc-number">14.4.5.5.</span> <span class="toc-text">驱动解析5 :</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E5%AE%9E%E7%8E%B0-callback-funcs-%E5%B9%B6%E6%B7%BB%E5%8A%A0-Legacy-Modeset-%E6%94%AF%E6%8C%81"><span class="toc-number">14.4.6.</span> <span class="toc-text">6、实现 callback funcs 并添加 Legacy Modeset 支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E5%B0%86-Legacy-code-%E8%BD%AC%E6%8D%A2%E4%B8%BA-Atomic-%E7%89%88%E6%9C%AC"><span class="toc-number">14.4.7.</span> <span class="toc-text">7、将 Legacy code 转换为 Atomic 版本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%901%EF%BC%9A"><span class="toc-number">14.4.7.1.</span> <span class="toc-text">驱动分析1：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%902%EF%BC%9A"><span class="toc-number">14.4.7.2.</span> <span class="toc-text">驱动分析2：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%903%EF%BC%9A"><span class="toc-number">14.4.7.3.</span> <span class="toc-text">驱动分析3：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%904%EF%BC%9A"><span class="toc-number">14.4.7.4.</span> <span class="toc-text">驱动分析4：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%905%EF%BC%9A"><span class="toc-number">14.4.7.5.</span> <span class="toc-text">驱动分析5：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%906%EF%BC%9A"><span class="toc-number">14.4.7.6.</span> <span class="toc-text">驱动分析6：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">14.5.</span> <span class="toc-text">五、总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81panel-simple-c%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">14.6.</span> <span class="toc-text">六、panel-simple.c文件分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9"><span class="toc-number">14.7.</span> <span class="toc-text">七、参考内容</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9"><span class="toc-number">15.</span> <span class="toc-text">参考内容</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5%EF%BC%88%E4%BE%B5%E5%88%A0%EF%BC%89"><span class="toc-number">16.</span> <span class="toc-text">相关链接（侵删）</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/2887556754.html" title="从零开始自制linux掌上电脑（F1C200S)"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="从零开始自制linux掌上电脑（F1C200S)"/></a><div class="content"><a class="title" href="/posts/2887556754.html" title="从零开始自制linux掌上电脑（F1C200S)">从零开始自制linux掌上电脑（F1C200S)</a><time datetime="2025-09-18T03:49:20.000Z" title="发表于 2025-09-18 11:49:20">2025-09-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/740584845.html" title="F1C200S在Linux下环境搭建"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="F1C200S在Linux下环境搭建"/></a><div class="content"><a class="title" href="/posts/740584845.html" title="F1C200S在Linux下环境搭建">F1C200S在Linux下环境搭建</a><time datetime="2025-09-17T12:06:20.000Z" title="发表于 2025-09-17 20:06:20">2025-09-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3907184433.html" title="裸机开发环境搭建"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="裸机开发环境搭建"/></a><div class="content"><a class="title" href="/posts/3907184433.html" title="裸机开发环境搭建">裸机开发环境搭建</a><time datetime="2025-09-15T13:18:20.000Z" title="发表于 2025-09-15 21:18:20">2025-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3480903282.html" title="ESP8266无线下载器"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ESP8266无线下载器"/></a><div class="content"><a class="title" href="/posts/3480903282.html" title="ESP8266无线下载器">ESP8266无线下载器</a><time datetime="2025-09-15T13:10:20.000Z" title="发表于 2025-09-15 21:10:20">2025-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2510049814.html" title="读写SD卡"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="读写SD卡"/></a><div class="content"><a class="title" href="/posts/2510049814.html" title="读写SD卡">读写SD卡</a><time datetime="2025-09-15T13:08:20.000Z" title="发表于 2025-09-15 21:08:20">2025-09-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By ZhaoYichen</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="icp连接"><img class="icp-icon" src="icp图片"><span>备案号：xxxxxx</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>